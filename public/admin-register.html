<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì íšŒì›ê°€ì… - ë§›ë‚¨ì‚´ë¡±</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #2563EB; 
      --primary-dark: #1E40AF;
      --primary-light: #3B82F6;
      --bg-light: #F5F7FB; 
      --bg-white: #FFFFFF;
      --text-primary: #0F172A; 
      --text-secondary: #64748B; 
      --border-color: #E2E8F0; 
      --border-radius: 12px;
      --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.1);
      --success-color: #10B981; 
      --danger-color: #EF4444;
      --font-sans: 'Noto Sans KR', Inter, system-ui, -apple-system, sans-serif;
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-light);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-primary);
    }

    .register-box {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      padding: 48px 40px;
      box-shadow: var(--shadow-lg);
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    @media (max-width: 640px) {
      .register-box {
        padding: 32px 24px;
      }
    }

    .logo {
      text-align: center;
      font-size: 64px;
      margin-bottom: 16px;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 14px;
      line-height: 1.6;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 24px 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-color);
    }

    .section-title:first-of-type {
      margin-top: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    label .required {
      color: var(--danger-color);
    }

    label .optional {
      color: var(--text-secondary);
      font-weight: 400;
      font-size: 12px;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 15px;
      transition: all 0.2s;
      background: var(--bg-white);
      color: var(--text-primary);
    }

    input:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    input::placeholder {
      color: var(--text-secondary);
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: var(--primary-color);
      color: var(--bg-white);
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .error {
      background: #FEE2E2;
      color: #991B1B;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #FECACA;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success {
      background: #D1FAE5;
      color: #065F46;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #A7F3D0;
      display: none;
    }

    .success.show {
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .back-link {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .back-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }

    .back-link a:hover {
      text-decoration: underline;
    }

    .info-box {
      background: #DBEAFE;
      border: 1px solid #BFDBFE;
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #1E40AF;
      line-height: 1.6;
    }

    .info-box strong {
      display: block;
      margin-bottom: 8px;
      font-size: 15px;
    }

    .help-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="register-box">
    <div class="logo">ğŸ¢</div>
    <h1>ê´€ë¦¬ì íšŒì›ê°€ì…</h1>
    <p class="subtitle">
      íšŒì‚¬ ê´€ë¦¬ìë¡œ ê°€ì…í•˜ê³  ì§ì› ê´€ë¦¬ ì‹œìŠ¤í…œì„ ì‹œì‘í•˜ì„¸ìš”<br>
      <strong>ì´ˆëŒ€ì½”ë“œ ì—†ì´ ë°”ë¡œ ê°€ì… ê°€ëŠ¥í•©ë‹ˆë‹¤</strong>
    </p>

    <div class="info-box">
      <strong>ğŸ’¡ ê´€ë¦¬ì ê°€ì… ì•ˆë‚´</strong>
      íšŒì‚¬ëª…ê³¼ ê¸°ë³¸ ì •ë³´ë§Œ ì…ë ¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.<br>
      ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸, ì£¼ì†Œ ë“±ì€ ë‚˜ì¤‘ì— ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì…ë ¥í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <div class="error" id="error-message"></div>
    <div class="success" id="success-message"></div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <form id="register-form" autocomplete="off">
      <!-- ê°œì¸ì •ë³´ ì„¹ì…˜ -->
      <div class="section-title">ğŸ‘¤ ê°œì¸ì •ë³´</div>

      <div class="form-group">
        <label for="displayName">ì´ë¦„ <span class="required">*</span></label>
        <input type="text" id="displayName" name="displayName" required placeholder="í™ê¸¸ë™" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="email">ì´ë©”ì¼ <span class="required">*</span></label>
        <input type="email" id="email" name="email" required placeholder="admin@company.com" autocomplete="off">
        <div class="help-text">ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤</div>
      </div>

      <div class="form-group">
        <label for="password">ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="password" id="password" name="password" required placeholder="6ì ì´ìƒ" minlength="6" autocomplete="new-password">
      </div>

      <div class="form-group">
        <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
        <input type="password" id="passwordConfirm" name="passwordConfirm" required placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" autocomplete="new-password">
      </div>

      <div class="form-group">
        <label for="phone">ì „í™”ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="tel" id="phone" name="phone" required placeholder="010-1234-5678" autocomplete="off">
      </div>

      <div class="form-group">
        <label for="birth">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="text" id="birth" name="birth" required placeholder="YYMMDD (ì˜ˆ: 901225)" maxlength="6" autocomplete="off">
        <div class="help-text">ìƒë…„ì›”ì¼ 6ìë¦¬ë§Œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 901225)</div>
      </div>

      <div class="form-group">
        <label for="address">ì£¼ì†Œ <span class="required">*</span></label>
        <input type="text" id="address" name="address" required placeholder="ê²½ê¸°ë„ ë¶€ì²œì‹œ..." autocomplete="off">
      </div>

      <!-- íšŒì‚¬ì •ë³´ ì„¹ì…˜ -->
      <div class="section-title">ğŸ¢ íšŒì‚¬ì •ë³´</div>

      <div class="form-group">
        <label for="companyName">íšŒì‚¬ëª… <span class="required">*</span></label>
        <input type="text" id="companyName" name="companyName" required placeholder="ABC ë””ì €íŠ¸ ì„¼í„°" autocomplete="off">
        <div class="help-text">ìš´ì˜í•˜ì‹œëŠ” íšŒì‚¬/ë¸Œëœë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš”</div>
      </div>

      <div class="form-group">
        <label for="businessNumber">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ <span class="optional">(ì„ íƒ)</span></label>
        <input type="text" id="businessNumber" name="businessNumber" placeholder="123-45-67890" autocomplete="off">
        <div class="help-text">ë‚˜ì¤‘ì— ì…ë ¥í•˜ì…”ë„ ë©ë‹ˆë‹¤</div>
      </div>

      <div class="form-group">
        <label for="companyPhone">íšŒì‚¬ ì „í™”ë²ˆí˜¸ <span class="optional">(ì„ íƒ)</span></label>
        <input type="tel" id="companyPhone" name="companyPhone" placeholder="02-1234-5678" autocomplete="off">
      </div>

      <button type="submit" class="btn" id="submit-btn">íšŒì›ê°€ì…</button>
    </form>

    <div class="back-link">
      ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/admin-login.html">ë¡œê·¸ì¸</a><br>
      ì§ì›ì´ì‹ ê°€ìš”? <a href="/employee-register.html">ì§ì› ê°€ì…</a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  
  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>
  
  <script>
    // firebase-config.jsì—ì„œ ì´ë¯¸ auth, db ì´ˆê¸°í™”ë¨
    const form = document.getElementById('register-form');
    const submitBtn = document.getElementById('submit-btn');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');

    // ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      successDiv.classList.remove('show');
      loadingDiv.classList.remove('show');
      submitBtn.disabled = false;
    }

    // ì„±ê³µ í‘œì‹œ í•¨ìˆ˜
    function showSuccess(message) {
      successDiv.textContent = message;
      successDiv.classList.add('show');
      errorDiv.classList.remove('show');
    }

    // Company ID ìƒì„± í•¨ìˆ˜ (íšŒì‚¬ëª… ê¸°ë°˜)
    function generateCompanyId(companyName) {
      // íšŒì‚¬ëª…ì˜ ì• 3ê¸€ì + ì—°ë„
      const prefix = companyName.replace(/[^a-zA-Zê°€-í£]/g, '').substring(0, 3).toUpperCase();
      const year = new Date().getFullYear();
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return `${prefix}${year}-${random}`;
    }

    // íšŒì›ê°€ì… ì²˜ë¦¬
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      errorDiv.classList.remove('show');
      successDiv.classList.remove('show');
      
      // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
      const displayName = document.getElementById('displayName').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('passwordConfirm').value;
      const phone = document.getElementById('phone').value.trim();
      const birth = document.getElementById('birth').value.trim();
      const address = document.getElementById('address').value.trim();
      const companyName = document.getElementById('companyName').value.trim();
      const businessNumber = document.getElementById('businessNumber').value.trim();
      const companyPhone = document.getElementById('companyPhone').value.trim();

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!displayName || !email || !password || !phone || !birth || !address || !companyName) {
        showError('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì£¼ë¯¼ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
      if (birth.length !== 6 || isNaN(birth)) {
        showError('ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      if (password !== passwordConfirm) {
        showError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      if (password.length < 6) {
        showError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      // ë¡œë”© ì‹œì‘
      submitBtn.disabled = true;
      loadingDiv.classList.add('show');

      try {
        // 1. Firebase Auth ê³„ì • ìƒì„±
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // 2. Company ID ìƒì„±
        const companyId = generateCompanyId(companyName);

        // 3. Firestoreì— íšŒì‚¬ ì •ë³´ ì €ì¥ (êµ¬ë… ì •ë³´ í¬í•¨)
        await db.collection('companies').doc(companyId).set({
          companyId: companyId,
          companyName: companyName,
          businessNumber: businessNumber || '',
          phone: companyPhone || '',
          email: email,
          address: '',  // ë‚˜ì¤‘ì— ì…ë ¥
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user.uid,
          // ğŸ¯ êµ¬ë…(Subscription) ì •ë³´ ì´ˆê¸°í™”
          subscription: {
            planType: 'free',          // ê¸°ë³¸ê°’: ë¬´ë£Œ í”Œëœ
            status: 'active',          // í™œì„± ìƒíƒœ
            maxUsers: 5,               // ë¬´ë£Œ í”Œëœ ì œí•œ: 5ëª…
            startedAt: firebase.firestore.FieldValue.serverTimestamp(),  // êµ¬ë… ì‹œì‘ì¼
            nextBillingDate: null      // ë¬´ë£ŒëŠ” ê²°ì œì¼ ì—†ìŒ
          }
        });

        // 4. Firestoreì— ê´€ë¦¬ì ì •ë³´ ì €ì¥ (users)
        await db.collection('users').doc(user.uid).set({
          uid: user.uid,
          email: email,
          name: displayName,
          displayName: displayName,
          phone: phone,
          birth: birth,  // ì£¼ë¯¼ë²ˆí˜¸
          address: address,  // ì£¼ì†Œ
          role: 'admin',
          companyId: companyId,
          companyName: companyName,
          storeId: null,  // ê´€ë¦¬ìëŠ” íŠ¹ì • ì§€ì ì— ì†í•˜ì§€ ì•ŠìŒ
          store: null,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 5. Firestoreì— ì§ì› ì •ë³´ ì €ì¥ (employees - users ë³µì‚¬ë³¸)
        await db.collection('employees').doc(user.uid).set({
          uid: user.uid,
          email: email,
          displayName: displayName,
          phone: phone,
          role: 'admin',
          companyId: companyId,
          storeId: null,
          status: 'active',
          position: 'ëŒ€í‘œ',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 6. Auth displayName ì—…ë°ì´íŠ¸
        await user.updateProfile({
          displayName: displayName
        });

        // ì„±ê³µ ë©”ì‹œì§€
        showSuccess('âœ… ê´€ë¦¬ì ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...');
        loadingDiv.classList.remove('show');

        // 2ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.location.href = '/admin-login.html';
        }, 2000);

      } catch (error) {
        console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
        
        let errorMessage = 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        } else if (error.code === 'permission-denied') {
          errorMessage = 'Firestore ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. Rulesë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        }
        
        showError(errorMessage);
      }
    });
  </script>
</body>
</html>
