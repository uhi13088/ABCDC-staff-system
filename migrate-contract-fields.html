<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³„ì•½ì„œ í•„ë“œëª… ë§ˆì´ê·¸ë ˆì´ì…˜</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
    .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
    .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    .error { background: #ffebee; border-left: 4px solid #f44336; }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover { background: #1976d2; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger { background: #f44336; }
    .danger:hover { background: #d32f2f; }
    #log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      max-height: 500px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“‹ ê³„ì•½ì„œ í•„ë“œëª… ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
    
    <div class="status info">
      <strong>â„¹ï¸ ì´ ë„êµ¬ëŠ” ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:</strong><br>
      1. êµ¬ í•„ë“œëª… â†’ ì‹  í•„ë“œëª… ë³€í™˜<br>
      &nbsp;&nbsp;&nbsp;â€¢ wageType â†’ salaryType<br>
      &nbsp;&nbsp;&nbsp;â€¢ wageAmount â†’ salaryAmount<br>
      &nbsp;&nbsp;&nbsp;â€¢ startDate â†’ contractStartDate<br>
      &nbsp;&nbsp;&nbsp;â€¢ endDate â†’ contractEndDate<br>
      2. employeeId: "NULL" â†’ ì‹¤ì œ UID ë§¤í•‘<br>
      3. employeeId ì—†ëŠ” ê³„ì•½ì„œ â†’ employeeName+Birthë¡œ UID ì°¾ê¸°
    </div>

    <div class="status warning">
      <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
      â€¢ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°˜ë“œì‹œ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤<br>
      â€¢ "ë¶„ì„" ë²„íŠ¼ìœ¼ë¡œ ë¨¼ì € í™•ì¸ í›„ "ì‹¤í–‰" í•˜ì„¸ìš”<br>
      â€¢ ì‹¤í–‰ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
    </div>

    <div style="margin: 20px 0;">
      <button onclick="analyzeContracts()">ğŸ” ë¶„ì„ (ì½ê¸° ì „ìš©)</button>
      <button onclick="migrateContracts()" class="danger" id="migrateBtn" disabled>âš¡ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</button>
    </div>

    <div id="log"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase ì§ì ‘ ì´ˆê¸°í™” (firebase-config.js ì‚¬ìš© ì•ˆ í•¨)
    const firebaseConfig = {
      apiKey: "AIzaSyDfOCVHKaF3L4ZaVPqc0Fn_WXqKiBaQsEU",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "775708268326",
      appId: "1:775708268326:web:9d4e74c2fbcad91aaa94ec"
    };
    
    firebase.initializeApp(firebaseConfig);
    const logEl = document.getElementById('log');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('ko-KR');
      const prefix = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        warning: 'âš ï¸',
        error: 'âŒ'
      }[type] || 'â„¹ï¸';
      
      logEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function analyzeContracts() {
      logEl.textContent = '';
      log('=== ê³„ì•½ì„œ ë¶„ì„ ì‹œì‘ ===');
      
      try {
        const snapshot = await db.collection('contracts').get();
        log(`ì´ ${snapshot.size}ê°œ ê³„ì•½ì„œ ë°œê²¬`);
        
        let needMigration = 0;
        let hasNullEmployeeId = 0;
        let missingEmployeeId = 0;
        let okCount = 0;
        
        const issues = [];
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const contractId = doc.id;
          let hasIssue = false;
          let issueDesc = [];
          
          // 1. êµ¬ í•„ë“œëª… ì‚¬ìš© í™•ì¸
          if (data.wageType && !data.salaryType) {
            issueDesc.push('wageType â†’ salaryType í•„ìš”');
            hasIssue = true;
          }
          if (data.wageAmount && !data.salaryAmount) {
            issueDesc.push('wageAmount â†’ salaryAmount í•„ìš”');
            hasIssue = true;
          }
          if (data.startDate && !data.contractStartDate) {
            issueDesc.push('startDate â†’ contractStartDate í•„ìš”');
            hasIssue = true;
          }
          if (data.endDate && !data.contractEndDate) {
            issueDesc.push('endDate â†’ contractEndDate í•„ìš”');
            hasIssue = true;
          }
          
          // 2. employeeId í™•ì¸
          if (!data.employeeId || data.employeeId === '') {
            issueDesc.push('employeeId ì—†ìŒ');
            missingEmployeeId++;
            hasIssue = true;
          } else if (data.employeeId === 'NULL' || data.employeeId === 'null') {
            issueDesc.push('employeeId: "NULL" â†’ UID ë§¤í•‘ í•„ìš”');
            hasNullEmployeeId++;
            hasIssue = true;
          }
          
          if (hasIssue) {
            needMigration++;
            issues.push({
              id: contractId,
              name: data.employeeName || 'ì´ë¦„ì—†ìŒ',
              issues: issueDesc
            });
          } else {
            okCount++;
          }
        }
        
        log('');
        log('=== ë¶„ì„ ê²°ê³¼ ===', 'success');
        log(`âœ… ì •ìƒ: ${okCount}ê°œ`);
        log(`âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”: ${needMigration}ê°œ`);
        log(`  - employeeId ì—†ìŒ: ${missingEmployeeId}ê°œ`);
        log(`  - employeeId "NULL": ${hasNullEmployeeId}ê°œ`);
        log('');
        
        if (issues.length > 0) {
          log('=== ìƒì„¸ ë‚´ì—­ ===', 'warning');
          issues.forEach(issue => {
            log(`${issue.id} (${issue.name}):`, 'warning');
            issue.issues.forEach(desc => {
              log(`  â€¢ ${desc}`, 'warning');
            });
          });
          
          document.getElementById('migrateBtn').disabled = false;
          log('');
          log('âš¡ "ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰" ë²„íŠ¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
          log('âœ… ëª¨ë“  ê³„ì•½ì„œê°€ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤', 'success');
        }
        
      } catch (error) {
        log(`ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function migrateContracts() {
      if (!confirm('âš ï¸ ê³„ì•½ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      logEl.textContent = '';
      log('=== ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘ ===');
      document.getElementById('migrateBtn').disabled = true;
      
      try {
        const snapshot = await db.collection('contracts').get();
        log(`ì´ ${snapshot.size}ê°œ ê³„ì•½ì„œ ì²˜ë¦¬ ì¤‘...`);
        
        let successCount = 0;
        let errorCount = 0;
        
        // users ì»¬ë ‰ì…˜ ë¯¸ë¦¬ ë¡œë“œ (employeeId ë§¤í•‘ìš©)
        const usersSnapshot = await db.collection('users').get();
        const usersMap = new Map();
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.name}_${data.birth}`;
          usersMap.set(key, doc.id);
        });
        log(`users ì»¬ë ‰ì…˜ì—ì„œ ${usersMap.size}ëª…ì˜ ì§ì› ì •ë³´ ë¡œë“œ ì™„ë£Œ`);
        log('');
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const contractId = doc.id;
          const updates = {};
          let needsUpdate = false;
          
          log(`ì²˜ë¦¬ ì¤‘: ${contractId} (${data.employeeName || 'ì´ë¦„ì—†ìŒ'})`);
          
          // 1. í•„ë“œëª… ë§ˆì´ê·¸ë ˆì´ì…˜
          if (data.wageType && !data.salaryType) {
            updates.salaryType = data.wageType;
            log(`  â€¢ salaryType = ${data.wageType}`);
            needsUpdate = true;
          }
          if (data.wageAmount && !data.salaryAmount) {
            updates.salaryAmount = data.wageAmount;
            log(`  â€¢ salaryAmount = ${data.wageAmount}`);
            needsUpdate = true;
          }
          if (data.startDate && !data.contractStartDate) {
            updates.contractStartDate = data.startDate;
            log(`  â€¢ contractStartDate = ${data.startDate}`);
            needsUpdate = true;
          }
          if (data.endDate && !data.contractEndDate) {
            updates.contractEndDate = data.endDate;
            log(`  â€¢ contractEndDate = ${data.endDate}`);
            needsUpdate = true;
          }
          
          // 2. employeeId ìˆ˜ì •
          if (!data.employeeId || data.employeeId === '' || data.employeeId === 'NULL' || data.employeeId === 'null') {
            if (data.employeeName && data.employeeBirth) {
              const key = `${data.employeeName}_${data.employeeBirth}`;
              const uid = usersMap.get(key);
              
              if (uid) {
                updates.employeeId = uid;
                log(`  â€¢ employeeId = ${uid} (${data.employeeName} ë§¤í•‘ ì„±ê³µ)`, 'success');
                needsUpdate = true;
              } else {
                log(`  â€¢ employeeId ë§¤í•‘ ì‹¤íŒ¨: usersì—ì„œ ${data.employeeName} (${data.employeeBirth}) ì°¾ì„ ìˆ˜ ì—†ìŒ`, 'error');
              }
            } else {
              log(`  â€¢ employeeId ë§¤í•‘ ë¶ˆê°€: employeeName ë˜ëŠ” employeeBirth ì—†ìŒ`, 'error');
            }
          }
          
          // 3. ì—…ë°ì´íŠ¸ ì‹¤í–‰
          if (needsUpdate) {
            try {
              await db.collection('contracts').doc(contractId).update(updates);
              log(`  âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
              successCount++;
            } catch (error) {
              log(`  âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
              errorCount++;
            }
          } else {
            log(`  â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ`);
          }
          
          log('');
        }
        
        log('=== ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ===', 'success');
        log(`âœ… ì„±ê³µ: ${successCount}ê°œ`);
        log(`âŒ ì‹¤íŒ¨: ${errorCount}ê°œ`);
        log('');
        log('ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
      } catch (error) {
        log(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }
  </script>
</body>
</html>
