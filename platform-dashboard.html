<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”Œë«í¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  
  <!-- ìºì‹œ ë°©ì§€ ë©”íƒ€ íƒœê·¸ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  
  <link rel="stylesheet" href="css/common.css">
  
  <style>
    /* í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
    .platform-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .platform-header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .platform-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border-color);
    }
    
    .stat-card-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .stat-card-icon {
      width: 24px;
      height: 24px;
      opacity: 0.7;
    }
    
    .companies-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .companies-table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .companies-table-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .company-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .plan-free {
      background: #e0e0e0;
      color: #666;
    }
    
    .plan-basic {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .plan-pro {
      background: #e8eaf6;
      color: #3f51b5;
    }
    
    .plan-enterprise {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .users-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .users-progress-bar {
      flex: 1;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .users-progress-fill {
      height: 100%;
      transition: width 0.3s ease, background 0.3s ease;
    }
    
    .progress-safe {
      background: var(--success-color);
    }
    
    .progress-warning {
      background: #ffc107;
    }
    
    .progress-danger {
      background: var(--danger);
    }
    
    /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ - ìˆ¨ê¹€ ìƒíƒœê°€ ê¸°ë³¸ */
    #companyManageModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      display: none;  /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      backdrop-filter: blur(4px);
    }
    
    /* ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ */
    #companyManageModal[style*="display: block"] {
      display: flex !important;
    }
    
    #companyManageModal .modal-content {
      position: relative;
      margin: auto;
    }
  </style>
</head>
<body>
  <!-- ğŸ”’ ë¡œë”© í™”ë©´ (ê¶Œí•œ í™•ì¸ ì¤‘) -->
  <div id="loadingScreen" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5;">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
      <div style="font-size: 18px; color: var(--text-secondary);">ê¶Œí•œ í™•ì¸ ì¤‘...</div>
    </div>
  </div>

  <!-- ë©”ì¸ í™”ë©´ (super_adminë§Œ ì ‘ê·¼ ê°€ëŠ¥) -->
  <div id="mainScreen" style="display: none;">
    <!-- í—¤ë” -->
    <div class="platform-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          í”Œë«í¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
        </h1>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; font-size: 14px;">
            <strong id="adminName">ìŠˆí¼ ì–´ë“œë¯¼</strong>
          </span>
          <button class="btn btn-secondary" onclick="logout()" style="background: rgba(255,255,255,0.9); color: #764ba2;">
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- ğŸ“Š í†µê³„ ì¹´ë“œ -->
      <div class="platform-stats">
        <div class="stat-card">
          <div class="stat-card-label">
            <svg class="stat-card-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
            </svg>
            ì´ ê°€ì… íšŒì‚¬ ìˆ˜
          </div>
          <div class="stat-card-value" id="totalCompanies">0</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-label">
            <svg class="stat-card-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            ì´ ì‚¬ìš©ì ìˆ˜
          </div>
          <div class="stat-card-value" id="totalUsers">0</div>
        </div>
      </div>

      <!-- ğŸ“‹ íšŒì‚¬ ëª©ë¡ í…Œì´ë¸” -->
      <div class="companies-table-container">
        <div class="companies-table-header">
          <div style="display: flex; align-items: center; gap: 16px;">
            <h2>ğŸ“‹ ê°€ì… íšŒì‚¬ ëª©ë¡</h2>
            <!-- ëŒ€ëŸ‰ ì‘ì—… ë²„íŠ¼ (ì„ íƒëœ í•­ëª©ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
            <div id="bulkActionsBar" style="display: none; gap: 8px;">
              <span id="selectedCount" style="font-size: 14px; color: var(--text-secondary);"></span>
              <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="bulkDelete()">
                ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ
              </button>
              <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
                ì„ íƒ í•´ì œ
              </button>
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-success" onclick="exportToCSV()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
              </svg>
              CSV ë‹¤ìš´ë¡œë“œ
            </button>
            <button class="btn btn-primary" onclick="refreshCompanies()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
              </svg>
              ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        </div>
        
        <!-- ğŸ” ê²€ìƒ‰ & í•„í„° -->
        <div style="padding: 16px 24px; border-bottom: 1px solid var(--border-color); background: #f8f9fa;">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; align-items: end;">
            <!-- ê²€ìƒ‰ì°½ -->
            <div>
              <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 6px;">
                ğŸ” íšŒì‚¬ëª… ê²€ìƒ‰
              </label>
              <input 
                type="text" 
                id="searchCompanyName" 
                class="form-control" 
                placeholder="íšŒì‚¬ëª… ì…ë ¥..." 
                onkeyup="applyFilters()"
                style="width: 100%;"
              />
            </div>
            
            <!-- í”Œëœ í•„í„° -->
            <div>
              <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 6px;">
                ğŸ“¦ í”Œëœ í•„í„°
              </label>
              <select id="filterPlan" class="form-control" onchange="applyFilters()" style="width: 100%;">
                <option value="">ì „ì²´ (All)</option>
                <option value="free">Free</option>
                <option value="basic">Basic</option>
                <option value="pro">Pro</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            
            <!-- ìƒíƒœ í•„í„° -->
            <div>
              <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 6px;">
                âš™ï¸ ìƒíƒœ í•„í„°
              </label>
              <select id="filterStatus" class="form-control" onchange="applyFilters()" style="width: 100%;">
                <option value="">ì „ì²´ (All)</option>
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
              </select>
            </div>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" />
                </th>
                <th style="cursor: pointer; user-select: none;" onclick="sortTable('name')">
                  íšŒì‚¬ëª… <span id="sortIcon-name"></span>
                </th>
                <th>ëŒ€í‘œì ì´ë©”ì¼</th>
                <th style="cursor: pointer; user-select: none;" onclick="sortTable('createdAt')">
                  ê°€ì…ì¼ <span id="sortIcon-createdAt">â†“</span>
                </th>
                <th>í”Œëœ</th>
                <th style="cursor: pointer; user-select: none;" onclick="sortTable('employeeCount')">
                  ì§ì› í˜„í™© <span id="sortIcon-employeeCount"></span>
                </th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="companiesTableBody">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="margin: 0 auto;">â³ íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; flex-wrap: wrap; gap: 16px;">
          <div style="font-size: 13px; color: var(--text-secondary);">
            <span id="paginationInfo">0ê°œ íšŒì‚¬</span>
          </div>
          
          <!-- í˜ì´ì§€ ë²ˆí˜¸ ë„¤ë¹„ê²Œì´ì…˜ -->
          <div style="display: flex; gap: 4px; align-items: center;">
            <button id="btnFirstPage" class="btn btn-secondary btn-sm" onclick="goToPage(1)" disabled>
              â®ï¸
            </button>
            <button id="btnPrevPage" class="btn btn-secondary btn-sm" onclick="goToPage(currentPage - 1)" disabled>
              â† ì´ì „
            </button>
            
            <!-- í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤ -->
            <div id="pageNumbers" style="display: flex; gap: 4px;"></div>
            
            <button id="btnNextPage" class="btn btn-secondary btn-sm" onclick="goToPage(currentPage + 1)" disabled>
              ë‹¤ìŒ â†’
            </button>
            <button id="btnLastPage" class="btn btn-secondary btn-sm" onclick="goToPage(totalPages)" disabled>
              â­ï¸
            </button>
          </div>
          
          <!-- Go to Page -->
          <div style="display: flex; gap: 8px; align-items: center;">
            <span style="font-size: 13px; color: var(--text-secondary);">í˜ì´ì§€ ì´ë™:</span>
            <input 
              type="number" 
              id="gotoPageInput" 
              min="1" 
              style="width: 60px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px;"
              onkeypress="if(event.key==='Enter') gotoPageByInput()"
            />
            <button class="btn btn-sm btn-secondary" onclick="gotoPageByInput()">ì´ë™</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ¢ íšŒì‚¬ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="companyManageModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 style="margin: 0; font-size: 20px; font-weight: 700;">ğŸ¢ íšŒì‚¬ ê´€ë¦¬</h2>
        <button type="button" class="modal-close" onclick="closeCompanyManageModal()" aria-label="ë‹«ê¸°">&times;</button>
      </div>
      <div class="modal-body">
        <form id="companyManageForm" onsubmit="saveCompanySettings(event)">
          <!-- íšŒì‚¬ëª… í‘œì‹œ -->
          <div class="form-group">
            <label style="font-weight: 600; color: var(--text-primary);">ëŒ€ìƒ íšŒì‚¬</label>
            <div id="targetCompanyName" style="font-size: 18px; padding: 12px; background: #f5f5f5; border-radius: 8px; margin-top: 8px;">
              -
            </div>
          </div>

          <!-- í”Œëœ ë³€ê²½ -->
          <div class="form-group">
            <label for="planTypeSelect">í”Œëœ ë³€ê²½</label>
            <select id="planTypeSelect" class="form-control" required>
              <option value="free">Free Plan (ë¬´ë£Œ)</option>
              <option value="basic">Basic Plan (ê¸°ë³¸)</option>
              <option value="pro">Pro Plan (í”„ë¡œ)</option>
              <option value="enterprise">Enterprise Plan (ê¸°ì—…)</option>
            </select>
          </div>

          <!-- ìµœëŒ€ ì¸ì› ìˆ˜ì • -->
          <div class="form-group">
            <label for="maxUsersInput">ìµœëŒ€ ì¸ì› (Max Users)</label>
            <input 
              type="number" 
              id="maxUsersInput" 
              class="form-control" 
              min="1" 
              max="10000" 
              required
              placeholder="ìµœëŒ€ ì§ì› ìˆ˜ ì…ë ¥"
            />
            <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
              ğŸ’¡ Free: 5ëª…, Basic: 20ëª…, Pro: 100ëª…, Enterprise: ë¬´ì œí•œ (10000ëª…)
            </small>
          </div>

          <!-- ìƒíƒœ ë³€ê²½ -->
          <div class="form-group">
            <label>íšŒì‚¬ ìƒíƒœ</label>
            <div style="display: flex; gap: 16px; margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="radio" name="companyStatus" value="active" checked />
                <span>âœ… Active (í™œì„±)</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="radio" name="companyStatus" value="suspended" />
                <span>ğŸš« Suspended (ì •ì§€)</span>
              </label>
            </div>
            <small style="color: var(--text-secondary); font-size: 12px; margin-top: 8px; display: block;">
              âš ï¸ ì •ì§€ ìƒíƒœ ì‹œ í•´ë‹¹ íšŒì‚¬ì˜ ëª¨ë“  ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </small>
          </div>

          <input type="hidden" id="targetCompanyId" />

          <!-- ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ -->
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
              ğŸ’¾ ì €ì¥
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeCompanyManageModal()" style="flex: 1;">
              ì·¨ì†Œ
            </button>
          </div>
        </form>

        <!-- ìœ„í—˜ êµ¬ì—­: íšŒì‚¬ ì‚­ì œ -->
        <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #f0f0f0;">
          <h3 style="color: #dc3545; font-size: 14px; font-weight: 600; margin-bottom: 8px;">âš ï¸ ìœ„í—˜ êµ¬ì—­</h3>
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
            ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íšŒì‚¬ì™€ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(ì§ì›, ê³„ì•½ì„œ, ê·¼íƒœ ê¸°ë¡ ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
          </p>
          <button 
            type="button" 
            class="btn" 
            onclick="deleteCompanyFromModal()"
            style="background: #dc3545; color: white; width: 100%; font-weight: 600; border: none;">
            ğŸ—‘ï¸ íšŒì‚¬ ì™„ì „ ì‚­ì œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCr3Tq2T7oy5rVlK1c33m_G0TlUWv0-g3k",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "442207878284",
      appId: "1:442207878284:web:49b157573851b124d28fa9"
    };

    // Firebase ì´ˆê¸°í™”
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let currentUser = null;
    
    // ğŸ“„ í˜ì´ì§€ë„¤ì´ì…˜ & ì •ë ¬ & ì„ íƒ ìƒíƒœ
    const PAGE_SIZE = 10;  // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
    let currentPage = 1;
    let totalPages = 1;
    let allCompaniesData = [];  // ëª¨ë“  íšŒì‚¬ ë°ì´í„° (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì •ë ¬/í˜ì´ì§•ìš©)
    let filteredCompaniesData = [];  // í•„í„°ë§ëœ íšŒì‚¬ ë°ì´í„°
    let selectedCompanies = new Set();  // ì„ íƒëœ íšŒì‚¬ ID Set
    
    // ì •ë ¬ ìƒíƒœ
    let currentSortField = 'createdAt';  // ê¸°ë³¸ ì •ë ¬: ê°€ì…ì¼
    let currentSortOrder = 'desc';  // desc: ë‚´ë¦¼ì°¨ìˆœ, asc: ì˜¤ë¦„ì°¨ìˆœ

    // ğŸ”’ í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ í™•ì¸
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        console.warn('âŒ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
        window.location.href = 'index.html';
        return;
      }

      try {
        // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
          alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          window.location.href = 'index.html';
          return;
        }

        const userData = userDoc.data();
        currentUser = {
          uid: user.uid,
          email: user.email,
          ...userData
        };

        // ğŸ”’ super_adminì´ ì•„ë‹ˆë©´ ì ‘ê·¼ ì°¨ë‹¨
        if (currentUser.role !== 'super_admin') {
          console.error('âŒ ê¶Œí•œ ì—†ìŒ (role: ' + currentUser.role + ') - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
          alert('âš ï¸ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\ní”Œë«í¼ ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          window.location.href = 'index.html';
          return;
        }

        console.log('âœ… ìŠˆí¼ ì–´ë“œë¯¼ ì¸ì¦ ì„±ê³µ:', currentUser.email);
        
        // ë©”ì¸ í™”ë©´ í‘œì‹œ
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'block';
        
        // ê´€ë¦¬ì ì´ë¦„ í‘œì‹œ
        document.getElementById('adminName').textContent = currentUser.name || currentUser.email;
        
        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        await loadPlatformDashboard();
        
      } catch (error) {
        console.error('âŒ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
        alert('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        window.location.href = 'index.html';
      }
    });

    /**
     * í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
     */
    async function loadPlatformDashboard() {
      console.log('ğŸ“Š í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹œì‘...');
      
      try {
        // ğŸ“Š í†µê³„ ì¹´ìš´íŠ¸
        const companiesSnapshot = await db.collection('companies').get();
        const usersSnapshot = await db.collection('users').get();
        
        document.getElementById('totalCompanies').textContent = companiesSnapshot.size;
        document.getElementById('totalUsers').textContent = usersSnapshot.size;
        
        console.log(`âœ… í†µê³„ ë¡œë“œ ì™„ë£Œ: ${companiesSnapshot.size}ê°œ íšŒì‚¬, ${usersSnapshot.size}ëª… ì‚¬ìš©ì`);
        
        // ğŸ“‹ íšŒì‚¬ ëª©ë¡ ë¡œë“œ
        await loadCompanies();
        
      } catch (error) {
        console.error('âŒ í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * íšŒì‚¬ ëª©ë¡ ë¡œë“œ (ì „ì²´ ë°ì´í„° ë¡œë“œ)
     */
    async function loadCompanies() {
      const tbody = document.getElementById('companiesTableBody');
      
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px;">
            <div class="loading-spinner">
              <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
              <div>íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
          </td>
        </tr>
      `;
      
      try {
        console.log('ğŸ“‹ íšŒì‚¬ ëª©ë¡ ì „ì²´ ë¡œë“œ ì‹œì‘...');
        
        // ğŸ”¥ Firestoreì—ì„œ ëª¨ë“  íšŒì‚¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const companiesSnapshot = await db.collection('companies')
          .orderBy('createdAt', 'desc')
          .get();
        
        if (companiesSnapshot.empty) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                ğŸ“­ ë“±ë¡ëœ íšŒì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.
              </td>
            </tr>
          `;
          document.getElementById('paginationInfo').textContent = '0ê°œ íšŒì‚¬';
          allCompaniesData = [];
          filteredCompaniesData = [];
          return;
        }
        
        // ê° íšŒì‚¬ì˜ ì§ì› ìˆ˜ ì¹´ìš´íŠ¸ ë° ë°ì´í„° ìˆ˜ì§‘
        allCompaniesData = [];
        
        for (const doc of companiesSnapshot.docs) {
          const company = doc.data();
          const companyId = doc.id;
          
          // í•´ë‹¹ íšŒì‚¬ì˜ ì§ì› ìˆ˜ ì¹´ìš´íŠ¸ (staff, store_manager, managerë§Œ)
          const employeesSnapshot = await db.collection('users')
            .where('companyId', '==', companyId)
            .where('role', 'in', ['staff', 'store_manager', 'manager'])
            .where('status', 'in', ['active', 'pending', 'approved'])
            .get();
          
          allCompaniesData.push({
            id: companyId,
            name: company.name || company.companyName || '(ì´ë¦„ ì—†ìŒ)',
            adminEmail: company.email || company.adminEmail || '(ì´ë©”ì¼ ì—†ìŒ)',
            createdAt: company.createdAt,
            subscription: company.subscription || {
              planType: 'free',
              status: 'active',
              maxUsers: 5
            },
            employeeCount: employeesSnapshot.size
          });
        }
        
        console.log(`âœ… ì „ì²´ ${allCompaniesData.length}ê°œ íšŒì‚¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
        
        // ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
        updateSortIcons();
        
        // ì •ë ¬ ë° í•„í„°ë§ ì ìš©í•˜ì—¬ ë Œë”ë§
        applySortingAndFiltering();
        
      } catch (error) {
        console.error('âŒ íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        
        // Firestore ì¸ë±ìŠ¤ í•„ìš” ì—ëŸ¬ ì²˜ë¦¬
        if (error.code === 'failed-precondition' || error.message.includes('index')) {
          console.error('ğŸ”— Firestore ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤!');
          console.error('ì•„ë˜ ë§í¬ì—ì„œ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”:');
          
          // ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ì¸ë±ìŠ¤ ìƒì„± ë§í¬ ì¶”ì¶œ
          const indexUrlMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
          if (indexUrlMatch) {
            console.error('ğŸ‘‰ ' + indexUrlMatch[0]);
          }
          
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px;">
                <div style="color: var(--danger); margin-bottom: 16px;">
                  âŒ Firestore ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                  í•„í„° ê²€ìƒ‰ì„ ìœ„í•´ Firestore ë³µí•© ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br/>
                  ì½˜ì†”ì—ì„œ ì¸ë±ìŠ¤ ìƒì„± ë§í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
                ${indexUrlMatch ? `
                  <a href="${indexUrlMatch[0]}" target="_blank" class="btn btn-primary">
                    ğŸ”— ì¸ë±ìŠ¤ ìƒì„±í•˜ê¸°
                  </a>
                ` : ''}
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">
                âŒ íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br/>
                <small style="font-size: 13px; color: var(--text-secondary); margin-top: 8px; display: block;">
                  ${error.message}
                </small>
              </td>
            </tr>
          `;
        }
      }
    }

    /**
     * íšŒì‚¬ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
     */
    function openCompanyManageModal(companyId, companyName, planType, maxUsers, status) {
      console.log('ğŸ¢ íšŒì‚¬ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°:', { companyId, companyName, planType, maxUsers, status });
      
      // ëª¨ë‹¬ ë°ì´í„° ì„¤ì •
      document.getElementById('targetCompanyId').value = companyId;
      document.getElementById('targetCompanyName').textContent = companyName;
      document.getElementById('planTypeSelect').value = planType;
      document.getElementById('maxUsersInput').value = maxUsers;
      
      // ìƒíƒœ ë¼ë””ì˜¤ ë²„íŠ¼ ì„¤ì •
      const statusRadios = document.querySelectorAll('input[name="companyStatus"]');
      statusRadios.forEach(radio => {
        radio.checked = radio.value === status;
      });
      
      // ëª¨ë‹¬ í‘œì‹œ
      document.getElementById('companyManageModal').style.display = 'block';
    }

    /**
     * íšŒì‚¬ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeCompanyManageModal() {
      document.getElementById('companyManageModal').style.display = 'none';
    }

    /**
     * íšŒì‚¬ ì„¤ì • ì €ì¥
     */
    async function saveCompanySettings(event) {
      event.preventDefault();
      
      const companyId = document.getElementById('targetCompanyId').value;
      const planType = document.getElementById('planTypeSelect').value;
      const maxUsers = parseInt(document.getElementById('maxUsersInput').value);
      const status = document.querySelector('input[name="companyStatus"]:checked').value;
      
      console.log('ğŸ’¾ íšŒì‚¬ ì„¤ì • ì €ì¥:', { companyId, planType, maxUsers, status });
      
      if (!companyId) {
        alert('âŒ íšŒì‚¬ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // Firestore ì—…ë°ì´íŠ¸
        await db.collection('companies').doc(companyId).update({
          'subscription.planType': planType,
          'subscription.maxUsers': maxUsers,
          'subscription.status': status,
          'subscription.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… íšŒì‚¬ ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
        // ì„±ê³µ ì•Œë¦¼
        alert('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n\në³€ê²½ ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeCompanyManageModal();
        
        // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
        await loadPlatformDashboard();
        
      } catch (error) {
        console.error('âŒ íšŒì‚¬ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
        alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!\n\n' + error.message);
      }
    }

    /**
     * ëª¨ë‹¬ì—ì„œ íšŒì‚¬ ì™„ì „ ì‚­ì œ
     */
    async function deleteCompanyFromModal() {
      const companyId = document.getElementById('targetCompanyId').value;
      const companyName = document.getElementById('targetCompanyName').textContent.trim();
      
      if (!companyId || companyId === '') {
        alert('âŒ íšŒì‚¬ IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // 2ë‹¨ê³„ í™•ì¸
      const confirmMessage = `âš ï¸ ì •ë§ë¡œ "${companyName}"ì™€ ëª¨ë“  ê´€ë ¨ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ìŒ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\n- íšŒì‚¬ ì •ë³´\n- ëª¨ë“  ì§ì› ê³„ì • (Firebase Auth í¬í•¨)\n- ê³„ì•½ì„œ\n- ê·¼íƒœ ê¸°ë¡\n- ìŠ¤ì¼€ì¤„\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
      
      if (!confirm(confirmMessage)) {
        console.log('íšŒì‚¬ ì‚­ì œ ì·¨ì†Œë¨');
        return;
      }
      
      // ì¶”ê°€ í™•ì¸: "ì‚­ì œ" ì…ë ¥ ë°›ê¸°
      const userInput = prompt(`ì •ë§ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
      if (userInput !== 'ì‚­ì œ') {
        alert('âŒ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      console.log('ğŸ—‘ï¸ íšŒì‚¬ ì‚­ì œ ì‹œì‘:', companyId, companyName);
      
      try {
        // Cloud Function í˜¸ì¶œ
        const deleteCompanyFunc = firebase.functions().httpsCallable('deleteCompany');
        const result = await deleteCompanyFunc({ companyId });
        
        console.log('âœ… íšŒì‚¬ ì‚­ì œ ì™„ë£Œ:', result.data);
        
        // ì‚­ì œ ì„±ê³µ ì•Œë¦¼
        const deletedCounts = result.data.deletedCount || {};
        const totalDeleted = result.data.totalDeleted || 0;
        
        alert(`âœ… íšŒì‚¬ ì‚­ì œ ì™„ë£Œ!\n\níšŒì‚¬ëª…: ${companyName}\nì´ ì‚­ì œëœ í•­ëª©: ${totalDeleted}ê°œ\n\nìƒì„¸:\n- ì§ì›: ${deletedCounts.users || 0}ëª…\n- ê·¼íƒœ ê¸°ë¡: ${deletedCounts.attendance || 0}ê°œ\n- ê³„ì•½ì„œ: ${deletedCounts.contracts || 0}ê°œ\n- ìŠ¤ì¼€ì¤„: ${deletedCounts.schedules || 0}ê°œ`);
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeCompanyManageModal();
        
        // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        await loadPlatformDashboard();
        
      } catch (error) {
        console.error('âŒ íšŒì‚¬ ì‚­ì œ ì‹¤íŒ¨:', error);
        
        let errorMessage = 'âŒ íšŒì‚¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
        if (error.code === 'permission-denied') {
          errorMessage += 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. super_admin ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
        } else if (error.message) {
          errorMessage += error.message;
        } else {
          errorMessage += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
        
        alert(errorMessage);
      }
    }

    /**
     * í•„í„° ì ìš©
     */
    function applyFilters() {
      console.log('ğŸ” í•„í„° ì ìš©');
      currentPage = 1;
      applySortingAndFiltering();
    }

    /**
     * íšŒì‚¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
     */
    async function refreshCompanies() {
      console.log('ğŸ”„ íšŒì‚¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨...');
      currentPage = 1;
      selectedCompanies.clear();
      await loadPlatformDashboard();
    }

    /**
     * í˜ì´ì§€ ì´ë™ (ë²ˆí˜¸ í´ë¦­)
     */
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderCurrentPage();
    }

    /**
     * ì…ë ¥ë€ìœ¼ë¡œ í˜ì´ì§€ ì´ë™
     */
    function gotoPageByInput() {
      const input = document.getElementById('gotoPageInput');
      const page = parseInt(input.value);
      if (page && page >= 1 && page <= totalPages) {
        goToPage(page);
        input.value = '';
      } else {
        alert(`1~${totalPages} ì‚¬ì´ì˜ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
      }
    }

    /**
     * í…Œì´ë¸” ì •ë ¬
     */
    function sortTable(field) {
      if (currentSortField === field) {
        // ê°™ì€ ì»¬ëŸ¼ í´ë¦­ ì‹œ ë°©í–¥ í† ê¸€
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        // ë‹¤ë¥¸ ì»¬ëŸ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì»¬ëŸ¼ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ
        currentSortField = field;
        currentSortOrder = 'asc';
      }
      
      // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
      updateSortIcons();
      
      // ë°ì´í„° ì •ë ¬ ë° ë Œë”ë§
      applySortingAndFiltering();
    }

    /**
     * ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
     */
    function updateSortIcons() {
      // ëª¨ë“  ì•„ì´ì½˜ ì´ˆê¸°í™”
      document.querySelectorAll('[id^="sortIcon-"]').forEach(icon => {
        icon.textContent = '';
      });
      
      // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì—ë§Œ ì•„ì´ì½˜ í‘œì‹œ
      const icon = document.getElementById(`sortIcon-${currentSortField}`);
      if (icon) {
        icon.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
      }
    }

    /**
     * ì •ë ¬ ë° í•„í„°ë§ ì ìš©
     */
    function applySortingAndFiltering() {
      // í•„í„° ì ìš©
      const searchName = document.getElementById('searchCompanyName')?.value.toLowerCase().trim() || '';
      const filterPlan = document.getElementById('filterPlan')?.value || '';
      const filterStatus = document.getElementById('filterStatus')?.value || '';
      
      filteredCompaniesData = allCompaniesData.filter(company => {
        // íšŒì‚¬ëª… ê²€ìƒ‰
        if (searchName && !company.name.toLowerCase().includes(searchName)) {
          return false;
        }
        
        // í”Œëœ í•„í„°
        if (filterPlan && company.subscription.planType !== filterPlan) {
          return false;
        }
        
        // ìƒíƒœ í•„í„°
        if (filterStatus && company.subscription.status !== filterStatus) {
          return false;
        }
        
        return true;
      });
      
      // ì •ë ¬ ì ìš©
      filteredCompaniesData.sort((a, b) => {
        let aVal = a[currentSortField];
        let bVal = b[currentSortField];
        
        // createdAtëŠ” Timestamp ê°ì²´
        if (currentSortField === 'createdAt') {
          aVal = aVal ? aVal.toDate().getTime() : 0;
          bVal = bVal ? bVal.toDate().getTime() : 0;
        }
        
        // ë¬¸ìì—´ ì •ë ¬ (íšŒì‚¬ëª…)
        if (currentSortField === 'name') {
          aVal = (aVal || '').toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }
        
        // ìˆ«ì ì •ë ¬ (ì§ì› ìˆ˜)
        if (currentSortField === 'employeeCount') {
          aVal = aVal || 0;
          bVal = bVal || 0;
        }
        
        if (aVal < bVal) return currentSortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ì¬ê³„ì‚°
      totalPages = Math.ceil(filteredCompaniesData.length / PAGE_SIZE) || 1;
      currentPage = Math.min(currentPage, totalPages);  // í˜„ì¬ í˜ì´ì§€ê°€ ë²”ìœ„ ë²—ì–´ë‚˜ë©´ ì¡°ì •
      
      // ë Œë”ë§
      renderCurrentPage();
    }

    /**
     * í˜„ì¬ í˜ì´ì§€ ë Œë”ë§
     */
    function renderCurrentPage() {
      const tbody = document.getElementById('companiesTableBody');
      const startIdx = (currentPage - 1) * PAGE_SIZE;
      const endIdx = startIdx + PAGE_SIZE;
      const pageData = filteredCompaniesData.slice(startIdx, endIdx);
      
      // ë°ì´í„° ì—†ìŒ
      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
              ğŸ“­ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </td>
          </tr>
        `;
        document.getElementById('paginationInfo').textContent = '0ê°œ íšŒì‚¬';
        return;
      }
      
      // í…Œì´ë¸” ë Œë”ë§
      tbody.innerHTML = pageData.map(company => {
        const subscription = company.subscription;
        const planType = subscription.planType || 'free';
        const status = subscription.status || 'active';
        const maxUsers = subscription.maxUsers || 5;
        const currentUsers = company.employeeCount;
        const isSelected = selectedCompanies.has(company.id);
        
        // ê°€ì…ì¼ í¬ë§·íŒ…
        let createdAtStr = '-';
        if (company.createdAt) {
          try {
            const date = company.createdAt.toDate();
            createdAtStr = date.toLocaleDateString('ko-KR');
          } catch (e) {
            createdAtStr = '-';
          }
        }
        
        // í”Œëœ ë°°ì§€
        const planNames = { 'free': 'Free', 'basic': 'Basic', 'pro': 'Pro', 'enterprise': 'Enterprise' };
        const planName = planNames[planType] || planType;
        const planClass = `plan-${planType}`;
        
        // ìƒíƒœ ë°°ì§€
        const statusText = status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±';
        const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
        
        // ì§ì› í˜„í™© í”„ë¡œê·¸ë ˆìŠ¤ ë°”
        const usagePercent = maxUsers > 0 ? (currentUsers / maxUsers) * 100 : 0;
        let progressClass = 'progress-safe';
        if (usagePercent >= 100) progressClass = 'progress-danger';
        else if (usagePercent >= 80) progressClass = 'progress-warning';
        
        return `
          <tr>
            <td><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${company.id}')" /></td>
            <td><strong>${company.name}</strong></td>
            <td>${company.adminEmail}</td>
            <td>${createdAtStr}</td>
            <td><span class="plan-badge ${planClass}">${planName}</span></td>
            <td>
              <div class="users-progress">
                <span style="font-weight: 600; min-width: 60px;">${currentUsers} / ${maxUsers}ëª…</span>
                <div class="users-progress-bar">
                  <div class="users-progress-fill ${progressClass}" style="width: ${Math.min(usagePercent, 100)}%;"></div>
                </div>
              </div>
            </td>
            <td><span class="company-status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="openCompanyManageModal('${company.id}', '${company.name.replace(/'/g, "\\'")}', '${planType}', ${maxUsers}, '${status}')">
                âš™ï¸ ê´€ë¦¬
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
      document.getElementById('paginationInfo').textContent = 
        `${startIdx + 1}-${startIdx + pageData.length} / ì „ì²´ ${filteredCompaniesData.length}ê°œ íšŒì‚¬`;
      
      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ ë Œë”ë§
      renderPageNumbers();
      
      // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
      updateSelectAllCheckbox();
      updateBulkActionsBar();
    }

    /**
     * í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ ë Œë”ë§
     */
    function renderPageNumbers() {
      const container = document.getElementById('pageNumbers');
      const maxButtons = 5;  // ìµœëŒ€ í‘œì‹œí•  ë²„íŠ¼ ìˆ˜
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      // ë í˜ì´ì§€ ì¡°ì •
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      
      let html = '';
      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentPage;
        html += `
          <button 
            class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-secondary'}" 
            onclick="goToPage(${i})"
            ${isActive ? 'style="font-weight: bold;"' : ''}
          >
            ${i}
          </button>
        `;
      }
      container.innerHTML = html;
      
      // ì²«/ë§ˆì§€ë§‰/ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ
      document.getElementById('btnFirstPage').disabled = currentPage === 1;
      document.getElementById('btnPrevPage').disabled = currentPage === 1;
      document.getElementById('btnNextPage').disabled = currentPage === totalPages;
      document.getElementById('btnLastPage').disabled = currentPage === totalPages;
    }

    /**
     * ì²´í¬ë°•ìŠ¤ ì„ íƒ/í•´ì œ
     */
    function toggleSelect(companyId) {
      if (selectedCompanies.has(companyId)) {
        selectedCompanies.delete(companyId);
      } else {
        selectedCompanies.add(companyId);
      }
      updateSelectAllCheckbox();
      updateBulkActionsBar();
    }

    /**
     * ì „ì²´ ì„ íƒ/í•´ì œ
     */
    function toggleSelectAll() {
      const checkbox = document.getElementById('selectAllCheckbox');
      const startIdx = (currentPage - 1) * PAGE_SIZE;
      const endIdx = startIdx + PAGE_SIZE;
      const pageData = filteredCompaniesData.slice(startIdx, endIdx);
      
      if (checkbox.checked) {
        pageData.forEach(company => selectedCompanies.add(company.id));
      } else {
        pageData.forEach(company => selectedCompanies.delete(company.id));
      }
      
      renderCurrentPage();
    }

    /**
     * ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
     */
    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('selectAllCheckbox');
      const startIdx = (currentPage - 1) * PAGE_SIZE;
      const endIdx = startIdx + PAGE_SIZE;
      const pageData = filteredCompaniesData.slice(startIdx, endIdx);
      
      const allSelected = pageData.length > 0 && pageData.every(company => selectedCompanies.has(company.id));
      checkbox.checked = allSelected;
    }

    /**
     * ëŒ€ëŸ‰ ì‘ì—… ë°” ì—…ë°ì´íŠ¸
     */
    function updateBulkActionsBar() {
      const bar = document.getElementById('bulkActionsBar');
      const countSpan = document.getElementById('selectedCount');
      
      if (selectedCompanies.size > 0) {
        bar.style.display = 'flex';
        countSpan.textContent = `${selectedCompanies.size}ê°œ ì„ íƒë¨`;
      } else {
        bar.style.display = 'none';
      }
    }

    /**
     * ì„ íƒ í•´ì œ
     */
    function clearSelection() {
      selectedCompanies.clear();
      renderCurrentPage();
    }

    /**
     * ì„ íƒ í•­ëª© ì‚­ì œ (Cloud Functions í˜¸ì¶œ)
     */
    async function bulkDelete() {
      if (selectedCompanies.size === 0) return;
      
      const companyNames = Array.from(selectedCompanies).map(id => {
        const company = allCompaniesData.find(c => c.id === id);
        return company ? company.name : id;
      }).join(', ');
      
      const confirmMessage = `ì„ íƒí•œ ${selectedCompanies.size}ê°œ íšŒì‚¬ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
        `íšŒì‚¬: ${companyNames}\n\n` +
        `âš ï¸ ê²½ê³ : ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n` +
        `âš ï¸ ëª¨ë“  ì§ì›, ì¶œí‡´ê·¼ ê¸°ë¡, ê³„ì•½ì„œ ë“±ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\n\n` +
        `ê³„ì†í•˜ë ¤ë©´ "ì‚­ì œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`;
      
      const userInput = prompt(confirmMessage);
      
      if (userInput !== 'ì‚­ì œ') {
        alert('ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        // ë¡œë”© í‘œì‹œ
        const tbody = document.getElementById('companiesTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
              <div class="loading-spinner">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—‘ï¸</div>
                <div>íšŒì‚¬ ì‚­ì œ ì¤‘... (ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</div>
              </div>
            </td>
          </tr>
        `;
        
        const deleteCompany = firebase.functions().httpsCallable('deleteCompany');
        const results = [];
        let successCount = 0;
        let failCount = 0;
        
        // ê° íšŒì‚¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
        for (const companyId of selectedCompanies) {
          try {
            console.log(`ğŸ—‘ï¸ íšŒì‚¬ ì‚­ì œ ì‹œì‘: ${companyId}`);
            const result = await deleteCompany({ companyId });
            console.log(`âœ… íšŒì‚¬ ì‚­ì œ ì™„ë£Œ:`, result.data);
            results.push({
              companyId,
              success: true,
              data: result.data
            });
            successCount++;
          } catch (error) {
            console.error(`âŒ íšŒì‚¬ ì‚­ì œ ì‹¤íŒ¨ (${companyId}):`, error);
            results.push({
              companyId,
              success: false,
              error: error.message
            });
            failCount++;
          }
        }
        
        // ê²°ê³¼ ìš”ì•½
        let summaryMessage = `ì‚­ì œ ì™„ë£Œ!\n\n`;
        summaryMessage += `âœ… ì„±ê³µ: ${successCount}ê°œ\n`;
        if (failCount > 0) {
          summaryMessage += `âŒ ì‹¤íŒ¨: ${failCount}ê°œ\n`;
        }
        
        // ì‚­ì œ í†µê³„ í‘œì‹œ (ì²« ë²ˆì§¸ ì„±ê³µ ì¼€ì´ìŠ¤)
        const successResult = results.find(r => r.success);
        if (successResult && successResult.data.deletedCount) {
          const counts = successResult.data.deletedCount;
          summaryMessage += `\n[ì‚­ì œëœ ë°ì´í„°]\n`;
          summaryMessage += `- ì‚¬ìš©ì: ${counts.users}ëª…\n`;
          summaryMessage += `- Auth ê³„ì •: ${counts.authAccounts}ê°œ\n`;
          summaryMessage += `- ì¶œí‡´ê·¼ ê¸°ë¡: ${counts.attendance}ê±´\n`;
          summaryMessage += `- ê³„ì•½ì„œ: ${counts.contracts}ê±´\n`;
          summaryMessage += `- ìŠ¤ì¼€ì¤„: ${counts.schedules}ê±´\n`;
          summaryMessage += `- ë§¤ì¥: ${counts.stores}ê°œ\n`;
          summaryMessage += `- ë¸Œëœë“œ: ${counts.brands}ê°œ\n`;
          summaryMessage += `- ì´ˆëŒ€ ì½”ë“œ: ${counts.invites}ê°œ\n`;
        }
        
        alert(summaryMessage);
        
        // ì„ íƒ í•´ì œ ë° ìƒˆë¡œê³ ì¹¨
        selectedCompanies.clear();
        await loadPlatformDashboard();
        
      } catch (error) {
        console.error('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
        alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n${error.message}`);
        await loadPlatformDashboard();
      }
    }

    /**
     * CSV ë‚´ë³´ë‚´ê¸°
     */
    function exportToCSV() {
      if (filteredCompaniesData.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // CSV í—¤ë”
      const headers = ['íšŒì‚¬ëª…', 'ëŒ€í‘œì ì´ë©”ì¼', 'ê°€ì…ì¼', 'í”Œëœ', 'í˜„ì¬ ì§ì› ìˆ˜', 'ìµœëŒ€ ì§ì› ìˆ˜', 'ìƒíƒœ'];
      
      // CSV ë°ì´í„°
      const rows = filteredCompaniesData.map(company => {
        const subscription = company.subscription || {};
        const createdAt = company.createdAt ? company.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
        const planNames = { 'free': 'Free', 'basic': 'Basic', 'pro': 'Pro', 'enterprise': 'Enterprise' };
        
        return [
          company.name,
          company.adminEmail,
          createdAt,
          planNames[subscription.planType] || subscription.planType || 'Free',
          company.employeeCount || 0,
          subscription.maxUsers || 5,
          subscription.status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±'
        ];
      });
      
      // CSV ë¬¸ìì—´ ìƒì„±
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      // UTF-8 BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      
      // ë‹¤ìš´ë¡œë“œ
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const timestamp = new Date().toISOString().slice(0, 10);
      link.setAttribute('href', url);
      link.setAttribute('download', `íšŒì‚¬ëª©ë¡_${timestamp}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      console.log(`âœ… CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: ${filteredCompaniesData.length}ê°œ íšŒì‚¬`);
    }

    /**
     * ë¡œê·¸ì•„ì›ƒ
     */
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        firebase.auth().signOut().then(() => {
          console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
          alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('companyManageModal');
      if (event.target === modal) {
        closeCompanyManageModal();
      }
    };
  </script>
</body>
</html>
