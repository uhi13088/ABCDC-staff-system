<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”Œë«í¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  
  <!-- ìºì‹œ ë°©ì§€ ë©”íƒ€ íƒœê·¸ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  
  <link rel="stylesheet" href="css/common.css">
  
  <style>
    /* í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
    .platform-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .platform-header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .platform-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border-color);
    }
    
    .stat-card-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .stat-card-icon {
      width: 24px;
      height: 24px;
      opacity: 0.7;
    }
    
    .companies-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .companies-table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .companies-table-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .company-status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .plan-free {
      background: #e0e0e0;
      color: #666;
    }
    
    .plan-basic {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .plan-pro {
      background: #e8eaf6;
      color: #3f51b5;
    }
    
    .plan-enterprise {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .users-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .users-progress-bar {
      flex: 1;
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .users-progress-fill {
      height: 100%;
      transition: width 0.3s ease, background 0.3s ease;
    }
    
    .progress-safe {
      background: var(--success-color);
    }
    
    .progress-warning {
      background: #ffc107;
    }
    
    .progress-danger {
      background: var(--danger);
    }
  </style>
</head>
<body>
  <!-- ğŸ”’ ë¡œë”© í™”ë©´ (ê¶Œí•œ í™•ì¸ ì¤‘) -->
  <div id="loadingScreen" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5;">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
      <div style="font-size: 18px; color: var(--text-secondary);">ê¶Œí•œ í™•ì¸ ì¤‘...</div>
    </div>
  </div>

  <!-- ë©”ì¸ í™”ë©´ (super_adminë§Œ ì ‘ê·¼ ê°€ëŠ¥) -->
  <div id="mainScreen" style="display: none;">
    <!-- í—¤ë” -->
    <div class="platform-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          í”Œë«í¼ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
        </h1>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; font-size: 14px;">
            <strong id="adminName">ìŠˆí¼ ì–´ë“œë¯¼</strong>
          </span>
          <button class="btn btn-secondary" onclick="logout()" style="background: rgba(255,255,255,0.9); color: #764ba2;">
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- ğŸ“Š í†µê³„ ì¹´ë“œ -->
      <div class="platform-stats">
        <div class="stat-card">
          <div class="stat-card-label">
            <svg class="stat-card-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
            </svg>
            ì´ ê°€ì… íšŒì‚¬ ìˆ˜
          </div>
          <div class="stat-card-value" id="totalCompanies">0</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-card-label">
            <svg class="stat-card-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            ì´ ì‚¬ìš©ì ìˆ˜
          </div>
          <div class="stat-card-value" id="totalUsers">0</div>
        </div>
      </div>

      <!-- ğŸ“‹ íšŒì‚¬ ëª©ë¡ í…Œì´ë¸” -->
      <div class="companies-table-container">
        <div class="companies-table-header">
          <h2>ğŸ“‹ ê°€ì… íšŒì‚¬ ëª©ë¡</h2>
          <button class="btn btn-primary" onclick="refreshCompanies()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>íšŒì‚¬ëª…</th>
                <th>ëŒ€í‘œì ì´ë©”ì¼</th>
                <th>ê°€ì…ì¼</th>
                <th>í”Œëœ</th>
                <th>ì§ì› í˜„í™©</th>
                <th>ìƒíƒœ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="companiesTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                  â³ íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAĞ²Ñ€Ğ¸1NcĞ¸Ñ‹R_xDĞ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸Ğ¸",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "755890751712",
      appId: "1:755890751712:web:a7d09a42e18a09bdb1fd32"
    };

    // Firebase ì´ˆê¸°í™”
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let currentUser = null;

    // ğŸ”’ í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ í™•ì¸
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        console.warn('âŒ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
        window.location.href = 'index.html';
        return;
      }

      try {
        // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
          console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
          alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          window.location.href = 'index.html';
          return;
        }

        const userData = userDoc.data();
        currentUser = {
          uid: user.uid,
          email: user.email,
          ...userData
        };

        // ğŸ”’ super_adminì´ ì•„ë‹ˆë©´ ì ‘ê·¼ ì°¨ë‹¨
        if (currentUser.role !== 'super_admin') {
          console.error('âŒ ê¶Œí•œ ì—†ìŒ (role: ' + currentUser.role + ') - index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
          alert('âš ï¸ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\ní”Œë«í¼ ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          window.location.href = 'index.html';
          return;
        }

        console.log('âœ… ìŠˆí¼ ì–´ë“œë¯¼ ì¸ì¦ ì„±ê³µ:', currentUser.email);
        
        // ë©”ì¸ í™”ë©´ í‘œì‹œ
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'block';
        
        // ê´€ë¦¬ì ì´ë¦„ í‘œì‹œ
        document.getElementById('adminName').textContent = currentUser.name || currentUser.email;
        
        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        await loadPlatformDashboard();
        
      } catch (error) {
        console.error('âŒ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
        alert('ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        window.location.href = 'index.html';
      }
    });

    /**
     * í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
     */
    async function loadPlatformDashboard() {
      console.log('ğŸ“Š í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹œì‘...');
      
      try {
        // ğŸ“Š í†µê³„ ì¹´ìš´íŠ¸
        const companiesSnapshot = await db.collection('companies').get();
        const usersSnapshot = await db.collection('users').get();
        
        document.getElementById('totalCompanies').textContent = companiesSnapshot.size;
        document.getElementById('totalUsers').textContent = usersSnapshot.size;
        
        console.log(`âœ… í†µê³„ ë¡œë“œ ì™„ë£Œ: ${companiesSnapshot.size}ê°œ íšŒì‚¬, ${usersSnapshot.size}ëª… ì‚¬ìš©ì`);
        
        // ğŸ“‹ íšŒì‚¬ ëª©ë¡ ë¡œë“œ
        await loadCompanies();
        
      } catch (error) {
        console.error('âŒ í”Œë«í¼ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * íšŒì‚¬ ëª©ë¡ ë¡œë“œ
     */
    async function loadCompanies() {
      const tbody = document.getElementById('companiesTableBody');
      
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px;">
            <div>â³ íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </td>
        </tr>
      `;
      
      try {
        console.log('ğŸ“‹ íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹œì‘...');
        
        const companiesSnapshot = await db.collection('companies')
          .orderBy('createdAt', 'desc')
          .get();
        
        if (companiesSnapshot.empty) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                ë“±ë¡ëœ íšŒì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.
              </td>
            </tr>
          `;
          return;
        }
        
        // ê° íšŒì‚¬ì˜ ì§ì› ìˆ˜ ì¹´ìš´íŠ¸ë¥¼ ìœ„í•œ Promise ë°°ì—´
        const companiesData = [];
        
        for (const doc of companiesSnapshot.docs) {
          const company = doc.data();
          const companyId = doc.id;
          
          // í•´ë‹¹ íšŒì‚¬ì˜ ì§ì› ìˆ˜ ì¹´ìš´íŠ¸ (staff, store_manager, managerë§Œ)
          const employeesSnapshot = await db.collection('users')
            .where('companyId', '==', companyId)
            .where('role', 'in', ['staff', 'store_manager', 'manager'])
            .where('status', 'in', ['active', 'pending', 'approved'])
            .get();
          
          companiesData.push({
            id: companyId,
            name: company.name || company.companyName || '(ì´ë¦„ ì—†ìŒ)',
            adminEmail: company.adminEmail || '(ì´ë©”ì¼ ì—†ìŒ)',
            createdAt: company.createdAt,
            subscription: company.subscription || {
              planType: 'free',
              status: 'active',
              maxUsers: 5
            },
            employeeCount: employeesSnapshot.size
          });
        }
        
        console.log(`âœ… ${companiesData.length}ê°œ íšŒì‚¬ ë¡œë“œ ì™„ë£Œ`);
        
        // í…Œì´ë¸” ë Œë”ë§
        tbody.innerHTML = companiesData.map(company => {
          const subscription = company.subscription;
          const planType = subscription.planType || 'free';
          const status = subscription.status || 'active';
          const maxUsers = subscription.maxUsers || 5;
          const currentUsers = company.employeeCount;
          
          // ê°€ì…ì¼ í¬ë§·íŒ…
          let createdAtStr = '-';
          if (company.createdAt) {
            try {
              const date = company.createdAt.toDate();
              createdAtStr = date.toLocaleDateString('ko-KR');
            } catch (e) {
              createdAtStr = '-';
            }
          }
          
          // í”Œëœ ë°°ì§€
          const planNames = {
            'free': 'Free',
            'basic': 'Basic',
            'pro': 'Pro',
            'enterprise': 'Enterprise'
          };
          const planName = planNames[planType] || planType;
          const planClass = `plan-${planType}`;
          
          // ìƒíƒœ ë°°ì§€
          const statusText = status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±';
          const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
          
          // ì§ì› í˜„í™© í”„ë¡œê·¸ë ˆìŠ¤ ë°”
          const usagePercent = maxUsers > 0 ? (currentUsers / maxUsers) * 100 : 0;
          let progressClass = 'progress-safe';
          if (usagePercent >= 100) {
            progressClass = 'progress-danger';
          } else if (usagePercent >= 80) {
            progressClass = 'progress-warning';
          }
          
          return `
            <tr>
              <td><strong>${company.name}</strong></td>
              <td>${company.adminEmail}</td>
              <td>${createdAtStr}</td>
              <td><span class="plan-badge ${planClass}">${planName}</span></td>
              <td>
                <div class="users-progress">
                  <span style="font-weight: 600; min-width: 60px;">${currentUsers} / ${maxUsers}ëª…</span>
                  <div class="users-progress-bar">
                    <div class="users-progress-fill ${progressClass}" style="width: ${Math.min(usagePercent, 100)}%;"></div>
                  </div>
                </div>
              </td>
              <td><span class="company-status-badge ${statusClass}">${statusText}</span></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="viewCompanyDetail('${company.id}')">
                  ìƒì„¸ë³´ê¸°
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('âŒ íšŒì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--danger);">
              âŒ íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            </td>
          </tr>
        `;
      }
    }

    /**
     * íšŒì‚¬ ìƒì„¸ë³´ê¸°
     */
    function viewCompanyDetail(companyId) {
      // TODO: íšŒì‚¬ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ë˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™
      alert(`íšŒì‚¬ ìƒì„¸ ì •ë³´ (ID: ${companyId})\n\nì´ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.`);
    }

    /**
     * íšŒì‚¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
     */
    async function refreshCompanies() {
      console.log('ğŸ”„ íšŒì‚¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨...');
      await loadPlatformDashboard();
    }

    /**
     * ë¡œê·¸ì•„ì›ƒ
     */
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        firebase.auth().signOut().then(() => {
          console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
          window.location.href = 'index.html';
        }).catch((error) => {
          console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
          alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }
    }
  </script>
</body>
</html>
