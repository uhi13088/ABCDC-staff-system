<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedules ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }
    .step {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      border-radius: 4px;
    }
    .step h3 {
      margin-top: 0;
      color: #007bff;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .danger {
      background: #dc3545;
    }
    .danger:hover {
      background: #c82333;
    }
    .success {
      background: #28a745;
    }
    .success:hover {
      background: #218838;
    }
    #log {
      background: #000;
      color: #0f0;
      padding: 20px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      margin-left: 10px;
    }
    .status.pending { background: #ffc107; color: #000; }
    .status.running { background: #17a2b8; color: #fff; }
    .status.success { background: #28a745; color: #fff; }
    .status.error { background: #dc3545; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Schedules ì»¬ë ‰ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬</h1>
    
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
      <strong>âš ï¸ ê²½ê³ :</strong> ì´ ì‘ì—…ì€ schedules ì»¬ë ‰ì…˜ êµ¬ì¡°ë¥¼ ì™„ì „íˆ ë³€ê²½í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ ë°±ì—… í›„ ì§„í–‰í•˜ì„¸ìš”!
    </div>

    <div class="step">
      <h3>1ë‹¨ê³„: í˜„ì¬ ë°ì´í„° ë°±ì—… <span id="status1" class="status pending">ëŒ€ê¸°ì¤‘</span></h3>
      <p>í˜„ì¬ schedules ì»¬ë ‰ì…˜ì„ schedules_backupì— ë³µì‚¬í•©ë‹ˆë‹¤.</p>
      <button onclick="backupData()" id="btn1">ë°±ì—… ì‹œì‘</button>
    </div>

    <div class="step">
      <h3>2ë‹¨ê³„: ë°ì´í„° ë³€í™˜ <span id="status2" class="status pending">ëŒ€ê¸°ì¤‘</span></h3>
      <p>ì£¼ì°¨ë³„ êµ¬ì¡°ë¥¼ ë‚ ì§œë³„ êµ¬ì¡°ë¡œ ë³€í™˜í•˜ì—¬ schedules_newì— ì €ì¥í•©ë‹ˆë‹¤.</p>
      <button onclick="migrateData()" id="btn2" disabled>ë³€í™˜ ì‹œì‘</button>
    </div>

    <div class="step">
      <h3>3ë‹¨ê³„: ë°ì´í„° ê²€ì¦ <span id="status3" class="status pending">ëŒ€ê¸°ì¤‘</span></h3>
      <p>ë³€í™˜ëœ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
      <button onclick="validateData()" id="btn3" disabled>ê²€ì¦ ì‹œì‘</button>
    </div>

    <div class="step">
      <h3>4ë‹¨ê³„: ì»¬ë ‰ì…˜ ì „í™˜ <span id="status4" class="status pending">ëŒ€ê¸°ì¤‘</span></h3>
      <p>schedules â†’ schedules_old, schedules_new â†’ schedules ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</p>
      <button onclick="switchCollections()" id="btn4" disabled class="danger">âš ï¸ ì „í™˜ ì‹¤í–‰</button>
    </div>

    <div class="step">
      <h3>ë¡¤ë°± (ë¬¸ì œ ë°œìƒ ì‹œ)</h3>
      <p>schedules_oldë¥¼ ë‹¤ì‹œ schedulesë¡œ ë³µì›í•©ë‹ˆë‹¤.</p>
      <button onclick="rollback()" class="danger">ğŸ”™ ë¡¤ë°± ì‹¤í–‰</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCXItvD5q_aN_k4Xav2HYOtyskNvv7_yGM",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "1032206299287",
      appId: "1:1032206299287:web:0de01ba98e33a1d024c0a5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ë¡œê·¸ í•¨ìˆ˜
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('ko-KR');
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
      logDiv.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setStatus(step, status) {
      const statusEl = document.getElementById(`status${step}`);
      statusEl.className = `status ${status}`;
      statusEl.textContent = {
        pending: 'ëŒ€ê¸°ì¤‘',
        running: 'ì‹¤í–‰ì¤‘',
        success: 'ì™„ë£Œ',
        error: 'ì˜¤ë¥˜'
      }[status];
    }

    // 1ë‹¨ê³„: ë°±ì—…
    async function backupData() {
      try {
        document.getElementById('btn1').disabled = true;
        setStatus(1, 'running');
        log('ë°±ì—… ì‹œì‘...', 'info');

        const snapshot = await db.collection('schedules').get();
        log(`ì´ ${snapshot.size}ê°œ ë¬¸ì„œ ë°œê²¬`, 'info');

        const batch = db.batch();
        let count = 0;

        for (const doc of snapshot.docs) {
          const backupRef = db.collection('schedules_backup').doc(doc.id);
          batch.set(backupRef, doc.data());
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            log(`${count}ê°œ ë°±ì—… ì™„ë£Œ...`, 'info');
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        log(`âœ… ë°±ì—… ì™„ë£Œ: ${count}ê°œ ë¬¸ì„œ`, 'success');
        setStatus(1, 'success');
        document.getElementById('btn2').disabled = false;

      } catch (error) {
        log(`ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
        setStatus(1, 'error');
        document.getElementById('btn1').disabled = false;
      }
    }

    // 2ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜
    async function migrateData() {
      try {
        document.getElementById('btn2').disabled = true;
        setStatus(2, 'running');
        log('ë°ì´í„° ë³€í™˜ ì‹œì‘...', 'info');

        const snapshot = await db.collection('schedules').get();
        log(`ì´ ${snapshot.size}ê°œ ì£¼ì°¨ ë¬¸ì„œ ì²˜ë¦¬`, 'info');

        const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
        let totalNewDocs = 0;
        let batchCount = 0;
        let batch = db.batch();

        for (const doc of snapshot.docs) {
          const data = doc.data();
          const docId = doc.id; // userId_year-weekNum í˜•ì‹
          
          // ë¬¸ì„œ IDì—ì„œ ì •ë³´ ì¶”ì¶œ
          const parts = docId.split('_');
          if (parts.length < 2) {
            log(`âš ï¸ ì˜ëª»ëœ ë¬¸ì„œ ID í˜•ì‹: ${docId}`, 'warning');
            continue;
          }

          const userId = parts[0];
          const weekInfo = parts[1]; // year-weekNum
          const [year, weekNum] = weekInfo.split('-').map(Number);

          // í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼ ë‚ ì§œ ê³„ì‚°
          const mondayDate = getMondayOfWeek(year, weekNum);

          // ê° ìš”ì¼ë³„ë¡œ ê°œë³„ ë¬¸ì„œ ìƒì„±
          days.forEach((day, index) => {
            const dayData = data[day];
            
            // ê·¼ë¬´ì¼ì¸ ê²½ìš°ë§Œ ë¬¸ì„œ ìƒì„±
            if (dayData && dayData.isWorkDay) {
              const workDate = new Date(mondayDate);
              workDate.setDate(workDate.getDate() + index);
              const dateStr = workDate.toISOString().split('T')[0]; // YYYY-MM-DD

              const newDoc = {
                userId: userId,
                userName: data.userName || '',
                store: data.store || '',
                date: dateStr,
                startTime: dayData.startTime || '',
                endTime: dayData.endTime || '',
                hours: dayData.hours || 0,
                isShiftReplacement: false,
                shiftRequestId: null,
                originalRequesterId: null,
                originalRequesterName: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                // ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ë³´
                migratedFrom: docId,
                migratedAt: firebase.firestore.FieldValue.serverTimestamp()
              };

              const newRef = db.collection('schedules_new').doc();
              batch.set(newRef, newDoc);
              totalNewDocs++;
              batchCount++;

              // 500ê°œë§ˆë‹¤ ì»¤ë°‹
              if (batchCount >= 500) {
                await batch.commit();
                log(`${totalNewDocs}ê°œ ë³€í™˜ ì™„ë£Œ...`, 'info');
                batch = db.batch();
                batchCount = 0;
              }
            }
          });
        }

        // ë‚¨ì€ ë°°ì¹˜ ì»¤ë°‹
        if (batchCount > 0) {
          await batch.commit();
        }

        log(`âœ… ë³€í™˜ ì™„ë£Œ: ${totalNewDocs}ê°œ ê·¼ë¬´ ë¬¸ì„œ ìƒì„±`, 'success');
        setStatus(2, 'success');
        document.getElementById('btn3').disabled = false;

      } catch (error) {
        log(`ë³€í™˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        setStatus(2, 'error');
        document.getElementById('btn2').disabled = false;
      }
    }

    // ISO 8601 ì£¼ì°¨ì˜ ì›”ìš”ì¼ ë‚ ì§œ ê³„ì‚°
    function getMondayOfWeek(year, week) {
      const jan4 = new Date(year, 0, 4);
      const jan4Day = jan4.getDay() || 7;
      const mondayOfWeek1 = new Date(jan4);
      mondayOfWeek1.setDate(jan4.getDate() - jan4Day + 1);
      const targetMonday = new Date(mondayOfWeek1);
      targetMonday.setDate(mondayOfWeek1.getDate() + (week - 1) * 7);
      return targetMonday;
    }

    // 3ë‹¨ê³„: ê²€ì¦
    async function validateData() {
      try {
        document.getElementById('btn3').disabled = true;
        setStatus(3, 'running');
        log('ë°ì´í„° ê²€ì¦ ì‹œì‘...', 'info');

        const oldSnapshot = await db.collection('schedules').get();
        const newSnapshot = await db.collection('schedules_new').get();

        log(`ì›ë³¸ ë¬¸ì„œ: ${oldSnapshot.size}ê°œ (ì£¼ì°¨)`, 'info');
        log(`ìƒˆ ë¬¸ì„œ: ${newSnapshot.size}ê°œ (ê·¼ë¬´)`, 'info');

        // ìƒ˜í”Œ ê²€ì¦: ì²« 3ëª…ì˜ ë°ì´í„° ë¹„êµ
        let sampleCount = 0;
        for (const oldDoc of oldSnapshot.docs) {
          if (sampleCount >= 3) break;

          const oldData = oldDoc.data();
          const userId = oldDoc.id.split('_')[0];

          // ìƒˆ ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ë¬¸ì„œ ì¡°íšŒ
          const userNewDocs = await db.collection('schedules_new')
            .where('migratedFrom', '==', oldDoc.id)
            .get();

          log(`ìƒ˜í”Œ ${sampleCount + 1}: ${oldData.userName || userId} - ${userNewDocs.size}ê°œ ê·¼ë¬´`, 'info');
          sampleCount++;
        }

        log(`âœ… ê²€ì¦ ì™„ë£Œ`, 'success');
        setStatus(3, 'success');
        document.getElementById('btn4').disabled = false;

      } catch (error) {
        log(`ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
        setStatus(3, 'error');
        document.getElementById('btn3').disabled = false;
      }
    }

    // 4ë‹¨ê³„: ì»¬ë ‰ì…˜ ì „í™˜
    async function switchCollections() {
      if (!confirm('âš ï¸ ê²½ê³ !\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nschedules ì»¬ë ‰ì…˜ì„ ì™„ì „íˆ êµì²´í•©ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      if (!confirm('ì •ë§ë¡œ í™•ì‹¤í•©ë‹ˆê¹Œ?\n\në§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤!')) {
        return;
      }

      try {
        document.getElementById('btn4').disabled = true;
        setStatus(4, 'running');
        log('ì»¬ë ‰ì…˜ ì „í™˜ ì‹œì‘...', 'info');

        // 1. schedules â†’ schedules_old
        log('1/3: schedules â†’ schedules_old ë³µì‚¬ ì¤‘...', 'info');
        const oldSnapshot = await db.collection('schedules').get();
        let batch = db.batch();
        let count = 0;

        for (const doc of oldSnapshot.docs) {
          const ref = db.collection('schedules_old').doc(doc.id);
          batch.set(ref, doc.data());
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            batch = db.batch();
            log(`${count}ê°œ ë³µì‚¬...`, 'info');
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        log('2/3: ì›ë³¸ schedules ì‚­ì œ ì¤‘...', 'info');
        batch = db.batch();
        count = 0;
        for (const doc of oldSnapshot.docs) {
          batch.delete(doc.ref);
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            batch = db.batch();
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        // 2. schedules_new â†’ schedules
        log('3/3: schedules_new â†’ schedules ë³µì‚¬ ì¤‘...', 'info');
        const newSnapshot = await db.collection('schedules_new').get();
        batch = db.batch();
        count = 0;

        for (const doc of newSnapshot.docs) {
          const ref = db.collection('schedules').doc(doc.id);
          batch.set(ref, doc.data());
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            batch = db.batch();
            log(`${count}ê°œ ë³µì‚¬...`, 'info');
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        log(`âœ… ì „í™˜ ì™„ë£Œ!`, 'success');
        log(`âœ… schedules_old: ë°±ì—…ìš© (${oldSnapshot.size}ê°œ)`, 'success');
        log(`âœ… schedules: ìƒˆ êµ¬ì¡° (${newSnapshot.size}ê°œ)`, 'success');
        setStatus(4, 'success');

        alert('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!\n\nì´ì œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤.');

      } catch (error) {
        log(`ì „í™˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        setStatus(4, 'error');
        document.getElementById('btn4').disabled = false;
      }
    }

    // ë¡¤ë°±
    async function rollback() {
      if (!confirm('âš ï¸ ë¡¤ë°± í™•ì¸\n\nschedules_oldë¥¼ schedulesë¡œ ë³µì›í•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        log('ë¡¤ë°± ì‹œì‘...', 'warning');

        // schedules ì‚­ì œ
        const currentSnapshot = await db.collection('schedules').get();
        let batch = db.batch();
        let count = 0;

        for (const doc of currentSnapshot.docs) {
          batch.delete(doc.ref);
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            batch = db.batch();
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        log('í˜„ì¬ schedules ì‚­ì œ ì™„ë£Œ', 'info');

        // schedules_old â†’ schedules ë³µì›
        const oldSnapshot = await db.collection('schedules_old').get();
        batch = db.batch();
        count = 0;

        for (const doc of oldSnapshot.docs) {
          const ref = db.collection('schedules').doc(doc.id);
          batch.set(ref, doc.data());
          count++;

          if (count % 500 === 0) {
            await batch.commit();
            batch = db.batch();
            log(`${count}ê°œ ë³µì›...`, 'info');
          }
        }

        if (count % 500 !== 0) {
          await batch.commit();
        }

        log(`âœ… ë¡¤ë°± ì™„ë£Œ: ${count}ê°œ ë¬¸ì„œ ë³µì›`, 'success');
        alert('âœ… ë¡¤ë°± ì™„ë£Œ!\n\nì´ì „ êµ¬ì¡°ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');

      } catch (error) {
        log(`ë¡¤ë°± ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // ì´ˆê¸° ë¡œê·¸
    log('ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ', 'success');
    log('âš ï¸ ë°˜ë“œì‹œ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”!', 'warning');
  </script>
</body>
</html>
