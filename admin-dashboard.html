<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>맛남살롱 관리자 페이지</title>
  
  <!-- 캐시 방지 메타 태그 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  
  <link rel="stylesheet" href="css/admin-dashboard.css">
  <style>
  </style>
</head>
<body>
  <div id="mainScreen">
    <div class="top-bar">
      <h1 style="font-size: 20px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 12px;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" style="color: var(--primary-color);"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>
        맛남살롱 근무관리
      </h1>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span class="admin-badge">관리자</span>
        <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="dashboard-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
          <div class="dashboard-card-label">총 직원 수</div>
          <div class="dashboard-card-value" id="totalEmployees">0</div>
          <div class="dashboard-card-sub">명</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="dashboard-card-label">오늘 출근</div>
          <div class="dashboard-card-value" id="todayAttendance">0</div>
          <div class="dashboard-card-sub">명</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg></div>
          <div class="dashboard-card-label">승인 대기</div>
          <div class="dashboard-card-value" id="pendingApprovals">0</div>
          <div class="dashboard-card-sub">건</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
          <div class="dashboard-card-label">미서명 계약서</div>
          <div class="dashboard-card-value" id="unsignedContracts">0</div>
          <div class="dashboard-card-sub">건</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">대시보드</button>
        <button class="tab" data-tab="admins" onclick="switchTab('admins')">관리자 목록</button>
        <button class="tab" data-tab="employees" onclick="switchTab('employees')">직원 관리</button>
        <button class="tab" data-tab="attendance" onclick="switchTab('attendance')">근무기록</button>
        <button class="tab" data-tab="salary" onclick="switchTab('salary')">급여 관리</button>
        <button class="tab" data-tab="approvals" onclick="switchTab('approvals')">승인 관리</button>
        <button class="tab" data-tab="contracts" onclick="switchTab('contracts')">계약서 관리</button>
        <button class="tab" data-tab="schedules" onclick="switchTab('schedules')">근무스케줄</button>
        <button class="tab" data-tab="notice" onclick="switchTab('notice')">공지사항</button>
        <button class="tab" data-tab="stores" onclick="switchTab('stores')">매장 관리</button>
        <button class="tab" data-tab="settings" onclick="switchTab('settings')">시스템 설정</button>
      </div>

      <div id="tabDashboard" class="tab-content active">
        <div class="card">
          <div class="card-header"><h3>📊 현황 요약</h3></div>
          <div class="card-body"><p style="color: var(--text-secondary);">관리자 페이지에 오신 것을 환영합니다.</p></div>
        </div>
      </div>

      <div id="tabAdmins" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>👑 관리자 목록</h3>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>이름</th>
                  <th>이메일</th>
                  <th>연락처</th>
                  <th>직책</th>
                  <th>상태</th>
                  <th>가입일</th>
                  <th>관리</th>
                  <th>상세</th>
                </tr>
              </thead>
              <tbody id="adminsTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <p style="margin-bottom: 16px;">관리자 정보를 불러오는 중...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabEmployees" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>👥 직원 목록</h3>
            <button class="btn" style="background: var(--success-color); color: white;" onclick="syncAllEmployeesWithContracts()">
              🔄 전체 동기화
            </button>
          </div>
          <div class="card-body">
            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
              <p style="margin: 0; font-size: 13px; color: #1565c0;">
                💡 <strong>전체 동기화</strong>: 모든 직원의 정보를 최신 계약서 기준으로 업데이트하고, 스케줄을 자동 생성합니다.
              </p>
            </div>
            <div class="filters">
              <div class="filter-group">
                <label>매장</label>
                <select id="employeeStoreFilter">
                  <option value="">전체</option>
                  <!-- 매장 목록은 loadStoresForFilter()에서 동적으로 로드됨 -->
                </select>
              </div>
              <div class="filter-group">
                <label>승인 상태</label>
                <select id="employeeStatusFilter">
                  <option value="">전체</option>
                  <option value="pending">승인 대기</option>
                  <option value="approved">승인됨</option>
                  <option value="rejected">거부됨</option>
                </select>
              </div>
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadEmployees()">조회</button>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>이름</th>
                  <th>매장</th>
                  <th>직급</th>
                  <th>연락처</th>
                  <th>상태</th>
                  <th>관리</th>
                  <th>상세</th>
                </tr>
              </thead>
              <tbody id="employeeTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <p style="margin-bottom: 16px;">직원 정보를 불러오는 중...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabAttendance" class="tab-content">
        <div class="card">
          <div class="card-header"><h3>📋 근무기록</h3></div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label>조회 월</label>
                <input type="month" id="attendanceMonth">
              </div>
              <div class="filter-group">
                <label>매장</label>
                <select id="attendanceStoreFilter">
                  <option value="">전체</option>
                  <!-- 매장 목록은 loadStoresForAttendanceFilter()에서 동적으로 로드됩니다 -->
                </select>
              </div>
              <div class="filter-group">
                <label>근무상태</label>
                <select id="attendanceEmploymentStatusFilter">
                  <option value="">전체</option>
                  <option value="active" selected>재직자</option>
                  <option value="resigned">퇴사자</option>
                </select>
              </div>
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadAttendanceList()">조회</button>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>날짜</th>
                  <th>이름</th>
                  <th>매장</th>
                  <th>출근</th>
                  <th>퇴근</th>
                  <th>상태</th>
                  <th>상세</th>
                </tr>
              </thead>
              <tbody id="attendanceTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-secondary);">근무기록이 없습니다.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabSalary" class="tab-content">
        <div class="card">
          <div class="card-header"><h3>💰 급여 내역</h3></div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label>조회 월</label>
                <input type="month" id="salaryMonth">
              </div>
              <div class="filter-group">
                <label>근무상태</label>
                <select id="salaryEmploymentStatusFilter">
                  <option value="">전체</option>
                  <option value="active" selected>재직자</option>
                  <option value="resigned">퇴사자</option>
                </select>
              </div>
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadSalaryList()">조회</button>
              </div>
            </div>
            

            <table>
              <thead>
                <tr>
                  <th>이름</th>
                  <th>매장</th>
                  <th>기본급</th>
                  <th>추가수당</th>
                  <th>공제</th>
                  <th>실지급액</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="salaryTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; color: var(--text-secondary);">급여 정보가 없습니다.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabApprovals" class="tab-content">
        <!-- 승인 대기 목록 (구매/폐기/퇴직서) -->
        <div class="card">
          <div class="card-header">
            <h3>✔️ 승인 대기 목록</h3>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label>승인 유형</label>
                <select id="approvalTypeFilter">
                  <option value="">전체</option>
                  <option value="purchase">💳 구매</option>
                  <option value="disposal">🗑️ 폐기</option>
                  <option value="resignation">📄 퇴직서</option>
                  <option value="shift">🔄 교대근무</option>
                </select>
              </div>
              <div class="filter-group">
                <label>상태</label>
                <select id="approvalStatusFilter">
                  <option value="">전체</option>
                  <option value="pending">대기중</option>
                  <option value="approved">승인됨</option>
                  <option value="rejected">거부됨</option>
                </select>
              </div>
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadApprovals()">조회</button>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>신청자</th>
                  <th>유형</th>
                  <th>제목/내용</th>
                  <th>신청일</th>
                  <th>상태</th>
                  <th>처리</th>
                </tr>
              </thead>
              <tbody id="approvalsTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; color: var(--text-secondary);">승인 대기 목록을 불러오는 중...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabContracts" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>📝 계약서 목록</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" onclick="openContractPage()">+ 새 계약서 작성</button>
              <button class="btn btn-secondary" onclick="openAdditionalContractPage()" style="background: var(--primary-color); color: white;">➕ 추가 계약서 작성</button>
            </div>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label>매장</label>
                <select id="contractStoreFilter">
                  <option value="">전체</option>
                  <option value="부천시청점">부천시청점</option>
                  <option value="상동점">상동점</option>
                  <option value="부천역사점">부천역사점</option>
                </select>
              </div>
              <div class="filter-group">
                <label>근무상태</label>
                <select id="contractEmploymentStatusFilter">
                  <option value="">전체</option>
                  <option value="active" selected>재직자</option>
                  <option value="resigned">퇴사자</option>
                </select>
              </div>
              <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadContracts()">조회</button>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>직원명</th>
                  <th>계약 유형</th>
                  <th>매장</th>
                  <th>계약 기간</th>
                  <th>작성일</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="contractsTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; color: var(--text-secondary);">계약서 정보를 불러오는 중...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabNotice" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>📢 공지사항 관리</h3>
            <button class="btn btn-primary" onclick="showAddNoticeModal()">+ 공지사항 작성</button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>제목</th>
                  <th>작성일</th>
                  <th>중요</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="noticeTableBody">
                <tr>
                  <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <p style="margin-bottom: 16px;">등록된 공지사항이 없습니다.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 근무스케줄 탭 -->
      <div id="tabSchedules" class="tab-content">
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin: 0;">📅 근무스케줄</h3>
          </div>
          
          <div class="card-body">
            <!-- 상단 컨트롤 -->
            <div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                <!-- 매장 선택 -->
                <div>
                  <label style="display: block; margin-bottom: 4px; font-weight: 600;">매장 선택</label>
                  <select id="scheduleStoreSelect" onchange="loadSchedules()" style="width: 100%;">
                    <option value="">선택하세요</option>
                  </select>
                </div>
                
                <!-- 표시 모드 -->
                <div>
                  <label style="display: block; margin-bottom: 4px; font-weight: 600;">표시 모드</label>
                  <div style="display: flex; gap: 10px; align-items: center; height: 38px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                      <input type="radio" name="scheduleDisplayMode" value="schedule" checked onchange="loadSchedules()">
                      <span>스케줄표</span>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                      <input type="radio" name="scheduleDisplayMode" value="attendance" onchange="loadSchedules()">
                      <span>출퇴근 기록</span>
                    </label>
                  </div>
                </div>
                
                <!-- 뷰 타입 -->
                <div>
                  <label style="display: block; margin-bottom: 4px; font-weight: 600;">뷰 타입</label>
                  <div style="display: flex; gap: 10px; align-items: center; height: 38px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                      <input type="radio" name="scheduleViewType" value="card" checked onchange="renderScheduleView()">
                      <span>카드형</span>
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 4px;">
                      <input type="radio" name="scheduleViewType" value="gantt" onchange="renderScheduleView()">
                      <span>간트차트형</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- 주차 네비게이션 -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                <button class="btn" onclick="changeWeek(-1)" style="background: #6c757d; color: white;">◀ 이전 주</button>
                <div style="font-weight: 600; font-size: 16px;" id="scheduleWeekDisplay">2025년 1월 1주차 (1/6 ~ 1/12)</div>
                <button class="btn" onclick="changeWeek(1)" style="background: #6c757d; color: white;">다음 주 ▶</button>
              </div>
              
              <!-- 액션 버튼 -->
              <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="showScheduleSimulator()">📋 스케줄 시뮬레이터</button>
                <button class="btn" onclick="exportSchedulePDF()" style="background: #28a745; color: white;">📄 PDF 저장</button>
              </div>
            </div>
            
            <!-- 스케줄 뷰 컨테이너 -->
            <div id="scheduleViewContainer">
              <p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                매장을 선택하면 근무 스케줄이 표시됩니다.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div id="tabStores" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>🏪 매장 관리</h3>
            <button class="btn btn-primary" onclick="showAddStoreModal()">+ 매장 추가</button>
          </div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>매장명</th>
                  <th>주소</th>
                  <th>연락처</th>
                  <th>대표자</th>
                  <th>사업자번호</th>
                  <th>급여지급일</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="storesTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <p style="margin-bottom: 16px;">로딩 중...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabSettings" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h3>⚙️ 시스템 설정</h3>
          </div>
          <div class="card-body">
            <h4 style="margin-bottom: var(--spacing-md);">🔧 데이터 마이그레이션</h4>
            
            <div style="background: var(--warning-bg); border: 1px solid var(--warning-border); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
              <p style="margin: 0 0 8px 0; font-weight: 600; color: var(--warning-text);">⚠️ 계약서 employeeId 수정</p>
              <p style="margin: 0 0 16px 0; font-size: 14px; color: var(--text-secondary);">
                employeeId가 없는 계약서를 자동으로 찾아서 수정합니다.<br>
                employeeName + employeeBirth로 직원을 찾아 employeeId를 채워줍니다.
              </p>
              <button class="btn btn-warning" onclick="migrateContractEmployeeIds()" style="background: var(--warning); color: white;">
                🔄 계약서 employeeId 자동 수정
              </button>
              <div id="migrationLog" style="margin-top: var(--spacing-md); font-family: monospace; font-size: 13px; background: var(--bg-secondary); padding: var(--spacing-sm); border-radius: var(--radius-sm); max-height: 300px; overflow-y: auto; display: none;">
              </div>
            </div>
            
            <p style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
              다른 시스템 설정 기능은 준비 중입니다.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 매장 추가/수정 모달 -->
  <div id="storeModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="storeModalTitle" style="margin: 0;">🏪 매장 추가</h2>
        <button class="modal-close" onclick="closeStoreModal()">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editStoreId">
        <div class="form-group">
          <label for="storeName">매장명 *</label>
          <input type="text" id="storeName" placeholder="부천시청점" required>
        </div>
        <div class="form-group">
          <label for="storeAddress">주소</label>
          <input type="text" id="storeAddress" placeholder="경기도 부천시...">
        </div>
        <div class="form-group">
          <label for="storePhone">연락처</label>
          <input type="tel" id="storePhone" placeholder="032-123-4567">
        </div>
        <div class="form-group">
          <label for="storeCEO">대표자명</label>
          <input type="text" id="storeCEO" placeholder="홍길동">
        </div>
        <div class="form-group">
          <label for="storeBusinessNumber">사업자등록번호</label>
          <input type="text" id="storeBusinessNumber" placeholder="123-45-67890">
        </div>
        
        <!-- 급여 지급일 설정 -->
        <div class="form-group" style="border-top: 2px solid var(--border-color); padding-top: var(--spacing-md); margin-top: var(--spacing-md);">
          <label style="font-weight: 700; font-size: 15px; margin-bottom: var(--spacing-sm);">📅 급여 지급일 및 계산 기간</label>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
            매장의 급여 지급일과 계산 기간을 설정하세요. 계약서와 급여 계산에 자동으로 반영됩니다.
          </p>
          
          <!-- 지급일 -->
          <div style="margin-bottom: var(--spacing-md);">
            <label for="storeSalaryPaymentDay">매월 지급일 *</label>
            <select id="storeSalaryPaymentDay" required style="width: 100%;">
              <option value="">선택</option>
              <option value="5">5일</option>
              <option value="10">10일</option>
              <option value="15">15일</option>
              <option value="20">20일</option>
              <option value="25">25일</option>
              <option value="28">말일 (28일)</option>
            </select>
          </div>
          
          <!-- 계산 기간 타입 -->
          <div style="margin-bottom: var(--spacing-md);">
            <label for="salaryCalculationType">계산 기간 타입 *</label>
            <select id="salaryCalculationType" required style="width: 100%;" onchange="toggleCustomCalculationPeriod()">
              <option value="">선택</option>
              <option value="prev_month_full" selected>전월 전체 (전월 1일~말일)</option>
              <option value="current_month_full">당월 전체 (당월 1일~말일)</option>
              <option value="custom">사용자 지정</option>
            </select>
          </div>
          
          <!-- 사용자 지정 계산 기간 -->
          <div id="customCalculationPeriod" style="display: none; background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
              <strong>💡 계산 기간 설정 방법:</strong><br>
              • <strong>전월 기준</strong>: 시작일 "전월", 종료일 "전월"<br>
              • <strong>당월 기준</strong>: 시작일 "당월", 종료일 "당월"<br>
              • <strong>전월~당월</strong>: 시작일 "전월", 종료일 "당월"
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div>
                <label for="calculationStartMonth">계산 시작 기준</label>
                <select id="calculationStartMonth" style="width: 100%; margin-bottom: 8px;">
                  <option value="prev">전월</option>
                  <option value="current">당월</option>
                </select>
                <label for="calculationStartDay">시작일</label>
                <select id="calculationStartDay" style="width: 100%;">
                  <option value="1">1일</option>
                  <option value="2">2일</option>
                  <option value="3">3일</option>
                  <option value="4">4일</option>
                  <option value="5">5일</option>
                  <option value="6">6일</option>
                  <option value="7">7일</option>
                  <option value="8">8일</option>
                  <option value="9">9일</option>
                  <option value="10">10일</option>
                  <option value="11">11일</option>
                  <option value="12">12일</option>
                  <option value="13">13일</option>
                  <option value="14">14일</option>
                  <option value="15">15일</option>
                  <option value="16">16일</option>
                  <option value="17">17일</option>
                  <option value="18">18일</option>
                  <option value="19">19일</option>
                  <option value="20">20일</option>
                  <option value="21">21일</option>
                  <option value="22">22일</option>
                  <option value="23">23일</option>
                  <option value="24">24일</option>
                  <option value="25">25일</option>
                  <option value="26">26일</option>
                  <option value="27">27일</option>
                  <option value="28">28일</option>
                </select>
              </div>
              
              <div>
                <label for="calculationEndMonth">계산 종료 기준</label>
                <select id="calculationEndMonth" style="width: 100%; margin-bottom: 8px;">
                  <option value="prev">전월</option>
                  <option value="current">당월</option>
                </select>
                <label for="calculationEndDay">종료일</label>
                <select id="calculationEndDay" style="width: 100%;">
                  <option value="1">1일</option>
                  <option value="2">2일</option>
                  <option value="3">3일</option>
                  <option value="4">4일</option>
                  <option value="5">5일</option>
                  <option value="6">6일</option>
                  <option value="7">7일</option>
                  <option value="8">8일</option>
                  <option value="9">9일</option>
                  <option value="10">10일</option>
                  <option value="11">11일</option>
                  <option value="12">12일</option>
                  <option value="13">13일</option>
                  <option value="14">14일</option>
                  <option value="15">15일</option>
                  <option value="16">16일</option>
                  <option value="17">17일</option>
                  <option value="18">18일</option>
                  <option value="19">19일</option>
                  <option value="20">20일</option>
                  <option value="21">21일</option>
                  <option value="22">22일</option>
                  <option value="23">23일</option>
                  <option value="24">24일</option>
                  <option value="25">25일</option>
                  <option value="26">26일</option>
                  <option value="27">27일</option>
                  <option value="28">28일</option>
                  <option value="last">말일</option>
                </select>
              </div>
            </div>
            
            <!-- 미리보기 -->
            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: white; border-radius: var(--border-radius); border: 1px solid var(--border-color);">
              <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">
                <strong>📋 계산 기간 미리보기:</strong><br>
                <span id="calculationPeriodPreview" style="color: var(--primary-color); font-weight: 600;">전월 1일 ~ 전월 말일</span>
              </p>
            </div>
          </div>
          
          <!-- 안내 메시지 -->
          <div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--border-radius);">
            <p style="font-size: 13px; margin: 0; color: var(--text-secondary);">
              <strong>💡 계산 기간 타입 설명:</strong><br>
              • <strong>전월 전체</strong>: 전월 1일~말일 고정<br>
              • <strong>당월 전체</strong>: 당월 1일~말일 고정<br>
              • <strong>사용자 지정</strong>: 원하는 기간 직접 설정
            </p>
          </div>
        </div>
        
        <!-- 수당 적용 옵션 -->
        <div class="form-group" style="border-top: 2px solid var(--border-color); padding-top: var(--spacing-md); margin-top: var(--spacing-md);">
          <label style="font-weight: 700; font-size: 15px; margin-bottom: var(--spacing-sm);">💰 수당 적용 옵션</label>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
            이 매장에서 적용할 수당 항목을 선택하세요. 계약서 작성 시 자동으로 반영됩니다.
          </p>
          
          <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
            <label style="display: flex; align-items: center; cursor: pointer; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius);">
              <input type="checkbox" id="storeOvertimeAllowance" style="width: auto; margin-right: 8px; cursor: pointer;">
              <span style="font-size: 14px;">연장근로수당 (시급 × 1.5배)</span>
            </label>
            
            <label style="display: flex; align-items: center; cursor: pointer; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius);">
              <input type="checkbox" id="storeNightAllowance" style="width: auto; margin-right: 8px; cursor: pointer;">
              <span style="font-size: 14px;">야간근로수당 (22:00~06:00, 시급 × 0.5배)</span>
            </label>
            
            <label style="display: flex; align-items: center; cursor: pointer; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius);">
              <input type="checkbox" id="storeHolidayAllowance" style="width: auto; margin-right: 8px; cursor: pointer;">
              <span style="font-size: 14px;">휴일근로수당 (시급 × 1.5배)</span>
            </label>
          </div>
        </div>
        
        <!-- 매장 운영시간 설정 -->
        <div class="form-group" style="border-top: 2px solid var(--border-color); padding-top: var(--spacing-md); margin-top: var(--spacing-md);">
          <label style="font-weight: 700; font-size: 15px; margin-bottom: var(--spacing-sm);">🕐 매장 운영시간</label>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
            매장의 영업 시작/종료 시간을 설정하세요. 근무 스케줄표는 이 시간 기준으로 앞뒤 3시간씩 표시됩니다.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
            <div>
              <label for="storeOpenTime">오픈 시간</label>
              <input type="time" id="storeOpenTime" value="09:00" required style="width: 100%;">
            </div>
            
            <div>
              <label for="storeCloseTime">마감 시간</label>
              <input type="time" id="storeCloseTime" value="22:00" required style="width: 100%;">
            </div>
          </div>
          
          <div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--border-radius); margin-top: var(--spacing-md);">
            <p style="font-size: 13px; margin: 0; color: var(--text-secondary);">
              <strong>💡 예시:</strong><br>
              • 오픈 09:00, 마감 22:00 → 스케줄표는 06:00~01:00 표시<br>
              • 이 시간은 근무 스케줄 타임테이블의 기준이 됩니다.
            </p>
          </div>
        </div>
        
        <!-- 출퇴근 허용시간 설정 -->
        <div class="form-group" style="border-top: 2px solid var(--border-color); padding-top: var(--spacing-md); margin-top: var(--spacing-md);">
          <label style="font-weight: 700; font-size: 15px; margin-bottom: var(--spacing-sm);">⏰ 출퇴근 허용시간 설정</label>
          <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
            근무시간 전후의 출퇴근 허용범위를 설정하세요. 이 설정에 따라 수당 적용 여부가 결정됩니다.
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md);">
            <div>
              <label for="earlyClockInThreshold">조기출근 허용시간 (분)</label>
              <input type="number" id="earlyClockInThreshold" min="0" max="60" value="15" style="width: 100%;">
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                이 시간 이상 일찍 출근해야 수당 적용
              </p>
            </div>
            
            <div>
              <label for="earlyClockOutThreshold">조기퇴근 허용시간 (분)</label>
              <input type="number" id="earlyClockOutThreshold" min="0" max="60" value="5" style="width: 100%;">
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                이 시간 이내 조기퇴근은 수당 미적용
              </p>
            </div>
            
            <div>
              <label for="overtimeThreshold">초과근무 최소시간 (분)</label>
              <input type="number" id="overtimeThreshold" min="0" max="60" value="5" style="width: 100%;">
              <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                이 시간 이상 늦게 퇴근해야 수당 적용
              </p>
            </div>
          </div>
          
          <div style="background: var(--bg-light); padding: var(--spacing-md); border-radius: var(--border-radius); margin-top: var(--spacing-md);">
            <p style="font-size: 13px; margin: 0; color: var(--text-secondary);">
              <strong>💡 예시 (기본값 기준):</strong><br>
              • <strong>조기출근</strong>: 09:00 근무 시작 → 08:44 이전 출근 시 수당 적용<br>
              • <strong>조기퇴근</strong>: 18:00 퇴근 → 17:55~18:00 퇴근 시 수당 미적용 (17:54 이전은 차감)<br>
              • <strong>초과근무</strong>: 18:00 퇴근 → 18:05 이후 퇴근 시 수당 적용
            </p>
          </div>
        </div>
        
        <div class="form-group">
          <label>대표 서명 이미지</label>
          <div style="margin-bottom: 10px;">
            <input type="file" id="storeCeoSignatureInput" accept="image/*" onchange="previewStoreSignature(event)" style="display: none;">
            <button type="button" class="btn" style="background: #6c757d; color: white; width: 100%;" onclick="document.getElementById('storeCeoSignatureInput').click()">
              📸 대표 서명 업로드
            </button>
          </div>
          <div id="storeCeoSignaturePreview" style="border: 2px dashed #ddd; padding: 20px; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <span style="color: #999;">서명 이미지 선택 (선택사항)</span>
          </div>
          <small style="color: #666; display: block; margin-top: 8px;">
            💡 매장별 대표자가 다를 경우 각각 서명을 등록할 수 있습니다.
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeStoreModal()">취소</button>
        <button class="btn btn-primary" onclick="saveStore()">저장</button>
        <button id="deleteStoreBtn" class="btn btn-danger" onclick="deleteStore()" style="display: none; margin-right: auto;">삭제</button>
      </div>
    </div>
  </div>

  <!-- 공지사항 작성/수정 모달 -->
  <div id="noticeModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 id="noticeModalTitle" style="margin: 0;">📢 공지사항 작성</h2>
        <button class="modal-close" onclick="closeNoticeModal()">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editNoticeId">
        <div class="form-group">
          <label for="noticeTitle">제목 *</label>
          <input type="text" id="noticeTitle" placeholder="공지사항 제목을 입력하세요" required>
        </div>
        <div class="form-group">
          <label for="noticeContent">내용 *</label>
          <textarea id="noticeContent" placeholder="공지사항 내용을 입력하세요" required style="width: 100%; min-height: 300px; resize: vertical; box-sizing: border-box;"></textarea>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="noticeImportant" style="width: auto; margin-right: 8px; cursor: pointer;">
            <span style="font-size: 14px;">⭐ 중요 공지사항으로 표시</span>
          </label>
          <small style="color: #666; display: block; margin-top: 8px;">
            중요 공지사항은 직원 페이지 상단에 고정 표시됩니다.
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNoticeModal()">취소</button>
        <button class="btn btn-primary" onclick="saveNotice()">저장</button>
        <button id="deleteNoticeBtn" class="btn btn-danger" onclick="deleteNotice()" style="display: none; margin-right: auto;">삭제</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Salary Calculator (before main script) -->
  <script src="js/salary-calculator.js"></script>

  <script>
    // ===========================================
    // MAIN ADMIN DASHBOARD SCRIPT
    // Firebase 인증 및 전체 관리자 기능
    // ===========================================

    // 🔥 추가 계약서 작성 모드 전역 변수
    let isAdditionalContractMode = false;

    async function showMainScreen() {
      document.getElementById('mainScreen').classList.remove('hidden');
      
      // 역할 체크 및 UI 제한
      const userRole = sessionStorage.getItem('admin_role');
      if (userRole === 'manager') {
        applyManagerRestrictions();
      }
      
      // signedContracts 캐시 로드
      await loadSignedContractsCache();
      // localStorage contracts 자동 마이그레이션
      await migrateLocalStorageContracts();
      loadDashboard();
      switchTab('employees');
    }
    
    // 매니저 권한 제한 적용
    function applyManagerRestrictions() {
      console.log('🔒 매니저 권한 제한 적용 중...');
      
      // 관리자 배지 변경
      const adminBadge = document.querySelector('.admin-badge');
      if (adminBadge) {
        adminBadge.textContent = '매니저 (읽기 전용)';
        adminBadge.style.background = 'var(--text-secondary)';
      }
      
      // 모든 쓰기 버튼 숨기기 (공통 클래스 사용)
      const writeButtons = [
        // 직원 관리 - 삭제 버튼 숨기기는 동적으로 생성되므로 loadEmployees에서 처리
        
        // 계약서 관리 - 새 계약서 작성 버튼
        'document.querySelector("#tabContracts .btn-primary")',
        
        // 공지사항 - 작성 버튼
        'document.querySelector("#tabNotice .btn-primary")',
        
        // 매장 관리 - 추가 버튼
        'document.querySelector("#tabStores .btn-primary")'
      ];
      
      writeButtons.forEach(selector => {
        try {
          const btn = eval(selector);
          if (btn) {
            btn.style.display = 'none';
          }
        } catch (e) {
          // 버튼이 없으면 무시
        }
      });
      
      // 승인 관리 탭의 승인/거부 버튼은 동적으로 생성되므로 loadApprovals에서 처리
      
      console.log('✅ 매니저 권한 제한 적용 완료');
    }
    
    // signedContracts Firestore 캐시 로드
    async function loadSignedContractsCache() {
      try {
        const snapshot = await firebase.firestore().collection('signedContracts').get();
        signedContractsCache = [];
        snapshot.forEach(doc => {
          signedContractsCache.push({ id: doc.id, ...doc.data() });
        });
        console.log(`✅ ${signedContractsCache.length}개 서명된 계약서 캐시 로드 완료`);
      } catch (error) {
        console.error('❌ signedContracts 로드 실패:', error);
        signedContractsCache = [];
      }
    }

    // localStorage contracts를 Firestore로 자동 마이그레이션
    async function migrateLocalStorageContracts() {
      console.log('🔄 localStorage contracts 마이그레이션 시작...');
      
      try {
        let migratedCount = 0;
        let skippedCount = 0;
        let errorCount = 0;
        
        // localStorage에서 모든 contract 키 찾기
        const contractKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('contract_C')) {
            contractKeys.push(key);
          }
        }
        
        if (contractKeys.length === 0) {
          console.log('✅ localStorage에 마이그레이션할 계약서가 없습니다.');
          return;
        }
        
        console.log(`📊 총 ${contractKeys.length}개의 localStorage 계약서 발견`);
        
        // 각 계약서 마이그레이션
        for (const key of contractKeys) {
          try {
            const contractId = key.replace('contract_', '');
            
            // Firestore에 이미 존재하는지 확인
            const docRef = firebase.firestore().collection('contracts').doc(contractId);
            const docSnap = await docRef.get();
            
            if (docSnap.exists) {
              console.log(`⏭️  건너뛰기: ${contractId} (이미 Firestore에 존재)`);
              skippedCount++;
              continue;
            }
            
            // localStorage에서 데이터 가져오기
            const contractData = JSON.parse(localStorage.getItem(key));
            
            // Firestore에 저장
            await docRef.set({
              ...contractData,
              migratedFrom: 'localStorage',
              migratedAt: new Date().toISOString()
            });
            
            console.log(`✅ 마이그레이션 완료: ${contractId} (${contractData.employeeName})`);
            migratedCount++;
            
            // localStorage에서 삭제
            localStorage.removeItem(key);
            console.log(`🗑️  localStorage에서 삭제: ${key}`);
            
          } catch (error) {
            console.error(`❌ 마이그레이션 실패: ${key}`, error);
            errorCount++;
          }
        }
        
        // 결과 요약
        console.log('');
        console.log('='.repeat(50));
        console.log('📊 마이그레이션 완료 요약');
        console.log('='.repeat(50));
        console.log(`✅ 성공: ${migratedCount}개`);
        console.log(`⏭️  건너뛰기: ${skippedCount}개 (이미 Firestore에 존재)`);
        console.log(`❌ 실패: ${errorCount}개`);
        console.log('='.repeat(50));
        
        if (migratedCount > 0) {
          alert(`✅ localStorage 계약서 마이그레이션 완료!\n\n성공: ${migratedCount}개\n건너뛰기: ${skippedCount}개\n실패: ${errorCount}개`);
        }
        
      } catch (error) {
        console.error('❌ 마이그레이션 중 오류 발생:', error);
      }
    }

    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (selectedTab) selectedTab.classList.add('active');
      const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);
      const tabId = `tab${capitalize(tabName)}`;
      const selectedContent = document.getElementById(tabId);
      if (selectedContent) {
        selectedContent.classList.add('active');
        selectedContent.style.display = 'block';
      }
      switch(tabName) {
        case 'dashboard': loadDashboard(); break;
        case 'admins': loadAdmins(); break;
        case 'employees': 
          loadStoresForFilter('employeeStoreFilter'); 
          loadEmployees(); 
          break;
        case 'attendance': 
          loadStoresForAttendanceFilter(); 
          loadAttendanceList(); 
          break;
        case 'salary': loadSalaryList(); break;
        case 'approvals': loadApprovals(); break;
        case 'contracts': loadContracts(); break;
        case 'schedules': 
          loadStoresForScheduleFilter(); 
          break;
        case 'notice': loadNotice(); break;
        case 'stores': loadStores(); break;
      }
    }

    async function loadDashboard() {
      let totalEmployees = 0; // 기본값 0 (Firebase에서 실제 수를 가져옴)
      let totalContracts = 0;
      let unsignedContracts = 0;
      
      // Firestore users 컬렉션에서 재직 직원 수 가져오기 (resigned 제외)
      try {
        const snapshot = await db.collection('users')
          .where('userType', '==', 'employee')
          .get();
        
        // resigned 상태 제외하고 카운트
        let activeCount = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.status !== 'resigned') {
            activeCount++;
          }
        });
        
        totalEmployees = activeCount;
        console.log(`📊 대시보드: 총 ${totalEmployees}명의 재직 직원 확인 (전체 ${snapshot.size}명 중 resigned 제외)`);
      } catch (error) {
        console.warn('⚠️ Firestore 직원 수 조회 실패:', error);
        totalEmployees = 0;
      }
      
      // Firestore에서 계약서 수 카운트
      try {
        const contractsSnapshot = await firebase.firestore().collection('contracts').get();
        const employeeMap = new Map();
        const unsignedEmployeeMap = new Map(); // 미서명 계약서 직원별 카운트
        
        contractsSnapshot.forEach(doc => {
          const contractData = doc.data();
          const contractId = doc.id;
          const signedContracts = signedContractsCache;
          const isSigned = signedContracts.some(sc => sc.id === contractId);
          
          const empKey = contractData.employeeName + '_' + contractData.employeeBirth;
          if (!employeeMap.has(empKey)) {
            employeeMap.set(empKey, true);
            totalContracts++;
          }
          
          // 🔥 미서명 계약서는 직원별로 1개만 카운트
          if (!isSigned) {
            if (!unsignedEmployeeMap.has(empKey)) {
              unsignedEmployeeMap.set(empKey, true);
              unsignedContracts++;
            }
          }
        });
        
        console.log(`📊 대시보드: 총 ${totalContracts}개 계약서, 미서명 ${unsignedContracts}개 (직원별 중복 제거)`);
      } catch (error) {
        console.warn('⚠️ Firestore 계약서 수 조회 실패:', error);
      }
      
      // 오늘 출근 직원 수 계산
      let todayAttendanceCount = 0;
      try {
        const today = new Date().toISOString().split('T')[0];
        const attendanceSnapshot = await db.collection('attendance')
          .where('date', '==', today)
          .get();
        todayAttendanceCount = attendanceSnapshot.size;
        console.log(`📈 오늘 출근: ${todayAttendanceCount}명`);
      } catch (error) {
        console.warn('⚠️ 출근 수 조회 실패:', error);
      }
      
      // 대기중 승인 수 계산
      let pendingApprovalsCount = 0;
      try {
        const approvalsSnapshot = await db.collection('approvals')
          .where('status', '==', 'pending')
          .get();
        pendingApprovalsCount = approvalsSnapshot.size;
        console.log(`📈 대기중 승인: ${pendingApprovalsCount}건`);
      } catch (error) {
        console.warn('⚠️ 승인 수 조회 실패:', error);
      }
      
      document.getElementById('totalEmployees').textContent = totalEmployees;
      document.getElementById('todayAttendance').textContent = todayAttendanceCount;
      document.getElementById('pendingApprovals').textContent = pendingApprovalsCount;
      document.getElementById('unsignedContracts').textContent = unsignedContracts;
    }

    function updateDashboardCard(id, value, subtitle) {
      const valueElement = document.getElementById(id);
      if (valueElement) {
        valueElement.textContent = value;
        if (subtitle) {
          const subElement = valueElement.nextElementSibling;
          if (subElement) subElement.textContent = subtitle;
        }
      }
    }

    async function loadEmployees() {
      const tbody = document.getElementById('employeeTableBody');
      if (!tbody) return;
      
      // 필터 값 가져오기
      const storeFilter = document.getElementById('employeeStoreFilter')?.value || '';
      const statusFilter = document.getElementById('employeeStatusFilter')?.value || '';
      
      // 로딩 표시
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px;">
            <div>⏳ 직원 목록을 불러오는 중...</div>
          </td>
        </tr>
      `;
      
      try {
        console.log('📋 직원 목록 로드 시작...');
        console.log('📍 컬렉션: users, 조건: userType == employee');
        
        // Firestore users 컬렉션에서 직원 데이터 가져오기
        let query = db.collection('users').where('userType', '==', 'employee');
        
        // 상태 필터 적용
        if (statusFilter) {
          // 특정 상태로 필터링 (resigned, active, approved, pending 등)
          query = query.where('status', '==', statusFilter);
        } else {
          // 필터가 없으면 resigned 제외 (재직자만 표시)
          // Firestore는 != 연산자를 지원하지 않으므로 클라이언트에서 필터링
          // query에서는 모두 가져온 후 클라이언트에서 resigned 제외
        }
        
        const usersSnapshot = await query.get();
        
        console.log(`📊 조회 결과: ${usersSnapshot.size}명의 직원`);
        
        // 디버깅: 모든 users 컬렉션 데이터 확인
        const allUsersSnapshot = await db.collection('users').get();
        console.log(`📊 전체 users 컬렉션: ${allUsersSnapshot.size}개 문서`);
        allUsersSnapshot.forEach(doc => {
          const data = doc.data();
          console.log(`  - ${doc.id}: ${data.name} (userType: ${data.userType || 'undefined'})`);
        });
        
        if (usersSnapshot.empty) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p style="margin-bottom: 16px;">등록된 직원이 없습니다.</p>
                <p style="font-size: 14px; color: var(--text-secondary);">직원 가입 페이지에서 먼저 직원을 등록해주세요.</p>
                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                  💡 전체 users: ${allUsersSnapshot.size}명 (콘솔에서 상세 확인)
                </p>
              </td>
            </tr>
          `;
          return;
        }
        
        let employees = [];
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          console.log(`✅ 직원 로드: ${data.name} (${doc.id}), status: ${data.status || 'active'}`);
          employees.push({
            uid: doc.id,
            name: data.name || '-',
            store: data.store || '-',
            position: data.position || '-',
            phone: data.phone || '-',
            birth: data.birth || '-',
            status: data.status || 'active',
            email: data.email || '-',
            address: data.address || '-'
          });
        });
        
        // 필터가 없으면 resigned 제외 (재직자만 표시)
        if (!statusFilter) {
          employees = employees.filter(emp => emp.status !== 'resigned');
          console.log(`🔍 resigned 제외: ${employees.length}명의 재직자`);
        }
        
        // 매장 필터 적용 (클라이언트 사이드)
        if (storeFilter) {
          employees = employees.filter(emp => emp.store === storeFilter);
        }
        
        console.log(`✅ ${employees.length}명의 직원 목록 표시`);
        
        // Firestore에서 모든 계약서 가져오기
        const contractsSnapshot = await firebase.firestore().collection('contracts').get();
        const contractsMap = new Map(); // key: "name_birth", value: count
        
        contractsSnapshot.forEach(doc => {
          const contract = doc.data();
          const key = `${contract.employeeName}_${contract.employeeBirth}`;
          contractsMap.set(key, (contractsMap.get(key) || 0) + 1);
        });
        
        console.log(`📄 계약서 총 ${contractsSnapshot.size}건 조회 완료`);
        
        // 각 직원의 계약서 존재 여부 확인
        tbody.innerHTML = employees.map(emp => {
          // Firestore에서 해당 직원의 계약서 확인
          const contractKey = `${emp.name}_${emp.birth}`;
          const hasContract = contractsMap.has(contractKey);
          const contractCount = contractsMap.get(contractKey) || 0;
          
          // 매니저 권한 체크
          const userRole = sessionStorage.getItem('admin_role');
          const isManager = userRole === 'manager';
          
          // 계약서 확인/작성 버튼
          let contractButton = '';
          if (!isManager) {
            contractButton = hasContract 
              ? `<button class="btn btn-sm" style="background: var(--success-color, #28a745); color: white;" onclick="viewEmployeeContracts('${emp.uid}', '${emp.name}', '${emp.birth}', '${emp.phone}', '${emp.address}')">📄 계약서 확인</button>`
              : `<button class="btn btn-sm btn-primary" onclick="openContractPageForEmployee('${emp.uid}', '${emp.name}', '${emp.birth}', '${emp.phone}', '${emp.address}')">📝 계약서 작성</button>`;
          } else {
            // 매니저는 계약서 조회만 가능
            contractButton = hasContract 
              ? `<button class="btn btn-sm" style="background: var(--text-secondary); color: white;" onclick="viewEmployeeContracts('${emp.uid}', '${emp.name}', '${emp.birth}', '${emp.phone}', '${emp.address}')">📄 계약서 ${contractCount}건 조회</button>`
              : '<span style="font-size: 12px; color: var(--text-secondary);">계약서 없음</span>';
          }
          
          // 상태 배지 결정
          let statusBadge = '';
          if (emp.status === 'approved') {
            statusBadge = '<span class="badge badge-success">재직</span>';
          } else if (emp.status === 'pending') {
            statusBadge = '<span class="badge badge-warning" style="background: #ffc107; color: #000;">승인대기중</span>';
          } else if (emp.status === 'rejected') {
            statusBadge = '<span class="badge badge-danger">가입거부</span>';
          } else {
            // status가 'active' 또는 기타인 경우 (이전 데이터 호환)
            statusBadge = '<span class="badge badge-success">재직</span>';
          }
          
          // 승인 대기 중인 경우 승인/거부 버튼 표시
          let approvalButtons = '';
          if (emp.status === 'pending' && !isManager) {
            approvalButtons = `
              <button class="btn btn-sm" style="background: var(--success-color, #28a745); color: white;" onclick="approveEmployee('${emp.uid}', '${emp.name}')">
                ✅ 승인
              </button>
              <button class="btn btn-sm" style="background: var(--danger-color, #dc3545); color: white;" onclick="rejectEmployee('${emp.uid}', '${emp.name}')">
                ❌ 거부
              </button>
            `;
          }
          
          // 삭제 버튼 (매니저는 표시 안 함)
          const deleteButton = !isManager 
            ? `<button class="btn btn-sm" style="background: var(--danger-color, #dc3545); color: white;" onclick="deleteEmployee('${emp.uid}', '${emp.name}')">
                🗑️ 삭제
              </button>`
            : '';
          
          return `
            <tr>
              <td>${emp.name}</td>
              <td>${emp.store}</td>
              <td>${emp.position}</td>
              <td>${emp.phone}</td>
              <td>${statusBadge}</td>
              <td>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                  ${approvalButtons}
                  ${contractButton}
                  ${deleteButton}
                </div>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="showEmployeeDetail('${emp.uid}')">
                  👤 상세
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('❌ 직원 목록 로드 실패:', error);
        
        // 에러 발생 시 더미 데이터 표시
        const dummyEmployees = [
          {
            uid: 'dummy_1',
            name: '김민수',
            email: 'minsu@example.com',
            birth: '900315-1234567',
            phone: '010-1234-5678',
            address: '경기도 부천시 원미구',
            store: '부천시청점',
            position: '바리스타',
            status: 'active'
          }
        ];
        
        tbody.innerHTML = dummyEmployees.map(emp => {
          return `
            <tr>
              <td>${emp.name}</td>
              <td style="font-size: 12px; color: var(--text-secondary);">${emp.email}</td>
              <td>${emp.store}</td>
              <td>${emp.position}</td>
              <td>${emp.phone}</td>
              <td>${emp.birth}</td>
              <td><span class="badge badge-success">활성 (더미)</span></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="alert('더미 데이터입니다. 실제 직원을 가입시켜주세요.')">📝 계약서 작성</button>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML += `
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; background: #fff9e6; color: #8b6914;">
              <p style="margin-bottom: 8px;">⚠️ Firestore 연결 실패. 더미 데이터를 표시합니다.</p>
              <p style="font-size: 13px;">실제 직원이 <a href="employee-register.html" target="_blank" style="color: var(--primary-color);">가입</a>하면 여기에 표시됩니다.</p>
            </td>
          </tr>
        `;
      }
    }

    async function deleteEmployee(uid, name) {
      const confirmMsg = `⚠️ ${name}님을 퇴사 처리하시겠습니까?\n\n처리 내용:\n• Firestore users 문서: status를 'resigned'로 변경\n• Firebase Authentication: 자동 삭제 (Cloud Function)\n• 통장사본, 보건증: 삭제\n\n※ 계약서와 근태 기록은 보존됩니다.\n※ 2년 후 자동으로 문서가 삭제됩니다.`;
      if (!confirm(confirmMsg)) return;
      
      try {
        console.log(`🔄 퇴사 처리 시작: ${name}`);
        
        // 1. Firestore users 문서의 status를 resigned로 업데이트
        await db.collection('users').doc(uid).update({
          status: 'resigned'
          // resignedAt은 Cloud Function에서 자동 설정됨
        });
        
        console.log(`✅ Firestore status 업데이트 완료`);
        
        // 2. employee_docs 컬렉션에서 서류 삭제
        try {
          await db.collection('employee_docs').doc(uid).delete();
          console.log(`✅ Firestore 서류 삭제 완료`);
        } catch (error) {
          console.warn(`⚠️ Firestore 서류 삭제 실패 (없을 수 있음):`, error.message);
        }
        
        // 3. employees 컬렉션도 status 업데이트 (있다면)
        try {
          await db.collection('employees').doc(uid).update({
            status: 'resigned'
          });
          console.log(`✅ employees 컬렉션 status 업데이트 완료`);
        } catch (error) {
          console.warn(`⚠️ employees 컬렉션 업데이트 실패 (없을 수 있음):`, error.message);
        }
        
        alert(`✅ ${name}님이 퇴사 처리되었습니다.\n\n• Firestore status: resigned로 변경\n• Authentication: 자동 삭제됨\n• 서류: 삭제 완료\n\n※ 2년 후 자동으로 모든 기록이 삭제됩니다.`);
        
        // 직원 목록 새로고침
        loadEmployees();
        
      } catch (error) {
        console.error('❌ 퇴사 처리 실패:', error);
        alert('❌ 퇴사 처리에 실패했습니다.\n\n오류: ' + error.message);
      }
    }

    async function showEmployeeContractList(employeeName) {
      try {
        const snapshot = await firebase.firestore().collection('contracts')
          .where('employeeName', '==', employeeName)
          .get();
        
        const contracts = [];
        let employeeId = null;
        
        snapshot.forEach(doc => {
          const contractData = doc.data();
          const contractId = doc.id;
          if (!employeeId) employeeId = getEmployeeIdFromContract(contractData);
          const signedContracts = signedContractsCache;
          const isSigned = signedContracts.some(sc => sc.id === contractId);
          contracts.push({
            id: contractId,
            data: contractData,
            isSigned: isSigned,
            createdAt: contractData.createdAt || null
          });
        });
        
        if (contracts.length === 0) {
          alert('⚠️ 해당 직원의 계약서가 없습니다.');
          return;
        }
      } catch (error) {
        console.error('❌ 계약서 조회 실패:', error);
        alert('⚠️ 계약서를 불러오는데 실패했습니다.');
        return;
      }
      
      if (contracts.length === 0) {
        alert('⚠️ 해당 직원의 계약서가 없습니다.');
        return;
      }
      
      contracts.sort((a, b) => {
        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
        return dateB - dateA;
      });
      
      // Firestore에서 서류 정보 가져오기
      let employeeDocs = {};
      try {
        if (employeeId) {
          const docRef = await firebase.firestore().collection('employee_docs').doc(employeeId).get();
          if (docRef.exists) {
            employeeDocs = docRef.data();
          }
        }
      } catch (error) {
        console.warn('⚠️ 서류 정보 조회 실패:', error);
      }
      
      let bankAccountHtml = '';
      if (employeeDocs.bankAccount) {
        const ba = employeeDocs.bankAccount;
        bankAccountHtml = `
          <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: #f0f9ff; border-radius: var(--border-radius); border-left: 4px solid #3b82f6;">
            <h4 style="margin-bottom: var(--spacing-sm);">🏦 통장사본</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
              <div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">은행명</p>
                <p style="font-weight: 600; margin: 0;">${ba.bankName || '-'}</p>
              </div>
              <div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">계좌번호</p>
                <p style="font-weight: 600; margin: 0;">${ba.accountNumber || '-'}</p>
              </div>
              <div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">예금주</p>
                <p style="font-weight: 600; margin: 0;">${ba.accountHolder || '-'}</p>
              </div>
            </div>
            <p style="font-size: 11px; color: var(--text-secondary); margin: 8px 0 0 0;">
              최종 업데이트: ${ba.updatedAt ? new Date(ba.updatedAt).toLocaleString('ko-KR') : '-'}
            </p>
          </div>
        `;
      } else {
        bankAccountHtml = `
          <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: #fff3cd; border-radius: var(--border-radius); border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 14px;">🏦 <strong>통장사본</strong> - 직원이 아직 등록하지 않았습니다.</p>
          </div>
        `;
      }
      
      let healthCertHtml = '';
      if (employeeDocs.healthCert) {
        const hc = employeeDocs.healthCert;
        const expiryDate = hc.expiryDate ? new Date(hc.expiryDate) : null;
        const isExpired = expiryDate && expiryDate < new Date();
        const expiryBadge = isExpired ? 
          '<span class="badge badge-danger" style="margin-left: 8px;">⚠️ 만료됨</span>' : 
          '<span class="badge badge-success" style="margin-left: 8px;">✅ 유효</span>';
        
        healthCertHtml = `
          <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: ${isExpired ? '#fee2e2' : '#f0fdf4'}; border-radius: var(--border-radius); border-left: 4px solid ${isExpired ? '#ef4444' : '#22c55e'};">
            <h4 style="margin-bottom: var(--spacing-sm);">🩺 보건증 ${expiryBadge}</h4>
            ${hc.imageData ? `
              <div style="margin-bottom: var(--spacing-md); text-align: center;">
                <img src="${hc.imageData}" 
                     style="max-width: 100%; max-height: 200px; border: 2px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                     onclick="window.open('${hc.imageData}', '_blank')"
                     title="클릭하면 크게 볼 수 있습니다">
                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">💡 이미지를 클릭하면 크게 볼 수 있습니다</p>
              </div>
            ` : '<p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">업로드된 이미지가 없습니다.</p>'}
            <div>
              <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 4px 0;">유효기간</p>
              <p style="font-weight: 600; margin: 0; font-size: 16px; color: ${isExpired ? '#ef4444' : '#22c55e'};">${hc.expiryDate || '-'}</p>
            </div>
            <p style="font-size: 11px; color: var(--text-secondary); margin: 8px 0 0 0;">
              최종 업데이트: ${hc.updatedAt ? new Date(hc.updatedAt).toLocaleString('ko-KR') : '-'}
            </p>
          </div>
        `;
      } else {
        healthCertHtml = `
          <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: #fff3cd; border-radius: var(--border-radius); border-left: 4px solid #ffc107;">
            <p style="margin: 0; font-size: 14px;">🩺 <strong>보건증</strong> - 직원이 아직 등록하지 않았습니다.</p>
          </div>
        `;
      }
      
      const contractRows = contracts.map((contract, index) => {
        // 날짜와 시간 함께 표시
        let createdDateTime = '-';
        if (contract.createdAt) {
          const date = new Date(contract.createdAt);
          const dateStr = date.toLocaleDateString('ko-KR');
          const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
          createdDateTime = `${dateStr} ${timeStr}`;
        }
        
        const statusBadge = contract.isSigned ? 
          '<span class="badge badge-success">✅ 서명완료</span>' : 
          '<span class="badge badge-warning">⏰ 서명대기</span>';
        const isLatest = index === 0 ? '<span class="badge badge-primary" style="margin-left: 8px;">최신</span>' : '';
        
        return `
          <tr>
            <td>${contracts.length - index}</td>
            <td>${contract.data.contractType || '근로계약서'}${isLatest}</td>
            <td>${contract.data.startDate} ~ ${contract.data.endDate}</td>
            <td>${createdDateTime}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="viewContract('${contract.id}')">📄 보기</button>
              <button class="btn btn-sm btn-primary" onclick="sendContractLink('${contract.id}')">📧 전송</button>
            </td>
          </tr>
        `;
      }).join('');
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.id = 'employeeContractListModal';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
          <div class="modal-header">
            <h3>📋 ${employeeName}님의 정보</h3>
            <button class="modal-close" onclick="closeEmployeeContractListModal()">✕</button>
          </div>
          <div class="modal-body">
            <div style="margin-bottom: var(--spacing-xl);">
              <h4 style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color);">
                📄 제출 서류
              </h4>
              ${bankAccountHtml}
              ${healthCertHtml}
            </div>
            <div>
              <h4 style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color);">
                📋 계약서 목록
              </h4>
              <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-light); border-radius: var(--border-radius);">
                <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
                  💡 총 <strong>${contracts.length}개</strong>의 계약서가 작성되었습니다.
                </p>
              </div>
              <table>
                <thead>
                  <tr>
                    <th style="width: 60px;">번호</th>
                    <th>계약유형</th>
                    <th>계약기간</th>
                    <th>작성일</th>
                    <th style="width: 120px;">상태</th>
                    <th style="width: 180px;">관리</th>
                  </tr>
                </thead>
                <tbody>
                  ${contractRows}
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEmployeeContractListModal()">닫기</button>
            <button class="btn btn-danger" onclick="resignEmployee('${employeeName}', ${employeeId})">🚪 퇴사 처리</button>
            <button class="btn btn-primary" onclick="openContractPage()">➕ 새 계약서 작성</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function closeEmployeeContractListModal() {
      const modal = document.getElementById('employeeContractListModal');
      if (modal) modal.remove();
    }

    async function resignEmployee(employeeName, employeeId) {
      const confirmMsg = `⚠️ ${employeeName}님을 퇴사 처리하시겠습니까?\n\n처리 내용:\n• Firestore users 문서: status를 'resigned'로 변경\n• Firebase Authentication: 자동 삭제 (Cloud Function)\n• 통장사본, 보건증: 삭제\n\n※ 계약서와 근태 기록은 보존됩니다.\n※ 2년 후 자동으로 문서가 삭제됩니다.`;
      if (!confirm(confirmMsg)) return;
      
      try {
        console.log(`🔄 퇴사 처리 시작: ${employeeName}`);
        
        // 1. Firestore에서 직원 UID 찾기
        const usersSnapshot = await firebase.firestore()
          .collection('users')
          .where('name', '==', employeeName)
          .where('userType', '==', 'employee')
          .get();
        
        if (usersSnapshot.empty) {
          throw new Error('직원을 찾을 수 없습니다.');
        }
        
        const userDoc = usersSnapshot.docs[0];
        const uid = userDoc.id;
        
        console.log(`📋 직원 UID: ${uid}`);
        
        // 2. Firestore users 문서의 status를 resigned로 업데이트
        await firebase.firestore().collection('users').doc(uid).update({
          status: 'resigned'
          // resignedAt은 Cloud Function에서 자동 설정됨
        });
        
        console.log(`✅ Firestore status 업데이트 완료`);
        
        // 4. employee_docs 컬렉션에서 서류 삭제
        try {
          await firebase.firestore().collection('employee_docs').doc(uid).delete();
          console.log(`✅ Firestore 서류 삭제 완료`);
        } catch (error) {
          console.warn(`⚠️ Firestore 서류 삭제 실패 (없을 수 있음):`, error.message);
        }
        
        alert(`✅ ${employeeName}님이 퇴사 처리되었습니다.\n\n• Firestore status: resigned로 변경\n• Authentication: 자동 삭제됨\n• 서류: 삭제 완료\n\n※ 2년 후 자동으로 모든 기록이 삭제됩니다.`);
        
        closeEmployeeContractListModal();
        loadEmployees();
        
      } catch (error) {
        console.error('❌ 퇴사 처리 실패:', error);
        alert(`❌ 퇴사 처리 중 오류가 발생했습니다.\n\n${error.message}`);
      }
    }

    function getEmployeeIdFromContract(contract) {
      const employeeMap = {
        '김민수': 1, '이지은': 2, '박서준': 3, '최영희': 4, '정수민': 5, '강호동': 6
      };
      return employeeMap[contract.employeeName] || 0;
    }

    async function viewContract(id) {
      try {
        // Firestore에서 계약서 찾기
        const docRef = firebase.firestore().collection('contracts').doc(id);
        const docSnap = await docRef.get();
        
        if (!docSnap.exists) {
          alert('⚠️ 계약서를 찾을 수 없습니다.');
          return;
        }
        
        const contract = docSnap.data();
        
        // 같은 직원의 모든 계약서 찾기 (Firestore만)
        const allContracts = [];
        
        const snapshot = await firebase.firestore().collection('contracts').get();
        snapshot.forEach(doc => {
          const c = doc.data();
          if (c.employeeBirth === contract.employeeBirth && c.employeeName === contract.employeeName) {
            allContracts.push({
              id: doc.id,
              data: c,
              createdAt: c.createdAt || new Date().toISOString()
            });
          }
        });
        
        // 날짜순 정렬 (최신순)
        allContracts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        await showContractViewModal(contract, id, allContracts);
      } catch (e) {
        console.error('❌ 계약서 조회 실패:', e);
        alert('⚠️ 계약서 데이터를 불러올 수 없습니다.');
      }
    }

    async function showContractViewModal(contract, currentId, allContracts = []) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.id = 'contractViewModal';
      
      // 서명 정보 확인
      const signedContracts = signedContractsCache;
      const signedContract = signedContracts.find(sc => sc.id === contract.id);
      const isSigned = !!signedContract;
      
      // 계약서 선택 드롭다운 생성 (여러 계약서가 있을 경우)
      let contractSelectorHtml = '';
      if (allContracts.length > 1) {
        const options = allContracts.map((c, index) => {
          const date = new Date(c.createdAt);
          const dateStr = date.toLocaleDateString('ko-KR');
          const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
          const label = `${dateStr} ${timeStr}${index === 0 ? ' (최신)' : ''}`;
          const selected = c.id === currentId ? 'selected' : '';
          return `<option value="${c.id}" ${selected}>${label}</option>`;
        }).join('');
        
        contractSelectorHtml = `
          <div style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="font-weight: 600; margin: 0; white-space: nowrap;">📋 계약서 선택:</label>
              <select id="contractVersionSelector" style="flex: 1; font-size: 14px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" onchange="switchContractVersion(this.value)">
                ${options}
              </select>
              <span style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">총 ${allContracts.length}건</span>
            </div>
          </div>
        `;
      }
      
      // 🔍 디버깅: 서명 데이터 확인
      console.log('🔍 계약서 ID:', contract.id);
      console.log('🔍 isSigned:', isSigned);
      console.log('🔍 signedContract:', signedContract);
      if (signedContract) {
        console.log('🔍 서명 데이터 길이:', signedContract.signature?.length || 0);
        console.log('🔍 서명 데이터 시작 부분:', signedContract.signature?.substring(0, 100) || 'N/A');
      }
      
      // 서명 정보 HTML
      let signatureHtml = '';
      if (isSigned && signedContract.signature) {
        const signDate = new Date(signedContract.signedAt);
        
        // 🔍 실제 서명 이미지가 유효한지 테스트
        console.log('✅ 서명 HTML 생성 시작');
        console.log('  - 서명일:', signDate.toLocaleDateString('ko-KR'));
        console.log('  - 근로자:', contract.employeeName);
        
        // 매장별 대표 서명 가져오기 (Firestore)
        let ceoSignature = '';
        try {
          const storeSnapshot = await firebase.firestore().collection('stores')
            .where('name', '==', contract.workStore)
            .limit(1)
            .get();
          if (!storeSnapshot.empty) {
            const storeData = storeSnapshot.docs[0].data();
            ceoSignature = storeData.ceoSignature || '';
          }
        } catch (error) {
          console.warn('⚠️ 매장 서명 조회 실패:', error);
        }
        
        signatureHtml = `
          <div style="margin-top: 50px;">
            <p style="margin-bottom: 20px; font-size: 16px; text-align: center;"><strong>서명일: ${signDate.toLocaleDateString('ko-KR')}</strong></p>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 40px;">
              <!-- 사용자(대표) 서명 -->
              <div style="flex: 1; text-align: center;">
                ${ceoSignature ? `
                  <img src="${ceoSignature}" alt="대표 서명" style="width: 200px; height: 80px; display: block; margin: 0 auto; object-fit: contain;">
                ` : `
                  <div style="width: 200px; height: 80px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #999;">
                    <span>대표 서명 미등록</span>
                  </div>
                `}
                <p style="margin-top: 8px; font-weight: 600; font-size: 14px;">사용자: ${contract.companyCEO || contract.companyName} (인)</p>
              </div>
              
              <!-- 근로자 서명 -->
              <div style="flex: 1; text-align: center;">
                <img src="${signedContract.signature}" alt="근로자 서명" style="width: 200px; height: 80px; display: block; margin: 0 auto; object-fit: contain;" onerror="console.error('❌ 서명 이미지 로드 실패!', this.src.substring(0,50))">
                <p style="margin-top: 8px; font-weight: 600; font-size: 14px;">근로자: ${contract.employeeName} (서명)</p>
              </div>
            </div>
          </div>
        `;
      } else {
        console.log('⚠️ 서명 없음');
        signatureHtml = `
          <div style="margin-top: 50px; text-align: right; padding: 20px; background: #fff3cd; border: 2px dashed #ffc107; border-radius: 4px;">
            <p style="color: #856404; font-weight: 600;">⚠️ 아직 서명되지 않은 계약서입니다.</p>
          </div>
        `;
      }
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px; max-height: 95vh; overflow-y: auto; padding: 0;">
          <!-- 상단 컨트롤 바 (인쇄 시 숨김) -->
          <div id="contractControls" style="position: sticky; top: 0; background: white; z-index: 100; padding: 16px; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 20px;">📄 계약서 상세보기</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" onclick="downloadContractPDF('${contract.id}')">📥 PDF 저장</button>
              <button class="btn btn-secondary" onclick="printContract()">🖨️ 인쇄</button>
              <button class="btn" style="background: #6c757d; color: white;" onclick="closeContractViewModal()">✕ 닫기</button>
            </div>
          </div>
          
          <!-- 드롭다운 (인쇄 시 숨김) -->
          <div id="contractSelector" style="padding: 0 40px; padding-top: 20px;">
            ${contractSelectorHtml}
          </div>
          
          <!-- A4 계약서 본문 -->
          <div id="contractPrintArea" style="width: 190mm; margin: 0 auto; background: white;">
            
            <!-- 1페이지: 계약서 테이블 -->
            <div>
              <!-- 계약서 제목 -->
              <h1 style="text-align: center; font-size: 32px; font-weight: 700; letter-spacing: 12px; margin: 0 0 30px 0;">근 로 계 약 서</h1>
              
              <!-- 서문 -->
              <p style="line-height: 1.8; margin-bottom: 25px; font-size: 14px;">
                <strong>${contract.companyName}</strong> (이하 "사용자"라 함)와 <strong>${contract.employeeName}</strong> (이하 "근로자"라 함)는 다음과 같이 근로계약을 체결한다.
              </p>
              
              <!-- 계약 내용 테이블 -->
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 13px;">
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; width: 25%; text-align: left;">근로자 정보</th>
                  <td style="border: 1px solid #333; padding: 10px; line-height: 1.8;">
                    <div>성명: ${contract.employeeName}</div>
                    <div>주민등록번호: ${contract.employeeBirth}</div>
                    <div>주소: ${contract.employeeAddress}</div>
                    <div>연락처: ${contract.employeePhone}</div>
                  </td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">사용자 정보</th>
                  <td style="border: 1px solid #333; padding: 10px; line-height: 1.8;">
                    <div>회사명: ${contract.companyName}</div>
                    <div>대표자: ${contract.companyCEO || '-'}</div>
                    <div>사업자등록번호: ${contract.companyBusinessNumber || '-'}</div>
                    <div>연락처: ${contract.companyPhone || '-'}</div>
                    <div>주소: ${contract.companyAddress || '-'}</div>
                  </td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">계약 기간</th>
                  <td style="border: 1px solid #333; padding: 10px;">${contract.contractStartDate || contract.startDate || '-'} ~ ${contract.contractEndDate || contract.endDate || '-'}</td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">근무 장소</th>
                  <td style="border: 1px solid #333; padding: 10px;">${contract.workStore || contract.workPlace || '-'}</td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">업무 내용</th>
                  <td style="border: 1px solid #333; padding: 10px;">${contract.position || contract.employeePosition || '-'}</td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">근무 일시</th>
                  <td style="border: 1px solid #333; padding: 10px; line-height: 1.8;">
                    <div>근무일: ${contract.workDays || contract.schedule?.days || '-'}</div>
                    <div>근무시간: ${contract.workTime || contract.schedule?.time || '-'}</div>
                    <div>휴게시간: ${contract.breakTime || contract.schedule?.breakTime || '근로기준법 준수'}</div>
                  </td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">급여 조건</th>
                  <td style="border: 1px solid #333; padding: 10px; line-height: 1.8;">
                    <div>${contract.wageType || contract.salaryType || '시급'}: ${(contract.wageAmount || contract.salaryAmount || 0).toLocaleString()}원</div>
                    <div>지급일: ${contract.paymentDay || contract.salaryPaymentDay || '매월 말일'}</div>
                    <div>지급방법: ${contract.paymentMethod || '계좌이체'}</div>
                  </td>
                </tr>
                <tr>
                  <th style="border: 1px solid #333; padding: 10px; background: #f5f5f5; font-weight: 600; text-align: left;">기타 내용</th>
                  <td style="border: 1px solid #333; padding: 10px; line-height: 1.8;">
                    ${contract.insurance ? `
                      ${contract.insurance.pension ? '<div>• 국민연금 가입</div>' : ''}
                      ${contract.insurance.health ? '<div>• 건강보험 가입</div>' : ''}
                      ${contract.insurance.employment ? '<div>• 고용보험 가입</div>' : ''}
                      ${contract.insurance.workComp ? '<div>• 산재보험 가입</div>' : ''}
                      ${contract.insurance.severancePay ? '<div style="color: #856404;">• 1년 이상 근속 시 퇴직금 지급 대상에 해당</div>' : ''}
                    ` : '<div>정보 없음</div>'}
                  </td>
                </tr>
              </table>
            </div>
            
            <!-- 2페이지부터: 계약 본문 + 서명란 -->
            <div class="page-break-before">
              <!-- 계약서 본문 (contractContent 또는 contractBody) -->
              ${(contract.contractContent || contract.contractBody) ? `
                <div style="white-space: pre-line; line-height: 1.8; margin-bottom: 25px; font-size: 13px; border: 1px solid #ddd; padding: 15px; background: #fafafa;">
                  ${contract.contractContent || contract.contractBody}
                </div>
              ` : ''}
              
              <!-- 계약 일자 -->
              <p style="text-align: center; margin-top: 40px; margin-bottom: 50px; font-size: 16px; font-weight: 600;">
                ${contract.contractDate || new Date(contract.createdAt).toLocaleDateString('ko-KR')}
              </p>
              
              <!-- 서명란 -->
              ${signatureHtml}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function closeContractViewModal() {
      const modal = document.getElementById('contractViewModal');
      if (modal) modal.remove();
    }
    
    // 계약서 버전 전환 함수
    window.switchContractVersion = function(contractId) {
      closeContractViewModal();
      viewContract(contractId);
    };
    
    // 인쇄 기능
    window.printContract = function() {
      window.print();
    };
    
    // PDF 저장 기능 (html2pdf 라이브러리 사용)
    window.downloadContractPDF = function(contractId) {
      const contractArea = document.getElementById('contractPrintArea');
      if (!contractArea) {
        alert('❌ 계약서를 찾을 수 없습니다.');
        return;
      }
      
      // html2pdf 라이브러리 로드 확인
      if (typeof html2pdf === 'undefined') {
        // 라이브러리 동적 로드
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.onload = function() {
          generatePDF(contractArea, contractId);
        };
        document.head.appendChild(script);
      } else {
        generatePDF(contractArea, contractId);
      }
    };
    
    async function generatePDF(element, contractId) {
      // Firestore에서 계약서 가져오기
      let contract = null;
      try {
        const docRef = await firebase.firestore().collection('contracts').doc(contractId).get();
        if (!docRef.exists) {
          alert('❌ 계약서를 찾을 수 없습니다.');
          return;
        }
        contract = docRef.data();
      } catch (error) {
        console.error('❌ 계약서 조회 실패:', error);
        alert('❌ 계약서를 불러올 수 없습니다.');
        return;
      }
      
      const fileName = `근로계약서_${contract.employeeName}_${new Date().toISOString().split('T')[0]}.pdf`;
      
      // 🔍 디버깅: element 내용 확인
      console.log('🔍 PDF 생성 영역:', element);
      console.log('🔍 element HTML 길이:', element.innerHTML.length);
      
      // 🔥 서명 데이터를 localStorage에서 직접 가져와서 다시 주입
      const signedContracts = signedContractsCache;
      const signedContract = signedContracts.find(sc => sc.id === contract.id);
      
      console.log('🔍 서명 데이터 존재:', !!signedContract);
      if (signedContract) {
        console.log('🔍 서명 이미지 길이:', signedContract.signature?.length || 0);
        console.log('🔍 서명 이미지 시작:', signedContract.signature?.substring(0, 50) || 'N/A');
      }
      
      // 🔥 서명이 있으면 무조건 다시 그려넣기 (사용자 + 근로자 양쪽)
      if (signedContract && signedContract.signature) {
        // 기존 서명 제거
        element.querySelectorAll('.avoid-page-break').forEach(div => {
          if (div.querySelector('img[alt="서명"], img[alt="근로자 서명"], img[alt="대표 서명"]')) {
            div.remove();
          }
        });
        
        // 매장별 대표 서명 가져오기 (Firestore)
        let ceoSignature = '';
        try {
          const storeSnapshot = await firebase.firestore().collection('stores')
            .where('name', '==', contract.workStore)
            .limit(1)
            .get();
          if (!storeSnapshot.empty) {
            const storeData = storeSnapshot.docs[0].data();
            ceoSignature = storeData.ceoSignature || '';
          }
        } catch (error) {
          console.warn('⚠️ 매장 서명 조회 실패:', error);
        }
        
        const signDate = new Date(signedContract.signedAt);
        const signatureHtml = `
          <div class="avoid-page-break" style="margin-top: 60px; page-break-inside: avoid;">
            <p style="margin-bottom: 20px; font-size: 16px; text-align: center;"><strong>서명일: ${signDate.toLocaleDateString('ko-KR')}</strong></p>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 40px;">
              <!-- 사용자(대표) 서명 -->
              <div style="flex: 1; text-align: center;">
                ${ceoSignature ? `
                  <img src="${ceoSignature}" alt="대표 서명" style="width: 200px; height: 80px; display: block; margin: 0 auto; object-fit: contain;">
                ` : `
                  <div style="width: 200px; height: 80px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #999; font-size: 12px;">
                    대표 서명 미등록
                  </div>
                `}
                <p style="margin-top: 8px; font-weight: 600; font-size: 14px;">사용자: ${contract.companyCEO || contract.companyName} (인)</p>
              </div>
              
              <!-- 근로자 서명 -->
              <div style="flex: 1; text-align: center;">
                <img src="${signedContract.signature}" alt="근로자 서명" style="width: 200px; height: 80px; display: block; margin: 0 auto; object-fit: contain;">
                <p style="margin-top: 8px; font-weight: 600; font-size: 14px;">근로자: ${contract.employeeName} (서명)</p>
              </div>
            </div>
          </div>
        `;
        element.insertAdjacentHTML('beforeend', signatureHtml);
        console.log('✅ 양쪽 서명 재주입 완료');
      }
      
      // PDF 생성 시작 알림
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      loadingDiv.innerHTML = '<p style="margin: 0; font-size: 16px; font-weight: 600;">📄 PDF 생성 중...</p><p style="margin-top: 8px; font-size: 14px; color: #666;">서명 이미지 처리 중...</p>';
      document.body.appendChild(loadingDiv);
      
      // PDF 생성 전 padding 제거 (margin으로 대체)
      const originalPadding = element.style.padding;
      element.style.padding = '0';
      
      // 500ms 대기
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const opt = {
        margin: 10, // 상하좌우 1cm (10mm)
        filename: fileName,
        image: { 
          type: 'jpeg', 
          quality: 0.98 
        },
        html2canvas: { 
          scale: 2,
          useCORS: false, // Blob URL은 CORS 불필요
          logging: true,
          letterRendering: true,
          imageTimeout: 0 // Blob URL은 즉시 로드
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { 
          mode: 'css',  // CSS 모드만 사용 (자연스러운 페이지 나누기)
          before: '.page-break-before',
          after: '.page-break-after'
        }
      };
      
      html2pdf().set(opt).from(element).save().then(() => {
        // padding 복원
        element.style.padding = originalPadding;
        document.body.removeChild(loadingDiv);
        console.log('✅ PDF 생성 완료:', fileName);
        alert('✅ PDF 다운로드 완료!');
      }).catch(err => {
        // padding 복원
        element.style.padding = originalPadding;
        document.body.removeChild(loadingDiv);
        console.error('❌ PDF 생성 실패:', err);
        alert('❌ PDF 생성에 실패했습니다:\n' + err.message);
      });
    }

    function copySignLink(link) {
      const tempInput = document.createElement('input');
      tempInput.value = link;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      alert('✅ 서명 링크가 복사되었습니다!');
    }

    async function sendContractLink(id) {
      try {
        // Firestore에서 계약서 가져오기
        const contractDoc = await firebase.firestore().collection('contracts').doc(id).get();
        
        if (!contractDoc.exists) {
          alert('⚠️ 계약서를 찾을 수 없습니다.');
          return;
        }
        
        const contract = contractDoc.data();
        // 서명 링크 생성 - 현재 디렉토리 기준
        const currentPath = window.location.pathname;
        const directory = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        const signLink = `${window.location.origin}${directory}contract-sign.html?id=${id}`;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.id = 'sendLinkModal';
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3>📧 서명 링크 전송</h3>
              <button class="modal-close" onclick="closeSendLinkModal()">✕</button>
            </div>
            <div class="modal-body">
              <p style="margin-bottom: 16px;"><strong>${contract.employeeName}</strong>님께 서명 링크를 전송합니다.</p>
              <div style="margin-bottom: 16px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">📱 연락처</label>
                <input type="tel" value="${contract.employeePhone}" readonly style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-light);">
              </div>
              <div style="margin-bottom: 16px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">🔗 서명 링크</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="linkToCopy" value="${signLink}" readonly style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;">
                  <button class="btn btn-primary btn-sm" onclick="copyLinkToSend()">📋 복사</button>
                </div>
              </div>
              <div style="padding: 16px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                <p style="margin: 0; font-size: 14px;">💡 <strong>링크 복사 후</strong> 카카오톡, 문자 등으로 직원에게 전달하세요.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeSendLinkModal()">닫기</button>
              <button class="btn btn-primary" onclick="copyAndClose()">📋 복사하고 닫기</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (e) {
        alert('⚠️ 오류가 발생했습니다.');
      }
    }

    function closeSendLinkModal() {
      const modal = document.getElementById('sendLinkModal');
      if (modal) modal.remove();
    }

    function copyLinkToSend() {
      const input = document.getElementById('linkToCopy');
      input.select();
      document.execCommand('copy');
      alert('✅ 서명 링크가 복사되었습니다!');
    }

    function copyAndClose() {
      copyLinkToSend();
      setTimeout(() => closeSendLinkModal(), 500);
    }

    /**
     * 근태 상태 자동 계산
     * @param {Object} att - 근태 데이터
     * @returns {Object} { text: '상태명', class: 'badge-클래스' }
     */
    function calculateAttendanceStatus(att) {
      // attendance 문서에 status 필드가 있으면 우선 사용 (직원이 수동으로 결근 표시한 경우)
      if (att.status === 'absent') {
        return { text: '결근', class: 'danger' };
      }
      
      // 출근 기록 없음
      if (!att.clockIn) {
        return { text: '결근', class: 'danger' };
      }
      
      // 퇴근 기록 없음 (아직 근무 중)
      if (!att.clockOut) {
        return { text: '근무중', class: 'info' };
      }
      
      // 기본값: 정상
      let status = { text: '정상', class: 'success' };
      
      // 지각/조퇴 판정을 위해 계약서 기준 시간이 필요하지만
      // 여기서는 간단하게 일반적인 기준으로 판정
      // TODO: 계약서 기준 시간과 비교하여 정확한 판정 가능
      
      // 09:00 이후 출근은 지각으로 임시 판정
      if (att.clockIn > '09:00') {
        status = { text: '지각', class: 'danger' };
      }
      
      // 18:00 이전 퇴근은 조퇴로 임시 판정
      if (att.clockOut < '18:00') {
        status = { text: '조퇴', class: 'danger' };
      }
      
      // 지각이면서 조퇴면 '지각+조퇴'
      if (att.clockIn > '09:00' && att.clockOut < '18:00') {
        status = { text: '지각+조퇴', class: 'danger' };
      }
      
      return status;
    }

    async function loadStoresForAttendanceFilter() {
      try {
        const snapshot = await firebase.firestore().collection('stores').get();
        const select = document.getElementById('attendanceStoreFilter');
        
        // 기존 옵션 제거 (전체 제외)
        select.innerHTML = '<option value="">전체</option>';
        
        console.log('📍 근무기록 매장 필터 로드:');
        snapshot.forEach(doc => {
          const store = doc.data();
          console.log(`  - 매장: "${store.name}"`);
          const option = document.createElement('option');
          option.value = store.name; // 매장 이름을 value로 사용
          option.textContent = store.name;
          select.appendChild(option);
        });
        
        console.log('✅ 근무기록 매장 필터 로드 완료:', snapshot.size, '개 매장');
      } catch (error) {
        console.error('❌ 근무기록 매장 필터 로드 실패:', error);
      }
    }

    async function loadAttendanceList() {
      console.log('🔍 loadAttendanceList 호출됨');
      
      const tbody = document.getElementById('attendanceTableBody');
      if (!tbody) {
        console.log('❌ attendanceTableBody 요소를 찾을 수 없습니다');
        return;
      }
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">근태 정보를 불러오는 중...</td></tr>';
      
      try {
        console.log('🔍 Firestore 쿼리 시작: attendance 컬렉션');
        
        // Firestore에서 근태 데이터 가져오기
        const attendanceSnapshot = await firebase.firestore().collection('attendance')
          .orderBy('date', 'desc')
          .limit(100)
          .get();
        
        console.log('📊 조회 결과:', {
          empty: attendanceSnapshot.empty,
          size: attendanceSnapshot.size,
          docs: attendanceSnapshot.docs.length
        });
        
        if (attendanceSnapshot.empty) {
          console.warn('⚠️ attendance 컬렉션이 비어있습니다');
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">근태 정보가 없습니다.</td></tr>';
          return;
        }
        
        let attendanceList = [];
        const storeSet = new Set(); // 실제 매장명 수집
        attendanceSnapshot.forEach(doc => {
          const data = doc.data();
          console.log('📄 문서 데이터:', { id: doc.id, data });
          attendanceList.push({ id: doc.id, ...data });
          if (data.store) {
            storeSet.add(data.store);
          }
        });
        
        console.log('✅ 총 근태 기록:', attendanceList.length);
        console.log('🏪 실제 매장명 목록:', Array.from(storeSet));
        
        // 근무상태 필터를 위해 직원 정보 가져오기
        const employmentStatusFilter = document.getElementById('attendanceEmploymentStatusFilter').value;
        let employeeStatusMap = {};
        
        // 필터 여부와 관계없이 직원 정보 가져오기 (이름 + 상태)
        const usersSnapshot = await firebase.firestore().collection('users').get();
        let employeeNamesMap = {};
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          // status 필드로 재직자/퇴사자 판단
          employeeStatusMap[doc.id] = user.status || 'active';
          // 이름 매핑
          employeeNamesMap[doc.id] = user.name || '-';
        });
        
        // attendance 데이터에 직원 이름 추가
        attendanceList = attendanceList.map(att => ({
          ...att,
          employeeName: att.employeeName || att.name || employeeNamesMap[att.uid] || '-'
        }));
        
        // 클라이언트 사이드 필터링
        const monthFilter = document.getElementById('attendanceMonth').value;
        const storeFilter = document.getElementById('attendanceStoreFilter').value;
        
        if (monthFilter) {
          attendanceList = attendanceList.filter(att => {
            return att.date && att.date.startsWith(monthFilter);
          });
          console.log(`📅 월 필터 적용 (${monthFilter}):`, attendanceList.length);
        }
        
        if (storeFilter) {
          attendanceList = attendanceList.filter(att => att.store === storeFilter);
          console.log(`🏪 매장 필터 적용 (${storeFilter}):`, attendanceList.length);
        }
        
        // 근무상태 필터 적용
        attendanceList = attendanceList.filter(att => {
          const empStatus = employeeStatusMap[att.uid];
          
          if (employmentStatusFilter === 'active') {
            // 재직자만
            return empStatus === 'approved' || empStatus === 'active';
          } else if (employmentStatusFilter === 'resigned') {
            // 퇴사자만
            return empStatus === 'resigned';
          } else {
            // 전체 = 재직자 + 퇴사자 모두
            return true;
          }
        });
        console.log(`👤 근무상태 필터 적용 (${employmentStatusFilter || '기본:재직자'}):`, attendanceList.length);
        
        if (attendanceList.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">조건에 맞는 근태 정보가 없습니다.</td></tr>';
          return;
        }
        
        tbody.innerHTML = attendanceList.map(att => {
          // 상태 자동 계산
          const calculatedStatus = calculateAttendanceStatus(att);
          const statusClass = calculatedStatus.class;
          const statusText = calculatedStatus.text;
          
          return `
            <tr>
              <td>${att.date || '-'}</td>
              <td>${att.employeeName || att.name || '-'}</td>
              <td>${att.store || '-'}</td>
              <td>${att.clockIn || '-'}</td>
              <td>${att.clockOut || '-'}</td>
              <td><span class="badge badge-${statusClass}">${statusText}</span></td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="showAttendanceDetailModal('${att.id}', '${att.employeeName || att.name}', '${att.uid}', '${att.date}', '${att.clockIn || ''}', '${att.clockOut || ''}', '${att.store || ''}', '${att.workType || '정규근무'}', '${statusText}')" style="margin-right: 4px;">📋 상세</button>
                <button class="btn btn-sm btn-primary" onclick="showAdminEditAttendanceModal('${att.id}', '${att.employeeName || att.name}', '${att.uid}', '${att.date}', '${att.clockIn || ''}', '${att.clockOut || ''}')">✏️ 수정</button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('❌ 근태 목록 로드 실패:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger-color);">❌ 근태 정보를 불러오는데 실패했습니다.</td></tr>';
      }
    }

    // ===========================================
    // 급여 계산 함수들은 js/salary-calculator.js 외부 모듈로 분리되었습니다
    // - publicHolidays2025 (공휴일 배열)
    // - isPublicHoliday()
    // - timeToMinutes()
    // - formatHoursAndMinutes()
    // - calculateWorkHours()
    // - calculateNightHours()
    // - calculateMonthlySalary()
    // - getWeekOfMonth()
    // ===========================================
    
    // ===========================================
    // 급여 관리 UI 함수들
    // ===========================================
    
    async function loadSalaryList() {
      const tbody = document.getElementById('salaryTableBody');
      if (!tbody) return;
      
      const monthInput = document.getElementById('salaryMonth');
      const yearMonth = monthInput.value;
      
      if (!yearMonth) {
        alert('⚠️ 조회할 월을 선택해주세요.');
        return;
      }
      
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">급여 계산 중...</td></tr>';
      
      try {
        console.log('💰 급여 조회 시작:', yearMonth);
        
        // 근무상태 필터
        const employmentStatusFilter = document.getElementById('salaryEmploymentStatusFilter').value;
        
        // 모든 직원 가져오기
        const employeesSnapshot = await firebase.firestore().collection('users')
          .where('userType', '==', 'employee')
          .get();
        
        if (employeesSnapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">등록된 직원이 없습니다.</td></tr>';
          return;
        }
        
        const salaryData = [];
        
        for (const empDoc of employeesSnapshot.docs) {
          const employee = { uid: empDoc.id, ...empDoc.data() };
          
          // 근무상태 필터 적용
          const empStatus = employee.status || 'approved';
          
          if (employmentStatusFilter === 'active') {
            // 재직자만
            if (empStatus !== 'approved' && empStatus !== 'active') {
              continue;
            }
          } else if (employmentStatusFilter === 'resigned') {
            // 퇴사자만
            if (empStatus !== 'resigned') {
              continue;
            }
          }
          // else: 전체 = 재직자 + 퇴사자 모두 표시 (필터링 없음)
          
          // 해당 직원의 계약서 찾기 (복합 인덱스 없이 처리)
          const contractsSnapshot = await firebase.firestore().collection('contracts')
            .where('employeeName', '==', employee.name)
            .get();
          
          if (contractsSnapshot.empty) {
            console.log('⚠️ 계약서 없음:', employee.name);
            continue;
          }
          
          // 클라이언트에서 최신 계약서 찾기
          const contracts = [];
          contractsSnapshot.forEach(doc => {
            contracts.push({ id: doc.id, ...doc.data() });
          });
          contracts.sort((a, b) => {
            const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            return bTime - aTime;
          });
          const contract = contracts[0];
          
          // 4단계 개선: 계약서의 계산 기간 설정을 기반으로 계산 기간 결정
          const salaryPaymentDay = contract.salaryPaymentDay || null;
          const calculationType = contract.salaryCalculationType || 'prev_month_full';
          const calculationPeriod = contract.salaryCalculationPeriod || null;
          const [year, month] = yearMonth.split('-');
          
          let startDate, endDate;
          
          // 계산 기간 타입에 따라 분기
          if (calculationType === 'prev_month_full') {
            // 전월 전체 (전월 1일~말일)
            const prevMonth = new Date(year, month - 2, 1);
            const prevYear = prevMonth.getFullYear();
            const prevMonthNum = String(prevMonth.getMonth() + 1).padStart(2, '0');
            const lastDayOfPrevMonth = new Date(prevYear, prevMonth.getMonth() + 1, 0).getDate();
            startDate = `${prevYear}-${prevMonthNum}-01`;
            endDate = `${prevYear}-${prevMonthNum}-${lastDayOfPrevMonth}`;
            console.log('💰 급여 계산 기간 (전월 전체):', startDate, '~', endDate);
            
          } else if (calculationType === 'current_month_full') {
            // 당월 전체 (당월 1일~말일)
            const lastDay = new Date(year, month, 0).getDate();
            startDate = `${year}-${String(month).padStart(2, '0')}-01`;
            endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
            console.log('💰 급여 계산 기간 (당월 전체):', startDate, '~', endDate);
            
          } else if (calculationType === 'custom' && calculationPeriod) {
            // 사용자 지정
            const startMonth = calculationPeriod.startMonth; // 'prev' or 'current'
            const startDay = calculationPeriod.startDay;
            const endMonth = calculationPeriod.endMonth;
            const endDay = calculationPeriod.endDay; // 숫자 or 'last'
            
            // 시작일 계산
            if (startMonth === 'prev') {
              const prevMonth = new Date(year, month - 2, 1);
              const prevYear = prevMonth.getFullYear();
              const prevMonthNum = String(prevMonth.getMonth() + 1).padStart(2, '0');
              startDate = `${prevYear}-${prevMonthNum}-${String(startDay).padStart(2, '0')}`;
            } else {
              startDate = `${year}-${String(month).padStart(2, '0')}-${String(startDay).padStart(2, '0')}`;
            }
            
            // 종료일 계산
            if (endMonth === 'prev') {
              const prevMonth = new Date(year, month - 2, 1);
              const prevYear = prevMonth.getFullYear();
              const prevMonthNum = String(prevMonth.getMonth() + 1).padStart(2, '0');
              if (endDay === 'last') {
                const lastDay = new Date(prevYear, prevMonth.getMonth() + 1, 0).getDate();
                endDate = `${prevYear}-${prevMonthNum}-${lastDay}`;
              } else {
                endDate = `${prevYear}-${prevMonthNum}-${String(endDay).padStart(2, '0')}`;
              }
            } else {
              if (endDay === 'last') {
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
              } else {
                endDate = `${year}-${String(month).padStart(2, '0')}-${String(endDay).padStart(2, '0')}`;
              }
            }
            
            console.log('💰 급여 계산 기간 (사용자 지정):', startDate, '~', endDate);
            
          } else {
            // 정보 없음 → 기본 전월 전체 계산
            const prevMonth = new Date(year, month - 2, 1);
            const prevYear = prevMonth.getFullYear();
            const prevMonthNum = String(prevMonth.getMonth() + 1).padStart(2, '0');
            const lastDayOfPrevMonth = new Date(prevYear, prevMonth.getMonth() + 1, 0).getDate();
            startDate = `${prevYear}-${prevMonthNum}-01`;
            endDate = `${prevYear}-${prevMonthNum}-${lastDayOfPrevMonth}`;
            console.log('⚠️ 계약서에 계산 기간 정보 없음, 전월 전체 기준 계산:', startDate, '~', endDate);
          }
          
          const attendancesSnapshot = await firebase.firestore().collection('attendance')
            .where('uid', '==', employee.uid)
            .where('date', '>=', startDate)
            .where('date', '<=', endDate)
            .get();
          
          const attendances = [];
          attendancesSnapshot.forEach(doc => {
            attendances.push(doc.data());
          });
          
          // 급여 계산
          const salary = await calculateMonthlySalary(employee, contract, attendances, yearMonth);
          salaryData.push(salary);
        }
        
        // Firestore에서 확정된 급여 정보 가져오기
        const confirmedSalaries = {};
        const salariesSnapshot = await firebase.firestore().collection('salaries')
          .where('yearMonth', '==', yearMonth)
          .get();
        
        salariesSnapshot.forEach(doc => {
          const data = doc.data();
          confirmedSalaries[data.employeeUid] = {
            status: data.status || 'confirmed',
            paid: data.paid || false,
            docId: doc.id
          };
        });
        
        // 테이블 렌더링
        if (salaryData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">급여 정보가 없습니다.</td></tr>';
          return;
        }
        
        tbody.innerHTML = salaryData.map(salary => {
          const confirmed = confirmedSalaries[salary.employeeUid];
          // status 필드가 'confirmed' 또는 'paid'일 때만 확정된 것으로 판단
          const isConfirmed = confirmed && (confirmed.status === 'confirmed' || confirmed.status === 'paid');
          const isPaid = confirmed && confirmed.status === 'paid';
          
          let statusBadge = '<span class="badge badge-warning">미확정</span>';
          if (isConfirmed && isPaid) {
            statusBadge = '<span class="badge badge-success">지급완료</span>';
          } else if (isConfirmed) {
            statusBadge = '<span class="badge badge-info">확정됨</span>';
          }
          
          let actionButtons = `<button class="btn btn-sm btn-secondary" onclick="showSalaryDetail('${salary.employeeUid}', '${yearMonth}')" style="margin-left: 4px;">상세</button>`;
          
          if (!isConfirmed) {
            // 5단계: 미확정 급여 → 급여 확정 버튼
            actionButtons += `<button class="btn btn-sm btn-primary" onclick="confirmSalary('${salary.employeeUid}', '${yearMonth}', ${salary.netPay}, '${salary.employeeName}')" style="margin-left: 4px;">💰 급여 확정</button>`;
          } else if (isConfirmed && !isPaid) {
            // 확정된 급여 → 지급완료 버튼
            actionButtons += `<button class="btn btn-sm btn-success" onclick="markAsPaid('${confirmed.docId}')" style="margin-left: 4px;">✅ 지급완료</button>`;
          }
          
          return `
            <tr>
              <td><strong>${salary.employeeName}</strong></td>
              <td>${salary.storeName || '-'}</td>
              <td style="text-align: right;">${salary.basePay.toLocaleString()}원</td>
              <td style="text-align: right; color: var(--success-color);">
                +${salary.totalAllowances.toLocaleString()}원
              </td>
              <td style="text-align: right; color: var(--danger-color);">
                -${salary.totalDeductions.toLocaleString()}원
              </td>
              <td style="text-align: right;">
                <strong style="font-size: 15px;">${salary.netPay.toLocaleString()}원</strong>
              </td>
              <td style="text-align: center;">${statusBadge}</td>
              <td style="text-align: center; white-space: nowrap;">${actionButtons}</td>
            </tr>
          `;
        }).join('');
        
        console.log('✅ 급여 목록 로드 완료');
        
      } catch (error) {
        console.error('❌ 급여 조회 실패:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger-color);">급여 조회 중 오류가 발생했습니다.</td></tr>';
      }
    }
    
    // 급여 상세 보기 전역 변수
    let currentSalaryDetail = null;
    
    async function showSalaryDetail(employeeUid, yearMonth) {
      try {
        console.log('💰 급여 상세 조회:', employeeUid, yearMonth);
        
        // 직원 정보 가져오기
        const empDoc = await firebase.firestore().collection('users').doc(employeeUid).get();
        if (!empDoc.exists) {
          alert('❌ 직원 정보를 찾을 수 없습니다.');
          return;
        }
        const employee = { uid: empDoc.id, ...empDoc.data() };
        
        // 계약서 찾기 (복합 인덱스 없이 처리)
        const contractsSnapshot = await firebase.firestore().collection('contracts')
          .where('employeeName', '==', employee.name)
          .get();
        
        if (contractsSnapshot.empty) {
          alert('❌ 계약서를 찾을 수 없습니다.');
          return;
        }
        
        // 클라이언트에서 최신 계약서 찾기
        const contracts = [];
        contractsSnapshot.forEach(doc => {
          contracts.push({ id: doc.id, ...doc.data() });
        });
        contracts.sort((a, b) => {
          const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return bTime - aTime;
        });
        const contract = contracts[0];
        
        // 출퇴근 기록 가져오기
        const [year, month] = yearMonth.split('-');
        const startDate = `${year}-${month}-01`;
        const endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
        
        const attendancesSnapshot = await firebase.firestore().collection('attendance')
          .where('uid', '==', employeeUid)
          .where('date', '>=', startDate)
          .where('date', '<=', endDate)
          .get();
        
        const attendances = [];
        attendancesSnapshot.forEach(doc => {
          attendances.push(doc.data());
        });
        
        // 급여 계산
        const salary = await calculateMonthlySalary(employee, contract, attendances, yearMonth);
        currentSalaryDetail = salary;
        
        // 모달에 데이터 표시
        document.getElementById('salaryDetailName').textContent = salary.employeeName;
        document.getElementById('salaryDetailStore').textContent = salary.storeName || '-';
        document.getElementById('salaryDetailMonth').textContent = yearMonth;
        document.getElementById('salaryDetailWorkDays').textContent = `${salary.workDays}일`;
        
        // 지급 항목
        document.getElementById('salaryDetailHourlyWage').textContent = salary.hourlyWage.toLocaleString();
        document.getElementById('salaryDetailTotalHours').textContent = formatHoursAndMinutes(salary.totalWorkHours);
        document.getElementById('salaryDetailBasePay').textContent = salary.basePay.toLocaleString() + '원';
        
        // 연장근로수당
        if (salary.overtimePay > 0) {
          document.getElementById('salaryDetailOvertimeRow').style.display = '';
          document.getElementById('salaryDetailOvertimeHours').textContent = formatHoursAndMinutes(salary.overtimeHours || 0);
          document.getElementById('salaryDetailOvertimePay').textContent = '+' + salary.overtimePay.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailOvertimeRow').style.display = 'none';
        }
        
        // 야간근로수당
        if (salary.nightPay > 0) {
          document.getElementById('salaryDetailNightRow').style.display = '';
          document.getElementById('salaryDetailNightHours').textContent = formatHoursAndMinutes(salary.nightHours || 0);
          document.getElementById('salaryDetailNightPay').textContent = '+' + salary.nightPay.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailNightRow').style.display = 'none';
        }
        
        // 휴일근로수당
        if (salary.holidayPay > 0) {
          document.getElementById('salaryDetailHolidayRow').style.display = '';
          document.getElementById('salaryDetailHolidayPay').textContent = '+' + salary.holidayPay.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailHolidayRow').style.display = 'none';
        }
        
        // 주휴수당
        if (salary.weeklyHolidayPay > 0) {
          document.getElementById('salaryDetailWeeklyRow').style.display = '';
          document.getElementById('salaryDetailWeeklyPay').textContent = '+' + salary.weeklyHolidayPay.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailWeeklyRow').style.display = 'none';
        }
        
        // 퇴직금 (계약서에 퇴직금 적용 대상이고, 퇴직금이 있는 경우만 표시)
        const isSeveranceTarget = contract.insurance && contract.insurance.severancePay;
        if (isSeveranceTarget && salary.severancePay > 0) {
          document.getElementById('salaryDetailSeveranceRow').style.display = '';
          document.getElementById('salaryDetailSeverancePay').textContent = '+' + salary.severancePay.toLocaleString() + '원';
          
          // 퇴직금 확정 버튼 표시 (퇴직금이 있는 경우만)
          document.getElementById('confirmSeveranceBtn').style.display = 'inline-block';
        } else {
          document.getElementById('salaryDetailSeveranceRow').style.display = 'none';
          document.getElementById('confirmSeveranceBtn').style.display = 'none';
        }
        
        document.getElementById('salaryDetailTotalPay').textContent = salary.totalPay.toLocaleString() + '원';
        
        // 공제 항목
        if (salary.nationalPension > 0) {
          document.getElementById('salaryDetailPensionRow').style.display = '';
          document.getElementById('salaryDetailPension').textContent = '-' + salary.nationalPension.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailPensionRow').style.display = 'none';
        }
        
        if (salary.healthInsurance > 0) {
          document.getElementById('salaryDetailHealthRow').style.display = '';
          document.getElementById('salaryDetailHealth').textContent = '-' + salary.healthInsurance.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailHealthRow').style.display = 'none';
        }
        
        if (salary.longTermCare > 0) {
          document.getElementById('salaryDetailLongTermRow').style.display = '';
          document.getElementById('salaryDetailLongTerm').textContent = '-' + salary.longTermCare.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailLongTermRow').style.display = 'none';
        }
        
        if (salary.employmentInsurance > 0) {
          document.getElementById('salaryDetailEmploymentRow').style.display = '';
          document.getElementById('salaryDetailEmployment').textContent = '-' + salary.employmentInsurance.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailEmploymentRow').style.display = 'none';
        }
        
        if (salary.incomeTax > 0) {
          document.getElementById('salaryDetailTaxRow').style.display = '';
          document.getElementById('salaryDetailTax').textContent = '-' + salary.incomeTax.toLocaleString() + '원';
        } else {
          document.getElementById('salaryDetailTaxRow').style.display = 'none';
        }
        
        document.getElementById('salaryDetailTotalDeduction').textContent = salary.totalDeductions.toLocaleString() + '원';
        
        // 실지급액
        document.getElementById('salaryDetailNetPay').textContent = salary.netPay.toLocaleString() + '원';
        
        // 🔥 실시간 자동 저장: 급여 상세 조회 시 자동으로 Firestore에 저장
        try {
          const docId = `${salary.employeeUid}_${yearMonth}`;
          const salaryData = {
            ...salary,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoSaved: true
          };
          
          // 기존 문서 확인
          const existingDoc = await firebase.firestore().collection('salaries').doc(docId).get();
          
          if (existingDoc.exists) {
            // 기존 status 유지하며 업데이트
            const existingData = existingDoc.data();
            salaryData.status = existingData.status || 'draft';
            salaryData.paid = existingData.paid || false;
            salaryData.confirmedAt = existingData.confirmedAt || null;
            salaryData.paidAt = existingData.paidAt || null;
          } else {
            // 신규 저장
            salaryData.status = 'draft';
            salaryData.paid = false;
            salaryData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          }
          
          await firebase.firestore().collection('salaries').doc(docId).set(salaryData, { merge: true });
          console.log('✅ 급여 상세내역 자동 저장 완료:', docId);
        } catch (autoSaveError) {
          console.warn('⚠️ 급여 자동 저장 실패 (계속 진행):', autoSaveError);
        }
        
        // 모달 표시
        document.getElementById('salaryDetailModal').style.display = 'flex';
        
      } catch (error) {
        console.error('❌ 급여 상세 조회 실패:', error);
        alert('급여 상세 조회에 실패했습니다: ' + error.message);
      }
    }
    
    function closeSalaryDetailModal() {
      document.getElementById('salaryDetailModal').style.display = 'none';
      currentSalaryDetail = null;
    }
    
    /**
     * 급여명세서 PDF 생성 및 다운로드
     */
    async function downloadSalaryPDF() {
      if (!currentSalaryDetail) {
        alert('⚠️ 급여 정보가 없습니다.');
        return;
      }
      
      try {
        console.log('📄 PDF 생성 시작:', currentSalaryDetail);
        
        // html2pdf 라이브러리 로드 확인
        if (typeof html2pdf === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        const salary = currentSalaryDetail;
        const today = new Date().toLocaleDateString('ko-KR');
        
        // PDF 내용 생성
        const pdfContent = `
          <div style="font-family: 'Malgun Gothic', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
            <!-- 헤더 -->
            <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #2563eb; padding-bottom: 20px;">
              <h1 style="font-size: 28px; margin: 0 0 10px 0; color: #1e293b;">급여명세서</h1>
              <p style="font-size: 14px; color: #64748b; margin: 0;">맛남살롱</p>
            </div>
            
            <!-- 기본 정보 -->
            <div style="margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 8px;">
              <table style="width: 100%; border-collapse: collapse;">
                <tr>
                  <td style="padding: 8px 0; width: 30%; font-weight: 600; color: #475569;">직원명</td>
                  <td style="padding: 8px 0;">${salary.employeeName}</td>
                  <td style="padding: 8px 0; width: 30%; font-weight: 600; color: #475569;">매장</td>
                  <td style="padding: 8px 0;">${salary.storeName || '-'}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; font-weight: 600; color: #475569;">급여 월</td>
                  <td style="padding: 8px 0;">${salary.yearMonth}</td>
                  <td style="padding: 8px 0; font-weight: 600; color: #475569;">근무 일수</td>
                  <td style="padding: 8px 0;">${salary.workDays}일</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; font-weight: 600; color: #475569;">급여 유형</td>
                  <td style="padding: 8px 0;">${salary.wageType}</td>
                  <td style="padding: 8px 0; font-weight: 600; color: #475569;">발행일</td>
                  <td style="padding: 8px 0;">${today}</td>
                </tr>
              </table>
            </div>
            
            <!-- 지급 항목 -->
            <div style="margin-bottom: 30px;">
              <h2 style="font-size: 18px; margin-bottom: 15px; color: #2563eb; border-left: 4px solid #2563eb; padding-left: 12px;">지급 항목</h2>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #e2e8f0;">
                <tr style="background: #f1f5f9;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e1;">항목</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;">금액</th>
                </tr>
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                    기본급 ${salary.wageType === '시급' ? `(시급 ${salary.hourlyWage.toLocaleString()}원 × ${formatHoursAndMinutes(salary.totalWorkHours)})` : ''}
                  </td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0;">${salary.basePay.toLocaleString()}원</td>
                </tr>
                ${salary.overtimePay > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">연장근로수당 (${formatHoursAndMinutes(salary.overtimeHours || 0)})</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981;">${salary.overtimePay.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.nightPay > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">야간근로수당 (${formatHoursAndMinutes(salary.nightHours || 0)})</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981;">${salary.nightPay.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.holidayPay > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">휴일근로수당 (${formatHoursAndMinutes(salary.holidayHours || 0)})</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981;">${salary.holidayPay.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.weeklyHolidayPay > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">주휴수당</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981;">${salary.weeklyHolidayPay.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.severancePay > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">퇴직금</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #10b981;">${salary.severancePay.toLocaleString()}원</td>
                </tr>
                ` : ''}
                <tr style="background: #f8fafc; font-weight: 600;">
                  <td style="padding: 12px; border-bottom: 2px solid #cbd5e1;">총 지급액 (공제 전)</td>
                  <td style="padding: 12px; text-align: right; font-size: 16px; border-bottom: 2px solid #cbd5e1;">${salary.totalPay.toLocaleString()}원</td>
                </tr>
              </table>
            </div>
            
            <!-- 공제 항목 -->
            <div style="margin-bottom: 30px;">
              <h2 style="font-size: 18px; margin-bottom: 15px; color: #dc2626; border-left: 4px solid #dc2626; padding-left: 12px;">공제 항목</h2>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #e2e8f0;">
                <tr style="background: #f1f5f9;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e1;">항목</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #cbd5e1;">금액</th>
                </tr>
                ${salary.nationalPension > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">국민연금 (4.5%)</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #dc2626;">${salary.nationalPension.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.healthInsurance > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">건강보험 (3.545%)</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #dc2626;">${salary.healthInsurance.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.longTermCare > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">장기요양 (0.459%)</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #dc2626;">${salary.longTermCare.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.employmentInsurance > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">고용보험 (0.9%)</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #dc2626;">${salary.employmentInsurance.toLocaleString()}원</td>
                </tr>
                ` : ''}
                ${salary.incomeTax > 0 ? `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">소득세 (3.3%)</td>
                  <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; color: #dc2626;">${salary.incomeTax.toLocaleString()}원</td>
                </tr>
                ` : ''}
                <tr style="background: #fef2f2; font-weight: 600;">
                  <td style="padding: 12px; border-bottom: 2px solid #cbd5e1;">총 공제액</td>
                  <td style="padding: 12px; text-align: right; font-size: 16px; border-bottom: 2px solid #cbd5e1; color: #dc2626;">${salary.totalDeductions.toLocaleString()}원</td>
                </tr>
              </table>
            </div>
            
            <!-- 실지급액 -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 30px;">
              <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.9;">실지급액</div>
              <div style="font-size: 38px; font-weight: 700; letter-spacing: -1px;">${salary.netPay.toLocaleString()}원</div>
            </div>
            
            <!-- 푸터 -->
            <div style="text-align: center; padding-top: 20px; border-top: 2px solid #e2e8f0; color: #64748b; font-size: 12px;">
              <p style="margin: 0;">본 급여명세서는 맛남살롱 급여관리 시스템에서 자동 생성되었습니다.</p>
              <p style="margin: 5px 0 0 0;">문의사항이 있으시면 관리자에게 연락해 주세요.</p>
            </div>
          </div>
        `;
        
        // 임시 컨테이너 생성
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = pdfContent;
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        document.body.appendChild(tempDiv);
        
        // PDF 옵션
        const opt = {
          margin: 10,
          filename: `급여명세서_${salary.employeeName}_${salary.yearMonth}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // PDF 생성 및 다운로드
        await html2pdf().set(opt).from(tempDiv).save();
        
        // 임시 컨테이너 제거
        document.body.removeChild(tempDiv);
        
        console.log('✅ PDF 생성 완료');
        
      } catch (error) {
        console.error('❌ PDF 생성 실패:', error);
        alert('PDF 생성에 실패했습니다: ' + error.message);
      }
    }
    
    // 급여 상세 모달에서 급여 확정
    async function confirmSalaryFromDetail() {
      if (!currentSalaryDetail) {
        alert('⚠️ 급여 정보가 없습니다.');
        return;
      }
      
      if (!confirm('이 급여를 확정하시겠습니까?\n확정 후에는 Firestore에 저장됩니다.')) {
        return;
      }
      
      try {
        console.log('💾 급여 확정 저장 시작:', currentSalaryDetail);
        
        // Firestore에 저장
        const salaryData = {
          ...currentSalaryDetail,
          confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
          confirmedBy: firebase.auth().currentUser?.uid || 'unknown',
          status: 'confirmed',
          paid: false
        };
        
        // 문서 ID: employeeUid_yearMonth
        const docId = `${currentSalaryDetail.employeeUid}_${currentSalaryDetail.yearMonth}`;
        
        await firebase.firestore().collection('salaries').doc(docId).set(salaryData);
        
        console.log('✅ 급여 확정 완료:', docId);
        alert('✅ 급여가 확정되었습니다.');
        
        closeSalaryDetailModal();
        loadSalaryList(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 급여 확정 실패:', error);
        alert('급여 확정에 실패했습니다: ' + error.message);
      }
    }
    
    // 퇴직금 확정
    async function confirmSeverancePay() {
      if (!currentSalaryDetail) {
        alert('⚠️ 급여 정보가 없습니다.');
        return;
      }
      
      if (!currentSalaryDetail.severancePay || currentSalaryDetail.severancePay <= 0) {
        alert('⚠️ 퇴직금 정보가 없습니다.');
        return;
      }
      
      const confirmMsg = `${currentSalaryDetail.employeeName}님의 퇴직금을 확정하시겠습니까?\n\n퇴직금액: ${currentSalaryDetail.severancePay.toLocaleString()}원\n\n✅ 확정 후 직원 페이지에서 확인 가능합니다.`;
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      try {
        console.log('💰 퇴직금 확정 시작:', currentSalaryDetail);
        
        // 문서 ID: employeeUid_yearMonth
        const docId = `${currentSalaryDetail.employeeUid}_${currentSalaryDetail.yearMonth}`;
        
        // Firestore 업데이트
        await firebase.firestore().collection('salaries').doc(docId).update({
          severanceConfirmed: true,
          severanceConfirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
          severanceConfirmedBy: firebase.auth().currentUser?.uid || 'unknown'
        });
        
        console.log('✅ 퇴직금 확정 완료:', docId);
        alert('✅ 퇴직금이 확정되었습니다.\n직원 페이지에서 확인할 수 있습니다.');
        
        // 버튼 숨기기
        document.getElementById('confirmSeveranceBtn').style.display = 'none';
        
      } catch (error) {
        console.error('❌ 퇴직금 확정 실패:', error);
        alert('퇴직금 확정에 실패했습니다: ' + error.message);
      }
    }
    
    async function markAsPaid(docId) {
      if (!confirm('이 급여를 지급 완료 처리하시겠습니까?')) {
        return;
      }
      
      try {
        console.log('💵 지급 완료 처리:', docId);
        
        await firebase.firestore().collection('salaries').doc(docId).update({
          status: 'paid', // 상태 업데이트
          paid: true,
          paidAt: firebase.firestore.FieldValue.serverTimestamp(),
          paidBy: firebase.auth().currentUser?.uid || 'unknown'
        });
        
        console.log('✅ 지급 완료 처리 성공');
        alert('✅ 지급 완료 처리되었습니다.');
        
        loadSalaryList(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 지급 완료 처리 실패:', error);
        alert('지급 완료 처리에 실패했습니다: ' + error.message);
      }
    }
    
    // 5단계: 급여 확정 기능
    async function confirmSalary(employeeUid, yearMonth, netPay, employeeName) {
      const confirmMsg = `${employeeName}님의 ${yearMonth} 급여를 확정하시겠습니까?\n\n실지급액: ${netPay.toLocaleString()}원\n\n⚠️ 확정 후에는 수정할 수 없습니다.`;
      
      if (!confirm(confirmMsg)) {
        return;
      }
      
      try {
        console.log('💰 급여 확정 시작:', { employeeUid, yearMonth, netPay });
        
        // salaries 컬렉션에 저장 (확정 상태)
        const salaryDoc = {
          employeeUid,
          employeeName,
          yearMonth,
          netPay,
          status: 'confirmed',
          paid: false,
          confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
          confirmedBy: firebase.auth().currentUser?.uid || 'unknown'
        };
        
        // 기존에 같은 직원의 같은 월 급여가 있는지 확인
        const existingSnapshot = await firebase.firestore().collection('salaries')
          .where('employeeUid', '==', employeeUid)
          .where('yearMonth', '==', yearMonth)
          .limit(1)
          .get();
        
        if (!existingSnapshot.empty) {
          // 기존 문서 업데이트
          const existingDocId = existingSnapshot.docs[0].id;
          await firebase.firestore().collection('salaries').doc(existingDocId).update({
            ...salaryDoc,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('✅ 급여 확정 완료 (업데이트):', existingDocId);
        } else {
          // 새 문서 생성
          const docRef = await firebase.firestore().collection('salaries').add(salaryDoc);
          console.log('✅ 급여 확정 완료 (신규):', docRef.id);
        }
        
        alert(`✅ ${employeeName}님의 ${yearMonth} 급여가 확정되었습니다.\n\n실지급액: ${netPay.toLocaleString()}원`);
        
        loadSalaryList(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 급여 확정 실패:', error);
        alert('급여 확정에 실패했습니다: ' + error.message);
      }
    }

    // 관리자 목록 로드
    async function loadAdmins() {
      const tbody = document.getElementById('adminsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">관리자 목록을 불러오는 중...</td></tr>';
      
      try {
        // Firestore에서 관리자/매니저 조회
        const snapshot = await db.collection('users')
          .where('userType', '==', 'admin')
          .get();
        
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">등록된 관리자가 없습니다.</td></tr>';
          return;
        }
        
        const admins = [];
        snapshot.forEach(doc => {
          admins.push({
            uid: doc.id,
            ...doc.data()
          });
        });
        
        // 최신순 정렬
        admins.sort((a, b) => {
          const aTime = a.createdAt?.toDate?.() || new Date(0);
          const bTime = b.createdAt?.toDate?.() || new Date(0);
          return bTime - aTime;
        });
        
        // 매니저 권한 체크
        const userRole = sessionStorage.getItem('admin_role');
        const isManager = userRole === 'manager';
        
        tbody.innerHTML = admins.map(user => {
          const roleText = user.role === 'admin' ? '관리자' : '매니저';
          const roleDesc = user.role === 'admin' ? '(전체 권한)' : '(읽기 전용)';
          const createdDate = user.createdAt?.toDate?.() ? user.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
          
          // 상태 배지
          let statusBadge = '';
          if (user.status === 'approved') {
            statusBadge = '<span class="badge badge-success">활성</span>';
          } else if (user.status === 'pending') {
            statusBadge = '<span class="badge badge-warning" style="background: #ffc107; color: #000;">승인대기</span>';
          } else if (user.status === 'rejected') {
            statusBadge = '<span class="badge badge-danger">거부됨</span>';
          } else {
            statusBadge = '<span class="badge badge-success">활성</span>';
          }
          
          // 매니저는 삭제 버튼 표시 안 함
          const deleteButton = !isManager 
            ? `<button class="btn btn-sm" style="background: var(--danger-color, #dc3545); color: white;" onclick="deleteAdmin('${user.uid}', '${user.name}')">
                🗑️ 삭제
              </button>`
            : '<span style="font-size: 12px; color: var(--text-secondary);">-</span>';
          
          return `
            <tr>
              <td>${user.name || '-'}</td>
              <td style="font-size: 12px; color: var(--text-secondary);">${user.email || '-'}</td>
              <td>${user.phone || '-'}</td>
              <td>
                <span class="badge ${user.role === 'admin' ? 'badge-primary' : 'badge-info'}">
                  ${roleText} ${roleDesc}
                </span>
              </td>
              <td>${statusBadge}</td>
              <td>${createdDate}</td>
              <td>
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                  ${deleteButton}
                </div>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="showAdminDetail('${user.uid}')">
                  👤 상세
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('❌ 관리자 목록 로드 실패:', error);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger-color);">목록을 불러오는데 실패했습니다.</td></tr>';
      }
    }

    // 승인 관리 로드 (구매/폐기/퇴직서)
    async function loadApprovals() {
      const tbody = document.getElementById('approvalsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">승인 대기 목록을 불러오는 중...</td></tr>';
      
      try {
        // Firestore에서 승인 대기 문서 조회
        const typeFilter = document.getElementById('approvalTypeFilter')?.value || '';
        const statusFilter = document.getElementById('approvalStatusFilter')?.value || '';
        
        let approvals = [];
        
        // 교대근무 승인 조회 (shift_requests 컬렉션)
        if (!typeFilter || typeFilter === 'shift') {
          let shiftQuery = db.collection('shift_requests').where('status', '==', 'matched');
          if (!statusFilter) {
            shiftQuery = shiftQuery.where('approvedByAdmin', '==', false);
          }
          
          const shiftSnapshot = await shiftQuery.get();
          shiftSnapshot.forEach(doc => {
            const data = doc.data();
            approvals.push({
              id: doc.id,
              type: 'shift',
              applicantName: data.requesterName,
              status: data.approvedByAdmin ? 'approved' : 'pending',
              createdAt: data.matchedAt || data.createdAt,
              data: {
                requesterName: data.requesterName,
                matchedUserName: data.matchedUserName,
                workDate: data.workDate,
                workStartTime: data.workStartTime,
                workEndTime: data.workEndTime,
                reason: data.reason,
                store: data.store
              }
            });
          });
        }
        
        // 기존 승인 문서 조회 (approvals 컬렉션)
        if (!typeFilter || typeFilter !== 'shift') {
          let query = db.collection('approvals');
          
          if (typeFilter && typeFilter !== 'shift') {
            query = query.where('type', '==', typeFilter);
          }
          
          if (statusFilter) {
            query = query.where('status', '==', statusFilter);
          } else {
            // 기본적으로 대기중만 표시
            query = query.where('status', '==', 'pending');
          }
          
          const snapshot = await query.get();
          snapshot.forEach(doc => {
            approvals.push({
              id: doc.id,
              ...doc.data()
            });
          });
        }
        
        if (approvals.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">
                <div style="color: var(--text-secondary);">
                  <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                  <p>승인 대기 중인 문서가 없습니다.</p>
                  <p style="font-size: 13px; margin-top: 8px;">직원이 문서를 신청하면 여기에 표시됩니다.</p>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        // 최신순 정렬
        approvals.sort((a, b) => {
          const aTime = a.createdAt?.toDate?.() || new Date(0);
          const bTime = b.createdAt?.toDate?.() || new Date(0);
          return bTime - aTime;
        });
        
        // 매니저 권한 체크
        const userRole = sessionStorage.getItem('admin_role');
        const isManager = userRole === 'manager';
        
        tbody.innerHTML = approvals.map(approval => {
          const typeEmoji = {
            'purchase': '💳',
            'disposal': '🗑️',
            'resignation': '📄',
            'shift': '🔄'
          };
          
          const typeText = {
            'purchase': '구매',
            'disposal': '폐기',
            'resignation': '퇴직서',
            'shift': '교대근무'
          };
          
          const statusBadge = {
            'pending': '<span class="badge badge-warning" style="background: #ffc107; color: #000;">대기중</span>',
            'approved': '<span class="badge badge-success">승인됨</span>',
            'rejected': '<span class="badge badge-danger">거부됨</span>'
          };
          
          const createdDate = approval.createdAt?.toDate?.() ? approval.createdAt.toDate().toLocaleString('ko-KR') : '-';
          
          // 요약 정보
          let summary = '';
          if (approval.type === 'purchase') {
            summary = `${approval.data?.item || '-'} (${approval.data?.quantity || '-'}개)`;
          } else if (approval.type === 'disposal') {
            summary = `${approval.data?.category || '-'}`;
          } else if (approval.type === 'resignation') {
            summary = `희망 퇴직일: ${approval.data?.resignationDate || '-'}`;
          } else if (approval.type === 'shift') {
            summary = `${approval.data?.requesterName} → ${approval.data?.matchedUserName} (${approval.data?.workDate} ${approval.data?.workStartTime}~${approval.data?.workEndTime})`;
          }
          
          // 매니저는 승인/거부 버튼 표시 안 함
          const actionButtons = !isManager && approval.status === 'pending'
            ? `<div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-sm" style="background: var(--primary-color); color: white;" onclick="viewApprovalDetail('${approval.id}', '${approval.type}')">
                  📄 상세
                </button>
                <button class="btn btn-sm" style="background: var(--success-color, #28a745); color: white;" onclick="approveDocument('${approval.id}', '${approval.type}')">
                  ✅ 승인
                </button>
                <button class="btn btn-sm" style="background: var(--danger-color, #dc3545); color: white;" onclick="rejectDocument('${approval.id}', '${approval.type}')">
                  ❌ 거부
                </button>
              </div>`
            : `<button class="btn btn-sm" style="background: var(--text-secondary); color: white;" onclick="viewApprovalDetail('${approval.id}', '${approval.type}')">
                📄 상세보기
              </button>`;
          
          return `
            <tr>
              <td>${approval.applicantName || '-'}</td>
              <td>${typeEmoji[approval.type] || ''} ${typeText[approval.type] || '-'}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${summary}</td>
              <td style="font-size: 12px;">${createdDate}</td>
              <td>${statusBadge[approval.status] || '-'}</td>
              <td>${actionButtons}</td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('❌ 승인 목록 로드 실패:', error);
        console.error('Error details:', error.message);
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <div style="color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                <p>승인 대기 중인 문서가 없습니다.</p>
                <p style="font-size: 13px; margin-top: 8px; color: var(--text-secondary);">직원이 문서를 신청하면 여기에 표시됩니다.</p>
              </div>
            </td>
          </tr>
        `;
      }
    }
    
    async function approveEmployee(uid, name) {
      if (!confirm(`${name} 직원의 가입을 승인하시겠습니까?`)) {
        return;
      }
      
      try {
        // users 컬렉션 업데이트
        await db.collection('users').doc(uid).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // employees 컬렉션도 업데이트
        await db.collection('employees').doc(uid).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`✅ ${name} 직원의 가입이 승인되었습니다.`);
        loadEmployees(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 승인 실패:', error);
        alert('❌ 승인 처리에 실패했습니다.');
      }
    }
    
    async function rejectEmployee(uid, name) {
      if (!confirm(`${name} 직원의 가입을 거부하시겠습니까?\n거부된 계정은 로그인할 수 없습니다.`)) {
        return;
      }
      
      try {
        // users 컬렉션 업데이트
        await db.collection('users').doc(uid).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // employees 컬렉션도 업데이트
        await db.collection('employees').doc(uid).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`❌ ${name} 직원의 가입이 거부되었습니다.`);
        loadEmployees(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 거부 실패:', error);
        alert('❌ 거부 처리에 실패했습니다.');
      }
    }

    // 관리자 승인 함수
    async function approveAdmin(uid, name, role) {
      const roleText = role === 'admin' ? '관리자' : '매니저';
      if (!confirm(`${name} ${roleText}의 가입을 승인하시겠습니까?`)) {
        return;
      }
      
      try {
        // users 컬렉션 업데이트
        await db.collection('users').doc(uid).update({
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`✅ ${name} ${roleText}의 가입이 승인되었습니다.`);
        loadApprovals(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 관리자 승인 실패:', error);
        alert('❌ 승인 처리에 실패했습니다.');
      }
    }
    
    // 관리자 거부 함수
    async function rejectAdmin(uid, name) {
      if (!confirm(`${name} 관리자의 가입을 거부하시겠습니까?\n거부된 계정은 로그인할 수 없습니다.`)) {
        return;
      }
      
      try {
        // users 컬렉션 업데이트
        await db.collection('users').doc(uid).update({
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`❌ ${name} 관리자의 가입이 거부되었습니다.`);
        loadApprovals(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 관리자 거부 실패:', error);
        alert('❌ 거부 처리에 실패했습니다.');
      }
    }

    // 관리자 삭제 함수
    async function deleteAdmin(uid, name) {
      if (!confirm(`${name} 관리자를 삭제하시겠습니까?\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
        return;
      }
      
      try {
        // users 컬렉션에서 삭제
        await db.collection('users').doc(uid).delete();
        
        alert(`✅ ${name} 관리자가 삭제되었습니다.`);
        loadAdmins(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 관리자 삭제 실패:', error);
        alert('❌ 삭제 처리에 실패했습니다.');
      }
    }

    // 승인 문서 상세보기
    async function viewApprovalDetail(approvalId) {
      try {
        const doc = await db.collection('approvals').doc(approvalId).get();
        
        if (!doc.exists) {
          alert('❌ 문서를 찾을 수 없습니다.');
          return;
        }
        
        const approval = doc.data();
        
        // 타입에 따라 다른 모달 표시
        if (approval.type === 'purchase') {
          showPurchaseDetailModal(approvalId, approval);
        } else if (approval.type === 'disposal') {
          showDisposalDetailModal(approvalId, approval);
        } else if (approval.type === 'resignation') {
          showResignationDetailModal(approvalId, approval);
        }
        
      } catch (error) {
        console.error('❌ 문서 로드 실패:', error);
        alert('❌ 문서를 불러오는데 실패했습니다.');
      }
    }

    // 구매 상세 모달 표시
    function showPurchaseDetailModal(approvalId, approval) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 10000;
      `;
      
      const items = approval.data?.items || [];
      const itemsHtml = items.map((item, idx) => `
        <div style="border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 8px; background: #fafafa;">
          <div style="font-weight: 600; color: #333; margin-bottom: 8px;">${idx + 1}. ${item.item}</div>
          <div style="color: #666; font-size: 14px;">
            <div>구매처: ${item.vendor}</div>
            <div>가격: ${parseInt(item.price || 0).toLocaleString()}원</div>
            <div>수량: ${item.quantity}개</div>
          </div>
        </div>
      `).join('');
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #333;">🛒 구매 신청서 상세</h3>
          
          <div style="margin-bottom: 16px;">
            <strong>신청자:</strong> ${approval.applicantName || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>신청 이메일:</strong> ${approval.applicantEmail || 'N/A'}
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>구매 물품 목록:</strong>
            ${itemsHtml || '<div style="color: #999;">물품 정보 없음</div>'}
          </div>
          
          <div style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px;">
            <strong>총 금액:</strong> <span style="font-size: 18px; color: #1976d2; font-weight: 600;">₩${parseInt(approval.data?.totalPrice || 0).toLocaleString()}</span>
          </div>
          
          <div style="margin-bottom: 16px;">
            <strong>구매 사유:</strong><br>
            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-top: 8px; white-space: pre-wrap;">
              ${approval.data?.reason || '사유 없음'}
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <strong>신청일:</strong> ${approval.createdAt ? new Date(approval.createdAt.toDate()).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>상태:</strong> 
            <span style="padding: 6px 16px; border-radius: 12px; font-weight: 600; background: ${approval.status === 'approved' ? '#d4edda' : approval.status === 'rejected' ? '#f8d7da' : '#fff3cd'}; color: ${approval.status === 'approved' ? '#155724' : approval.status === 'rejected' ? '#721c24' : '#856404'};">
              ${approval.status === 'approved' ? '✅ 승인됨' : approval.status === 'rejected' ? '❌ 거부됨' : '⏳ 대기중'}
            </span>
          </div>
          ${approval.status === 'rejected' && approval.rejectionReason ? `
            <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
              <strong>거부 사유:</strong><br>
              ${approval.rejectionReason}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            ${approval.status === 'pending' ? `
              <button onclick="approveDocument('${approvalId}', 'purchase'); this.closest('div').parentElement.parentElement.remove();" 
                style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ✅ 승인
              </button>
              <button onclick="rejectDocument('${approvalId}', 'purchase'); this.closest('div').parentElement.parentElement.remove();" 
                style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ❌ 거부
              </button>
            ` : ''}
            <button onclick="this.closest('div').parentElement.parentElement.remove();" 
              style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              닫기
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // 폐기 상세 모달 표시
    function showDisposalDetailModal(approvalId, approval) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #333;">🗑️ 폐기 신청서 상세</h3>
          
          <div style="margin-bottom: 16px;">
            <strong>신청자:</strong> ${approval.applicantName || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>신청 이메일:</strong> ${approval.applicantEmail || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>품목:</strong> ${approval.data?.category || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>폐기 상세 내용:</strong><br>
            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-top: 8px; white-space: pre-wrap;">
              ${approval.data?.details || '상세 내용 없음'}
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <strong>신청일:</strong> ${approval.createdAt ? new Date(approval.createdAt.toDate()).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>상태:</strong> 
            <span style="padding: 6px 16px; border-radius: 12px; font-weight: 600; background: ${approval.status === 'approved' ? '#d4edda' : approval.status === 'rejected' ? '#f8d7da' : '#fff3cd'}; color: ${approval.status === 'approved' ? '#155724' : approval.status === 'rejected' ? '#721c24' : '#856404'};">
              ${approval.status === 'approved' ? '✅ 승인됨' : approval.status === 'rejected' ? '❌ 거부됨' : '⏳ 대기중'}
            </span>
          </div>
          ${approval.status === 'rejected' && approval.rejectionReason ? `
            <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
              <strong>거부 사유:</strong><br>
              ${approval.rejectionReason}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            ${approval.status === 'pending' ? `
              <button onclick="approveDocument('${approvalId}', 'disposal'); this.closest('div').parentElement.parentElement.remove();" 
                style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ✅ 승인
              </button>
              <button onclick="rejectDocument('${approvalId}', 'disposal'); this.closest('div').parentElement.parentElement.remove();" 
                style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ❌ 거부
              </button>
            ` : ''}
            <button onclick="this.closest('div').parentElement.parentElement.remove();" 
              style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              닫기
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // 퇴직서 상세 모달 표시
    function showResignationDetailModal(approvalId, approval) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
        z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-bottom: 20px; color: #333;">📄 퇴직서 상세</h3>
          
          <div style="margin-bottom: 16px;">
            <strong>신청자:</strong> ${approval.data?.name || approval.applicantName || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>신청 이메일:</strong> ${approval.applicantEmail || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>퇴직 희망일:</strong> ${approval.data?.resignationDate || 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>퇴직 사유:</strong><br>
            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-top: 8px; white-space: pre-wrap;">
              ${approval.data?.reason || '사유 없음'}
            </div>
          </div>
          ${approval.data?.employeeSignature ? `
            <div style="margin-bottom: 16px;">
              <strong>신청자 서명:</strong><br>
              <div style="border: 1px solid #ddd; padding: 8px; background: white; border-radius: 8px; margin-top: 8px;">
                <img src="${approval.data.employeeSignature}" alt="신청자 서명" style="max-width: 200px; height: auto; display: block;">
              </div>
            </div>
          ` : ''}
          <div style="margin-bottom: 16px;">
            <strong>신청일:</strong> ${approval.createdAt ? new Date(approval.createdAt.toDate()).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'}
          </div>
          <div style="margin-bottom: 16px;">
            <strong>상태:</strong> 
            <span style="padding: 6px 16px; border-radius: 12px; font-weight: 600; background: ${approval.status === 'approved' ? '#d4edda' : approval.status === 'rejected' ? '#f8d7da' : '#fff3cd'}; color: ${approval.status === 'approved' ? '#155724' : approval.status === 'rejected' ? '#721c24' : '#856404'};">
              ${approval.status === 'approved' ? '✅ 승인됨 (계정 삭제됨)' : approval.status === 'rejected' ? '❌ 거부됨' : '⏳ 대기중'}
            </span>
          </div>
          ${approval.status === 'rejected' && approval.rejectionReason ? `
            <div style="margin-bottom: 16px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
              <strong>거부 사유:</strong><br>
              ${approval.rejectionReason}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 12px; margin-top: 24px;">
            ${approval.status === 'pending' ? `
              <button onclick="if(confirm('⚠️ 퇴직서를 승인하면 해당 직원의 계정이 삭제됩니다.\\n\\n계속하시겠습니까?')) { approveDocument('${approvalId}', 'resignation'); this.closest('div').parentElement.parentElement.remove(); }" 
                style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ✅ 승인 (계정 삭제)
              </button>
              <button onclick="rejectDocument('${approvalId}', 'resignation'); this.closest('div').parentElement.parentElement.remove();" 
                style="flex: 1; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ❌ 거부
              </button>
            ` : ''}
            <button onclick="this.closest('div').parentElement.parentElement.remove();" 
              style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
              닫기
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // 문서 승인
    async function approveDocument(approvalId, type) {
      if (!confirm('이 문서를 승인하시겠습니까?')) {
        return;
      }
      
      try {
        // 교대근무 승인 처리 (새 구조: 날짜별 개별 문서)
        if (type === 'shift') {
          // 교대근무 요청 데이터 가져오기
          const shiftDoc = await db.collection('shift_requests').doc(approvalId).get();
          const shiftData = shiftDoc.data();
          
          console.log(`📅 교대근무 승인: ${shiftData.workDate} ${shiftData.workStartTime}-${shiftData.workEndTime}`);
          console.log(`   신청자: ${shiftData.requesterName}, 승인자: ${shiftData.matchedUserName}`);
          
          // 1. 원래 직원(A)의 해당 날짜 해당 근무 문서 삭제
          try {
            // 신청자의 해당 날짜, 해당 시간대 근무 문서 찾기
            const originalScheduleQuery = await db.collection('schedules')
              .where('userId', '==', shiftData.requesterId)
              .where('date', '==', shiftData.workDate)
              .where('startTime', '==', shiftData.workStartTime)
              .where('endTime', '==', shiftData.workEndTime)
              .get();
            
            if (!originalScheduleQuery.empty) {
              // 해당 근무 문서 삭제
              const deletePromises = [];
              originalScheduleQuery.forEach(doc => {
                deletePromises.push(doc.ref.delete());
                console.log(`✅ 신청자(${shiftData.requesterName}) 근무 삭제: ${shiftData.workDate} ${shiftData.workStartTime}-${shiftData.workEndTime}`);
              });
              await Promise.all(deletePromises);
            } else {
              console.log(`⚠️ 신청자(${shiftData.requesterName}) 해당 근무 문서 없음`);
            }
          } catch (err) {
            console.error(`❌ 신청자 근무 삭제 실패:`, err);
            throw err; // 오류 발생 시 전체 트랜잭션 중단
          }
          
          // 2. 승인자(B)에게 새 근무 문서 추가
          try {
            // 근무시간 계산
            const startTime = shiftData.workStartTime;
            const endTime = shiftData.workEndTime;
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            const hours = (endHour * 60 + endMin - (startHour * 60 + startMin)) / 60;
            
            // 새 근무 문서 생성
            const newSchedule = {
              userId: shiftData.matchedUserId,
              userName: shiftData.matchedUserName,
              store: shiftData.store,
              date: shiftData.workDate,
              startTime: startTime,
              endTime: endTime,
              hours: hours,
              isShiftReplacement: true, // 대체근무 표시
              shiftRequestId: approvalId,
              originalRequesterId: shiftData.requesterId,
              originalRequesterName: shiftData.requesterName,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('schedules').add(newSchedule);
            console.log(`✅ 승인자(${shiftData.matchedUserName}) 근무 추가: ${shiftData.workDate} ${startTime}-${endTime}`);
            
          } catch (err) {
            console.error(`❌ 승인자 근무 추가 실패:`, err);
            throw err; // 오류 발생 시 전체 트랜잭션 중단
          }
          
          // 3. 교대근무 요청 상태 업데이트
          await db.collection('shift_requests').doc(approvalId).update({
            status: 'approved',
            approvedByAdmin: true,
            approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
            approvedBy: sessionStorage.getItem('admin_email')
          });
          
          alert('✅ 교대근무가 승인되었습니다.\n\n' +
                `• ${shiftData.requesterName}: 해당 근무 삭제됨\n` +
                `• ${shiftData.matchedUserName}: 새 근무 추가됨 (기존 근무 유지)`);
        } else {
          // 기존 문서 승인 처리
          await db.collection('approvals').doc(approvalId).update({
            status: 'approved',
            approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
            approvedBy: sessionStorage.getItem('admin_email')
          });
          
          // 퇴직서인 경우 계정 삭제
          if (type === 'resignation') {
            const doc = await db.collection('approvals').doc(approvalId).get();
            const approval = doc.data();
            
            if (approval.applicantUid) {
              // users 컬렉션에서 삭제
              await db.collection('users').doc(approval.applicantUid).delete();
              // employees 컬렉션에서 삭제
              await db.collection('employees').doc(approval.applicantUid).delete();
              
              console.log(`✅ 퇴직서 승인으로 ${approval.applicantName} 직원 계정 삭제 완료`);
            }
          }
          
          alert('✅ 문서가 승인되었습니다.');
        }
        
        loadApprovals(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 승인 실패:', error);
        alert('❌ 승인 처리에 실패했습니다.');
      }
    }

    // 문서 거부
    async function rejectDocument(approvalId, type) {
      const reason = prompt('거부 사유를 입력하세요:');
      
      if (reason === null) {
        return; // 취소
      }
      
      try {
        // 교대근무 거부 처리
        if (type === 'shift') {
          await db.collection('shift_requests').doc(approvalId).update({
            status: 'rejected',
            approvedByAdmin: false,
            rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            rejectedBy: sessionStorage.getItem('admin_email'),
            rejectReason: reason
          });
        } else {
          // 기존 문서 거부 처리
          await db.collection('approvals').doc(approvalId).update({
            status: 'rejected',
            rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
            rejectedBy: sessionStorage.getItem('admin_email'),
            rejectReason: reason
          });
        }
        
        alert('❌ 문서가 거부되었습니다.');
        loadApprovals(); // 목록 새로고침
        
      } catch (error) {
        console.error('❌ 거부 실패:', error);
        alert('❌ 거부 처리에 실패했습니다.');
      }
    }

    /**
     * 매장 필터 옵션 동적 로드 (매장 관리 탭과 동기화)
     */
    async function loadStoreFilterOptions() {
      const storeFilter = document.getElementById('contractStoreFilter');
      if (!storeFilter) return;
      
      try {
        const storesSnapshot = await firebase.firestore().collection('stores').get();
        const currentValue = storeFilter.value; // 현재 선택값 저장
        
        // 옵션 초기화 (전체는 유지)
        storeFilter.innerHTML = '<option value="">전체</option>';
        
        // Firestore에서 매장 목록 추가
        storesSnapshot.forEach(doc => {
          const store = doc.data();
          const option = document.createElement('option');
          option.value = store.name;
          option.textContent = store.name;
          storeFilter.appendChild(option);
        });
        
        // 이전 선택값 복원
        if (currentValue) {
          storeFilter.value = currentValue;
        }
      } catch (error) {
        console.error('❌ 매장 필터 로드 실패:', error);
      }
    }

    async function loadContracts() {
      const tbody = document.getElementById('contractsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">계약서를 불러오는 중...</td></tr>';
      
      // 🔥 매장 필터 동적 로드 (매장 관리 탭과 동기화)
      await loadStoreFilterOptions();
      
      try {
        // 필터 값 가져오기
        const storeFilter = document.getElementById('contractStoreFilter').value;
        const employmentStatusFilter = document.getElementById('contractEmploymentStatusFilter').value;
        
        // 직원 정보 가져오기 (필터링용 - 필터 여부와 관계없이 항상 가져오기)
        let employeeStatusMap = {};
        const usersSnapshot = await firebase.firestore().collection('users').get();
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          // name + birth를 키로 사용
          const key = `${user.name}_${user.birth}`;
          employeeStatusMap[key] = user.status || 'approved';
        });
        
        // Firestore에서 모든 계약서 로드 (localStorage 제거 완료)
        const snapshot = await firebase.firestore().collection('contracts').get();
        const allContracts = [];
        
        snapshot.forEach(doc => {
          const contractData = doc.data();
          const contractId = doc.id;
          const signedContracts = signedContractsCache;
          const isSigned = signedContracts.some(sc => sc.id === contractId);
          
          // 매장 필터 적용
          if (storeFilter) {
            console.log(`🏪 매장 필터 체크: storeFilter=${storeFilter}, workStore=${contractData.workStore}, companyName=${contractData.companyName}`);
            if (contractData.workStore !== storeFilter && contractData.companyName !== storeFilter) {
              return;
            }
          }
          
          // 근무상태 필터 적용
          const empKey = `${contractData.employeeName}_${contractData.employeeBirth}`;
          const empStatus = employeeStatusMap[empKey] || 'approved';
          
          if (employmentStatusFilter === 'active') {
            // 재직자만
            if (empStatus !== 'approved' && empStatus !== 'active') {
              return;
            }
          } else if (employmentStatusFilter === 'resigned') {
            // 퇴사자만
            if (empStatus !== 'resigned') {
              return;
            }
          }
          // else: 전체 = 재직자 + 퇴사자 모두 표시 (필터링 없음)
          
          allContracts.push({
            id: contractId,
            name: contractData.employeeName,
            birth: contractData.employeeBirth,
            type: contractData.contractType,
            period: `${contractData.contractStartDate || contractData.startDate || '-'} ~ ${contractData.contractEndDate || contractData.endDate || '-'}`,
            createdAt: contractData.createdAt || new Date().toISOString(),
            status: isSigned ? '서명완료' : '서명대기',
            data: contractData
          });
        });
        
        if (allContracts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);"><p style="margin-bottom: 16px;">생성된 계약서가 없습니다.</p><button class="btn btn-primary" onclick="openContractPage()">+ 첫 계약서 작성하기</button></td></tr>';
          return;
        }
        
        // 직원별로 계약서 그룹화 (주민번호 기준)
        const employeeGroups = new Map();
        allContracts.forEach(contract => {
          const key = `${contract.name}_${contract.birth}`;
          if (!employeeGroups.has(key)) {
            employeeGroups.set(key, []);
          }
          employeeGroups.get(key).push(contract);
        });
        
        // 각 그룹의 계약서를 날짜순 정렬 (최신순)
        employeeGroups.forEach((contracts, key) => {
          contracts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        });
        
        // 테이블 행 생성
        const rows = [];
        employeeGroups.forEach((contracts, key) => {
          // 🔥 일반 계약서와 추가 계약서 분리
          const normalContracts = contracts.filter(c => !c.data.isAdditional);
          const additionalContracts = contracts.filter(c => c.data.isAdditional);
          
          // 🔥 일반 계약서: 최신 1개만 표시 (드롭다운으로 이력 선택)
          if (normalContracts.length > 0) {
            const latestContract = normalContracts[0];
            const contractCount = normalContracts.length;
            const statusClass = latestContract.status === '서명완료' ? 'badge-success' : 'badge-warning';
            
            // 계약서 선택 드롭다운 생성
            const contractOptions = normalContracts.map((contract, index) => {
              const date = new Date(contract.createdAt);
              const dateStr = date.toLocaleDateString('ko-KR');
              const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
              const label = `${dateStr} ${timeStr}${index === 0 ? ' (최신)' : ''}`;
              return `<option value="${contract.id}">${label}</option>`;
            }).join('');
            
            const selectId = `contract-select-${latestContract.id}`;
            
            rows.push(`
              <tr data-contract-id="${latestContract.id}">
                <td style="width: 120px;">
                  <strong>${latestContract.name}</strong>
                  ${contractCount > 1 ? `<br><span class="badge" style="background: var(--primary-color); color: white; font-size: 11px;">📝 ${contractCount}건</span>` : ''}
                </td>
                <td style="width: 100px;">${latestContract.data.contractType || latestContract.type}</td>
                <td style="width: 120px;">${latestContract.data.workStore || latestContract.data.companyName || '-'}</td>
                <td style="width: 200px;">${latestContract.period}</td>
                <td style="width: 150px;">
                  ${contractCount > 1 ? `
                    <select id="${selectId}" class="form-control" style="font-size: 13px; padding: 4px 8px;" onchange="updateContractButtons('${selectId}', this.value)">
                      ${contractOptions}
                    </select>
                  ` : `
                    ${new Date(latestContract.createdAt).toLocaleDateString('ko-KR')} ${new Date(latestContract.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                  `}
                </td>
                <td style="width: 80px;"><span class="badge ${statusClass}" id="status-${latestContract.id}">${latestContract.status}</span></td>
                <td style="width: 200px;">
                  <div id="buttons-${latestContract.id}" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="viewContract('${latestContract.id}')">📄 보기</button>
                    ${latestContract.status === '서명대기' ? `<button class="btn btn-sm btn-primary" onclick="sendContractLink('${latestContract.id}')">📧 링크전송</button>` : ''}
                    <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="deleteContract('${latestContract.id}', '${latestContract.name}')">🗑️ 삭제</button>
                  </div>
                </td>
              </tr>
            `);
          }
          
          // 🔥 추가 계약서: 모두 별도 행으로 표시
          additionalContracts.forEach((contract, index) => {
            const statusClass = contract.status === '서명완료' ? 'badge-success' : 'badge-warning';
            const createdDate = new Date(contract.createdAt);
            const dateStr = createdDate.toLocaleDateString('ko-KR');
            const timeStr = createdDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            rows.push(`
              <tr data-contract-id="${contract.id}">
                <td style="width: 120px;">
                  <strong>${contract.name}</strong>
                  <br><span class="badge" style="background: var(--info-color); color: white; font-size: 11px;">➕ 추가 계약서</span>
                </td>
                <td style="width: 100px;">${contract.data.contractType || contract.type}</td>
                <td style="width: 120px;">${contract.data.workStore || contract.data.companyName || '-'}</td>
                <td style="width: 200px;">${contract.period}</td>
                <td style="width: 150px;">${dateStr} ${timeStr}</td>
                <td style="width: 80px;"><span class="badge ${statusClass}" id="status-${contract.id}">${contract.status}</span></td>
                <td style="width: 200px;">
                  <div id="buttons-${contract.id}" style="display: flex; gap: 4px; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="viewContract('${contract.id}')">📄 보기</button>
                    ${contract.status === '서명대기' ? `<button class="btn btn-sm btn-primary" onclick="sendContractLink('${contract.id}')">📧 링크전송</button>` : ''}
                    <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="deleteContract('${contract.id}', '${contract.name}')">🗑️ 삭제</button>
                  </div>
                </td>
              </tr>
            `);
          });
        });
        
        tbody.innerHTML = rows.join('');
      } catch (error) {
        console.error('❌ 계약서 로드 실패:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">계약서를 불러오는데 실패했습니다.</td></tr>';
      }
    }
    
    // 드롭다운 변경 시 버튼 업데이트
    window.updateContractButtons = async function(selectId, contractId) {
      // 선택된 계약서 정보 가져오기 (Firestore)
      try {
        const signedContracts = signedContractsCache;
        const isSigned = signedContracts.some(sc => sc.id === contractId);
        const status = isSigned ? '서명완료' : '서명대기';
        const statusClass = status === '서명완료' ? 'badge-success' : 'badge-warning';
        
        // Firestore에서 계약서 정보 가져오기
        const docRef = await firebase.firestore().collection('contracts').doc(contractId).get();
        const contractData = docRef.exists ? docRef.data() : {};
      
        // 상태 배지 업데이트
        const statusBadge = document.getElementById(`status-${selectId.replace('contract-select-', '')}`);
        if (statusBadge) {
          statusBadge.className = `badge ${statusClass}`;
          statusBadge.textContent = status;
        }
        
        // 버튼 업데이트
        const buttonsDiv = document.getElementById(`buttons-${selectId.replace('contract-select-', '')}`);
        if (buttonsDiv) {
          const employeeName = contractData.employeeName || '';
          buttonsDiv.innerHTML = `
            <button class="btn btn-sm btn-secondary" onclick="viewContract('${contractId}')">📄 보기</button>
            ${status === '서명대기' ? `<button class="btn btn-sm btn-primary" onclick="sendContractLink('${contractId}')">📧 링크전송</button>` : ''}
            <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="deleteContract('${contractId}', '${employeeName}')">🗑️ 삭제</button>
          `;
        }
      } catch (error) {
        console.error('❌ 계약서 정보 조회 실패:', error);
      }
    };
    
    // 계약서 삭제 함수
    window.deleteContract = async function(contractId, employeeName) {
      if (!confirm(`⚠️ 정말로 "${employeeName}"님의 계약서를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        return;
      }
      
      try {
        // Firestore에서 계약서 삭제
        await firebase.firestore().collection('contracts').doc(contractId).delete();
        console.log(`✅ Firestore contracts 삭제 완료: ${contractId}`);
        
        // signedContracts Firestore에서도 제거
        await firebase.firestore().collection('signedContracts').doc(contractId).delete();
        console.log('✅ signedContracts에서도 삭제 완료');
        
        // 캐시 업데이트
        signedContractsCache = signedContractsCache.filter(sc => sc.id !== contractId);
        
        alert(`✅ "${employeeName}"님의 계약서가 삭제되었습니다.`);
        
        // 계약서 목록 새로고침
        await loadContracts();
        
        // 대시보드도 업데이트
        if (currentTab === 'dashboard') {
          loadDashboard();
        }
      } catch (error) {
        console.error('❌ 계약서 삭제 실패:', error);
        alert('❌ 계약서 삭제에 실패했습니다: ' + error.message);
      }
    };

    function loadNotice() {
      // loadNotices() 호출
      loadNotices();
    }

    // 매장 관리 함수들
    async function loadStores() {
      const tbody = document.getElementById('storesTableBody');
      
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">매장 정보를 불러오는 중...</td></tr>';
      
      try {
        // Firestore에서 매장 정보 로드
        const storesSnapshot = await firebase.firestore().collection('stores').get();
        
        let stores = [];
        storesSnapshot.forEach(doc => {
          stores.push({ id: doc.id, ...doc.data() });
        });
        
        // 기본 매장이 없으면 Firestore에 추가
        if (stores.length === 0) {
          console.log('📋 기본 매장 생성 중...');
          const defaultStores = [
            { name: '맛남살롱 부천시청점', address: '경기도 부천시 원미구', phone: '032-123-4567', ceo: '홍길동', businessNumber: '123-45-67890', salaryPaymentDay: 5 },
            { name: '맛남살롱 상동점', address: '경기도 부천시 상동', phone: '032-123-4568', ceo: '홍길동', businessNumber: '123-45-67890', salaryPaymentDay: 5 },
            { name: '맛남살롱 부천역사점', address: '경기도 부천시 부천역 인근', phone: '032-123-4569', ceo: '홍길동', businessNumber: '123-45-67890', salaryPaymentDay: 5 }
          ];
          
          for (const store of defaultStores) {
            const docRef = await firebase.firestore().collection('stores').add({
              ...store,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            stores.push({ id: docRef.id, ...store });
          }
          console.log('✅ 기본 매장 3개 생성 완료');
        }
        
        if (stores.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p style="margin-bottom: 16px;">등록된 매장이 없습니다.</p>
                <button class="btn btn-primary" onclick="showAddStoreModal()">+ 첫 매장 추가하기</button>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = stores.map(store => `
          <tr>
            <td>${store.name}</td>
            <td>${store.address || '-'}</td>
            <td>${store.phone || '-'}</td>
            <td>${store.ceo || '-'}</td>
            <td>${store.businessNumber || '-'}</td>
            <td><span style="color: var(--primary-color); font-weight: 600;">매월 ${store.salaryPaymentDay || '-'}일</span></td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="showEditStoreModal('${store.id}')">✏️ 수정</button>
            </td>
          </tr>
        `).join('');
        
        console.log(`✅ ${stores.length}개 매장 로드 완료`);
      } catch (error) {
        console.error('❌ 매장 로드 실패:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger-color);">매장 정보를 불러오는데 실패했습니다.</td></tr>';
      }
    }

    // 필터용 매장 목록 로드 (드롭다운)
    async function loadStoresForFilter(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      try {
        const snapshot = await db.collection('stores').orderBy('name').get();
        
        // 기존 옵션 유지하고 매장만 추가
        const currentValue = select.value;
        const defaultOption = select.querySelector('option[value=""]');
        select.innerHTML = '';
        if (defaultOption) {
          select.appendChild(defaultOption);
        } else {
          select.innerHTML = '<option value="">전체</option>';
        }
        
        snapshot.forEach(doc => {
          const store = doc.data();
          const option = document.createElement('option');
          option.value = store.name;
          option.textContent = store.name;
          select.appendChild(option);
        });
        
        // 이전 선택값 복원
        if (currentValue) {
          select.value = currentValue;
        }
        
        console.log(`✅ 필터용 매장 ${snapshot.size}개 로드 완료`);
      } catch (error) {
        console.error('❌ 필터용 매장 로드 실패:', error);
      }
    }

    let storeCeoSignatureData = null;

    function showAddStoreModal() {
      document.getElementById('storeModalTitle').textContent = '🏪 매장 추가';
      document.getElementById('editStoreId').value = '';
      document.getElementById('storeName').value = '';
      document.getElementById('storeAddress').value = '';
      document.getElementById('storePhone').value = '';
      document.getElementById('storeCEO').value = '';
      document.getElementById('storeBusinessNumber').value = '';
      document.getElementById('storeSalaryPaymentDay').value = '';
      
      // 계산 기간 타입 초기화 (기본값: 자동)
      document.getElementById('salaryCalculationType').value = 'prev_month_full';
      document.getElementById('customCalculationPeriod').style.display = 'none';
      document.getElementById('calculationStartMonth').value = 'prev';
      document.getElementById('calculationStartDay').value = '1';
      document.getElementById('calculationEndMonth').value = 'prev';
      document.getElementById('calculationEndDay').value = 'last';
      
      document.getElementById('deleteStoreBtn').style.display = 'none';
      
      // 수당 옵션 초기화 (기본값: 모두 미적용)
      document.getElementById('storeOvertimeAllowance').checked = false;
      document.getElementById('storeNightAllowance').checked = false;
      document.getElementById('storeHolidayAllowance').checked = false;
      
      // 서명 초기화
      storeCeoSignatureData = null;
      document.getElementById('storeCeoSignaturePreview').innerHTML = '<span style="color: #999;">서명 이미지 선택 (선택사항)</span>';
      
      document.getElementById('storeModal').style.display = 'flex';
    }

    async function showEditStoreModal(storeId) {
      try {
        // Firestore에서 매장 정보 가져오기
        const storeDoc = await firebase.firestore().collection('stores').doc(storeId).get();
        
        if (!storeDoc.exists) {
          alert('매장 정보를 찾을 수 없습니다.');
          return;
        }
        
        const store = { id: storeDoc.id, ...storeDoc.data() };
        
        document.getElementById('storeModalTitle').textContent = '🏪 매장 수정';
        document.getElementById('editStoreId').value = store.id;
        document.getElementById('storeName').value = store.name;
        document.getElementById('storeAddress').value = store.address || '';
        document.getElementById('storePhone').value = store.phone || '';
        document.getElementById('storeCEO').value = store.ceo || '';
        document.getElementById('storeBusinessNumber').value = store.businessNumber || '';
        document.getElementById('storeSalaryPaymentDay').value = store.salaryPaymentDay || '';
        
        // 계산 기간 타입 불러오기
        const calculationType = store.salaryCalculationType || 'prev_month_full';
        document.getElementById('salaryCalculationType').value = calculationType;
        
        // 사용자 지정 계산 기간 불러오기
        if (calculationType === 'custom' && store.salaryCalculationPeriod) {
          const period = store.salaryCalculationPeriod;
          document.getElementById('calculationStartMonth').value = period.startMonth || 'prev';
          document.getElementById('calculationStartDay').value = period.startDay || '1';
          document.getElementById('calculationEndMonth').value = period.endMonth || 'prev';
          document.getElementById('calculationEndDay').value = period.endDay || 'last';
          document.getElementById('customCalculationPeriod').style.display = 'block';
          updateCalculationPeriodPreview();
        } else {
          document.getElementById('customCalculationPeriod').style.display = 'none';
          // 기본값 설정
          document.getElementById('calculationStartMonth').value = 'prev';
          document.getElementById('calculationStartDay').value = '1';
          document.getElementById('calculationEndMonth').value = 'prev';
          document.getElementById('calculationEndDay').value = 'last';
        }
        
        document.getElementById('deleteStoreBtn').style.display = 'block';
        
        // 수당 옵션 불러오기
        if (store.allowances) {
          document.getElementById('storeOvertimeAllowance').checked = store.allowances.overtime || false;
          document.getElementById('storeNightAllowance').checked = store.allowances.night || false;
          document.getElementById('storeHolidayAllowance').checked = store.allowances.holiday || false;
        } else {
          // 기본값 (모두 미적용)
          document.getElementById('storeOvertimeAllowance').checked = false;
          document.getElementById('storeNightAllowance').checked = false;
          document.getElementById('storeHolidayAllowance').checked = false;
        }
        
        // 매장 운영시간 불러오기
        if (store.businessHours) {
          document.getElementById('storeOpenTime').value = store.businessHours.open || '09:00';
          document.getElementById('storeCloseTime').value = store.businessHours.close || '22:00';
        } else {
          // 기본값
          document.getElementById('storeOpenTime').value = '09:00';
          document.getElementById('storeCloseTime').value = '22:00';
        }
        
        // 출퇴근 허용시간 설정 불러오기
        if (store.attendanceThresholds) {
          document.getElementById('earlyClockInThreshold').value = store.attendanceThresholds.earlyClockIn || 15;
          document.getElementById('earlyClockOutThreshold').value = store.attendanceThresholds.earlyClockOut || 5;
          document.getElementById('overtimeThreshold').value = store.attendanceThresholds.overtime || 5;
        } else {
          // 기본값
          document.getElementById('earlyClockInThreshold').value = 15;
          document.getElementById('earlyClockOutThreshold').value = 5;
          document.getElementById('overtimeThreshold').value = 5;
        }
        
        // 서명 불러오기
        if (store.ceoSignature) {
          storeCeoSignatureData = store.ceoSignature;
          document.getElementById('storeCeoSignaturePreview').innerHTML = `<img src="${store.ceoSignature}" style="max-width: 100%; max-height: 100px; object-fit: contain;">`;
        } else {
          storeCeoSignatureData = null;
          document.getElementById('storeCeoSignaturePreview').innerHTML = '<span style="color: #999;">서명 이미지 선택 (선택사항)</span>';
        }
        
        document.getElementById('storeModal').style.display = 'flex';
      } catch (error) {
        console.error('❌ 매장 정보 로드 실패:', error);
        alert('매장 정보를 불러오는데 실패했습니다.');
      }
    }

    function closeStoreModal() {
      document.getElementById('storeModal').style.display = 'none';
    }

    // 사용자 지정 계산 기간 토글
    function toggleCustomCalculationPeriod() {
      const calculationType = document.getElementById('salaryCalculationType').value;
      const customPeriod = document.getElementById('customCalculationPeriod');
      
      if (calculationType === 'custom') {
        customPeriod.style.display = 'block';
        updateCalculationPeriodPreview();
      } else {
        customPeriod.style.display = 'none';
      }
    }
    
    // 계산 기간 미리보기 업데이트
    function updateCalculationPeriodPreview() {
      const startMonth = document.getElementById('calculationStartMonth').value;
      const startDay = document.getElementById('calculationStartDay').value;
      const endMonth = document.getElementById('calculationEndMonth').value;
      const endDay = document.getElementById('calculationEndDay').value;
      
      const startMonthText = startMonth === 'prev' ? '전월' : '당월';
      const endMonthText = endMonth === 'prev' ? '전월' : '당월';
      const endDayText = endDay === 'last' ? '말일' : `${endDay}일`;
      
      const previewText = `${startMonthText} ${startDay}일 ~ ${endMonthText} ${endDayText}`;
      document.getElementById('calculationPeriodPreview').textContent = previewText;
    }
    
    // 계산 기간 셀렉트에 이벤트 리스너 추가
    window.addEventListener('DOMContentLoaded', () => {
      const calcStartMonth = document.getElementById('calculationStartMonth');
      const calcStartDay = document.getElementById('calculationStartDay');
      const calcEndMonth = document.getElementById('calculationEndMonth');
      const calcEndDay = document.getElementById('calculationEndDay');
      
      if (calcStartMonth) calcStartMonth.addEventListener('change', updateCalculationPeriodPreview);
      if (calcStartDay) calcStartDay.addEventListener('change', updateCalculationPeriodPreview);
      if (calcEndMonth) calcEndMonth.addEventListener('change', updateCalculationPeriodPreview);
      if (calcEndDay) calcEndDay.addEventListener('change', updateCalculationPeriodPreview);
    });

    async function saveStore() {
      const storeId = document.getElementById('editStoreId').value;
      const name = document.getElementById('storeName').value.trim();
      const address = document.getElementById('storeAddress').value.trim();
      const phone = document.getElementById('storePhone').value.trim();
      const ceo = document.getElementById('storeCEO').value.trim();
      const businessNumber = document.getElementById('storeBusinessNumber').value.trim();
      
      if (!name) {
        alert('⚠️ 매장명을 입력해주세요.');
        return;
      }
      
      // 급여 지급일
      const salaryPaymentDay = document.getElementById('storeSalaryPaymentDay').value;
      if (!salaryPaymentDay) {
        alert('⚠️ 급여 지급일을 선택해주세요.');
        return;
      }
      
      // 계산 기간 타입
      const calculationType = document.getElementById('salaryCalculationType').value;
      if (!calculationType) {
        alert('⚠️ 계산 기간 타입을 선택해주세요.');
        return;
      }
      
      // 사용자 지정 계산 기간 (custom인 경우에만)
      let calculationPeriod = null;
      if (calculationType === 'custom') {
        calculationPeriod = {
          startMonth: document.getElementById('calculationStartMonth').value,
          startDay: parseInt(document.getElementById('calculationStartDay').value),
          endMonth: document.getElementById('calculationEndMonth').value,
          endDay: document.getElementById('calculationEndDay').value === 'last' ? 'last' : parseInt(document.getElementById('calculationEndDay').value)
        };
      }
      
      // 매장 운영시간
      const openTime = document.getElementById('storeOpenTime').value;
      const closeTime = document.getElementById('storeCloseTime').value;
      
      if (!openTime || !closeTime) {
        alert('⚠️ 매장 운영시간을 입력해주세요.');
        return;
      }
      
      // 수당 적용 옵션 수집
      const overtimeAllowance = document.getElementById('storeOvertimeAllowance').checked;
      const nightAllowance = document.getElementById('storeNightAllowance').checked;
      const holidayAllowance = document.getElementById('storeHolidayAllowance').checked;
      
      // 출퇴근 허용시간 설정
      const earlyClockInThreshold = parseInt(document.getElementById('earlyClockInThreshold').value) || 15;
      const earlyClockOutThreshold = parseInt(document.getElementById('earlyClockOutThreshold').value) || 5;
      const overtimeThreshold = parseInt(document.getElementById('overtimeThreshold').value) || 5;
      
      try {
        const storeData = {
          name,
          address,
          phone,
          ceo,
          businessNumber,
          businessHours: {
            open: openTime,
            close: closeTime
          },
          salaryPaymentDay: parseInt(salaryPaymentDay),
          salaryCalculationType: calculationType, // 계산 기간 타입
          salaryCalculationPeriod: calculationPeriod, // 사용자 지정 계산 기간
          ceoSignature: storeCeoSignatureData || null,
          allowances: {
            overtime: overtimeAllowance,
            night: nightAllowance,
            holiday: holidayAllowance
          },
          attendanceThresholds: {
            earlyClockIn: earlyClockInThreshold,    // 조기출근 허용시간 (분)
            earlyClockOut: earlyClockOutThreshold,  // 조기퇴근 허용시간 (분)
            overtime: overtimeThreshold             // 초과근무 최소시간 (분)
          },
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (storeId) {
          // 수정 - Firestore 업데이트
          // 기존 매장명 가져오기
          const oldStoreDoc = await firebase.firestore().collection('stores').doc(storeId).get();
          const oldStoreName = oldStoreDoc.exists ? oldStoreDoc.data().name : null;
          
          await firebase.firestore().collection('stores').doc(storeId).update(storeData);
          console.log('✅ 매장 수정 완료:', storeId);
          
          // 매장명이 변경된 경우 직원들의 매장명도 업데이트
          if (oldStoreName && oldStoreName !== name) {
            console.log(`🔄 매장명 변경: ${oldStoreName} → ${name}`);
            
            // users 컬렉션에서 해당 매장 직원 업데이트
            const usersSnapshot = await firebase.firestore().collection('users')
              .where('store', '==', oldStoreName)
              .get();
            
            const batch = firebase.firestore().batch();
            let updateCount = 0;
            
            usersSnapshot.forEach(doc => {
              batch.update(doc.ref, { store: name });
              updateCount++;
            });
            
            if (updateCount > 0) {
              await batch.commit();
              console.log(`✅ ${updateCount}명의 직원 매장명 업데이트 완료`);
            }
          }
        } else {
          // 추가 - Firestore 신규 생성
          storeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await firebase.firestore().collection('stores').add(storeData);
          console.log('✅ 매장 추가 완료:', docRef.id);
        }
        
        closeStoreModal();
        loadStores();
        
        // 서명 초기화
        storeCeoSignatureData = null;
        
        alert('✅ 매장 정보가 저장되었습니다.');
      } catch (error) {
        console.error('❌ 매장 저장 실패:', error);
        alert('매장 정보 저장에 실패했습니다.');
      }
    }

    async function deleteStore() {
      if (!confirm('⚠️ 정말 이 매장을 삭제하시겠습니까?')) {
        return;
      }
      
      const storeId = document.getElementById('editStoreId').value;
      
      if (!storeId) {
        alert('삭제할 매장을 선택해주세요.');
        return;
      }
      
      try {
        // Firestore에서 매장 삭제
        await firebase.firestore().collection('stores').doc(storeId).delete();
        console.log('✅ 매장 삭제 완료:', storeId);
        
        closeStoreModal();
        loadStores();
        alert('✅ 매장이 삭제되었습니다.');
      } catch (error) {
        console.error('❌ 매장 삭제 실패:', error);
        alert('매장 삭제에 실패했습니다.');
      }
    }

    // 공지사항 관리
    async function loadNotices() {
      const tbody = document.getElementById('noticeTableBody');
      
      if (!tbody) {
        console.error('❌ noticeTableBody 요소를 찾을 수 없음');
        return;
      }
      
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">공지사항을 불러오는 중...</td></tr>';
      
      try {
        // Firestore에서 공지사항 가져오기
        const snapshot = await firebase.firestore().collection('notices').get();
        
        const notices = [];
        snapshot.forEach(doc => {
          notices.push({ id: doc.id, ...doc.data() });
        });
        
        if (notices.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p style="margin-bottom: 16px;">등록된 공지사항이 없습니다.</p>
                <button class="btn btn-primary" onclick="showAddNoticeModal()">+ 공지사항 작성</button>
              </td>
            </tr>
          `;
          return;
        }
        
        // 클라이언트에서 최신순 정렬
        notices.sort((a, b) => {
          const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
          const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
          return dateB - dateA;
        });
        
        tbody.innerHTML = notices.map(notice => {
          // Firestore Timestamp 또는 ISO 문자열 처리
          const date = notice.createdAt ? (notice.createdAt.toDate ? notice.createdAt.toDate() : new Date(notice.createdAt)) : new Date();
          const dateStr = date.toLocaleDateString('ko-KR');
          const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
          
          return `
            <tr>
              <td>
                ${notice.important ? '<span style="color: #ff6b6b; font-weight: bold;">⭐</span> ' : ''}
                ${notice.title}
              </td>
              <td>${dateStr} ${timeStr}</td>
              <td>${notice.important ? '<span style="color: #ff6b6b;">중요</span>' : '-'}</td>
              <td>
                <button class="btn btn-sm" onclick="showEditNoticeModal('${notice.id}')">수정</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNoticeConfirm('${notice.id}')">삭제</button>
              </td>
            </tr>
          `;
        }).join('');
        
        console.log(`✅ ${notices.length}개 공지사항 로드 완료`);
      } catch (error) {
        console.error('❌ 공지사항 로드 실패:', error);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger-color);">공지사항을 불러오는데 실패했습니다.</td></tr>';
      }
    }

    function showAddNoticeModal() {
      document.getElementById('noticeModalTitle').textContent = '📢 공지사항 작성';
      document.getElementById('editNoticeId').value = '';
      document.getElementById('noticeTitle').value = '';
      document.getElementById('noticeContent').value = '';
      document.getElementById('noticeImportant').checked = false;
      document.getElementById('deleteNoticeBtn').style.display = 'none';
      document.getElementById('noticeModal').style.display = 'flex';
    }

    async function showEditNoticeModal(noticeId) {
      try {
        // Firestore에서 공지사항 가져오기
        const noticeDoc = await firebase.firestore().collection('notices').doc(noticeId).get();
        
        if (!noticeDoc.exists) {
          alert('공지사항을 찾을 수 없습니다.');
          return;
        }
        
        const notice = noticeDoc.data();
        
        document.getElementById('noticeModalTitle').textContent = '✏️ 공지사항 수정';
        document.getElementById('editNoticeId').value = noticeId;
        document.getElementById('noticeTitle').value = notice.title || '';
        document.getElementById('noticeContent').value = notice.content || '';
        document.getElementById('noticeImportant').checked = notice.important || false;
        document.getElementById('deleteNoticeBtn').style.display = 'block';
        document.getElementById('noticeModal').style.display = 'flex';
      } catch (error) {
        console.error('❌ 공지사항 로드 실패:', error);
        alert('공지사항을 불러오는데 실패했습니다.');
      }
    }

    function closeNoticeModal() {
      document.getElementById('noticeModal').style.display = 'none';
    }

    async function saveNotice() {
      const noticeId = document.getElementById('editNoticeId').value;
      const title = document.getElementById('noticeTitle').value.trim();
      const content = document.getElementById('noticeContent').value.trim();
      const important = document.getElementById('noticeImportant').checked;
      
      if (!title) {
        alert('⚠️ 제목을 입력해주세요.');
        return;
      }
      
      if (!content) {
        alert('⚠️ 내용을 입력해주세요.');
        return;
      }
      
      try {
        const noticeData = {
          title,
          content,
          important
        };
        
        if (noticeId) {
          // 수정 - Firestore 업데이트
          noticeData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          await firebase.firestore().collection('notices').doc(noticeId).update(noticeData);
          console.log('✅ 공지사항 수정 완료:', noticeId);
        } else {
          // 추가 - Firestore 신규 생성
          noticeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await firebase.firestore().collection('notices').add(noticeData);
          console.log('✅ 공지사항 추가 완료:', docRef.id);
        }
        
        closeNoticeModal();
        loadNotices();
        alert('✅ 공지사항이 저장되었습니다.');
      } catch (error) {
        console.error('❌ 공지사항 저장 실패:', error);
        alert('공지사항 저장에 실패했습니다.');
      }
    }

    async function deleteNoticeConfirm(noticeId) {
      if (!confirm('⚠️ 정말 이 공지사항을 삭제하시겠습니까?')) {
        return;
      }
      
      try {
        // Firestore에서 삭제
        await firebase.firestore().collection('notices').doc(noticeId).delete();
        console.log('✅ 공지사항 삭제 완료:', noticeId);
        
        loadNotices();
        alert('✅ 공지사항이 삭제되었습니다.');
      } catch (error) {
        console.error('❌ 공지사항 삭제 실패:', error);
        alert('공지사항 삭제에 실패했습니다.');
      }
    }

    function deleteNotice() {
      const noticeId = document.getElementById('editNoticeId').value;
      deleteNoticeConfirm(noticeId);
      closeNoticeModal();
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // 특정 직원을 위한 계약서 작성 페이지 열기
    function openContractPageForEmployee(uid, name, birth, phone, address) {
      console.log('📝 특정 직원 계약서 작성:', name);
      
      // 계약서 모달 열기
      openContractPage();
      
      // 직원 정보 자동 입력
      setTimeout(() => {
        document.getElementById('employeeName').value = name;
        document.getElementById('employeeBirth').value = birth;
        document.getElementById('employeePhone').value = phone;
        document.getElementById('employeeAddress').value = address;
        
        // employeeSelect는 숨기거나 readonly로 설정
        const employeeSelect = document.getElementById('employeeSelect');
        if (employeeSelect) {
          employeeSelect.value = ''; // 선택 안함
          employeeSelect.style.display = 'none'; // 숨김
        }
        
        console.log('✅ 직원 정보 자동 입력 완료');
      }, 500);
    }

    // 계약서 확인 모달 관련 변수
    let currentEmployeeContractsData = null;

    // 계약서 확인 모달 열기
    async function viewEmployeeContracts(uid, name, birth, phone, address) {
      console.log('📄 계약서 확인:', name);
      
      // 직원 정보 저장
      currentEmployeeContractsData = { uid, name, birth, phone, address };
      
      // 모달 열기
      const modal = document.getElementById('employeeContractsModal');
      modal.style.display = 'flex';
      
      // 직원 이름 표시
      document.getElementById('employeeContractsName').textContent = name;
      
      // 계약서 목록 로드
      await loadEmployeeContractsList(name, birth);
    }

    // 계약서 확인 모달 닫기
    function closeEmployeeContractsModal() {
      document.getElementById('employeeContractsModal').style.display = 'none';
      currentEmployeeContractsData = null;
    }

    // 계약서 목록 로드
    async function loadEmployeeContractsList(name, birth) {
      const listContainer = document.getElementById('employeeContractsList');
      listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">📂 계약서를 불러오는 중...</div>';
      
      try {
        const snapshot = await firebase.firestore().collection('contracts')
          .where('employeeName', '==', name)
          .where('employeeBirth', '==', birth)
          .get();
        
        if (snapshot.empty) {
          listContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
              <p style="margin-bottom: 16px;">📭 저장된 계약서가 없습니다.</p>
              <button class="btn btn-primary" onclick="createNewContractForEmployee()">➕ 첫 계약서 작성하기</button>
            </div>
          `;
          return;
        }
        
        // 계약서 목록 표시
        const contracts = [];
        snapshot.forEach(doc => {
          contracts.push({ id: doc.id, ...doc.data() });
        });
        
        // 생성일 기준 최신순 정렬
        contracts.sort((a, b) => {
          const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return bTime - aTime;
        });
        
        let html = '';
        contracts.forEach((contract, index) => {
          const createdDate = contract.createdAt ? new Date(contract.createdAt).toLocaleDateString('ko-KR') : '날짜 정보 없음';
          
          // 급여 타입과 금액 (실제 저장된 필드명 사용)
          const wageType = contract.salaryType || contract.wageType || '시급';
          const wageAmount = contract.salaryAmount || contract.wageAmount || 0;
          
          const wageAmountText = wageAmount ? parseInt(wageAmount).toLocaleString() : '0';
          const contractPeriod = `${contract.contractStartDate || ''} ~ ${contract.contractEndDate || ''}`;
          const isLatest = index === 0;
          
          html += `
            <div class="card" style="padding: var(--spacing-lg); cursor: pointer; transition: all 0.2s;" 
                 onclick="viewContractDetail('${contract.id}')"
                 onmouseover="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 4px 12px rgba(79, 70, 229, 0.1)';"
                 onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                <div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <h4 style="margin: 0;">📄 근로계약서 #${contracts.length - index}</h4>
                    ${isLatest ? '<span class="badge" style="background: var(--success-color);">최신</span>' : ''}
                  </div>
                  <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">생성일: ${createdDate}</p>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewContractDetail('${contract.id}')">
                    👁️ 상세보기
                  </button>
                  <button class="btn btn-sm" style="background: var(--danger-color); color: white;" onclick="event.stopPropagation(); deleteContract('${contract.id}', '${name}', '${birth}')">
                    🗑️ 삭제
                  </button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                <div>
                  <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 4px 0;">급여 유형</p>
                  <p style="font-weight: 600; margin: 0;">${wageType}: ${wageAmountText}원</p>
                </div>
                <div>
                  <p style="color: var(--text-secondary); font-size: 13px; margin: 0 0 4px 0;">계약 기간</p>
                  <p style="font-weight: 600; margin: 0; font-size: 13px;">${contractPeriod}</p>
                </div>
              </div>
            </div>
          `;
        });
        
        listContainer.innerHTML = html;
        console.log(`✅ 계약서 ${contracts.length}건 로드 완료`);
        
      } catch (error) {
        console.error('❌ 계약서 목록 로드 오류:', error);
        listContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger-color);">
            ❌ 계약서를 불러오는 중 오류가 발생했습니다.<br>
            ${error.message}
          </div>
        `;
      }
    }

    // 계약서 삭제
    async function deleteContract(contractId, employeeName, employeeBirth) {
      // 확인 메시지
      if (!confirm(`⚠️ 정말로 이 계약서를 삭제하시겠습니까?\n\n삭제된 계약서는 복구할 수 없습니다.\n직원용 페이지에서도 삭제됩니다.`)) {
        return;
      }
      
      try {
        console.log('🗑️ 계약서 삭제 시작:', contractId);
        
        // Firestore에서 계약서 삭제
        await firebase.firestore().collection('contracts').doc(contractId).delete();
        
        console.log('✅ 계약서 삭제 완료:', contractId);
        alert('✅ 계약서가 삭제되었습니다.');
        
        // 계약서 목록 새로고침
        await loadEmployeeContractsList(employeeName, employeeBirth);
        
      } catch (error) {
        console.error('❌ 계약서 삭제 실패:', error);
        alert('❌ 계약서 삭제에 실패했습니다.\n\n' + error.message);
      }
    }

    // 계약서 상세 보기
    async function viewContractDetail(contractId) {
      console.log('📄 계약서 상세 보기:', contractId);
      
      // 계약서 확인 모달 닫기
      closeEmployeeContractsModal();
      
      // 계약서 보기 모달 열기 (계약서 관리 탭의 viewContract 함수 호출)
      await viewContract(contractId);
    }

    // 새 계약서 작성 (계약서 확인 모달에서)
    function createNewContractForEmployee() {
      if (!currentEmployeeContractsData) {
        alert('⚠️ 직원 정보가 없습니다.');
        return;
      }
      
      // 계약서 확인 모달 닫기
      closeEmployeeContractsModal();
      
      // 계약서 관리 탭으로 이동
      switchTab('contracts');
      
      // 계약서 작성 모달 열기
      setTimeout(() => {
        const { uid, name, birth, phone, address } = currentEmployeeContractsData;
        openContractPageForEmployee(uid, name, birth, phone, address);
      }, 300);
    }

    // 계약서 작성 모달 열기/닫기
    function openContractPage() {
      console.log('🚀 계약서 모달 열기');
      
      // 🔥 일반 계약서 모드 (추가 계약서 아님)
      isAdditionalContractMode = false;
      
      const modal = document.getElementById('contractModal');
      if (!modal) {
        console.error('❌ contractModal을 찾을 수 없습니다');
        return;
      }
      
      // 모달 표시
      modal.style.display = 'flex';
      
      // 작성하기 탭 강제 활성화
      const formTab = document.getElementById('formTab');
      const formTabBtn = document.getElementById('formTabBtn');
      const previewTab = document.getElementById('previewTab');
      const previewTabBtn = document.getElementById('previewTabBtn');
      
      console.log('📍 탭 요소 확인:', { formTab, formTabBtn, previewTab, previewTabBtn });
      
      if (formTab && formTabBtn) {
        formTab.classList.add('active');
        formTab.style.display = 'block'; // 강제 표시
        formTabBtn.classList.add('active');
        console.log('✅ 작성하기 탭 활성화');
      }
      
      if (previewTab && previewTabBtn) {
        previewTab.classList.remove('active');
        previewTab.style.display = 'none';
        previewTabBtn.classList.remove('active');
      }
      
      // 모달이 화면에 렌더링될 때까지 대기
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          console.log('✅ 모달 렌더링 완료, 초기화 시작');
          
          // 폼 컨텐츠 가시성 재확인
          const formTabCheck = document.getElementById('formTab');
          if (formTabCheck) {
            const computedStyle = window.getComputedStyle(formTabCheck);
            console.log('📊 formTab computed display:', computedStyle.display);
            console.log('📊 formTab classList:', formTabCheck.classList.toString());
          }
          
          initializeContractFormNow();
        });
      });
    }
    
    function initializeContractFormNow() {
      console.log('📝 계약서 폼 강제 초기화 시작');
      
      // formTab 최종 확인
      const formTab = document.getElementById('formTab');
      if (formTab) {
        console.log('✅ formTab 발견, 내부 HTML 길이:', formTab.innerHTML.length);
        console.log('📊 formTab 첫 100자:', formTab.innerHTML.substring(0, 100));
      } else {
        console.error('❌ formTab을 찾을 수 없음!');
        return;
      }
      
      // 오늘 날짜
      const today = new Date().toISOString().split('T')[0];
      const startDateEl = document.getElementById('startDate');
      if (startDateEl) {
        startDateEl.value = today;
        console.log('✅ 시작일 설정:', today);
      } else {
        console.error('❌ startDate 요소를 찾을 수 없음');
      }
      
      // 시간 드롭다운
      const startHourEl = document.querySelector('.schedule-start-hour');
      const startMinuteEl = document.querySelector('.schedule-start-minute');
      const endHourEl = document.querySelector('.schedule-end-hour');
      const endMinuteEl = document.querySelector('.schedule-end-minute');
      
      console.log('시간 요소 확인:', { startHourEl, startMinuteEl, endHourEl, endMinuteEl });
      
      if (startHourEl && startMinuteEl && endHourEl && endMinuteEl) {
        // 시 옵션
        for (let i = 0; i <= 23; i++) {
          const h = String(i).padStart(2, '0');
          startHourEl.innerHTML += `<option value="${i}">${h}시</option>`;
          endHourEl.innerHTML += `<option value="${i}">${h}시</option>`;
        }
        
        // 분 옵션
        for (let i = 0; i <= 59; i++) {
          const m = String(i).padStart(2, '0');
          startMinuteEl.innerHTML += `<option value="${i}">${m}분</option>`;
          endMinuteEl.innerHTML += `<option value="${i}">${m}분</option>`;
        }
        
        // 디폴트: 00분 선택
        startMinuteEl.value = '0';
        endMinuteEl.value = '0';
        
        console.log('✅ 근무시간 드롭다운 초기화 완료 (분 디폴트: 00분)');
      } else {
        console.error('❌ 근무시간 드롭다운 요소를 찾을 수 없음');
      }
      
      // 휴게시간
      const breakStartHour = document.getElementById('breakStartHour');
      const breakStartMinute = document.getElementById('breakStartMinute');
      const breakEndHour = document.getElementById('breakEndHour');
      const breakEndMinute = document.getElementById('breakEndMinute');
      
      if (breakStartHour && breakStartMinute && breakEndHour && breakEndMinute) {
        for (let i = 0; i <= 23; i++) {
          const h = String(i).padStart(2, '0');
          breakStartHour.innerHTML += `<option value="${i}">${h}시</option>`;
          breakEndHour.innerHTML += `<option value="${i}">${h}시</option>`;
        }
        
        for (let i = 0; i <= 59; i++) {
          const m = String(i).padStart(2, '0');
          breakStartMinute.innerHTML += `<option value="${i}">${m}분</option>`;
          breakEndMinute.innerHTML += `<option value="${i}">${m}분</option>`;
        }
        
        // 디폴트: 00분 선택
        breakStartMinute.value = '0';
        breakEndMinute.value = '0';
        
        console.log('✅ 휴게시간 드롭다운 초기화 완료 (분 디폴트: 00분)');
      }
      
      // 직원 목록 - Firestore users 컬렉션에서 로드 (재직자만)
      const employeeSelect = document.getElementById('employeeSelect');
      if (employeeSelect) {
        employeeSelect.innerHTML = '<option value="">직원을 선택하세요</option>';
        
        // Firestore에서 직원 목록 가져오기 (users 컬렉션, userType === 'employee', resigned 제외)
        firebase.firestore().collection('users')
          .where('userType', '==', 'employee')
          .get()
          .then(snapshot => {
            if (!snapshot.empty) {
              let activeCount = 0;
              snapshot.forEach(doc => {
                const emp = doc.data();
                // resigned 상태 제외 (재직자만 표시)
                if (emp.status !== 'resigned') {
                  const displayName = `${emp.name} (${emp.store || '매장미지정'}) - ${emp.phone}`;
                  employeeSelect.innerHTML += `<option value="${doc.id}">${displayName}</option>`;
                  activeCount++;
                }
              });
              console.log(`✅ ${activeCount}명의 재직 직원 목록 로드 완료 (전체 ${snapshot.size}명 중 resigned 제외)`);
              
              if (activeCount === 0) {
                console.log('📋 재직 중인 직원이 없습니다');
                employeeSelect.innerHTML += '<option value="" disabled>재직 중인 직원이 없습니다</option>';
              }
            } else {
              console.log('📋 등록된 직원이 없습니다');
              employeeSelect.innerHTML += '<option value="" disabled>등록된 직원이 없습니다</option>';
            }
          })
          .catch(error => {
            console.error('❌ 직원 목록 로드 실패:', error);
            employeeSelect.innerHTML += '<option value="" disabled>직원 목록 로드 실패</option>';
          });
      }
      
      // 회사 목록 - Firestore에서만 가져오기
      const storeSelect = document.getElementById('storeSelect');
      if (storeSelect) {
        storeSelect.innerHTML = '<option value="">매장을 선택하세요</option>';
        
        // Firestore에서 매장 목록 가져오기
        firebase.firestore().collection('stores')
          .get()
          .then(snapshot => {
            if (!snapshot.empty) {
              const stores = [];
              snapshot.forEach(doc => {
                const store = { id: doc.id, ...doc.data() };
                stores.push(store);
                storeSelect.innerHTML += `<option value="${doc.id}">${store.name}</option>`;
              });
              
              // 첫 번째 매장 자동 선택
              if (stores.length > 0) {
                storeSelect.value = stores[0].id;
                // 매장 정보 자동 입력
                const store = stores[0];
                document.getElementById('companyCEO').value = store.ceo || '';
                document.getElementById('companyBusinessNumber').value = store.businessNumber || '';
                document.getElementById('companyPhone').value = store.phone || '';
                document.getElementById('companyAddress').value = store.address || '';
                document.getElementById('workStore').value = store.name || '';
                
                // 급여 지급일 자동 입력
                if (store.salaryPaymentDay) {
                  const paymentDay = store.salaryPaymentDay;
                  const paymentDaySelect = document.getElementById('paymentDay');
                  
                  // 지급일 텍스트 생성 (5일 → "매월 5일", 28일 → "매월 말일")
                  let paymentDayText = '';
                  if (paymentDay === 28) {
                    paymentDayText = '매월 말일';
                  } else {
                    paymentDayText = `매월 ${paymentDay}일`;
                  }
                  
                  // option이 있는지 확인하고 없으면 추가
                  let optionExists = false;
                  for (let i = 0; i < paymentDaySelect.options.length; i++) {
                    if (paymentDaySelect.options[i].value === paymentDayText) {
                      optionExists = true;
                      break;
                    }
                  }
                  
                  if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = paymentDayText;
                    newOption.textContent = paymentDayText;
                    paymentDaySelect.appendChild(newOption);
                  }
                  
                  // 값 설정
                  paymentDaySelect.value = paymentDayText;
                  console.log('📅 급여 지급일 자동 입력:', paymentDayText);
                }
                
                // 매장 수당 설정 자동 적용
                const allowances = store.allowances || {};
                console.log('💰 매장 수당 설정 자동 적용:', allowances);
                const overtimeCheckbox = document.getElementById('allowOvertime');
                const nightCheckbox = document.getElementById('allowNight');
                const holidayCheckbox = document.getElementById('allowHoliday');
                if (overtimeCheckbox) overtimeCheckbox.checked = allowances.overtime || false;
                if (nightCheckbox) nightCheckbox.checked = allowances.night || false;
                if (holidayCheckbox) holidayCheckbox.checked = allowances.holiday || false;
                
                console.log('✅ 매장 정보 자동 입력 완료:', store.name);
              }
              
              console.log(`✅ ${stores.length}개 매장 목록 로드 완료 (계약서 폼)`);
            } else {
              console.log('📋 등록된 매장이 없습니다');
              storeSelect.innerHTML += '<option value="" disabled>등록된 매장이 없습니다</option>';
            }
          })
          .catch(error => {
            console.error('❌ 매장 목록 로드 실패:', error);
            storeSelect.innerHTML += '<option value="" disabled>매장 목록 로드 실패</option>';
          });
      }
      
      // 기본 템플릿
      const contentEl = document.getElementById('contractContent');
      if (contentEl) {
        const template = `제1조 (근로계약 기간)
본 계약의 기간은 위 표에 명시된 바와 같다.

제2조 (근무 장소 및 업무 내용)
근로자는 위 표에 명시된 근무 장소에서 명시된 업무를 수행한다.

제3조 (근로시간 및 휴게시간)
1. 근로시간은 위 표에 명시된 바와 같다.
2. 휴게시간은 근로시간 중 위 표에 명시된 바와 같다.

제4조 (근무일 및 휴일)
1. 근무일은 위 표에 명시된 바와 같다.
2. 주휴일은 근로기준법에 따라 부여한다.

제5조 (임금)
1. 근로자의 임금은 위 표에 명시된 바와 같다.
2. 임금은 위 표에 명시된 지급일에 지급한다.
3. 연장·야간·휴일 근로 시에는 근로기준법에 따라 가산임금을 지급한다.

제6조 (연차유급휴가)
연차유급휴가는 근로기준법에 따라 부여한다.

제7조 (사회보험 가입)
사용자는 근로자를 4대 사회보험에 가입시킨다.

제8조 (계약의 해지)
1. 본 계약을 해지하고자 할 때는 30일 전에 예고하여야 한다.
2. 해고 예고 기간을 두지 않을 경우 30일분의 통상임금을 지급한다.

제9조 (기타)
이 계약서에 명시되지 않은 사항은 근로기준법 및 관계 법령에 따른다.`;
        
        contentEl.value = template;
        console.log('✅ 기본 템플릿 로드 완료');
      }
      
      console.log('🎉 모든 초기화 완료!');
    }
    
    function closeContractModal() {
      if (confirm('작성 중인 내용이 저장되지 않을 수 있습니다.\n닫으시겠습니까?')) {
        document.getElementById('contractModal').style.display = 'none';
        // 🔥 추가 계약서 모드 초기화
        isAdditionalContractMode = false;
      }
    }
    
    function resetContractForm() {
      document.getElementById('contractFormTab').querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'date' && el.id === 'startDate') {
          el.value = new Date().toISOString().split('T')[0];
        } else if (el.tagName === 'TEXTAREA' && el.id === 'contractContent') {
          loadDefaultTemplate();
        } else {
          el.value = '';
        }
      });
      document.getElementById('signLinkSection').style.display = 'none';
      switchContractTab('form');
    }
    
    // 4대보험 정보 업데이트
    function updateInsuranceInfo() {
      const insuranceType = document.getElementById('insuranceType').value;
      const infoDiv = document.getElementById('insuranceInfo');
      const infoP = infoDiv.querySelector('p');
      
      if (!insuranceType) {
        infoDiv.style.display = 'none';
        return;
      }
      
      let infoText = '';
      if (insuranceType === 'all') {
        infoText = '📋 공제 항목: 국민연금 4.5% + 건강보험 3.545% + 장기요양 0.459% + 고용보험 0.9% + 소득세 약 3.3%';
      } else if (insuranceType === 'employment_only') {
        infoText = '📋 공제 항목: 고용보험 0.9% + 산재보험(사업주 부담) + 소득세 약 3.3%';
      } else if (insuranceType === 'freelancer') {
        infoText = '📋 공제 항목: 소득세 3.3%만 적용 (프리랜서 세율)';
      } else if (insuranceType === 'none') {
        infoText = '📋 공제 항목: 없음 (세금 및 보험 전혀 적용 안 함)';
      }
      
      infoP.textContent = infoText;
      infoDiv.style.display = 'block';
    }
    
    // 매장 선택 시 수당 자동 체크 (매장 설정 기반)
    async function applyStoreAllowances(storeName) {
      if (!storeName) return;
      
      try {
        // Firestore에서 매장 정보 조회
        const snapshot = await db.collection('stores')
          .where('name', '==', storeName)
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          const store = snapshot.docs[0].data();
          const allowances = store.allowances || {};
          
          // 매장 설정에 따라 수당 체크박스 자동 설정
          document.getElementById('allowOvertime').checked = allowances.overtime || false;
          document.getElementById('allowNight').checked = allowances.night || false;
          document.getElementById('allowHoliday').checked = allowances.holiday || false;
          
          console.log('✅ 매장 수당 설정 적용:', storeName, allowances);
        }
      } catch (error) {
        console.error('❌ 매장 수당 설정 로드 실패:', error);
      }
    }
  </script>
  
  <!-- 계약서 전용 JavaScript (모든 코드 인라인) -->
  <script>
    // ===================================================================
    // config.js - 설정 및 디버그 함수
    // ===================================================================
    
    const CONFIG = {
      APPS_SCRIPT_URL: 'YOUR_APPS_SCRIPT_URL_HERE',
      STORES: [
        { id: 'busan_city', name: '부천시청점', address: '경기도 부천시 원미구' },
        { id: 'sangdong', name: '상동점', address: '경기도 부천시 상동' },
        { id: 'bucheon_station', name: '부천역사점', address: '경기도 부천시 역곡동' }
      ],
      WORK_TYPES: [
        { id: 'regular', name: '정규근무', color: '#4CAF50' },
        { id: 'overtime', name: '초과근무', color: '#FF9800' },
        { id: 'substitute', name: '대타근무', color: '#2196F3' }
      ],
      ATTENDANCE_STATUS: [
        { id: 'normal', name: '정상', color: '#4CAF50' },
        { id: 'late', name: '지각', color: '#FF9800' },
        { id: 'early', name: '조퇴', color: '#FFC107' },
        { id: 'absent', name: '결근', color: '#F44336' }
      ],
      EMPLOYMENT_TYPES: [
        { id: 'hourly', name: '시급제' },
        { id: 'monthly', name: '월급제' }
      ],
      CONTRACT_TYPES: [
        { id: 'fulltime', name: '정규직 근로계약서', template: 'template_fulltime' },
        { id: 'parttime', name: '시간제 근로계약서', template: 'template_parttime' },
        { id: 'intern', name: '인턴 근로계약서', template: 'template_intern' },
        { id: 'temporary', name: '임시직 근로계약서', template: 'template_temporary' }
      ],
      INSURANCE_RATES: {
        national_pension: 0.045,
        health_insurance: 0.03545,
        long_term_care: 0.004591,
        employment_insurance: 0.009
      },
      FREELANCE_TAX_RATE: 0.033,
      TARDINESS_THRESHOLD: 1,
      EARLY_LEAVE_THRESHOLD: 1,
      WEEKLY_HOLIDAY_PAY: {
        MIN_WEEKLY_HOURS: 15,
        WEEKLY_HOURS: 40
      },
      RETIREMENT_PAY: {
        MIN_MONTHS: 12,
        AVERAGE_MONTHS: 3
      },
      PAGINATION: {
        DEFAULT_PAGE_SIZE: 20,
        PAGE_SIZE_OPTIONS: [10, 20, 50, 100]
      },
      STORAGE_KEYS: {
        USER_INFO: 'matnamsalon_user',
        CURRENT_ROLE: 'matnamsalon_role',
        LAST_LOGIN: 'matnamsalon_last_login'
      },
      DATE_FORMAT: {
        DISPLAY: 'YYYY-MM-DD',
        DATETIME_DISPLAY: 'YYYY-MM-DD HH:mm:ss',
        TIME_DISPLAY: 'HH:mm'
      },
      API_TIMEOUT: 30000,
      AUTO_CONFIRM_TIME: '00:00',
      DATA_RETENTION_YEARS: 2,
      DEBUG_MODE: true
    };

    function getConfig(key) {
      const keys = key.split('.');
      let value = CONFIG;
      
      for (const k of keys) {
        if (value && typeof value === 'object' && k in value) {
          value = value[k];
        } else {
          console.warn(`[미검증] 설정 키를 찾을 수 없음: ${key}`);
          return null;
        }
      }
      
      return value;
    }

    function isConfigured() {
      return CONFIG.APPS_SCRIPT_URL && CONFIG.APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL_HERE';
    }

    function debugLog(...args) {
      if (CONFIG.DEBUG_MODE) {
        console.log('[DEBUG]', ...args);
      }
    }

    // ===================================================================
    // utils.js - 유틸리티 함수 (contract.js에서 필요한 것만)
    // ===================================================================

    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      if (isNaN(d.getTime())) return '';
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateTime(date) {
      if (!date) return '';
      const d = new Date(date);
      if (isNaN(d.getTime())) return '';
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const seconds = String(d.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    function formatTime(date) {
      if (!date) return '';
      const d = new Date(date);
      if (isNaN(d.getTime())) return '';
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function parseTime(timeStr, baseDate = new Date()) {
      if (!timeStr) return null;
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(baseDate);
      date.setHours(hours, minutes, 0, 0);
      return date;
    }

    function getMinutesDifference(startTime, endTime) {
      const start = new Date(startTime);
      const end = new Date(endTime);
      if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
      return Math.round((end - start) / (1000 * 60));
    }

    function getHoursDifference(startTime, endTime) {
      const minutes = getMinutesDifference(startTime, endTime);
      return parseFloat((minutes / 60).toFixed(2));
    }

    function formatMinutesToHourMin(minutes) {
      if (!minutes || minutes < 0) return '0분';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      if (hours === 0) return `${mins}분`;
      if (mins === 0) return `${hours}시간`;
      return `${hours}시간 ${mins}분`;
    }

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '0';
      return Math.round(num).toLocaleString('ko-KR');
    }

    function formatCurrency(amount) {
      return `${formatNumber(amount)}원`;
    }

    function extractNumber(str) {
      if (!str) return 0;
      const num = String(str).replace(/[^\d.-]/g, '');
      return parseFloat(num) || 0;
    }

    function isEmpty(value) {
      return value === null || value === undefined || value === '' || 
             (Array.isArray(value) && value.length === 0) ||
             (typeof value === 'object' && Object.keys(value).length === 0);
    }

    function generateId(prefix = '') {
      const timestamp = Date.now().toString(36);
      const random = Math.random().toString(36).substring(2, 9);
      return prefix ? `${prefix}_${timestamp}_${random}` : `${timestamp}_${random}`;
    }

    function getUrlParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // ===================================================================
    // contract.js - 계약서 작성 시스템 (전체 코드)
    // ===================================================================

    // 전역 변수
    let companies = [];
    let savedContracts = [];
    let signedContractsCache = []; // Firestore signedContracts 캐시

    // 더미 직원 데이터 (contract.js용 - 기존 DUMMY_EMPLOYEES와 동일인물)
    const CONTRACT_DUMMY_EMPLOYEES = [
      { id: '1', name: '김민수', birth: '1990-03-15', address: '경기도 부천시 원미구', phone: '010-1234-5678' },
    ];

    // 초기화 함수
    function initializeContractForm() {
      console.log('📝 계약서 폼 초기화');
      
      const today = new Date().toISOString().split('T')[0];
      const startDateEl = document.getElementById('startDate');
      if (startDateEl) startDateEl.value = today;
      
      initializeTimeDropdowns();
      loadEmployeeList();
      loadCompanyList();
      loadDefaultTemplate();
    }

    // 탭 전환 함수 - switchContractTab로 변경하여 기존 switchTab과 충돌 방지
    function switchContractTab(tabName) {
      console.log('🔄 계약서 탭 전환 요청:', tabName);
      
      if (tabName === 'preview') {
        if (!validateForm()) {
          console.log('❌ 유효성 검사 실패');
          return;
        }
        updatePreview();
      }
      
      const formTab = document.getElementById('formTab');
      const formTabBtn = document.getElementById('formTabBtn');
      const previewTab = document.getElementById('previewTab');
      const previewTabBtn = document.getElementById('previewTabBtn');
      
      // 모든 탭 비활성화
      formTabBtn.classList.remove('active');
      previewTabBtn.classList.remove('active');
      formTab.classList.remove('active');
      previewTab.classList.remove('active');
      
      if (tabName === 'form') {
        formTabBtn.classList.add('active');
        formTab.classList.add('active');
        formTab.style.display = 'block';  // 명시적 표시
        previewTab.style.display = 'none';  // 명시적 숨김
        console.log('✅ 작성하기 탭 활성화');
      } else if (tabName === 'preview') {
        previewTabBtn.classList.add('active');
        previewTab.classList.add('active');
        previewTab.style.display = 'block';  // 명시적 표시
        formTab.style.display = 'none';  // 명시적 숨김
        console.log('✅ 미리보기 탭 활성화');
        
        // 미리보기 탭 맨 위로 스크롤
        setTimeout(() => {
          const modalBody = document.querySelector('#contractModal .modal-body');
          if (modalBody) modalBody.scrollTop = 0;
        }, 50);
      }
    }

    // 직원 정보
    async function loadEmployeeList() {
      console.log('👥 직원 목록 로드 시작 (Firestore)');
      const select = document.getElementById('employeeSelect');
      console.log('employeeSelect 요소:', select);
      if (!select) {
        console.error('❌ employeeSelect 요소를 찾을 수 없습니다!');
        return;
      }
      select.innerHTML = '<option value="">새 직원 (직접 입력)</option>';
      
      try {
        // Firestore에서 계약서 가져오기
        const snapshot = await firebase.firestore().collection('contracts').get();
        const employeeMap = new Map();
        
        snapshot.forEach(doc => {
          const contractData = doc.data();
          const empKey = contractData.employeeName + '_' + contractData.employeeBirth;
          
          if (!employeeMap.has(empKey)) {
            employeeMap.set(empKey, {
              id: empKey,
              name: contractData.employeeName,
              birth: contractData.employeeBirth,
              address: contractData.employeeAddress,
              phone: contractData.employeePhone
            });
          }
        });
        
        const employees = Array.from(employeeMap.values());
        
        if (employees.length === 0) {
          CONTRACT_DUMMY_EMPLOYEES.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name} (${emp.phone})`;
            select.appendChild(option);
          });
        } else {
          employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.name} (${emp.phone})`;
            select.appendChild(option);
          });
        }
        
        console.log(`✅ 직원 ${employees.length}명 로드 완료`);
      } catch (error) {
        console.error('❌ 직원 목록 로드 실패:', error);
        // 오류 발생 시 더미 데이터 사용
        CONTRACT_DUMMY_EMPLOYEES.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.id;
          option.textContent = `${emp.name} (${emp.phone})`;
          select.appendChild(option);
        });
      }
    }

    /**
     * 주민번호를 생년월일(YYYY-MM-DD)로 변환
     * @param {string} ssn - 주민등록번호 (YYMMDD-******* 형식)
     * @returns {string} YYYY-MM-DD 형식의 생년월일
     */
    function convertSSNtoBirthDate(ssn) {
      if (!ssn || ssn.length < 6) return '';
      
      // 주민번호 앞 6자리 추출 (YYMMDD)
      const ssnFront = ssn.replace(/-/g, '').substring(0, 6);
      const yy = parseInt(ssnFront.substring(0, 2));
      const mm = ssnFront.substring(2, 4);
      const dd = ssnFront.substring(4, 6);
      
      // 뒷자리 첫번째 숫자로 세기 판단 (1,2: 1900년대, 3,4: 2000년대)
      const genderDigit = ssn.replace(/-/g, '').charAt(6);
      let yyyy;
      
      if (genderDigit === '1' || genderDigit === '2') {
        yyyy = 1900 + yy;
      } else if (genderDigit === '3' || genderDigit === '4') {
        yyyy = 2000 + yy;
      } else {
        // 기본값: 1900년대로 가정
        yyyy = 1900 + yy;
      }
      
      return `${yyyy}-${mm}-${dd}`;
    }

    async function loadEmployeeInfo() {
      const employeeSelect = document.getElementById('employeeSelect');
      
      // employeeSelect가 없으면 조용히 리턴
      if (!employeeSelect) {
        console.log('ℹ️ employeeSelect 요소를 찾을 수 없음 (아직 모달이 열리지 않음)');
        return;
      }
      
      const employeeId = employeeSelect.value;
      
      if (!employeeId) {
        document.getElementById('employeeName').value = '';
        document.getElementById('employeeBirth').value = '';
        document.getElementById('employeeAddress').value = '';
        document.getElementById('employeePhone').value = '';
        document.getElementById('employeeName').readOnly = false;
        return;
      }
      
      try {
        console.log('📋 직원 정보 로드:', employeeId);
        
        // Firestore users 컬렉션에서 직원 정보 가져오기
        const doc = await firebase.firestore().collection('users').doc(employeeId).get();
        
        if (doc.exists) {
          const employee = doc.data();
          
          document.getElementById('employeeName').value = employee.name || '';
          document.getElementById('employeeAddress').value = employee.address || '';
          document.getElementById('employeePhone').value = employee.phone || '';
          document.getElementById('employeeName').readOnly = true;
          
          // 주민번호 자동 입력
          if (employee.birth) {
            document.getElementById('employeeBirth').value = employee.birth;
            console.log('✅ 주민번호 자동 입력:', employee.birth);
          }
          
          console.log('✅ 직원 정보 로드 완료:', employee.name);
          updatePreview(); // 미리보기 업데이트
        } else {
          console.error('❌ 직원 정보를 찾을 수 없음');
          alert('직원 정보를 찾을 수 없습니다.');
        }
      } catch (error) {
        console.error('❌ 직원 정보 로드 실패:', error);
        alert('직원 정보를 불러오는데 실패했습니다: ' + error.message);
      }
    }

    // 회사 정보 - 더 이상 사용하지 않음 (stores로 통합)
    function loadCompanyList() {
      console.log('ℹ️ loadCompanyList는 더 이상 사용되지 않습니다. stores를 사용하세요.');
      // companies는 제거됨 - stores Firestore 사용
    }

    async function loadStoreInfoToContract() {
      const storeSelect = document.getElementById('storeSelect');
      if (!storeSelect) {
        console.log('ℹ️ storeSelect 요소를 찾을 수 없음');
        return;
      }
      const storeId = storeSelect.value;
      
      if (!storeId) {
        document.getElementById('companyCEO').value = '';
        document.getElementById('companyBusinessNumber').value = '';
        document.getElementById('companyPhone').value = '';
        document.getElementById('companyAddress').value = '';
        document.getElementById('workStore').value = '';
        updatePreview();
        return;
      }
      
      try {
        // Firestore에서 매장 정보 가져오기
        const storeDoc = await firebase.firestore().collection('stores').doc(storeId).get();
        
        if (storeDoc.exists) {
          const store = storeDoc.data();
          document.getElementById('companyCEO').value = store.ceo || '';
          document.getElementById('companyBusinessNumber').value = store.businessNumber || '';
          document.getElementById('companyPhone').value = store.phone || '';
          document.getElementById('companyAddress').value = store.address || '';
          document.getElementById('workStore').value = store.name || '';
          
          // 매장 수당 설정 자동 적용
          const allowances = store.allowances || {};
          console.log('💰 매장 수당 설정 자동 적용:', allowances);
          document.getElementById('allowOvertime').checked = allowances.overtime || false;
          document.getElementById('allowNight').checked = allowances.night || false;
          document.getElementById('allowHoliday').checked = allowances.holiday || false;
          
          // 급여 지급일 자동 입력 (1단계에서 추가된 필드)
          if (store.salaryPaymentDay) {
            const paymentDay = store.salaryPaymentDay;
            const paymentDaySelect = document.getElementById('paymentDay');
            
            // 지급일 텍스트 생성 (5일 → "매월 5일", 28일 → "매월 말일")
            let paymentDayText = '';
            if (paymentDay === 28) {
              paymentDayText = '매월 말일';
            } else {
              paymentDayText = `매월 ${paymentDay}일`;
            }
            
            // option이 있는지 확인하고 없으면 추가
            let optionExists = false;
            for (let i = 0; i < paymentDaySelect.options.length; i++) {
              if (paymentDaySelect.options[i].value === paymentDayText) {
                optionExists = true;
                break;
              }
            }
            
            if (!optionExists) {
              const newOption = document.createElement('option');
              newOption.value = paymentDayText;
              newOption.textContent = paymentDayText;
              paymentDaySelect.appendChild(newOption);
            }
            
            // 값 설정
            paymentDaySelect.value = paymentDayText;
            console.log('📅 급여 지급일 자동 입력:', paymentDayText);
          } else {
            console.log('⚠️ 매장에 급여 지급일이 설정되지 않았습니다');
          }
          
          updatePreview();
        }
      } catch (error) {
        console.error('❌ 매장 정보 로드 실패:', error);
      }
    }

    function loadCompanyInfo() {
      // 하위 호환성 유지
      loadStoreInfoToContract();
    }

    function showAddCompanyModal() {
      // companies는 제거됨 - 매장 관리에서 관리하세요
      alert('ℹ️ 회사/매장 정보는 "매장 관리" 탭에서 관리할 수 있습니다.');
    }

    function showEditCompanyModal() {
      // companies는 제거됨 - 매장 관리에서 관리하세요
      alert('ℹ️ 회사/매장 정보는 "매장 관리" 탭에서 관리할 수 있습니다.');
      
      if (!company) {
        alert('⚠️ 회사 정보를 찾을 수 없습니다.');
        return;
      }
      
      document.getElementById('companyModalTitle').textContent = '✏️ 회사 수정';
      document.getElementById('editCompanyId').value = companyId;
      document.getElementById('deleteCompanyBtnContainer').style.display = 'block';
      
      document.getElementById('newCompanyName').value = company.name;
      document.getElementById('newCompanyCEO').value = company.ceo;
      document.getElementById('newCompanyBusinessNumber').value = company.businessNumber;
      document.getElementById('newCompanyPhone').value = company.phone;
      document.getElementById('newCompanyAddress').value = company.address;
      
      document.getElementById('addCompanyModal').style.display = 'flex';
    }

    function closeAddCompanyModal() {
      document.getElementById('addCompanyModal').style.display = 'none';
      document.getElementById('editCompanyId').value = '';
      document.getElementById('newCompanyName').value = '';
      document.getElementById('newCompanyCEO').value = '';
      document.getElementById('newCompanyBusinessNumber').value = '';
      document.getElementById('newCompanyPhone').value = '';
      document.getElementById('newCompanyAddress').value = '';
    }

    function saveCompany() {
      // companies는 제거됨 - 매장 관리 사용
      alert('ℹ️ 회사/매장 정보는 "매장 관리" 탭에서 관리할 수 있습니다.');
      closeAddCompanyModal();
    }

    function deleteCompany() {
      // companies는 제거됨 - 매장 관리 사용
      alert('ℹ️ 회사/매장 정보는 "매장 관리" 탭에서 관리할 수 있습니다.');
      
      closeAddCompanyModal();
      loadCompanyList();
      
      alert('✅ 회사가 삭제되었습니다.');
    }

    // 시간 드롭다운 초기화
    function initializeTimeDropdowns() {
      console.log('⏰ 시간 드롭다운 초기화 시작');
      
      const startHour = document.querySelector('.schedule-start-hour');
      const startMinute = document.querySelector('.schedule-start-minute');
      const endHour = document.querySelector('.schedule-end-hour');
      const endMinute = document.querySelector('.schedule-end-minute');
      
      console.log('근무시간 요소:', { startHour, startMinute, endHour, endMinute });
      
      if (!startHour || !startMinute || !endHour || !endMinute) {
        console.error('❌ 근무시간 드롭다운 요소를 찾을 수 없습니다!');
        return;
      }
      
      populateHourOptions(startHour);
      populateHourOptions(endHour);
      populateMinuteOptions(startMinute);
      populateMinuteOptions(endMinute);
      
      const breakStartHour = document.getElementById('breakStartHour');
      const breakStartMinute = document.getElementById('breakStartMinute');
      const breakEndHour = document.getElementById('breakEndHour');
      const breakEndMinute = document.getElementById('breakEndMinute');
      
      console.log('휴게시간 요소:', { breakStartHour, breakStartMinute, breakEndHour, breakEndMinute });
      
      populateHourOptions(breakStartHour);
      populateHourOptions(breakEndHour);
      populateMinuteOptions(breakStartMinute);
      populateMinuteOptions(breakEndMinute);
      
      console.log('✅ 시간 드롭다운 초기화 완료');
    }

    function populateHourOptions(select) {
      if (!select) return;
      for (let i = 0; i <= 23; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = String(i).padStart(2, '0') + '시';
        select.appendChild(option);
      }
    }

    function populateMinuteOptions(select) {
      if (!select) return;
      for (let i = 0; i <= 59; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = String(i).padStart(2, '0') + '분';
        select.appendChild(option);
      }
      select.value = '0';
    }

    // 근무 일정 관리
    function toggleDayForSchedule(button, scheduleIndex) {
      button.classList.toggle('active');
      updateWorkTimeDisplay();
    }

    let scheduleCounter = 1;

    function addSchedule() {
      const container = document.getElementById('workScheduleContainer');
      const newIndex = scheduleCounter++;
      
      const newItem = document.createElement('div');
      newItem.className = 'work-schedule-item';
      newItem.setAttribute('data-index', newIndex);
      
      newItem.innerHTML = `
        <div class="form-group">
          <label>근무일 *</label>
          <div class="day-buttons">
            <button type="button" class="day-btn" data-day="월" onclick="toggleDayForSchedule(this, ${newIndex})">월</button>
            <button type="button" class="day-btn" data-day="화" onclick="toggleDayForSchedule(this, ${newIndex})">화</button>
            <button type="button" class="day-btn" data-day="수" onclick="toggleDayForSchedule(this, ${newIndex})">수</button>
            <button type="button" class="day-btn" data-day="목" onclick="toggleDayForSchedule(this, ${newIndex})">목</button>
            <button type="button" class="day-btn" data-day="금" onclick="toggleDayForSchedule(this, ${newIndex})">금</button>
            <button type="button" class="day-btn" data-day="토" onclick="toggleDayForSchedule(this, ${newIndex})">토</button>
            <button type="button" class="day-btn" data-day="일" onclick="toggleDayForSchedule(this, ${newIndex})">일</button>
          </div>
        </div>
        <div class="form-row" style="align-items: flex-end;">
          <div class="form-group">
            <label>시작 시간 *</label>
            <div style="display: flex; gap: 8px;">
              <select class="schedule-start-hour" required onchange="updateWorkTimeDisplay()">
                <option value="">시</option>
              </select>
              <select class="schedule-start-minute" required onchange="updateWorkTimeDisplay()">
                <option value="">분</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>종료 시간 *</label>
            <div style="display: flex; gap: 8px;">
              <select class="schedule-end-hour" required onchange="updateWorkTimeDisplay()">
                <option value="">시</option>
              </select>
              <select class="schedule-end-minute" required onchange="updateWorkTimeDisplay()">
                <option value="">분</option>
              </select>
            </div>
          </div>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(${newIndex})" style="height: 42px; margin-bottom: 0;">삭제</button>
        </div>
      `;
      
      container.appendChild(newItem);
      
      const newStartHour = newItem.querySelector('.schedule-start-hour');
      const newStartMinute = newItem.querySelector('.schedule-start-minute');
      const newEndHour = newItem.querySelector('.schedule-end-hour');
      const newEndMinute = newItem.querySelector('.schedule-end-minute');
      
      populateHourOptions(newStartHour);
      populateHourOptions(newEndHour);
      populateMinuteOptions(newStartMinute);
      populateMinuteOptions(newEndMinute);
      
      const firstDeleteBtn = container.querySelector('[data-index="0"] .btn-danger');
      if (firstDeleteBtn) firstDeleteBtn.style.display = 'inline-block';
    }

    function removeSchedule(index) {
      const item = document.querySelector(`[data-index="${index}"]`);
      if (item) {
        item.remove();
        updateWorkTimeDisplay();
        
        const container = document.getElementById('workScheduleContainer');
        if (container.children.length === 1) {
          const firstDeleteBtn = container.querySelector('.btn-danger');
          if (firstDeleteBtn) firstDeleteBtn.style.display = 'none';
        }
      }
    }

    function updateWorkTimeDisplay() {
      const allDays = [];
      const schedules = [];
      let totalWeeklyHours = 0; // 주간 총 근무시간 계산
      
      const scheduleItems = document.querySelectorAll('.work-schedule-item');
      
      scheduleItems.forEach((item) => {
        const selectedDays = [];
        
        const activeDayBtns = item.querySelectorAll('.day-btn.active');
        activeDayBtns.forEach(btn => {
          const day = btn.getAttribute('data-day');
          selectedDays.push(day);
          if (!allDays.includes(day)) {
            allDays.push(day);
          }
        });
        
        const startHour = item.querySelector('.schedule-start-hour')?.value;
        const startMinute = item.querySelector('.schedule-start-minute')?.value;
        const endHour = item.querySelector('.schedule-end-hour')?.value;
        const endMinute = item.querySelector('.schedule-end-minute')?.value;
        
        if (selectedDays.length > 0 && startHour !== '' && startMinute !== '' && endHour !== '' && endMinute !== '') {
          const startTime = `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`;
          const endTime = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
          schedules.push(`${selectedDays.join(', ')}: ${startTime}~${endTime}`);
          
          // 일일 근무시간 계산
          const startMinutes = parseInt(startHour) * 60 + parseInt(startMinute);
          const endMinutes = parseInt(endHour) * 60 + parseInt(endMinute);
          const dailyMinutes = endMinutes - startMinutes;
          const dailyHours = dailyMinutes / 60;
          
          // 선택된 요일 수만큼 곱하기
          totalWeeklyHours += dailyHours * selectedDays.length;
        }
      });
      
      document.getElementById('workDays').value = allDays.join(', ');
      document.getElementById('workTime').value = schedules.join(' / ');
      
      // 주간 근무시간이 15시간 이상이면 주휴수당 자동 체크
      const weeklyHolidayCheckbox = document.getElementById('allowWeeklyHoliday');
      if (weeklyHolidayCheckbox) {
        if (totalWeeklyHours >= 15) {
          weeklyHolidayCheckbox.checked = true;
          console.log(`✅ 주간 근무시간 ${totalWeeklyHours.toFixed(1)}시간 -> 주휴수당 자동 적용`);
        } else {
          weeklyHolidayCheckbox.checked = false;
          console.log(`ℹ️ 주간 근무시간 ${totalWeeklyHours.toFixed(1)}시간 -> 주휴수당 미적용`);
        }
      }
    }

    // 휴게시간 관리
    function updateBreakTimeDisplay() {
      const hour = document.getElementById('breakTimeHour')?.value;
      const minute = document.getElementById('breakTimeMinute')?.value;
      const startHour = document.getElementById('breakStartHour')?.value;
      const startMinute = document.getElementById('breakStartMinute')?.value;
      const endHour = document.getElementById('breakEndHour')?.value;
      const endMinute = document.getElementById('breakEndMinute')?.value;
      
      let breakTimeText = '';
      
      if (hour || minute) {
        const h = hour || '0';
        const m = minute || '0';
        breakTimeText = `${h}시간 ${m}분`;
        
        if (startHour !== '' && startMinute !== '' && endHour !== '' && endMinute !== '') {
          const start = `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`;
          const end = `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
          breakTimeText += ` (${start}~${end})`;
        }
      }
      
      document.getElementById('breakTime').value = breakTimeText;
      const previewEl = document.getElementById('breakTimePreview');
      if (previewEl) previewEl.textContent = breakTimeText ? `휴게시간: ${breakTimeText}` : '';
    }

    // 유효성 검사
    function validateForm() {
      const requiredFields = [
        { id: 'employeeName', name: '이름' },
        { id: 'employeeBirth', name: '생년월일' },
        { id: 'employeeAddress', name: '주소' },
        { id: 'employeePhone', name: '연락처' },
        { id: 'storeSelect', name: '매장' },
        { id: 'contractType', name: '계약 유형' },
        { id: 'workStore', name: '근무 매장' },
        { id: 'startDate', name: '계약 시작일' },
        { id: 'position', name: '직책/직무' },
        { id: 'wageType', name: '급여 형태' },
        { id: 'wageAmount', name: '급여액' },
        { id: 'paymentDay', name: '급여 지급일' },
        { id: 'paymentMethod', name: '급여 지급 방법' }
      ];
      
      for (const field of requiredFields) {
        const element = document.getElementById(field.id);
        if (!element || !element.value || element.value.trim() === '') {
          alert(`⚠️ ${field.name}을(를) 입력해주세요.`);
          if (element) element.focus();
          return false;
        }
      }
      
      const workDays = document.getElementById('workDays').value;
      const workTime = document.getElementById('workTime').value;
      
      if (!workDays || workDays.trim() === '') {
        alert('⚠️ 근무일을 선택해주세요.');
        return false;
      }
      
      if (!workTime || workTime.trim() === '') {
        alert('⚠️ 근무시간을 설정해주세요.');
        return false;
      }
      
      return true;
    }

    // 미리보기 업데이트
    function updatePreview() {
      console.log('🔍 미리보기 업데이트');
      
      // 필수 요소 체크
      const employeeNameEl = document.getElementById('employeeName');
      if (!employeeNameEl) {
        console.log('ℹ️ 폼 요소가 아직 로드되지 않음');
        return;
      }
      
      // 직원(근로자) 정보
      const employeeName = employeeNameEl.value;
      const employeeBirth = document.getElementById('employeeBirth')?.value || '';
      const employeeAddress = document.getElementById('employeeAddress')?.value || '';
      const employeePhone = document.getElementById('employeePhone')?.value || '';
      
      document.getElementById('previewName').textContent = employeeName || '_______';
      document.getElementById('previewEmployeeName').textContent = employeeName || '_______';
      document.getElementById('previewEmployeeName2').textContent = employeeName || '_______';
      document.getElementById('previewBirth').textContent = employeeBirth || '_______';
      document.getElementById('previewAddress').textContent = employeeAddress || '_______';
      document.getElementById('previewPhone').textContent = employeePhone || '_______';
      
      // 주민번호도 표시 (생년월일 input에서 가져온 값 또는 원본 주민번호)
      // employeeBirth가 YYYY-MM-DD 형식이면 변환, 아니면 그대로 표시
      const birthFormatted = employeeBirth ? employeeBirth.replace(/-/g, '.') : '_______';
      const previewSSN = document.getElementById('previewSSN');
      if (previewSSN) previewSSN.textContent = birthFormatted;
      
      // 회사(사용자) 정보 - storeSelect에서 가져오기
      const storeSelectEl = document.getElementById('storeSelect');
      if (!storeSelectEl) {
        console.log('ℹ️ storeSelect 요소를 찾을 수 없음');
        return;
      }
      
      // 폼에서 직접 읽어온 값 사용 (이미 loadStoreInfoToContract에서 채워짐)
      const companyName = document.getElementById('workStore')?.value || '(주)ABC디저트센터';
      const companyCEO = document.getElementById('companyCEO')?.value || '_______';
      const companyBusinessNumber = document.getElementById('companyBusinessNumber')?.value || '_______';
      const companyPhone = document.getElementById('companyPhone')?.value || '_______';
      const companyAddress = document.getElementById('companyAddress')?.value || '_______';
      
      document.getElementById('previewCompanyName').textContent = companyName;
      document.getElementById('previewCompanyName2').textContent = companyName;
      document.getElementById('previewCEO').textContent = companyCEO;
      
      // 사용자(회사) 상세정보 표시
      const previewCompanyNameDetail = document.getElementById('previewCompanyNameDetail');
      if (previewCompanyNameDetail) previewCompanyNameDetail.textContent = companyName;
      
      const previewCEODetail = document.getElementById('previewCEODetail');
      if (previewCEODetail) previewCEODetail.textContent = companyCEO;
      
      const previewBusinessNumber = document.getElementById('previewBusinessNumber');
      if (previewBusinessNumber) previewBusinessNumber.textContent = companyBusinessNumber;
      
      const previewCompanyPhone = document.getElementById('previewCompanyPhone');
      if (previewCompanyPhone) previewCompanyPhone.textContent = companyPhone;
      
      const previewCompanyAddress = document.getElementById('previewCompanyAddress');
      if (previewCompanyAddress) previewCompanyAddress.textContent = companyAddress;
      
      document.getElementById('previewStartDate').textContent = document.getElementById('startDate').value || '_______';
      const endDate = document.getElementById('endDate').value;
      document.getElementById('previewEndDate').textContent = endDate || '기간의 정함이 없음';
      document.getElementById('previewStore').textContent = document.getElementById('workStore').value || '_______';
      document.getElementById('previewPosition').textContent = document.getElementById('position').value || '_______';
      
      document.getElementById('previewWorkDays').textContent = document.getElementById('workDays').value || '_______';
      document.getElementById('previewWorkTime').textContent = document.getElementById('workTime').value || '_______';
      document.getElementById('previewBreakTime').textContent = document.getElementById('breakTime').value || '없음';
      
      document.getElementById('previewWageType').textContent = document.getElementById('wageType').value || '_______';
      const wageAmount = document.getElementById('wageAmount').value;
      document.getElementById('previewWageAmount').textContent = wageAmount ? Number(wageAmount).toLocaleString() : '_______';
      
      // 급여 조건 텍스트 자동 생성 (3단계)
      const paymentDayValue = document.getElementById('paymentDay').value;
      let salaryConditionText = paymentDayValue || '_______';
      
      if (paymentDayValue) {
        // paymentDayValue 예: "매월 5일", "매월 25일", "매월 말일"
        // 숫자만 추출 (말일인 경우 28로 처리)
        let dayNumber = 0;
        if (paymentDayValue.includes('말일')) {
          dayNumber = 28;
        } else {
          const match = paymentDayValue.match(/\d+/);
          if (match) {
            dayNumber = parseInt(match[0]);
          }
        }
        
        // 계산 기간 결정 (일단 모든 지급일을 전월 기준으로)
        let calculationPeriod = '전월 1일부터 전월 말일까지';
        
        // 지급일별 계산 기간 (향후 수정 가능)
        if (dayNumber <= 15) {
          calculationPeriod = '전월 1일부터 전월 말일까지';
        } else if (dayNumber === 20) {
          calculationPeriod = '전월 16일부터 당월 15일까지';
        } else if (dayNumber === 25) {
          calculationPeriod = '전월 21일부터 당월 20일까지';
        } else if (dayNumber === 28) {
          calculationPeriod = '당월 1일부터 당월 말일까지';
        }
        
        // 최종 텍스트 생성
        salaryConditionText = `${calculationPeriod} 근무한 급여를 ${paymentDayValue} 지급`;
      }
      
      document.getElementById('previewPaymentDay').textContent = salaryConditionText;
      document.getElementById('previewPaymentMethod').textContent = document.getElementById('paymentMethod').value || '_______';
      
      // 퇴직금 지급 대상 표시
      const severancePayChecked = document.getElementById('allowSeverancePay')?.checked || false;
      const severancePayDiv = document.getElementById('previewSeverancePay');
      if (severancePayDiv) {
        severancePayDiv.style.display = severancePayChecked ? 'block' : 'none';
      }
      
      const contractContent = document.getElementById('contractContent').value;
      const bodyDiv = document.getElementById('previewContractBody');
      if (contractContent && contractContent.trim()) {
        bodyDiv.innerHTML = '<div style="white-space: pre-wrap; line-height: 1.8; margin: 30px 0;">' + contractContent + '</div>';
      } else {
        bodyDiv.innerHTML = '';
      }
      
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('previewContractDate').textContent = `${year}년 ${month}월 ${day}일`;
      
      console.log('✅ 미리보기 업데이트 완료');
    }

    // 계약서 템플릿
    function loadDefaultTemplate() {
      console.log('📄 기본 템플릿 로드 시작');
      const contentEl = document.getElementById('contractContent');
      console.log('contractContent 요소:', contentEl);
      if (!contentEl) {
        console.error('❌ contractContent 요소를 찾을 수 없습니다!');
        return;
      }
      
      const template = `제1조 (근로계약 기간)
본 계약의 기간은 위 표에 명시된 바와 같다.

제2조 (근무 장소 및 업무 내용)
근로자는 위 표에 명시된 근무 장소에서 명시된 업무를 수행한다.

제3조 (근로시간 및 휴게시간)
1. 근로시간은 위 표에 명시된 바와 같다.
2. 휴게시간은 근로시간 중 위 표에 명시된 바와 같다.

제4조 (근무일 및 휴일)
1. 근무일은 위 표에 명시된 바와 같다.
2. 주휴일은 근로기준법에 따라 부여한다.

제5조 (임금)
1. 근로자의 임금은 위 표에 명시된 바와 같다.
2. 임금은 위 표에 명시된 지급일에 지급한다.
3. 연장·야간·휴일 근로 시에는 근로기준법에 따라 가산임금을 지급한다.

제6조 (연차유급휴가)
연차유급휴가는 근로기준법에 따라 부여한다.

제7조 (사회보험 가입)
사용자는 근로자를 4대 사회보험에 가입시킨다.

제8조 (계약의 해지)
1. 본 계약을 해지하고자 할 때는 30일 전에 예고하여야 한다.
2. 해고 예고 기간을 두지 않을 경우 30일분의 통상임금을 지급한다.

제9조 (기타)
이 계약서에 명시되지 않은 사항은 근로기준법 및 관계 법령에 따른다.`;

      contentEl.value = template;
      console.log('✅ 기본 템플릿 로드 완료');
    }

    // 스케줄 데이터 수집 및 복원
    function collectScheduleData() {
      const schedules = [];
      const scheduleItems = document.querySelectorAll('.work-schedule-item');
      
      scheduleItems.forEach((item, index) => {
        const selectedDays = [];
        const activeDayBtns = item.querySelectorAll('.day-btn.active');
        activeDayBtns.forEach(btn => {
          selectedDays.push(btn.getAttribute('data-day'));
        });
        
        const startHour = item.querySelector('.schedule-start-hour')?.value || '';
        const startMinute = item.querySelector('.schedule-start-minute')?.value || '';
        const endHour = item.querySelector('.schedule-end-hour')?.value || '';
        const endMinute = item.querySelector('.schedule-end-minute')?.value || '';
        
        schedules.push({
          index: index,
          days: selectedDays,
          startHour: startHour,
          startMinute: startMinute,
          endHour: endHour,
          endMinute: endMinute
        });
      });
      
      return schedules;
    }

    function restoreScheduleData(schedules, breakTimeData) {
      if (!schedules || schedules.length === 0) return;
      
      const container = document.getElementById('workScheduleContainer');
      const items = container.querySelectorAll('.work-schedule-item');
      for (let i = items.length - 1; i > 0; i--) {
        items[i].remove();
      }
      
      schedules.forEach((schedule, index) => {
        let scheduleItem;
        
        if (index === 0) {
          scheduleItem = container.querySelector('.work-schedule-item[data-index="0"]');
        } else {
          addSchedule();
          scheduleItem = container.querySelector(`.work-schedule-item[data-index="${scheduleCounter - 1}"]`);
        }
        
        if (scheduleItem) {
          schedule.days.forEach(day => {
            const dayBtn = scheduleItem.querySelector(`.day-btn[data-day="${day}"]`);
            if (dayBtn) {
              dayBtn.classList.add('active');
            }
          });
          
          const startHourSelect = scheduleItem.querySelector('.schedule-start-hour');
          const startMinuteSelect = scheduleItem.querySelector('.schedule-start-minute');
          const endHourSelect = scheduleItem.querySelector('.schedule-end-hour');
          const endMinuteSelect = scheduleItem.querySelector('.schedule-end-minute');
          
          if (startHourSelect) startHourSelect.value = schedule.startHour;
          if (startMinuteSelect) startMinuteSelect.value = schedule.startMinute;
          if (endHourSelect) endHourSelect.value = schedule.endHour;
          if (endMinuteSelect) endMinuteSelect.value = schedule.endMinute;
        }
      });
      
      if (breakTimeData) {
        if (breakTimeData.hour) document.getElementById('breakTimeHour').value = breakTimeData.hour;
        if (breakTimeData.minute) document.getElementById('breakTimeMinute').value = breakTimeData.minute;
        if (breakTimeData.startHour) document.getElementById('breakStartHour').value = breakTimeData.startHour;
        if (breakTimeData.startMinute) document.getElementById('breakStartMinute').value = breakTimeData.startMinute;
        if (breakTimeData.endHour) document.getElementById('breakEndHour').value = breakTimeData.endHour;
        if (breakTimeData.endMinute) document.getElementById('breakEndMinute').value = breakTimeData.endMinute;
      }
      
      updateWorkTimeDisplay();
      updateBreakTimeDisplay();
    }

    // 계약서 저장
    function showSaveContractModal() {
      // 임시 저장은 validation 없이 가능
      document.getElementById('saveContractModal').style.display = 'flex';
      const employeeName = document.getElementById('employeeName').value || '직원미정';
      const position = document.getElementById('position').value || '직책미정';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('contractSaveName').value = `${employeeName}_${position}_${today}`;
    }

    function closeSaveContractModal() {
      document.getElementById('saveContractModal').style.display = 'none';
      document.getElementById('contractSaveName').value = '';
    }

    async function saveContract() {
      const contractName = document.getElementById('contractSaveName').value.trim();
      
      if (!contractName) {
        alert('⚠️ 계약서 이름을 입력해주세요.');
        return;
      }
      
      // 임시 저장은 validation 없이 진행 (작성 중인 내용 그대로 저장)
      const schedules = collectScheduleData();
      
      const breakTimeData = {
        hour: document.getElementById('breakTimeHour')?.value || '',
        minute: document.getElementById('breakTimeMinute')?.value || '',
        startHour: document.getElementById('breakStartHour')?.value || '',
        startMinute: document.getElementById('breakStartMinute')?.value || '',
        endHour: document.getElementById('breakEndHour')?.value || '',
        endMinute: document.getElementById('breakEndMinute')?.value || ''
      };
      
      const contractData = {
        name: contractName,
        employeeId: document.getElementById('employeeSelect')?.value || '',
        employeeName: document.getElementById('employeeName')?.value || '',
        employeeBirth: document.getElementById('employeeBirth')?.value || '',
        employeeAddress: document.getElementById('employeeAddress')?.value || '',
        employeePhone: document.getElementById('employeePhone')?.value || '',
        storeId: document.getElementById('storeSelect')?.value || '',
        companyName: document.getElementById('workStore')?.value || '',
        companyCEO: document.getElementById('companyCEO')?.value || '',
        companyBusinessNumber: document.getElementById('companyBusinessNumber')?.value || '',
        companyPhone: document.getElementById('companyPhone')?.value || '',
        companyAddress: document.getElementById('companyAddress')?.value || '',
        contractType: document.getElementById('contractType')?.value || '',
        workStore: document.getElementById('workStore')?.value || '',
        startDate: document.getElementById('startDate')?.value || '',
        endDate: document.getElementById('endDate')?.value || '',
        position: document.getElementById('position')?.value || '',
        workDays: document.getElementById('workDays')?.value || '',
        workTime: document.getElementById('workTime')?.value || '',
        breakTime: document.getElementById('breakTime')?.value || '',
        wageType: document.getElementById('wageType')?.value || '',
        wageAmount: document.getElementById('wageAmount')?.value || '',
        paymentDay: document.getElementById('paymentDay')?.value || '',
        paymentMethod: document.getElementById('paymentMethod')?.value || '',
        contractContent: document.getElementById('contractContent')?.value || '',
        schedules: schedules || [],
        breakTimeData: breakTimeData || {},
        savedAt: new Date().toISOString(),
        // 급여 지급 항목 설정
        allowances: {
          weeklyHoliday: document.getElementById('allowWeeklyHoliday')?.checked || false,
          overtime: document.getElementById('allowOvertime')?.checked || false,
          night: document.getElementById('allowNight')?.checked || false,
          holiday: document.getElementById('allowHoliday')?.checked || false
        },
        // 4대보험 적용 설정
        insurance: {
          type: document.getElementById('insuranceType')?.value || '',
          severancePay: document.getElementById('allowSeverancePay')?.checked || false
        }
      };
      
      try {
        // Firestore에서 같은 이름의 계약서가 있는지 확인
        const existingSnapshot = await firebase.firestore().collection('savedContracts')
          .where('name', '==', contractName)
          .where('createdBy', '==', firebase.auth().currentUser.uid)
          .limit(1)
          .get();
        
        if (!existingSnapshot.empty) {
          if (!confirm('⚠️ 같은 이름의 계약서가 이미 존재합니다.\n덮어쓰시겠습니까?')) {
            return;
          }
          // 기존 문서 업데이트
          const existingDocId = existingSnapshot.docs[0].id;
          await firebase.firestore().collection('savedContracts').doc(existingDocId).update({
            ...contractData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('✅ 계약서 업데이트 완료:', existingDocId);
        } else {
          // 새 문서 생성
          contractData.createdBy = firebase.auth().currentUser.uid;
          contractData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          const docRef = await firebase.firestore().collection('savedContracts').add(contractData);
          console.log('✅ 계약서 저장 완료:', docRef.id);
        }
        
        closeSaveContractModal();
        alert('✅ 계약서가 저장되었습니다.');
      } catch (error) {
        console.error('❌ 계약서 저장 실패:', error);
        alert('계약서 저장에 실패했습니다.');
      }
    }

    // 저장된 계약서 불러오기
    async function showLoadContractModal() {
      const listDiv = document.getElementById('savedContractsList');
      listDiv.innerHTML = '<p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">계약서를 불러오는 중...</p>';
      
      document.getElementById('loadContractModal').style.display = 'flex';
      
      try {
        // Firestore에서 저장된 계약서 가져오기
        const snapshot = await firebase.firestore().collection('savedContracts')
          .where('createdBy', '==', firebase.auth().currentUser.uid)
          .get();
        
        savedContracts = [];
        snapshot.forEach(doc => {
          savedContracts.push({ id: doc.id, ...doc.data() });
        });
        
        // 클라이언트에서 날짜 기준 정렬 (최신순)
        savedContracts.sort((a, b) => {
          const dateA = a.savedAt ? new Date(a.savedAt).getTime() : 0;
          const dateB = b.savedAt ? new Date(b.savedAt).getTime() : 0;
          return dateB - dateA; // 내림차순
        });
        
        if (savedContracts.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">저장된 계약서가 없습니다.</p>';
        } else {
          listDiv.innerHTML = savedContracts.map((contract, index) => {
            const displayName = contract.name || `${contract.employeeName} - ${contract.position}`;
            const savedDate = contract.savedAt ? new Date(contract.savedAt).toLocaleString('ko-KR', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            }) : '날짜 미상';
            
            return `
              <div style="padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: var(--spacing-sm); cursor: pointer; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.borderColor='var(--primary-color)'; this.style.backgroundColor='var(--bg-light)';" onmouseout="this.style.borderColor='var(--border-color)'; this.style.backgroundColor='white';" onclick="loadSavedContract(${index})">
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px; font-size: 15px;">📄 ${displayName}</div>
                  <div style="font-size: 13px; color: var(--text-secondary);">${savedDate}</div>
                </div>
                <button onclick="event.stopPropagation(); deleteSavedContract('${contract.id}', ${index});" style="padding: 6px 12px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">삭제</button>
              </div>
            `;
          }).join('');
        }
        
        console.log(`✅ ${savedContracts.length}개 저장된 계약서 로드 완료`);
      } catch (error) {
        console.error('❌ 계약서 목록 로드 실패:', error);
        listDiv.innerHTML = '<p style="text-align: center; padding: var(--spacing-xl); color: var(--danger-color);">계약서 목록을 불러오는데 실패했습니다.</p>';
      }
    }

    function closeLoadContractModal() {
      document.getElementById('loadContractModal').style.display = 'none';
    }

    function loadSavedContract(index) {
      const contract = savedContracts[index];
      
      if (confirm('현재 작성 중인 내용이 덮어씌워집니다. 계속하시겠습니까?')) {
        // 직원 선택
        if (contract.employeeId) {
          document.getElementById('employeeSelect').value = contract.employeeId;
          loadEmployeeInfo();
        }
        
        // 매장 선택 (storeId 사용)
        if (contract.storeId) {
          document.getElementById('storeSelect').value = contract.storeId;
          loadStoreInfoToContract();
        }
        
        document.getElementById('contractType').value = contract.contractType;
        document.getElementById('workStore').value = contract.workStore;
        document.getElementById('startDate').value = contract.startDate;
        document.getElementById('endDate').value = contract.endDate;
        document.getElementById('position').value = contract.position;
        document.getElementById('wageType').value = contract.wageType;
        document.getElementById('wageAmount').value = contract.wageAmount;
        document.getElementById('paymentDay').value = contract.paymentDay;
        document.getElementById('paymentMethod').value = contract.paymentMethod;
        document.getElementById('contractContent').value = contract.contractContent;
        
        // 급여 지급 항목 복원
        if (contract.allowances) {
          document.getElementById('allowWeeklyHoliday').checked = contract.allowances.weeklyHoliday || false;
          document.getElementById('allowOvertime').checked = contract.allowances.overtime || false;
          document.getElementById('allowNight').checked = contract.allowances.night || false;
          document.getElementById('allowHoliday').checked = contract.allowances.holiday || false;
        }
        
        // 4대보험 설정 복원
        if (contract.insurance) {
          document.getElementById('insuranceType').value = contract.insurance.type || '';
          updateInsuranceInfo(); // 보험 정보 표시 업데이트
          document.getElementById('allowSeverancePay').checked = contract.insurance.severancePay || false;
        }
        
        if (contract.schedules && contract.schedules.length > 0) {
          restoreScheduleData(contract.schedules, contract.breakTimeData);
        }
        
        closeLoadContractModal();
        alert('✅ 계약서를 불러왔습니다.');
      }
    }

    async function deleteSavedContract(docId, index) {
      const contract = savedContracts[index];
      const displayName = contract.name || `${contract.employeeName} - ${contract.position}`;
      
      if (confirm(`"${displayName}" 계약서를 삭제하시겠습니까?`)) {
        try {
          // Firestore에서 삭제
          await firebase.firestore().collection('savedContracts').doc(docId).delete();
          console.log('✅ 계약서 삭제 완료:', docId);
          
          // 목록 새로고침
          showLoadContractModal();
          alert('✅ 계약서가 삭제되었습니다.');
        } catch (error) {
          console.error('❌ 계약서 삭제 실패:', error);
          alert('계약서 삭제에 실패했습니다.');
        }
      }
    }

    /**
     * 추가 계약서 작성 페이지 열기
     * 같은 직원이 여러 매장에서 근무할 수 있도록 추가 계약서 작성
     */
    function openAdditionalContractPage() {
      console.log('🚀 추가 계약서 모달 열기');
      
      // 🔥 추가 계약서 모드 활성화
      isAdditionalContractMode = true;
      
      const modal = document.getElementById('contractModal');
      if (!modal) {
        console.error('❌ contractModal을 찾을 수 없습니다');
        return;
      }
      
      // 모달 표시
      modal.style.display = 'flex';
      
      // 작성하기 탭 강제 활성화
      const formTab = document.getElementById('formTab');
      const formTabBtn = document.getElementById('formTabBtn');
      const previewTab = document.getElementById('previewTab');
      const previewTabBtn = document.getElementById('previewTabBtn');
      
      if (formTab && formTabBtn) {
        formTab.classList.add('active');
        formTab.style.display = 'block';
        formTabBtn.classList.add('active');
      }
      
      if (previewTab && previewTabBtn) {
        previewTab.classList.remove('active');
        previewTab.style.display = 'none';
        previewTabBtn.classList.remove('active');
      }
      
      // 모달이 화면에 렌더링될 때까지 대기
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          initializeContractFormNow();
        });
      });
    }

    // 계약서 생성
    async function generateContract() {
      console.log('📝 계약서 생성 시작');
      
      // 유효성 검사
      if (!validateForm()) {
        alert('⚠️ 필수 항목을 모두 입력해주세요.');
        return;
      }
      
      // 🔥 미서명 계약서 덮어쓰기 로직: 같은 직원 + 같은 매장의 미서명 계약서만 삭제
      const employeeName = document.getElementById('employeeName').value;
      const employeeBirth = document.getElementById('employeeBirth').value;
      const workStore = document.getElementById('workStore').value;
      
      if (employeeName && employeeBirth && workStore) {
        try {
          const unsignedContractsSnapshot = await firebase.firestore().collection('contracts')
            .where('employeeName', '==', employeeName)
            .where('employeeBirth', '==', employeeBirth)
            .where('signedAt', '==', null)
            .get();
          
          if (!unsignedContractsSnapshot.empty) {
            console.log(`⚠️ ${employeeName}의 미서명 계약서 ${unsignedContractsSnapshot.size}개 발견`);
            
            // 같은 매장의 미서명 계약서만 삭제 (다른 매장은 유지)
            const deletePromises = [];
            unsignedContractsSnapshot.docs.forEach(doc => {
              const data = doc.data();
              if (data.workStore === workStore || data.companyName === workStore) {
                console.log(`🗑️ 미서명 계약서 삭제 (같은 매장): ${doc.id}`);
                deletePromises.push(firebase.firestore().collection('contracts').doc(doc.id).delete());
              } else {
                console.log(`✅ 미서명 계약서 유지 (다른 매장): ${doc.id} - ${data.workStore}`);
              }
            });
            
            if (deletePromises.length > 0) {
              await Promise.all(deletePromises);
              console.log('✅ 같은 매장 미서명 계약서 삭제 완료');
            }
          }
        } catch (error) {
          console.error('❌ 미서명 계약서 확인/삭제 실패:', error);
          // 에러가 있어도 계속 진행 (새 계약서 생성)
        }
      }
      
      const contractId = 'C' + Date.now();
      // 현재 페이지의 디렉토리 경로 추출
      const currentPath = window.location.pathname;
      const directory = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
      const baseUrl = window.location.origin + directory;
      const signLink = `${baseUrl}contract-sign.html?id=${contractId}`;
      console.log('🔗 서명 링크 생성:', signLink);
      
      // Firestore에서 stores 가져오기
      const storesSnapshot = await firebase.firestore().collection('stores').get();
      const stores = [];
      storesSnapshot.forEach(doc => {
        stores.push({ id: doc.id, ...doc.data() });
      });
      
      const store = stores.find(s => s.id === document.getElementById('storeSelect').value);
      
      // 스케줄 데이터 수집 (요일별 다른 시간 지원)
      const schedules = collectScheduleData();
      
      const contractData = {
        id: contractId,
        employeeId: document.getElementById('employeeSelect')?.value || '',  // 직원 UID 추가
        employeeName: document.getElementById('employeeName').value,
        employeeBirth: document.getElementById('employeeBirth').value,
        employeeAddress: document.getElementById('employeeAddress').value,
        employeePhone: document.getElementById('employeePhone').value,
        employeePosition: document.getElementById('position').value,  // employeePosition 필드 추가
        companyName: store?.name || '',
        companyCEO: store?.ceo || '',
        companyBusinessNumber: store?.businessNumber || '',
        companyPhone: store?.phone || '',
        companyAddress: store?.address || '',
        contractType: document.getElementById('contractType').value,
        workStore: document.getElementById('workStore').value,
        storeId: document.getElementById('storeSelect').value,
        
        // ✅ 신 필드명 사용 (contractStartDate, contractEndDate)
        contractStartDate: document.getElementById('startDate').value,
        contractEndDate: document.getElementById('endDate').value || '기간의 정함이 없음',
        
        position: document.getElementById('position').value,  // 호환성 유지
        
        // ✅ schedules 배열 (요일별 다른 시간 지원)
        schedules: schedules || [],
        
        // 스케줄 정보 (schedule 객체로 통합)
        schedule: {
          days: document.getElementById('workDays').value,
          time: document.getElementById('workTime').value,
          breakTime: document.getElementById('breakTime').value
        },
        // 호환성 유지 (개별 필드도 저장)
        workDays: document.getElementById('workDays').value,
        workTime: document.getElementById('workTime').value,
        breakTime: document.getElementById('breakTime').value,
        
        // ✅ 신 필드명 사용 (salaryType, salaryAmount, salaryPaymentDay)
        salaryType: document.getElementById('wageType').value,
        salaryAmount: document.getElementById('wageAmount').value,
        salaryPaymentDay: document.getElementById('paymentDay').value,
        
        // 매장 급여 설정
        salaryCalculationType: store?.salaryCalculationType || 'prev_month_full',
        salaryCalculationPeriod: store?.salaryCalculationPeriod || null,
        
        paymentMethod: document.getElementById('paymentMethod').value,
        contractContent: document.getElementById('contractContent').value,
        contractDate: new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }),
        createdAt: new Date().toISOString(),
        signLink: signLink,
        createdBy: firebase.auth().currentUser?.uid || 'unknown',
        
        // 🔥 추가 계약서 여부 (isAdditionalContractMode 전역 변수 사용)
        isAdditional: isAdditionalContractMode,
        
        // 급여 지급 항목 설정
        allowances: {
          weeklyHoliday: document.getElementById('allowWeeklyHoliday').checked,
          overtime: document.getElementById('allowOvertime').checked,
          night: document.getElementById('allowNight').checked,
          holiday: document.getElementById('allowHoliday').checked
        },
        
        // 4대보험 적용 설정
        insurance: {
          type: document.getElementById('insuranceType').value,
          severancePay: document.getElementById('allowSeverancePay').checked
        }
      };
      
      console.log('💾 계약서 데이터 Firestore 저장:', contractId);
      
      try {
        // Firestore에 저장 (문서 ID를 contractId로 지정)
        await firebase.firestore().collection('contracts').doc(contractId).set(contractData);
        console.log('✅ Firestore 저장 완료:', contractId);
        
        // 🔥 직원 정보 업데이트 (최신 계약서 내용 반영)
        await updateEmployeeFromContract(contractData);
        
        // 🔥 계약서 작성 완료 시 스케줄 자동 생성
        await createInitialSchedule(contractData);
        
        // 서명 링크 표시
        document.getElementById('signLinkSection').style.display = 'block';
        document.getElementById('contractIdDisplay').textContent = contractId;
        document.getElementById('signLinkInput').value = signLink;
        
        alert(`✅ 계약서가 생성되었습니다!\n\n계약서 ID: ${contractId}\n\n서명 링크가 클립보드에 복사됩니다.`);
        
        // 서명 링크 자동 복사
        const input = document.getElementById('signLinkInput');
        input.select();
        document.execCommand('copy');
        
        // 3초 후 모달 닫고 목록 새로고침
        setTimeout(() => {
          console.log('🔄 모달 닫기 및 목록 새로고침');
          closeContractModal();
          loadContracts(); // 계약서 목록 새로고침
          switchTab('contracts'); // 계약서 관리 탭으로 이동
        }, 3000);
      } catch (error) {
        console.error('❌ Firestore 저장 실패:', error);
        alert('❌ 계약서 저장에 실패했습니다: ' + error.message);
      }
    }

    function copySignLink() {
      const input = document.getElementById('signLinkInput');
      input.select();
      document.execCommand('copy');
      alert('✅ 링크가 복사되었습니다!');
    }
    
    /**
     * 모든 기존 직원의 정보를 최신 계약서 기준으로 업데이트
     */
    async function syncAllEmployeesWithContracts() {
      if (!confirm('⚠️ 모든 기존 직원의 정보를 최신 계약서 기준으로 업데이트하시겠습니까?\n\n이 작업은 다음을 수행합니다:\n- 각 직원의 최신 계약서 조회\n- users 컬렉션의 store, position, salaryType, salaryAmount 업데이트\n- schedules 컬렉션에 스케줄 자동 생성 (없는 경우)')) {
        return;
      }
      
      try {
        console.log('🔄 전체 직원 동기화 시작...');
        
        // 모든 직원 조회
        const usersSnapshot = await db.collection('users')
          .where('role', '==', 'employee')
          .get();
        
        console.log(`📊 총 ${usersSnapshot.size}명의 직원 발견`);
        
        let successCount = 0;
        let skipCount = 0;
        let errorCount = 0;
        
        for (const userDoc of usersSnapshot.docs) {
          const userId = userDoc.id;
          const userData = userDoc.data();
          
          // 퇴사자 제외
          if (userData.status === 'resigned') {
            console.log(`⏭️ ${userData.name}: 퇴사자 제외`);
            skipCount++;
            continue;
          }
          
          try {
            // 해당 직원의 모든 계약서 조회
            const contractsSnapshot = await db.collection('contracts')
              .where('employeeName', '==', userData.name)
              .where('employeeBirth', '==', userData.birth)
              .get();
            
            if (contractsSnapshot.empty) {
              console.log(`⚠️ ${userData.name}: 계약서 없음`);
              skipCount++;
              continue;
            }
            
            // 최신 계약서 찾기 (createdAt 기준)
            let latestContract = null;
            let latestDate = null;
            
            contractsSnapshot.forEach(doc => {
              const contract = doc.data();
              const createdAt = new Date(contract.createdAt);
              
              if (!latestDate || createdAt > latestDate) {
                latestDate = createdAt;
                latestContract = { ...contract, employeeId: userId };
              }
            });
            
            if (!latestContract) {
              console.log(`⚠️ ${userData.name}: 유효한 계약서 없음`);
              skipCount++;
              continue;
            }
            
            console.log(`🔍 ${userData.name}: 최신 계약서 발견 (${latestDate.toISOString().split('T')[0]})`);
            
            // 직원 정보 업데이트
            await updateEmployeeFromContract(latestContract);
            
            // 스케줄 생성 (없는 경우만)
            await createInitialScheduleIfNotExists(latestContract);
            
            successCount++;
            
          } catch (error) {
            console.error(`❌ ${userData.name}: 동기화 실패`, error);
            errorCount++;
          }
        }
        
        console.log('');
        console.log('='.repeat(50));
        console.log('📊 전체 직원 동기화 완료');
        console.log('='.repeat(50));
        console.log(`✅ 성공: ${successCount}명`);
        console.log(`⏭️ 건너뛰기: ${skipCount}명`);
        console.log(`❌ 실패: ${errorCount}명`);
        console.log('='.repeat(50));
        
        alert(`✅ 전체 직원 동기화 완료!\n\n성공: ${successCount}명\n건너뛰기: ${skipCount}명\n실패: ${errorCount}명\n\n근무스케줄 탭을 새로고침하여 확인하세요.`);
        
        // 직원 목록 새로고침
        loadEmployees();
        
      } catch (error) {
        console.error('❌ 전체 동기화 실패:', error);
        alert('❌ 동기화 중 오류가 발생했습니다: ' + error.message);
      }
    }
    
    /**
     * 스케줄이 없는 경우에만 초기 스케줄 생성
     * @param {Object} contractData - 계약서 데이터
     */
    async function createInitialScheduleIfNotExists(contractData) {
      try {
        const employeeId = contractData.employeeId;
        if (!employeeId) return;
        
        const startDate = new Date(contractData.contractStartDate || contractData.startDate);
        
        // 계약 시작일이 속한 주의 월요일 계산
        const monday = new Date(startDate);
        const dayOfWeek = monday.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        monday.setDate(monday.getDate() + diff);
        
        // 해당 주의 일요일 계산
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        
        const mondayStr = monday.toISOString().split('T')[0];
        const sundayStr = sunday.toISOString().split('T')[0];
        
        // 해당 주에 이미 스케줄이 있는지 확인 (새 구조: 날짜 범위 쿼리)
        const existingSchedules = await db.collection('schedules')
          .where('userId', '==', employeeId)
          .where('date', '>=', mondayStr)
          .where('date', '<=', sundayStr)
          .limit(1)
          .get();
        
        if (!existingSchedules.empty) {
          console.log(`  ⏭️ 스케줄 이미 존재: ${mondayStr} ~ ${sundayStr}`);
          return;
        }
        
        // 스케줄이 없으면 생성
        await createInitialSchedule(contractData);
        
      } catch (error) {
        console.error('❌ 스케줄 생성 확인 실패:', error);
      }
    }
    
    /**
     * 계약서 작성 완료 시 직원 정보 업데이트 (최신 계약서 반영)
     * @param {Object} contractData - 계약서 데이터
     */
    async function updateEmployeeFromContract(contractData) {
      try {
        console.log('🔄 직원 정보 업데이트 시작');
        
        const employeeId = contractData.employeeId;
        if (!employeeId) {
          console.warn('⚠️ 직원 ID가 없어 정보 업데이트를 건너뜁니다.');
          return;
        }
        
        // 직원 문서 참조
        const employeeRef = firebase.firestore().collection('users').doc(employeeId);
        const employeeDoc = await employeeRef.get();
        
        if (!employeeDoc.exists) {
          console.warn(`⚠️ 직원 문서를 찾을 수 없습니다: ${employeeId}`);
          return;
        }
        
        // 업데이트할 정보 (최신 계약서 기준)
        const updateData = {
          store: contractData.workStore,                          // 근무지 (매장 이름)
          position: contractData.position || contractData.employeePosition,  // 직책
          salaryType: contractData.salaryType || 'hourly',        // 급여 유형 (신 필드명)
          salaryAmount: parseInt(contractData.salaryAmount || 0), // 급여 금액 (신 필드명)
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await employeeRef.update(updateData);
        
        console.log(`✅ 직원 정보 업데이트 완료: ${contractData.employeeName}`);
        console.log(`   - 근무지: ${updateData.store}`);
        console.log(`   - 직책: ${updateData.position}`);
        console.log(`   - 급여: ${updateData.salaryType} ${updateData.salaryAmount.toLocaleString()}원`);
        
      } catch (error) {
        console.error('❌ 직원 정보 업데이트 실패:', error);
        // 업데이트 실패해도 계약서 생성은 계속 진행
      }
    }
    
    /**
     * 계약서 작성 완료 시 초기 스케줄 자동 생성 (요일별 다른 시간 지원 + 여러 주차)
     * @param {Object} contractData - 계약서 데이터
     */
    async function createInitialSchedule(contractData) {
      try {
        console.log('📅 초기 스케줄 자동 생성 시작');
        
        // 직원 UID 가져오기
        const employeeId = contractData.employeeId;
        if (!employeeId) {
          console.warn('⚠️ 직원 ID가 없어 스케줄 생성을 건너뜁니다.');
          return;
        }
        
        // 계약 시작일/종료일 가져오기
        const startDateStr = contractData.contractStartDate || contractData.startDate;
        const endDateStr = contractData.contractEndDate || contractData.endDate;
        
        const startDate = new Date(startDateStr);
        const endDate = endDateStr && endDateStr !== '기간의 정함이 없음' ? new Date(endDateStr) : null;
        
        console.log(`📌 직원: ${contractData.employeeName}`);
        console.log(`   계약 기간: ${startDateStr} ~ ${endDateStr || '기간의 정함이 없음'}`);
        
        // 요일별 근무시간 매핑 생성 (schedules 배열 사용)
        const dayScheduleMap = {}; // { '월': { startTime, endTime, hours }, ... }
        const allDays = ['월', '화', '수', '목', '금', '토', '일'];
        
        // schedules 배열이 있으면 사용
        if (contractData.schedules && Array.isArray(contractData.schedules) && contractData.schedules.length > 0) {
          console.log('📋 계약서 schedules 배열 사용');
          
          // 휴게시간 파싱
          const breakTimeStr = contractData.schedule?.breakTime || contractData.breakTime || '';
          const breakMatch = breakTimeStr.match(/(\d+)시간/);
          const breakHours = breakMatch ? parseFloat(breakMatch[1]) : 0;
          
          contractData.schedules.forEach(schedule => {
            const startTime = `${String(schedule.startHour).padStart(2, '0')}:${String(schedule.startMinute).padStart(2, '0')}`;
            const endTime = `${String(schedule.endHour).padStart(2, '0')}:${String(schedule.endMinute).padStart(2, '0')}`;
            
            // 근무 시간 계산 (휴게시간 제외)
            const totalMinutes = (parseInt(schedule.endHour) * 60 + parseInt(schedule.endMinute)) - 
                                (parseInt(schedule.startHour) * 60 + parseInt(schedule.startMinute));
            const workHours = Math.max(0, (totalMinutes / 60) - breakHours);
            
            // 해당 스케줄의 요일들에 적용
            schedule.days.forEach(day => {
              dayScheduleMap[day] = {
                startTime: startTime,
                endTime: endTime,
                hours: workHours
              };
            });
            
            console.log(`   ${schedule.days.join(', ')}: ${startTime} - ${endTime} (${workHours}h)`);
          });
        } else {
          // schedules 배열이 없으면 기존 방식 사용
          console.log('📋 workDays/workTime 사용 (모든 근무일 같은 시간)');
          
          const workDaysStr = contractData.schedule?.days || contractData.workDays || '';
          const workDays = workDaysStr.split(',').map(d => d.trim()).filter(d => d);
          
          const workTimeStr = contractData.schedule?.time || contractData.workTime || '';
          const timeMatch = workTimeStr.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
          const startTime = timeMatch ? timeMatch[1] : '09:00';
          const endTime = timeMatch ? timeMatch[2] : '18:00';
          
          const breakTimeStr = contractData.schedule?.breakTime || contractData.breakTime || '';
          const breakMatch = breakTimeStr.match(/(\d+)시간/);
          const breakHours = breakMatch ? parseFloat(breakMatch[1]) : 0;
          
          const totalMinutes = (parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1])) - 
                              (parseInt(endTime.split(':')[0]) * 60 + parseInt(endTime.split(':')[1]));
          const workHours = Math.max(0, Math.abs(totalMinutes / 60) - breakHours);
          
          workDays.forEach(day => {
            dayScheduleMap[day] = {
              startTime: startTime,
              endTime: endTime,
              hours: workHours
            };
          });
          
          console.log(`   ${workDays.join(', ')}: ${startTime} - ${endTime} (${workHours}h)`);
        }
        
        // 생성할 주차 범위 결정 (계약 시작일부터 4주 또는 계약 종료일까지)
        const weeksToCreate = [];
        let currentDate = new Date(startDate);
        const maxWeeks = 4; // 최대 4주 생성
        
        for (let i = 0; i < maxWeeks; i++) {
          const monday = getMonday(currentDate);
          const year = monday.getFullYear();
          const weekNum = getWeekNumber(monday);
          
          // 계약 종료일이 있으면 체크
          if (endDate && monday > endDate) {
            break;
          }
          
          weeksToCreate.push({ year, weekNum, monday });
          
          // 다음 주로 이동
          currentDate.setDate(currentDate.getDate() + 7);
        }
        
        console.log(`📅 생성할 주차: ${weeksToCreate.length}주`);
        
        // 새 구조: 각 날짜별 근무를 개별 문서로 생성
        let batch = firebase.firestore().batch();
        let docCount = 0;
        
        for (const week of weeksToCreate) {
          // 해당 주의 각 요일별로 처리
          for (let dayIndex = 0; dayIndex < allDays.length; dayIndex++) {
            const day = allDays[dayIndex];
            
            // 해당 요일에 근무가 있는지 확인
            if (dayScheduleMap[day]) {
              // 해당 날짜 계산
              const workDate = new Date(week.monday);
              workDate.setDate(workDate.getDate() + dayIndex);
              const dateStr = workDate.toISOString().split('T')[0]; // YYYY-MM-DD
              
              // 새 스케줄 문서 생성
              const scheduleRef = firebase.firestore().collection('schedules').doc();
              const scheduleData = {
                userId: employeeId,
                userName: contractData.employeeName,
                store: contractData.workStore,
                date: dateStr,
                startTime: dayScheduleMap[day].startTime,
                endTime: dayScheduleMap[day].endTime,
                hours: dayScheduleMap[day].hours,
                isShiftReplacement: false,
                shiftRequestId: null,
                originalRequesterId: null,
                originalRequesterName: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              batch.set(scheduleRef, scheduleData);
              docCount++;
              
              // 500개마다 커밋
              if (docCount % 500 === 0) {
                await batch.commit();
                console.log(`   ${docCount}개 스케줄 생성 중...`);
                batch = firebase.firestore().batch(); // 새 배치 생성
              }
            }
          }
        }
        
        // 남은 배치 커밋
        if (docCount % 500 !== 0) {
          await batch.commit();
        }
        
        console.log(`✅ 초기 스케줄 생성 완료: ${docCount}개 근무`);
        
      } catch (error) {
        console.error('❌ 초기 스케줄 생성 실패:', error);
        // 스케줄 생성 실패해도 계약서 생성은 계속 진행
      }
    }
  </script>

  <!-- 계약서 작성 모달 -->
  <div id="contractModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin: 0;">📝 근로계약서 작성</h2>
        <button class="modal-close" onclick="closeContractModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- 탭 및 저장된 계약서 불러오기 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
          <div class="tab-buttons" style="margin-bottom: 0;">
            <button id="formTabBtn" class="tab-button active" onclick="switchContractTab('form')">✍️ 작성하기</button>
            <button id="previewTabBtn" class="tab-button" onclick="switchContractTab('preview')">👁️ 미리보기</button>
          </div>
          <button class="btn btn-secondary" onclick="showLoadContractModal()">📂 저장된 계약서 불러오기</button>
        </div>

        <!-- 작성 폼 탭 -->
        <div id="formTab" class="tab-content active">
          <!-- 1. 직원 및 사용자 정보 -->
          <div class="form-section">
            <h3>1. 기본 정보</h3>
            
            <h4>👤 근로자 (직원) 정보</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="employeeSelect">직원 선택 *</label>
                <select id="employeeSelect" required onchange="loadEmployeeInfo(); updatePreview();">
                  <option value="">선택하세요</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="employeeName">이름 *</label>
                <input type="text" id="employeeName" placeholder="자동 입력" readonly required>
              </div>
              <div class="form-group">
                <label for="employeeBirth">주민등록번호 *</label>
                <input type="text" id="employeeBirth" placeholder="123456-1234567" pattern="\d{6}-\d{7}" readonly required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="employeeAddress">주소 *</label>
                <input type="text" id="employeeAddress" required>
              </div>
              <div class="form-group">
                <label for="employeePhone">연락처 *</label>
                <input type="tel" id="employeePhone" required>
              </div>
            </div>

            <h4>🏢 사용자 (회사) 정보</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="storeSelect">매장 선택 *</label>
                <select id="storeSelect" required onchange="loadStoreInfoToContract(); applyStoreAllowances(this.options[this.selectedIndex].text); updatePreview();">
                  <option value="">선택하세요</option>
                </select>
              </div>
            </div>
            <p class="help-text" style="margin-top: -12px; margin-bottom: 16px;">
              💡 매장 정보는 '매장 관리' 탭에서 관리할 수 있습니다.
            </p>
            <div class="form-row">
              <div class="form-group">
                <label for="companyCEO">대표자명 *</label>
                <input type="text" id="companyCEO" placeholder="자동 입력" readonly required>
              </div>
              <div class="form-group">
                <label for="companyBusinessNumber">사업자등록번호 *</label>
                <input type="text" id="companyBusinessNumber" placeholder="자동 입력" readonly required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="companyPhone">회사 연락처 *</label>
                <input type="tel" id="companyPhone" placeholder="자동 입력" readonly required>
              </div>
              <div class="form-group">
                <label for="companyAddress">사업장 주소 *</label>
                <input type="text" id="companyAddress" placeholder="자동 입력" readonly required>
              </div>
            </div>
          </div>

          <!-- 2. 계약 정보 -->
          <div class="form-section">
            <h3>2. 계약 정보</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="contractType">계약 유형 *</label>
                <select id="contractType" required>
                  <option value="">선택하세요</option>
                  <option value="정규직">정규직</option>
                  <option value="계약직">계약직</option>
                  <option value="시간제">시간제</option>
                </select>
              </div>
              <div class="form-group">
                <label for="workStore">근무 매장 *</label>
                <input type="text" id="workStore" placeholder="자동 입력" readonly required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="startDate">계약 시작일 *</label>
                <input type="date" id="startDate" required>
              </div>
              <div class="form-group">
                <label for="endDate">계약 종료일</label>
                <input type="date" id="endDate">
                <p class="help-text">기간의 정함이 없는 경우 비워두세요</p>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="position">직책/직무 *</label>
                <input type="text" id="position" placeholder="바리스타, 매니저 등" required>
              </div>
            </div>
          </div>

          <!-- 3. 근무 조건 -->
          <div class="form-section">
            <h3>3. 근무 조건</h3>
            
            <!-- 근무 시간대 (다중 스케줄) -->
            <div id="workScheduleContainer">
              <div class="work-schedule-item" data-index="0">
                <div class="form-group">
                  <label>근무일 *</label>
                  <div class="day-buttons">
                    <button type="button" class="day-btn" data-day="월" onclick="toggleDayForSchedule(this, 0)">월</button>
                    <button type="button" class="day-btn" data-day="화" onclick="toggleDayForSchedule(this, 0)">화</button>
                    <button type="button" class="day-btn" data-day="수" onclick="toggleDayForSchedule(this, 0)">수</button>
                    <button type="button" class="day-btn" data-day="목" onclick="toggleDayForSchedule(this, 0)">목</button>
                    <button type="button" class="day-btn" data-day="금" onclick="toggleDayForSchedule(this, 0)">금</button>
                    <button type="button" class="day-btn" data-day="토" onclick="toggleDayForSchedule(this, 0)">토</button>
                    <button type="button" class="day-btn" data-day="일" onclick="toggleDayForSchedule(this, 0)">일</button>
                  </div>
                </div>
                <div class="form-row" style="align-items: flex-end;">
                  <div class="form-group">
                    <label>시작 시간 *</label>
                    <div style="display: flex; gap: 8px;">
                      <select class="schedule-start-hour" required onchange="updateWorkTimeDisplay()">
                        <option value="">시</option>
                      </select>
                      <select class="schedule-start-minute" required onchange="updateWorkTimeDisplay()">
                        <option value="">분</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>종료 시간 *</label>
                    <div style="display: flex; gap: 8px;">
                      <select class="schedule-end-hour" required onchange="updateWorkTimeDisplay()">
                        <option value="">시</option>
                      </select>
                      <select class="schedule-end-minute" required onchange="updateWorkTimeDisplay()">
                        <option value="">분</option>
                      </select>
                    </div>
                  </div>
                  <button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(0)" style="display: none; height: 42px; margin-bottom: 0;">삭제</button>
                </div>
              </div>
            </div>
            
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSchedule()" style="margin-top: 8px;">
              ➕ 시간대 추가
            </button>
            <input type="hidden" id="workDays">
            <input type="hidden" id="workTime">

            <!-- 휴게시간 -->
            <div class="form-row" style="margin-top: var(--spacing-md);">
              <div class="form-group">
                <label>휴게시간 (선택사항)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <select id="breakTimeHour" onchange="updateBreakTimeDisplay()">
                    <option value="">시간</option>
                    <option value="0">0시간</option>
                    <option value="1">1시간</option>
                    <option value="2">2시간</option>
                  </select>
                  <select id="breakTimeMinute" onchange="updateBreakTimeDisplay()">
                    <option value="">분</option>
                    <option value="0">0분</option>
                    <option value="15">15분</option>
                    <option value="30">30분</option>
                    <option value="45">45분</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>휴게시간 시작 (선택사항)</label>
                <div style="display: flex; gap: 8px;">
                  <select id="breakStartHour" onchange="updateBreakTimeDisplay()">
                    <option value="">시</option>
                  </select>
                  <select id="breakStartMinute" onchange="updateBreakTimeDisplay()">
                    <option value="">분</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>휴게시간 종료 (선택사항)</label>
                <div style="display: flex; gap: 8px;">
                  <select id="breakEndHour" onchange="updateBreakTimeDisplay()">
                    <option value="">시</option>
                  </select>
                  <select id="breakEndMinute" onchange="updateBreakTimeDisplay()">
                    <option value="">분</option>
                  </select>
                </div>
              </div>
            </div>
            <input type="hidden" id="breakTime">
            <p class="help-text" id="breakTimePreview" style="margin-top: 8px;"></p>
          </div>

          <!-- 4. 급여 조건 -->
          <div class="form-section">
            <h3>4. 급여 조건</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="wageType">급여 형태 *</label>
                <select id="wageType" required>
                  <option value="">선택하세요</option>
                  <option value="시급">시급</option>
                  <option value="월급">월급</option>
                  <option value="연봉">연봉</option>
                </select>
              </div>
              <div class="form-group">
                <label for="wageAmount">급여액 *</label>
                <input type="number" id="wageAmount" placeholder="금액 입력" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="paymentDay">급여 지급일 *</label>
                <select id="paymentDay" required>
                  <option value="">선택하세요</option>
                  <option value="매월 10일">매월 10일</option>
                  <option value="매월 25일">매월 25일</option>
                  <option value="매월 말일">매월 말일</option>
                </select>
              </div>
              <div class="form-group">
                <label for="paymentMethod">급여 지급 방법 *</label>
                <select id="paymentMethod" required>
                  <option value="">선택하세요</option>
                  <option value="계좌이체">계좌이체</option>
                  <option value="현금">현금</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 5. 지급 항목 설정 -->
          <div class="form-section" style="border: 2px solid var(--primary-color); padding: var(--spacing-lg);">
            <h3>5. 급여 지급 항목 설정</h3>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
              💡 이 직원의 급여 계산 시 적용할 수당 항목을 선택하세요. (매장 설정 기준으로 자동 선택됨)
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
              <!-- 주휴수당은 주간 근무시간에 따라 자동 적용 (숨김) -->
              <input type="checkbox" id="allowWeeklyHoliday" style="display: none;">
              
              <label style="display: none; align-items: center; padding: var(--spacing-sm); background: var(--e8f5e9); border-radius: var(--border-radius); border: 1px solid var(--success-color); pointer-events: none;">
                <input type="checkbox" id="allowWeeklyHolidayDisplay" disabled checked style="width: auto; margin-right: 8px;">
                <span style="font-size: 14px; color: var(--success-color);">✅ 주휴수당 (주 15시간 이상 근무 시 자동 적용)</span>
              </label>
              
              <label style="display: flex; align-items: center; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius); cursor: pointer;">
                <input type="checkbox" id="allowOvertime" style="width: auto; margin-right: 8px;">
                <span style="font-size: 14px;">연장근로수당 (시급 × 1.5배)</span>
              </label>
              
              <label style="display: flex; align-items: center; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius); cursor: pointer;">
                <input type="checkbox" id="allowNight" style="width: auto; margin-right: 8px;">
                <span style="font-size: 14px;">야간근로수당 (22:00~06:00)</span>
              </label>
              
              <label style="display: flex; align-items: center; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius); cursor: pointer;">
                <input type="checkbox" id="allowHoliday" style="width: auto; margin-right: 8px;">
                <span style="font-size: 14px;">휴일근로수당 (시급 × 1.5배)</span>
              </label>
            </div>
          </div>

          <!-- 6. 공제 항목 설정 -->
          <div class="form-section" style="border: 2px solid var(--danger-color); padding: var(--spacing-lg);">
            <h3>6. 4대보험 적용</h3>
            <div class="form-group">
              <label for="insuranceType">4대보험 및 세금 적용 방식 *</label>
              <select id="insuranceType" required onchange="updateInsuranceInfo()">
                <option value="">선택하세요</option>
                <option value="all">전체 적용 (국민연금+건강+장기요양+고용+산재)</option>
                <option value="employment_only">고용·산재보험만 (단시간 근로자)</option>
                <option value="freelancer">소득세만 적용 (프리랜서 3.3%)</option>
                <option value="none">완전 적용 안 함 (세금 없음)</option>
              </select>
            </div>
            
            <div id="insuranceInfo" style="background: #f8f9fa; padding: var(--spacing-md); border-radius: var(--border-radius); font-size: 13px; color: #666; display: none;">
              <p style="margin: 0;"></p>
            </div>
            
            <div style="margin-top: var(--spacing-md);">
              <label style="display: flex; align-items: center; padding: var(--spacing-sm); background: var(--bg-light); border-radius: var(--border-radius); cursor: pointer;">
                <input type="checkbox" id="allowSeverancePay" style="width: auto; margin-right: 8px;" onchange="updatePreview()">
                <span style="font-size: 14px;"><strong>퇴직금 적용 대상</strong> (주 15시간 이상 근무, 1년 이상 근속)</span>
              </label>
            </div>
          </div>

          <!-- 7. 계약서 본문 -->
          <div class="form-section">
            <h3>7. 계약서 본문 (선택사항)</h3>
            <div class="form-group">
              <label for="contractContent">계약서 추가 내용</label>
              <textarea id="contractContent" placeholder="기본 템플릿이 자동으로 제공됩니다. 필요시 수정하세요." style="min-height: 500px; height: auto;"></textarea>
              <p class="help-text">특약사항이나 추가 내용이 있으면 입력하세요</p>
            </div>
          </div>

          <!-- 액션 버튼 -->
          <div class="action-buttons">
            <button class="btn btn-secondary" onclick="closeContractModal()">← 닫기</button>
            <button class="btn btn-secondary" onclick="showSaveContractModal()">📁 계약서 저장</button>
            <button class="btn btn-primary" onclick="switchContractTab('preview')">미리보기 →</button>
          </div>
        </div>

        <!-- 미리보기 탭 -->
        <div id="previewTab" class="tab-content">
          <div class="preview-section">
            <div class="preview-content" id="previewContent">
              <div class="preview-title">근 로 계 약 서</div>
              
              <p><strong><span id="previewCompanyName">(주)ABC디저트센터</span></strong> (이하 "사용자"라 함)와 <strong id="previewName">_______</strong> (이하 "근로자"라 함)는 다음과 같이 근로계약을 체결한다.</p>

              <table class="preview-table">
                <tr>
                  <th>근로자 (직원) 정보</th>
                  <td>
                    <div>성명: <span id="previewEmployeeName">_______</span></div>
                    <div>주민등록번호: <span id="previewBirth">_______</span></div>
                    <div>주소: <span id="previewAddress">_______</span></div>
                    <div>연락처: <span id="previewPhone">_______</span></div>
                  </td>
                </tr>
                <tr>
                  <th>사용자 (회사) 정보</th>
                  <td>
                    <div>상호: <span id="previewCompanyNameDetail">_______</span></div>
                    <div>대표자: <span id="previewCEODetail">_______</span></div>
                    <div>사업자등록번호: <span id="previewBusinessNumber">_______</span></div>
                    <div>회사 전화번호: <span id="previewCompanyPhone">_______</span></div>
                    <div>사업장 주소: <span id="previewCompanyAddress">_______</span></div>
                  </td>
                </tr>
                <tr>
                  <th>계약 기간</th>
                  <td>
                    <span id="previewStartDate">_______</span> ~ <span id="previewEndDate">기간의 정함이 없음</span>
                  </td>
                </tr>
                <tr>
                  <th>근무 장소</th>
                  <td>맛남살롱 <span id="previewStore">_______</span></td>
                </tr>
                <tr>
                  <th>업무 내용</th>
                  <td><span id="previewPosition">_______</span></td>
                </tr>
                <tr>
                  <th>근무 일시</th>
                  <td>
                    <div>근무일: <span id="previewWorkDays">_______</span></div>
                    <div>근무시간: <span id="previewWorkTime">_______</span></div>
                    <div>휴게시간: <span id="previewBreakTime">_______</span></div>
                  </td>
                </tr>
                <tr>
                  <th>급여 조건</th>
                  <td>
                    <div><span id="previewWageType">_______</span>: <span id="previewWageAmount">_______</span>원</div>
                    <div>지급일: <span id="previewPaymentDay">_______</span></div>
                    <div>지급방법: <span id="previewPaymentMethod">_______</span></div>
                    <div id="previewSeverancePay" style="display: none; margin-top: 4px; color: #666; font-size: 13px;">
                      • 1년 이상 근속 시 퇴직금 지급 대상에 해당
                    </div>
                  </td>
                </tr>
              </table>

              <div id="previewContractBody"></div>

              <p style="text-align: center; margin-top: 40px;">
                <strong id="previewContractDate">20__년 __월 __일</strong>
              </p>

              <div style="margin-top: 40px; display: flex; justify-content: space-around;">
                <div style="text-align: center;">
                  <p>사용자 <span id="previewCompanyName2">(주)ABC디저트센터</span></p>
                  <p style="margin-top: 20px;">대표이사: <span id="previewCEO">_______</span> (인)</p>
                </div>
                <div style="text-align: center;">
                  <p>근로자</p>
                  <p style="margin-top: 20px;"><span id="previewEmployeeName2">_______</span> (인)</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 액션 버튼 -->
          <div class="action-buttons">
            <button class="btn btn-secondary" onclick="switchContractTab('form')">← 수정하기</button>
            <button class="btn btn-primary" onclick="generateContract()">계약서 생성</button>
          </div>

          <!-- 서명 링크 표시 영역 -->
          <div id="signLinkSection" style="display: none; margin-top: var(--spacing-lg);">
            <div class="form-section">
              <h3 style="color: var(--success-color);">✅ 계약서 생성 완료!</h3>
              <p style="margin-bottom: var(--spacing-md);">계약서가 성공적으로 생성되었습니다. 아래 링크를 직원에게 전송하여 서명을 요청하세요.</p>
              
              <div style="margin-bottom: var(--spacing-md);">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">📋 계약서 ID</label>
                <div id="contractIdDisplay" style="padding: var(--spacing-md); background: var(--bg-light); border-radius: var(--border-radius); font-family: monospace;"></div>
              </div>

              <div style="margin-bottom: var(--spacing-md);">
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">🔗 서명 링크</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="signLinkInput" readonly style="flex: 1; padding: var(--spacing-md); border: 2px solid var(--success-color); border-radius: var(--border-radius);">
                  <button class="btn btn-primary" onclick="copySignLink()">📋 복사</button>
                </div>
              </div>

              <div class="action-buttons">
                <button class="btn btn-secondary" onclick="closeContractModal()">← 닫기</button>
                <button class="btn btn-primary" onclick="resetContractForm()">+ 새 계약서 작성</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 회사 추가 모달 -->
  <div id="addCompanyModal" class="modal-overlay" style="display: none; z-index: 10001;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="companyModalTitle">🏢 회사 추가</h3>
        <button class="modal-close" onclick="closeAddCompanyModal()">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCompanyId" value="">
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <label for="newCompanyName">회사명 *</label>
          <input type="text" id="newCompanyName" placeholder="예: (주)ABC디저트센터">
        </div>
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <label for="newCompanyCEO">대표자명 *</label>
          <input type="text" id="newCompanyCEO" placeholder="예: 홍길동">
        </div>
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <label for="newCompanyBusinessNumber">사업자등록번호 *</label>
          <input type="text" id="newCompanyBusinessNumber" placeholder="예: 123-45-67890">
        </div>
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <label for="newCompanyPhone">회사 연락처 *</label>
          <input type="tel" id="newCompanyPhone" placeholder="예: 032-123-4567">
        </div>
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <label for="newCompanyAddress">사업장 주소 *</label>
          <input type="text" id="newCompanyAddress" placeholder="예: 경기도 부천시 원미구 74">
        </div>
      </div>
      <div class="modal-footer">
        <div id="deleteCompanyBtnContainer" style="margin-right: auto; display: none;">
          <button class="btn btn-danger" onclick="deleteCompany()">🗑️ 삭제</button>
        </div>
        <button class="btn btn-secondary" onclick="closeAddCompanyModal()">취소</button>
        <button class="btn btn-primary" onclick="saveCompany()">저장</button>
      </div>
    </div>
  </div>

  <!-- 계약서 확인 모달 -->
  <div id="employeeContractsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2 style="margin: 0;">📄 <span id="employeeContractsName"></span>님의 계약서</h2>
        <button class="modal-close" onclick="closeEmployeeContractsModal()">✕</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: var(--spacing-lg); display: flex; justify-content: space-between; align-items: center;">
          <p class="help-text" style="margin: 0;">
            📋 직원의 계약서 목록입니다. 계약서를 클릭하면 상세 내용을 확인할 수 있습니다.
          </p>
          <button class="btn btn-primary" onclick="createNewContractForEmployee()">
            ➕ 새 계약서 작성
          </button>
        </div>
        
        <div id="employeeContractsList" style="display: grid; gap: var(--spacing-md);">
          <!-- 계약서 목록이 여기에 표시됩니다 -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEmployeeContractsModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 계약서 저장 모달 -->
  <div id="saveContractModal" class="modal-overlay" style="display: none; z-index: 10001;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>💾 계약서 저장</h3>
        <button class="modal-close" onclick="closeSaveContractModal()">✕</button>
      </div>
      <div class="modal-body">
        <p class="help-text" style="margin-bottom: var(--spacing-md);">
          저장할 계약서의 이름을 입력하세요.
        </p>
        <div class="form-group">
          <label for="contractSaveName">계약서 이름 *</label>
          <input type="text" id="contractSaveName" placeholder="예: 홍길동_바리스타_2024년">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSaveContractModal()">취소</button>
        <button class="btn btn-primary" onclick="saveContract()">저장</button>
      </div>
    </div>
  </div>

  <!-- 저장된 계약서 불러오기 모달 -->
  <div id="loadContractModal" class="modal-overlay" style="display: none; z-index: 10001;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📂 저장된 계약서 불러오기</h3>
        <button class="modal-close" onclick="closeLoadContractModal()">✕</button>
      </div>
      <div class="modal-body">
        <p class="help-text" style="margin-bottom: var(--spacing-md);">
          불러올 계약서를 선택하세요. 현재 작성 중인 내용은 덮어씌워집니다.
        </p>
        <div id="savedContractsList">
          <p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
            저장된 계약서가 없습니다.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLoadContractModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 급여 상세 모달 -->
  <div id="salaryDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 style="margin: 0;">💰 급여 상세 내역</h2>
        <button class="modal-close" onclick="closeSalaryDetailModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- 기본 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">직원명</div>
              <div style="font-size: 16px; font-weight: 600;" id="salaryDetailName">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">매장</div>
              <div style="font-size: 16px; font-weight: 600;" id="salaryDetailStore">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">조회 월</div>
              <div style="font-size: 16px; font-weight: 600;" id="salaryDetailMonth">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">근무 일수</div>
              <div style="font-size: 16px; font-weight: 600;" id="salaryDetailWorkDays">-</div>
            </div>
          </div>
        </div>

        <!-- 지급 항목 -->
        <div style="margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">📊 지급 항목</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 2px solid var(--border-color);">
              <td style="padding: 12px; font-weight: 600;">항목</td>
              <td style="padding: 12px; text-align: right; font-weight: 600;">금액</td>
            </tr>
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                기본급 (시급 <span id="salaryDetailHourlyWage">-</span>원 × <span id="salaryDetailTotalHours">-</span>시간)
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);" id="salaryDetailBasePay">-</td>
            </tr>
            <tr id="salaryDetailOvertimeRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                연장근로수당 (시급 × 1.5배 × <span id="salaryDetailOvertimeHours">-</span>시간)
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--success-color);" id="salaryDetailOvertimePay">-</td>
            </tr>
            <tr id="salaryDetailNightRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                야간근로수당 (시급 × 0.5배 × <span id="salaryDetailNightHours">-</span>시간)
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--success-color);" id="salaryDetailNightPay">-</td>
            </tr>
            <tr id="salaryDetailHolidayRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                휴일근로수당 (시급 × 1.5배)
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--success-color);" id="salaryDetailHolidayPay">-</td>
            </tr>
            <tr id="salaryDetailWeeklyRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                주휴수당
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--success-color);" id="salaryDetailWeeklyPay">-</td>
            </tr>
            <tr id="salaryDetailSeveranceRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">
                퇴직금 (1년 이상 근속, 주 15시간 이상)
              </td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--success-color);" id="salaryDetailSeverancePay">-</td>
            </tr>
            <tr style="background: var(--bg-light); font-weight: 600;">
              <td style="padding: 12px; border-bottom: 2px solid var(--border-color);">총 지급액 (공제 전)</td>
              <td style="padding: 12px; text-align: right; font-size: 16px; border-bottom: 2px solid var(--border-color);" id="salaryDetailTotalPay">-</td>
            </tr>
          </table>
        </div>

        <!-- 공제 항목 -->
        <div style="margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--danger-color);">📋 공제 항목</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 2px solid var(--border-color);">
              <td style="padding: 12px; font-weight: 600;">항목</td>
              <td style="padding: 12px; text-align: right; font-weight: 600;">금액</td>
            </tr>
            <tr id="salaryDetailPensionRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">국민연금 (4.5%)</td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--danger-color);" id="salaryDetailPension">-</td>
            </tr>
            <tr id="salaryDetailHealthRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">건강보험 (3.545%)</td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--danger-color);" id="salaryDetailHealth">-</td>
            </tr>
            <tr id="salaryDetailLongTermRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">장기요양 (0.459%)</td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--danger-color);" id="salaryDetailLongTerm">-</td>
            </tr>
            <tr id="salaryDetailEmploymentRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">고용보험 (0.9%)</td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--danger-color);" id="salaryDetailEmployment">-</td>
            </tr>
            <tr id="salaryDetailTaxRow" style="display: none;">
              <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">소득세 (3.3%)</td>
              <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); color: var(--danger-color);" id="salaryDetailTax">-</td>
            </tr>
            <tr style="background: var(--bg-light); font-weight: 600;">
              <td style="padding: 12px; border-bottom: 2px solid var(--border-color);">총 공제액</td>
              <td style="padding: 12px; text-align: right; font-size: 16px; border-bottom: 2px solid var(--border-color); color: var(--danger-color);" id="salaryDetailTotalDeduction">-</td>
            </tr>
          </table>
        </div>

        <!-- 실지급액 -->
        <div style="background: var(--primary-color); color: white; padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center;">
          <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">실지급액</div>
          <div style="font-size: 32px; font-weight: 700;" id="salaryDetailNetPay">-</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSalaryDetailModal()">닫기</button>
        <button class="btn btn-info" onclick="downloadSalaryPDF()" style="margin-right: 8px;">📄 PDF 다운로드</button>
        <button id="confirmSeveranceBtn" class="btn btn-warning" onclick="confirmSeverancePay()" style="margin-right: 8px; display: none;">💰 퇴직금 확정</button>
        <button class="btn btn-success" onclick="confirmSalaryFromDetail()">✅ 급여 확정</button>
      </div>
    </div>
  </div>

  <!-- 직원 상세 모달 -->
  <div id="employeeDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h2 style="margin: 0;">👤 직원 상세 정보</h2>
        <button class="modal-close" onclick="closeEmployeeDetailModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- 기본 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">📋 기본 정보</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">이름</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailName">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">매장</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailStore">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">직급</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailPosition">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">연락처</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailPhone">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">이메일</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailEmail">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">생년월일</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailBirth">-</div>
            </div>
            <div style="grid-column: 1 / -1;">
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">주소</div>
              <div style="font-size: 16px; font-weight: 600;" id="empDetailAddress">-</div>
            </div>
          </div>
        </div>

        <!-- 서류 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">📄 서류 정보</h3>
          <div id="empDetailDocuments" style="font-size: 14px; color: var(--text-secondary);">
            서류 정보를 불러오는 중...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEmployeeDetailModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 관리자 상세 모달 -->
  <div id="adminDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 style="margin: 0;">👑 관리자 상세 정보</h2>
        <button class="modal-close" onclick="closeAdminDetailModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- 기본 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">📋 기본 정보</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">이름</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailName">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">역할</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailRole">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">이메일</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailEmail">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">연락처</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailPhone">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">생년월일</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailBirth">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">가입일</div>
              <div style="font-size: 16px; font-weight: 600;" id="adminDetailCreatedAt">-</div>
            </div>
          </div>
        </div>

        <!-- 권한 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">🔐 권한</h3>
          <div id="adminDetailPermissions" style="font-size: 14px;">
            권한 정보를 불러오는 중...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAdminDetailModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 관리자 근무시간 수정 모달 -->
  <div id="adminEditAttendanceModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 style="margin: 0;">✏️ 근무시간 수정 (관리자)</h2>
        <button class="modal-close" onclick="closeAdminEditAttendanceModal()">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>직원명</label>
          <input type="text" id="adminEditEmployeeName" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-group">
          <label>날짜</label>
          <input type="text" id="adminEditDate" readonly style="background: #f5f5f5;">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>출근시간 *</label>
            <input type="time" id="adminEditClockIn" required>
          </div>
          <div class="form-group">
            <label>퇴근시간 *</label>
            <input type="time" id="adminEditClockOut" required>
          </div>
        </div>
        <div class="form-group">
          <label>수정 사유 * <span style="color: var(--danger-color); font-size: 12px;">(필수 - 직원에게 전달됨)</span></label>
          <textarea id="adminEditReason" rows="5" placeholder="근무시간을 수정하는 이유를 입력해주세요 (직원이 확인할 수 있습니다)" required style="min-height: 120px;"></textarea>
        </div>
        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 12px;">
          💡 수정 내용은 해당 직원에게 알림됩니다.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAdminEditAttendanceModal()">취소</button>
        <button class="btn btn-primary" onclick="submitAdminAttendanceEdit()">수정 완료</button>
      </div>
    </div>
  </div>

  <!-- 근무기록 상세 모달 -->
  <div id="attendanceDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 style="margin: 0;">📋 근무기록 상세</h2>
        <button class="modal-close" onclick="closeAttendanceDetailModal()">✕</button>
      </div>
      <div class="modal-body">
        <!-- 기본 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">👤 직원 정보</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">이름</div>
              <div style="font-size: 16px; font-weight: 600;" id="detailEmployeeName">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">매장</div>
              <div style="font-size: 16px; font-weight: 600;" id="detailStore">-</div>
            </div>
          </div>
        </div>

        <!-- 근무 정보 -->
        <div style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">⏰ 근무 정보</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">날짜</div>
              <div style="font-size: 16px; font-weight: 600;" id="detailDate">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">근무타입</div>
              <div style="font-size: 16px; font-weight: 600;" id="detailWorkType">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">출근시간</div>
              <div style="font-size: 16px; font-weight: 600; color: var(--success-color);" id="detailClockIn">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">퇴근시간</div>
              <div style="font-size: 16px; font-weight: 600; color: var(--danger-color);" id="detailClockOut">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">근무시간</div>
              <div style="font-size: 16px; font-weight: 600; color: var(--primary-color);" id="detailWorkHours">-</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">상태</div>
              <div style="font-size: 16px; font-weight: 600;" id="detailStatus">-</div>
            </div>
          </div>
        </div>

        <!-- 결근 사유 (결근인 경우에만 표시) -->
        <div id="detailAbsentReason" style="background: #fff3cd; padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg); display: none;">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: #856404;">📝 결근 사유</h3>
          <div id="detailAbsentReasonContent" style="font-size: 14px; color: #856404; line-height: 1.6;">
            <!-- 결근 사유가 여기 표시됩니다 -->
          </div>
        </div>

        <!-- 계약서 근무시간 비교 -->
        <div id="detailContractComparison" style="background: #fff3cd; padding: var(--spacing-lg); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg); display: none;">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: #856404;">⚠️ 계약서 근무시간 비교</h3>
          <div id="detailContractInfo" style="font-size: 14px; color: #856404;">
            <!-- 계약서 정보가 여기 표시됩니다 -->
          </div>
        </div>

        <!-- 수정 이력 -->
        <div id="detailEditHistory" style="background: var(--bg-light); padding: var(--spacing-lg); border-radius: var(--border-radius); display: none;">
          <h3 style="font-size: 16px; margin-bottom: var(--spacing-md); color: var(--primary-color);">📝 수정 이력</h3>
          <div id="detailEditHistoryContent" style="font-size: 14px;">
            <!-- 수정 이력이 여기 표시됩니다 -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAttendanceDetailModal()">닫기</button>
        <button class="btn btn-primary" id="detailEditButton" onclick="openEditFromDetail()">✏️ 수정하기</button>
      </div>
    </div>
  </div>

  <script>
    // 매장 서명 미리보기
    function previewStoreSignature(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('❌ 이미지 파일만 업로드 가능합니다.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        storeCeoSignatureData = e.target.result;
        const preview = document.getElementById('storeCeoSignaturePreview');
        preview.innerHTML = `<img src="${storeCeoSignatureData}" style="max-width: 100%; max-height: 100px; object-fit: contain;">`;
      };
      reader.readAsDataURL(file);
    }

    // 직원 상세 정보 모달
    async function showEmployeeDetail(uid) {
      try {
        console.log('👤 직원 상세 조회:', uid);
        
        // Firestore에서 직원 정보 가져오기
        const empDoc = await firebase.firestore().collection('users').doc(uid).get();
        if (!empDoc.exists) {
          alert('❌ 직원 정보를 찾을 수 없습니다.');
          return;
        }
        
        const emp = empDoc.data();
        
        // 기본 정보
        document.getElementById('empDetailName').textContent = emp.name || '-';
        document.getElementById('empDetailStore').textContent = emp.store || '-';
        document.getElementById('empDetailPosition').textContent = emp.position || '-';
        document.getElementById('empDetailPhone').textContent = emp.phone || '-';
        document.getElementById('empDetailEmail').textContent = emp.email || '-';
        document.getElementById('empDetailBirth').textContent = emp.birth || '-';
        document.getElementById('empDetailAddress').textContent = emp.address || '-';
        
        // 계좌 정보 및 서류 정보 (employee_docs 컬렉션에서 가져오기)
        try {
          const docRef = await firebase.firestore().collection('employee_docs').doc(uid).get();
          const documentsDiv = document.getElementById('empDetailDocuments');
          
          if (docRef.exists) {
            const docs = docRef.data();
            
            // 서류 정보
            let docsHtml = '<div style="display: grid; gap: 12px;">';
            let hasDocuments = false;
            
            // 보건증 정보 (healthCert 객체)
            if (docs.healthCert) {
              hasDocuments = true;
              const expiryDate = docs.healthCert.expiryDate || '-';
              const hasImage = docs.healthCert.imageData ? true : false;
              
              docsHtml += `
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="font-weight: 600; margin-bottom: 8px;">📄 보건증</div>
                  <div style="font-size: 14px; color: var(--text-secondary);">
                    유효기간: <strong>${expiryDate}</strong>
                  </div>
                  ${hasImage ? `
                    <div style="margin-top: 8px;">
                      <button class="btn btn-sm btn-primary" onclick="showHealthCertImage('${uid}')">이미지 보기</button>
                    </div>
                  ` : '<div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">이미지 없음</div>'}
                </div>
              `;
            }
            
            // 통장사본 정보 (bankAccount 객체와 bankbook 이미지)
            if (docs.bankAccount || docs.bankbook) {
              hasDocuments = true;
              const hasBankInfo = docs.bankAccount ? true : false;
              const hasImage = docs.bankbook ? true : false;
              
              docsHtml += `
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="font-weight: 600; margin-bottom: 8px;">🏦 통장사본</div>
                  ${hasBankInfo ? `
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">
                      은행: <strong>${docs.bankAccount.bankName}</strong><br>
                      계좌번호: <strong>${docs.bankAccount.accountNumber}</strong><br>
                      예금주: <strong>${docs.bankAccount.accountHolder}</strong>
                    </div>
                  ` : ''}
                  ${hasImage ? `
                    <div style="margin-top: 8px;">
                      <a href="${docs.bankbook}" target="_blank" class="btn btn-sm btn-primary">이미지 보기</a>
                    </div>
                  ` : '<div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">이미지 없음</div>'}
                </div>
              `;
            }
            
            // 신분증 (idCard)
            if (docs.idCard) {
              hasDocuments = true;
              docsHtml += `
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px;">
                  <div style="font-weight: 600; margin-bottom: 8px;">🪪 신분증</div>
                  <a href="${docs.idCard}" target="_blank" class="btn btn-sm btn-primary">이미지 보기</a>
                </div>
              `;
            }
            
            docsHtml += '</div>';
            
            if (!hasDocuments) {
              documentsDiv.innerHTML = '<div style="color: var(--text-secondary);">등록된 서류가 없습니다.</div>';
            } else {
              documentsDiv.innerHTML = docsHtml;
            }
          } else {
            // employee_docs 없으면 기본값
            documentsDiv.innerHTML = '<div style="color: var(--text-secondary);">등록된 서류가 없습니다.</div>';
            console.log('⚠️ employee_docs 문서 없음');
          }
        } catch (docError) {
          console.warn('서류 정보 조회 실패:', docError);
          document.getElementById('empDetailDocuments').innerHTML = '<div style="color: var(--text-secondary);">서류 정보를 불러올 수 없습니다.</div>';
        }
        
        // 모달 표시
        document.getElementById('employeeDetailModal').style.display = 'flex';
        
      } catch (error) {
        console.error('❌ 직원 상세 조회 실패:', error);
        alert('직원 상세 조회에 실패했습니다: ' + error.message);
      }
    }
    
    function closeEmployeeDetailModal() {
      document.getElementById('employeeDetailModal').style.display = 'none';
    }
    
    // 보건증 이미지 새 창으로 보기
    async function showHealthCertImage(uid) {
      try {
        const docRef = await firebase.firestore().collection('employee_docs').doc(uid).get();
        if (docRef.exists) {
          const docs = docRef.data();
          if (docs.healthCert && docs.healthCert.imageData) {
            // 새 창에서 이미지 표시
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
              <!DOCTYPE html>
              <html>
              <head>
                <title>보건증 이미지</title>
                <style>
                  body { 
                    margin: 0; 
                    padding: 20px; 
                    background: #f5f5f5; 
                    display: flex; 
                    justify-content: center; 
                    align-items: center;
                    min-height: 100vh;
                  }
                  img { 
                    max-width: 100%; 
                    max-height: 90vh; 
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  }
                </style>
              </head>
              <body>
                <img src="${docs.healthCert.imageData}" alt="보건증">
              </body>
              </html>
            `);
          } else {
            alert('❌ 보건증 이미지가 없습니다.');
          }
        } else {
          alert('❌ 서류 정보를 찾을 수 없습니다.');
        }
      } catch (error) {
        console.error('❌ 보건증 이미지 로드 실패:', error);
        alert('❌ 이미지를 불러올 수 없습니다.');
      }
    }

    // 관리자 상세 정보 모달
    async function showAdminDetail(uid) {
      try {
        console.log('👑 관리자 상세 조회:', uid);
        
        // Firestore에서 관리자 정보 가져오기
        const adminDoc = await firebase.firestore().collection('users').doc(uid).get();
        if (!adminDoc.exists) {
          alert('❌ 관리자 정보를 찾을 수 없습니다.');
          return;
        }
        
        const admin = adminDoc.data();
        
        // 기본 정보
        document.getElementById('adminDetailName').textContent = admin.name || '-';
        document.getElementById('adminDetailRole').textContent = admin.userType === 'admin' ? '관리자' : (admin.userType === 'manager' ? '매니저' : '-');
        document.getElementById('adminDetailEmail').textContent = admin.email || '-';
        document.getElementById('adminDetailPhone').textContent = admin.phone || '-';
        document.getElementById('adminDetailBirth').textContent = admin.birth || '-';
        
        // 가입일
        if (admin.createdAt) {
          const createdDate = admin.createdAt.toDate ? admin.createdAt.toDate() : new Date(admin.createdAt);
          document.getElementById('adminDetailCreatedAt').textContent = createdDate.toLocaleDateString('ko-KR');
        } else {
          document.getElementById('adminDetailCreatedAt').textContent = '-';
        }
        
        // 권한 정보
        const permissionsDiv = document.getElementById('adminDetailPermissions');
        if (admin.userType === 'admin') {
          permissionsDiv.innerHTML = `
            <div style="color: var(--success-color); font-weight: 600; margin-bottom: 8px;">✅ 전체 권한</div>
            <ul style="margin-left: 20px; font-size: 14px; color: var(--text-secondary);">
              <li>직원 관리 (등록, 수정, 삭제)</li>
              <li>계약서 작성 및 관리</li>
              <li>급여 관리 및 확정</li>
              <li>매장 관리</li>
              <li>공지사항 작성</li>
              <li>모든 데이터 조회 및 편집</li>
            </ul>
          `;
        } else if (admin.userType === 'manager') {
          permissionsDiv.innerHTML = `
            <div style="color: var(--warning-color); font-weight: 600; margin-bottom: 8px;">👀 읽기 전용 권한</div>
            <ul style="margin-left: 20px; font-size: 14px; color: var(--text-secondary);">
              <li>직원 정보 조회</li>
              <li>계약서 조회</li>
              <li>급여 조회 (편집 불가)</li>
              <li>출퇴근 기록 조회</li>
              <li>공지사항 조회</li>
            </ul>
          `;
        }
        
        // 모달 표시
        document.getElementById('adminDetailModal').style.display = 'flex';
        
      } catch (error) {
        console.error('❌ 관리자 상세 조회 실패:', error);
        alert('관리자 상세 조회에 실패했습니다: ' + error.message);
      }
    }
    
    function closeAdminDetailModal() {
      document.getElementById('adminDetailModal').style.display = 'none';
    }

    // ===================================================================
    // 관리자 근무시간 수정
    // ===================================================================

    let currentAdminEditAttendanceId = null;
    let currentAdminEditEmployeeUid = null;
    let currentAdminEditEmployeeName = null;

    /**
     * 관리자 근무시간 수정 모달 열기
     */
    function showAdminEditAttendanceModal(attendanceId, employeeName, employeeUid, date, clockIn, clockOut) {
      console.log('🔧 수정 모달 데이터:', { attendanceId, employeeName, employeeUid, date, clockIn, clockOut });
      
      currentAdminEditAttendanceId = attendanceId;
      currentAdminEditEmployeeUid = employeeUid;
      currentAdminEditEmployeeName = employeeName || '-';
      
      document.getElementById('adminEditEmployeeName').value = employeeName || '-';
      document.getElementById('adminEditDate').value = date;
      document.getElementById('adminEditClockIn').value = clockIn;
      document.getElementById('adminEditClockOut').value = clockOut;
      document.getElementById('adminEditReason').value = '';
      
      document.getElementById('adminEditAttendanceModal').style.display = 'flex';
    }

    /**
     * 관리자 근무시간 수정 모달 닫기
     */
    function closeAdminEditAttendanceModal() {
      document.getElementById('adminEditAttendanceModal').style.display = 'none';
      currentAdminEditAttendanceId = null;
      currentAdminEditEmployeeUid = null;
      currentAdminEditEmployeeName = null;
    }

    /**
     * 관리자 근무시간 수정 제출
     */
    async function submitAdminAttendanceEdit() {
      if (!currentAdminEditAttendanceId || !currentAdminEditEmployeeUid) return;
      
      const clockIn = document.getElementById('adminEditClockIn').value;
      const clockOut = document.getElementById('adminEditClockOut').value;
      const reason = document.getElementById('adminEditReason').value.trim();
      
      if (!clockIn || !clockOut) {
        alert('⚠️ 출근시간과 퇴근시간을 모두 입력해주세요.');
        return;
      }
      
      if (!reason) {
        alert('⚠️ 수정 사유를 입력해주세요.\n(직원에게 전달됩니다)');
        return;
      }
      
      try {
        // 기존 데이터 조회
        const attendanceDoc = await firebase.firestore().collection('attendance').doc(currentAdminEditAttendanceId).get();
        if (!attendanceDoc.exists) {
          alert('❌ 근무 기록을 찾을 수 없습니다.');
          return;
        }
        
        const oldData = attendanceDoc.data();
        
        // 현재 관리자 정보
        const adminUid = sessionStorage.getItem('admin_uid');
        const adminName = sessionStorage.getItem('admin_name');
        
        // 근무시간 업데이트
        await firebase.firestore().collection('attendance').doc(currentAdminEditAttendanceId).update({
          clockIn: clockIn,
          clockOut: clockOut,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastEditedBy: 'admin',
          lastEditedByUid: adminUid,
          lastEditedByName: adminName
        });
        
        // 변경 보고 저장 (직원에게 역보고)
        await firebase.firestore().collection('time_change_reports').add({
          type: 'admin_edit',
          reportedBy: 'admin',
          adminUid: adminUid,
          adminName: adminName,
          employeeUid: currentAdminEditEmployeeUid,
          employeeName: currentAdminEditEmployeeName,
          attendanceId: currentAdminEditAttendanceId,
          attendanceDate: oldData.date || '-',
          oldTime: {
            clockIn: oldData.clockIn,
            clockOut: oldData.clockOut
          },
          newTime: {
            clockIn: clockIn,
            clockOut: clockOut
          },
          reason: reason,
          status: 'reported',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`✅ 근무시간이 수정되었습니다.\n\n변경 내용이 ${currentAdminEditEmployeeName}님에게 알림됩니다.`);
        closeAdminEditAttendanceModal();
        loadAttendanceList();
        
      } catch (error) {
        console.error('❌ 근무시간 수정 오류:', error);
        alert('❌ 수정 중 오류가 발생했습니다.\n\n' + error.message);
      }
    }

    // ===================================================================
    // 근무기록 상세 모달
    // ===================================================================

    let currentDetailAttendanceId = null;
    let currentDetailEmployeeUid = null;
    let currentDetailEmployeeName = null;

    /**
     * 근무기록 상세 모달 열기
     */
    async function showAttendanceDetailModal(attendanceId, employeeName, employeeUid, date, clockIn, clockOut, store, workType, status) {
      currentDetailAttendanceId = attendanceId;
      currentDetailEmployeeUid = employeeUid;
      currentDetailEmployeeName = employeeName;
      
      // 기본 정보 표시
      document.getElementById('detailEmployeeName').textContent = employeeName;
      document.getElementById('detailStore').textContent = store;
      document.getElementById('detailDate').textContent = date;
      document.getElementById('detailWorkType').textContent = workType;
      document.getElementById('detailClockIn').textContent = clockIn || '-';
      document.getElementById('detailClockOut').textContent = clockOut || '-';
      
      // 근무시간 계산
      if (clockIn && clockOut) {
        const workMinutes = calculateWorkMinutes(clockIn, clockOut);
        const hours = Math.floor(workMinutes / 60);
        const minutes = workMinutes % 60;
        document.getElementById('detailWorkHours').textContent = `${hours}시간 ${minutes}분`;
      } else {
        document.getElementById('detailWorkHours').textContent = '-';
      }
      
      document.getElementById('detailStatus').innerHTML = `<span class="badge badge-${calculateAttendanceStatus({clockIn, clockOut}).class}">${status}</span>`;
      
      // 🔥 결근 사유 표시 (결근인 경우)
      if (status === '결근') {
        try {
          const attDoc = await firebase.firestore().collection('attendance').doc(attendanceId).get();
          if (attDoc.exists) {
            const attData = attDoc.data();
            const absentReasonDiv = document.getElementById('detailAbsentReason');
            const absentReasonContent = document.getElementById('detailAbsentReasonContent');
            
            if (attData.absentReason && attData.absentReason.trim() !== '') {
              absentReasonContent.innerHTML = `
                <div style="margin-bottom: 8px;">${attData.absentReason}</div>
                ${attData.reasonSubmittedAt ? `
                  <div style="font-size: 12px; color: #856404; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ffeaa7;">
                    제출 시간: ${attData.reasonSubmittedAt.toDate ? attData.reasonSubmittedAt.toDate().toLocaleString('ko-KR') : '-'}
                  </div>
                ` : ''}
              `;
            } else {
              absentReasonContent.innerHTML = '<div style="color: var(--danger-color); font-weight: 600;">⚠️ 사유 미입력</div>';
            }
            absentReasonDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('결근 사유 조회 실패:', error);
        }
      } else {
        document.getElementById('detailAbsentReason').style.display = 'none';
      }
      
      // 수정 버튼에 데이터 전달용 저장
      document.getElementById('detailEditButton').setAttribute('data-date', date);
      document.getElementById('detailEditButton').setAttribute('data-clockin', clockIn);
      document.getElementById('detailEditButton').setAttribute('data-clockout', clockOut);
      
      // 계약서 근무시간과 비교
      await loadContractComparison(employeeUid, employeeName, clockIn, clockOut);
      
      // 수정 이력 조회
      await loadEditHistory(attendanceId);
      
      document.getElementById('attendanceDetailModal').style.display = 'flex';
    }

    /**
     * 근무시간 계산 (분 단위)
     */
    function calculateWorkMinutes(clockIn, clockOut) {
      if (!clockIn || !clockOut) return 0;
      
      const [inHour, inMin] = clockIn.split(':').map(Number);
      const [outHour, outMin] = clockOut.split(':').map(Number);
      
      const inMinutes = inHour * 60 + inMin;
      const outMinutes = outHour * 60 + outMin;
      
      return outMinutes - inMinutes;
    }

    /**
     * 계약서 근무시간과 비교
     */
    async function loadContractComparison(employeeUid, employeeName, clockIn, clockOut) {
      const comparisonDiv = document.getElementById('detailContractComparison');
      const infoDiv = document.getElementById('detailContractInfo');
      
      try {
        // 계약서 조회
        const contractsSnapshot = await firebase.firestore().collection('contracts')
          .where('employeeName', '==', employeeName)
          .get();
        
        if (contractsSnapshot.empty) {
          comparisonDiv.style.display = 'none';
          return;
        }
        
        // 최신 계약서
        const contracts = [];
        contractsSnapshot.forEach(doc => {
          contracts.push({ id: doc.id, ...doc.data() });
        });
        contracts.sort((a, b) => {
          const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return bTime - aTime;
        });
        
        const contract = contracts[0];
        
        if (!contract.workStartTime || !contract.workEndTime) {
          comparisonDiv.style.display = 'none';
          return;
        }
        
        // 비교
        let html = `<div style="margin-bottom: 8px;"><strong>계약서 근무시간:</strong> ${contract.workStartTime} ~ ${contract.workEndTime}</div>`;
        html += `<div style="margin-bottom: 8px;"><strong>실제 근무시간:</strong> ${clockIn} ~ ${clockOut}</div>`;
        
        const isEarly = clockIn < contract.workStartTime;
        const isLate = clockOut > contract.workEndTime;
        
        if (isEarly || isLate) {
          html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #856404;">';
          if (isEarly) {
            html += `<div>• 출근: 계약시간(${contract.workStartTime})보다 일찍 출근함</div>`;
          }
          if (isLate) {
            html += `<div>• 퇴근: 계약시간(${contract.workEndTime})보다 늦게 퇴근함</div>`;
          }
          html += '</div>';
          
          comparisonDiv.style.display = 'block';
        } else {
          comparisonDiv.style.display = 'none';
        }
        
        infoDiv.innerHTML = html;
        
      } catch (error) {
        console.error('❌ 계약서 비교 오류:', error);
        comparisonDiv.style.display = 'none';
      }
    }

    /**
     * 수정 이력 조회
     */
    async function loadEditHistory(attendanceId) {
      const historyDiv = document.getElementById('detailEditHistory');
      const contentDiv = document.getElementById('detailEditHistoryContent');
      
      try {
        const reportsSnapshot = await firebase.firestore().collection('time_change_reports')
          .where('attendanceId', '==', attendanceId)
          .orderBy('createdAt', 'desc')
          .get();
        
        if (reportsSnapshot.empty) {
          historyDiv.style.display = 'none';
          return;
        }
        
        let html = '<div style="display: grid; gap: 12px;">';
        
        reportsSnapshot.forEach(doc => {
          const report = doc.data();
          const date = report.createdAt ? report.createdAt.toDate().toLocaleString('ko-KR') : '-';
          
          // 수정 타입 결정
          let reportType = '';
          let reporterName = '';
          let badgeClass = '';
          
          if (report.type === 'violation') {
            reportType = '⚠️ 계약서 외 근무';
            reporterName = report.employeeName || '직원';
            badgeClass = 'warning';
          } else if (report.type === 'employee_edit') {
            reportType = '✏️ 직원 수정';
            reporterName = report.employeeName || '직원';
            badgeClass = 'info';
          } else if (report.type === 'admin_edit') {
            reportType = '👨‍💼 관리자 수정';
            reporterName = report.adminName || '관리자';
            badgeClass = 'primary';
          } else {
            reportType = '📝 기타 변경';
            reporterName = '-';
            badgeClass = 'secondary';
          }
          
          html += `
            <div style="padding: 12px; background: white; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span class="badge badge-${badgeClass}">${reportType}</span>
                <span style="font-size: 12px; color: var(--text-secondary);">${date}</span>
              </div>
              
              <div style="margin-bottom: 8px;">
                <strong>수정자:</strong> ${reporterName}
              </div>
              
              <div style="background: var(--bg-light); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;">
                  <div>
                    <div style="font-size: 11px; color: var(--text-secondary);">변경 전</div>
                    <div style="font-weight: 600; color: var(--danger-color);">
                      ${report.oldTime ? `${report.oldTime.clockIn} ~ ${report.oldTime.clockOut}` : '-'}
                    </div>
                  </div>
                  <div style="text-align: center;">→</div>
                  <div>
                    <div style="font-size: 11px; color: var(--text-secondary);">변경 후</div>
                    <div style="font-weight: 600; color: var(--success-color);">
                      ${report.newTime ? `${report.newTime.clockIn} ~ ${report.newTime.clockOut}` : '-'}
                    </div>
                  </div>
                </div>
              </div>
              
              <div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">📝 사유</div>
                <div style="font-size: 13px; line-height: 1.5; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                  ${report.reason || '-'}
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        contentDiv.innerHTML = html;
        historyDiv.style.display = 'block';
        
      } catch (error) {
        console.error('❌ 수정 이력 조회 오류:', error);
        historyDiv.style.display = 'none';
      }
    }

    /**
     * 근무기록 상세 모달 닫기
     */
    function closeAttendanceDetailModal() {
      document.getElementById('attendanceDetailModal').style.display = 'none';
      currentDetailAttendanceId = null;
      currentDetailEmployeeUid = null;
      currentDetailEmployeeName = null;
    }

    /**
     * 상세 모달에서 수정 모달 열기
     */
    function openEditFromDetail() {
      const date = document.getElementById('detailEditButton').getAttribute('data-date');
      const clockIn = document.getElementById('detailEditButton').getAttribute('data-clockin');
      const clockOut = document.getElementById('detailEditButton').getAttribute('data-clockout');
      
      closeAttendanceDetailModal();
      showAdminEditAttendanceModal(currentDetailAttendanceId, currentDetailEmployeeName, currentDetailEmployeeUid, date, clockIn, clockOut);
    }

    // ===================================================================
    // 근무스케줄 관리
    // ===================================================================

    let currentScheduleWeek = new Date(); // 현재 선택된 주
    let currentScheduleData = null; // 현재 스케줄 데이터

    /**
     * 매장 선택 드롭다운 로드 (스케줄용)
     */
    async function loadStoresForScheduleFilter() {
      try {
        const snapshot = await firebase.firestore().collection('stores').get();
        const select = document.getElementById('scheduleStoreSelect');
        
        select.innerHTML = '<option value="">매장 선택</option>';
        
        console.log('📍 매장 목록:');
        snapshot.forEach(doc => {
          const store = doc.data();
          console.log(`  - ID: ${doc.id}, 이름: "${store.name}"`);
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = store.name;
          select.appendChild(option);
        });
        
        // 초기 주차 표시 업데이트
        updateWeekDisplay();
        
        console.log('✅ 스케줄 매장 필터 로드 완료:', snapshot.size, '개 매장');
      } catch (error) {
        console.error('❌ 매장 목록 로드 실패:', error);
      }
    }

    /**
     * 주차 변경
     */
    function changeWeek(offset) {
      currentScheduleWeek.setDate(currentScheduleWeek.getDate() + (offset * 7));
      updateWeekDisplay();
      loadSchedules();
    }

    /**
     * 주차 표시 업데이트
     */
    function updateWeekDisplay() {
      const monday = getMonday(currentScheduleWeek);
      const sunday = new Date(monday);
      sunday.setDate(sunday.getDate() + 6);
      
      const year = monday.getFullYear();
      const month = monday.getMonth() + 1;
      const weekNum = getWeekNumber(monday);
      
      const mondayStr = `${monday.getMonth() + 1}/${monday.getDate()}`;
      const sundayStr = `${sunday.getMonth() + 1}/${sunday.getDate()}`;
      
      document.getElementById('scheduleWeekDisplay').textContent = 
        `${year}년 ${month}월 ${weekNum}주차 (${mondayStr} ~ ${sundayStr})`;
    }

    /**
     * 월요일 날짜 구하기
     */
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    /**
     * 주차 번호 구하기 (해당 연도의 몇 번째 주)
     */
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    /**
     * 스케줄 로드
     */
    async function loadSchedules() {
      const storeId = document.getElementById('scheduleStoreSelect').value;
      const displayMode = document.querySelector('input[name="scheduleDisplayMode"]:checked').value;
      
      if (!storeId) {
        document.getElementById('scheduleViewContainer').innerHTML = 
          '<p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">매장을 선택하세요.</p>';
        return;
      }
      
      updateWeekDisplay();
      
      document.getElementById('scheduleViewContainer').innerHTML = 
        '<p style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">로딩 중...</p>';
      
      try {
        const monday = getMonday(currentScheduleWeek);
        const year = monday.getFullYear();
        const weekNum = getWeekNumber(monday);
        
        if (displayMode === 'schedule') {
          // 스케줄 데이터 로드
          await loadScheduleData(storeId, year, weekNum);
        } else {
          // 출퇴근 기록 데이터 로드
          await loadAttendanceData(storeId, monday);
        }
        
        renderScheduleView();
      } catch (error) {
        console.error('❌ 스케줄 로드 실패:', error);
        document.getElementById('scheduleViewContainer').innerHTML = 
          '<p style="text-align: center; padding: var(--spacing-xl); color: var(--danger-color);">데이터를 불러오는데 실패했습니다.</p>';
      }
    }

    /**
     * 스케줄 데이터 로드 (새 구조: 날짜별 개별 문서)
     */
    async function loadScheduleData(storeId, year, weekNum) {
      try {
        // 선택된 매장 이름 가져오기
        const storeDoc = await db.collection('stores').doc(storeId).get();
        const storeName = storeDoc.exists ? storeDoc.data().name : '';
        
        console.log(`🔍 스케줄 조회: 매장ID=${storeId}, 매장명="${storeName}", 주차=${year}-${weekNum}`);
        
        // 해당 주의 월요일과 일요일 날짜 계산
        const monday = getMonday(currentScheduleWeek);
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        
        const mondayStr = monday.toISOString().split('T')[0];
        const sundayStr = sunday.toISOString().split('T')[0];
        
        console.log(`📅 조회 기간: ${mondayStr} ~ ${sundayStr}`);
        
        // 해당 매장의 모든 직원 조회 (퇴사자 제외)
        const employeesSnapshot = await db.collection('users')
          .where('role', '==', 'employee')
          .where('store', '==', storeName)
          .get();
        
        console.log(`👥 "${storeName}" 매장 직원: ${employeesSnapshot.size}명`);
        
        const employees = [];
        const days = ['월', '화', '수', '목', '금', '토', '일'];
        
        // 각 직원의 해당 주 스케줄 조회
        for (const empDoc of employeesSnapshot.docs) {
          const empData = empDoc.data();
          const empUid = empDoc.id;
          
          // 퇴사자 제외
          if (empData.status === 'resigned') {
            console.log(`  ⏭️ ${empData.name}: 퇴사자 제외`);
            continue;
          }
          
          // 해당 직원의 해당 주 모든 스케줄 조회
          const schedulesSnapshot = await db.collection('schedules')
            .where('userId', '==', empUid)
            .where('date', '>=', mondayStr)
            .where('date', '<=', sundayStr)
            .get();
          
          console.log(`  📅 ${empData.name}: ${schedulesSnapshot.size}개 근무`);
          
          // 요일별로 스케줄 정리 (한 날짜에 여러 근무가 있을 수 있음)
          const schedules = {};
          days.forEach(day => {
            schedules[day] = []; // 배열로 변경 (여러 근무 가능)
          });
          
          schedulesSnapshot.forEach(doc => {
            const scheduleData = doc.data();
            const scheduleDate = new Date(scheduleData.date + 'T00:00:00');
            const dayOfWeek = scheduleDate.getDay(); // 0=일, 1=월, ..., 6=토
            const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // 월=0, ..., 일=6
            const dayName = days[dayIndex];
            
            schedules[dayName].push({
              startTime: scheduleData.startTime || '',
              endTime: scheduleData.endTime || '',
              hours: scheduleData.hours || 0,
              isShiftReplacement: scheduleData.isShiftReplacement || false,
              isWorkDay: true
            });
          });
          
          // 로그 출력
          days.forEach(day => {
            if (schedules[day].length > 0) {
              const timesStr = schedules[day].map(s => `${s.startTime}-${s.endTime}`).join(', ');
              console.log(`    ${day}: ${timesStr}`);
            }
          });
          
          // 계약서에서 급여 정보 조회
          let salaryType = 'hourly';
          let salaryAmount = 0;
          
          try {
            // 1차 시도: employeeId + status='active'
            let contractSnapshot = await db.collection('contracts')
              .where('employeeId', '==', empUid)
              .where('status', '==', 'active')
              .limit(1)
              .get();
            
            // 2차 시도: employeeId만 (status 무관, 클라이언트 정렬)
            if (contractSnapshot.empty) {
              contractSnapshot = await db.collection('contracts')
                .where('employeeId', '==', empUid)
                .get();
              
              // 클라이언트에서 최신순 정렬
              if (!contractSnapshot.empty) {
                const docs = contractSnapshot.docs.sort((a, b) => {
                  const aTime = a.data().createdAt ? new Date(a.data().createdAt).getTime() : 0;
                  const bTime = b.data().createdAt ? new Date(b.data().createdAt).getTime() : 0;
                  return bTime - aTime;
                });
                // 최신 문서만 사용
                contractSnapshot = { empty: false, docs: [docs[0]] };
              }
            }
            
            // 3차 시도: employeeName + employeeBirth로 조회 (폴백)
            if (contractSnapshot.empty) {
              contractSnapshot = await db.collection('contracts')
                .where('employeeName', '==', empData.name)
                .where('employeeBirth', '==', empData.birth)
                .get();
              
              // 클라이언트에서 최신순 정렬
              if (!contractSnapshot.empty) {
                const docs = contractSnapshot.docs.sort((a, b) => {
                  const aTime = a.data().createdAt ? new Date(a.data().createdAt).getTime() : 0;
                  const bTime = b.data().createdAt ? new Date(b.data().createdAt).getTime() : 0;
                  return bTime - aTime;
                });
                // 최신 문서만 사용
                contractSnapshot = { empty: false, docs: [docs[0]] };
              }
            }
            
            if (!contractSnapshot.empty) {
              const contractData = contractSnapshot.docs[0].data();
              
              // 실제 저장된 필드명 사용
              salaryType = contractData.salaryType || contractData.wageType || 'hourly';
              salaryAmount = contractData.salaryAmount || contractData.wageAmount || 0;
              
              console.log(`  💰 ${empData.name} 급여: ${salaryType} = ₩${salaryAmount.toLocaleString()}`);
            } else {
              console.log(`  ⚠️ ${empData.name} 계약서 없음 (employeeId: ${empUid}, name: ${empData.name})`);
            }
          } catch (err) {
            console.warn(`  ⚠️ ${empData.name} 계약서 조회 실패:`, err);
          }
          
          employees.push({
            uid: empUid,
            name: empData.name || '이름없음',
            schedules: schedules, // schedules[day] = [{startTime, endTime, hours, isShiftReplacement}...]
            salaryType: salaryType,
            salaryAmount: salaryAmount
          });
        }
        
        currentScheduleData = {
          type: 'schedule',
          employees: employees
        };
        
        console.log('✅ 스케줄 데이터 로드 완료:', employees.length, '명');
      } catch (error) {
        console.error('❌ 스케줄 데이터 로드 실패:', error);
        // 오류 시 빈 데이터
        currentScheduleData = { type: 'schedule', employees: [] };
      }
    }

    /**
     * 출퇴근 기록 데이터 로드
     */
    async function loadAttendanceData(storeId, monday) {
      try {
        // 선택된 매장 이름 가져오기
        const storeDoc = await db.collection('stores').doc(storeId).get();
        const storeName = storeDoc.exists ? storeDoc.data().name : '';
        
        console.log(`🔍 출퇴근 기록 조회: 매장ID=${storeId}, 매장명=${storeName}`);
        
        // 주간 시작일과 종료일 계산
        const days = ['월', '화', '수', '목', '금', '토', '일'];
        const startDate = new Date(monday);
        const endDate = new Date(monday);
        endDate.setDate(endDate.getDate() + 6);
        
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        
        console.log(`📅 조회 기간: ${startDateStr} ~ ${endDateStr}`);
        
        // attendance 컬렉션에서 해당 매장의 해당 주 출퇴근 기록 직접 조회
        const attendanceSnapshot = await db.collection('attendance')
          .where('store', '==', storeName)
          .where('date', '>=', startDateStr)
          .where('date', '<=', endDateStr)
          .get();
        
        console.log(`📊 조회된 출퇴근 기록: ${attendanceSnapshot.size}건`);
        
        // 직원별로 그룹화
        const employeeMap = {};
        
        attendanceSnapshot.forEach(doc => {
          const attendanceData = doc.data();
          const empUid = attendanceData.uid;
          const empName = attendanceData.employeeName || attendanceData.name || '이름없음';
          
          if (!employeeMap[empUid]) {
            employeeMap[empUid] = {
              uid: empUid,
              name: empName,
              schedules: {}
            };
            
            // 모든 요일 초기화
            days.forEach(day => {
              employeeMap[empUid].schedules[day] = { isWorkDay: false };
            });
          }
          
          // 날짜를 요일로 변환
          const attendanceDate = new Date(attendanceData.date + 'T00:00:00');
          const dayIndex = (attendanceDate.getDay() + 6) % 7; // 월요일=0, 일요일=6
          const day = days[dayIndex];
          
          // 상태 판별 (정상/지각/조퇴/결근)
          let status = 'normal';
          
          if (attendanceData.status === 'absent' || !attendanceData.clockIn) {
            status = 'absent';
          } else if (attendanceData.isLate) {
            status = 'late';
          } else if (attendanceData.isEarlyLeave) {
            status = 'early';
          }
          
          employeeMap[empUid].schedules[day] = {
            startTime: attendanceData.clockIn || '',
            endTime: attendanceData.clockOut || '',
            hours: attendanceData.actualHours || 0,
            isWorkDay: true,
            status: status,
            scheduledStart: attendanceData.scheduledStartTime || '',
            scheduledEnd: attendanceData.scheduledEndTime || ''
          };
        });
        
        // 배열로 변환
        const employees = Object.values(employeeMap);
        
        console.log(`✅ 직원 ${employees.length}명의 출퇴근 기록 로드 완료`);
        
        currentScheduleData = {
          type: 'attendance',
          employees: employees
        };
        
        console.log('✅ 출퇴근 기록 로드 완료:', employees.length, '명');
      } catch (error) {
        console.error('❌ 출퇴근 기록 로드 실패:', error);
        currentScheduleData = { type: 'attendance', employees: [] };
      }
    }

    /**
     * 스케줄 뷰 렌더링
     */
    function renderScheduleView() {
      if (!currentScheduleData) {
        return;
      }
      
      const viewType = document.querySelector('input[name="scheduleViewType"]:checked').value;
      
      if (viewType === 'card') {
        renderCardView();
      } else {
        renderGanttView();
      }
    }

    /**
     * 카드형 뷰 렌더링
     */
    function renderCardView() {
      const container = document.getElementById('scheduleViewContainer');
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const monday = getMonday(currentScheduleWeek);
      
      let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; overflow-x: auto;">';
      
      days.forEach((day, index) => {
        const date = new Date(monday);
        date.setDate(date.getDate() + index);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        
        html += `
          <div style="min-width: 140px; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 8px; background: white;">
            <div style="font-weight: 600; text-align: center; padding: 8px; background: var(--bg-light); border-radius: 4px; margin-bottom: 8px;">
              ${day}(${dateStr})
            </div>
        `;
        
        // 각 직원의 스케줄 카드
        if (currentScheduleData.employees) {
          currentScheduleData.employees.forEach(emp => {
            const scheduleArray = emp.schedules[day]; // 이제 배열임
            
            // 배열이고 요소가 있으면 모두 표시
            if (scheduleArray && Array.isArray(scheduleArray) && scheduleArray.length > 0) {
              scheduleArray.forEach(schedule => {
                if (schedule.isWorkDay) {
                  // 대체근무 표시
                  const replacementIcon = schedule.isShiftReplacement ? '🔄 ' : '';
                  const backgroundColor = schedule.isShiftReplacement ? '#fff3cd' : '#e3f2fd';
                  const borderColor = schedule.isShiftReplacement ? '#ffc107' : '#1976d2';
                  
                  html += `
                    <div style="background: ${backgroundColor}; border-radius: 8px; padding: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                      <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${replacementIcon}👤 ${emp.name}</div>
                      <div style="font-size: 12px; color: #1976d2; border-top: 2px solid ${borderColor}; padding-top: 4px; margin-top: 4px;">
                        🕐 ${schedule.startTime} - ${schedule.endTime}
                      </div>
                      <div style="font-size: 11px; color: #555; margin-top: 2px;">
                        ⏱️ ${schedule.hours}시간
                      </div>
                    </div>
                  `;
                }
              });
            }
            // 휴무는 표시하지 않음
          });
        }
        
        html += '</div>';
      });
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    /**
     * 간트차트형 뷰 렌더링 (가로: 요일, 세로: 시간)
     * 각 직원의 근무시간을 하나의 긴 막대로 표시
     */
    function renderGanttView() {
      const container = document.getElementById('scheduleViewContainer');
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const monday = getMonday(currentScheduleWeek);
      
      // 직원별 색상 정의
      const employeeColors = [
        '#FF6B6B', '#4ECDC4', '#95E1D3', '#FFE66D', '#C7CEEA',
        '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'
      ];
      
      const colorMap = {};
      if (currentScheduleData.employees) {
        currentScheduleData.employees.forEach((emp, index) => {
          colorMap[emp.name] = employeeColors[index % employeeColors.length];
        });
      }
      
      // 날짜 정보 생성
      const dateInfo = [];
      days.forEach((day, index) => {
        const date = new Date(monday);
        date.setDate(date.getDate() + index);
        dateInfo.push({
          day: day,
          date: `${date.getMonth() + 1}/${date.getDate()}`
        });
      });
      
      // 각 요일별 근무자 목록 생성
      const dayWorkers = {};
      days.forEach(day => {
        dayWorkers[day] = [];
      });
      
      if (currentScheduleData.employees) {
        currentScheduleData.employees.forEach(emp => {
          days.forEach(day => {
            const scheduleArray = emp.schedules[day]; // 이제 배열임
            
            // 배열이고 요소가 있으면 모두 처리
            if (scheduleArray && Array.isArray(scheduleArray) && scheduleArray.length > 0) {
              scheduleArray.forEach(schedule => {
                if (schedule.isWorkDay) {
                  // 출퇴근 기록인 경우 상태에 따라 색상 변경
                  let barColor = colorMap[emp.name];
                  if (currentScheduleData.type === 'attendance' && schedule.status) {
                    switch (schedule.status) {
                      case 'late': barColor = '#FFA726'; break; // 주황색 (지각)
                      case 'early': barColor = '#FFB74D'; break; // 연한 주황색 (조퇴)
                      case 'absent': barColor = '#EF5350'; break; // 빨간색 (결근)
                      default: barColor = '#66BB6A'; // 초록색 (정상)
                    }
                  }
                  
                  // 대체근무는 승인자(현재 직원)의 색상을 그대로 사용 (색상 변경 안 함)
                  // isShiftReplacement는 표시용으로만 사용
                  
                  dayWorkers[day].push({
                    name: emp.name,
                    startTime: schedule.startTime,
                    endTime: schedule.endTime,
                    hours: schedule.hours,
                    color: barColor,
                    status: schedule.status || 'normal',
                    scheduledStart: schedule.scheduledStart || '',
                    scheduledEnd: schedule.scheduledEnd || '',
                    isShiftReplacement: schedule.isShiftReplacement || false
                  });
                }
              });
            }
          });
        });
      }
      
      // 각 요일별 최대 근무자 수 계산
      let maxWorkers = 1;
      days.forEach(day => {
        if (dayWorkers[day].length > maxWorkers) {
          maxWorkers = dayWorkers[day].length;
        }
      });
      
      // 시간 범위 (06:00 ~ 01:00, 1시간 단위)
      const startHour = 6;
      const endHour = 25; // 다음날 01:00
      const totalHours = endHour - startHour;
      const rowHeight = 35; // 1시간당 높이 (px) - 스크롤 없이 보이도록 축소
      const totalHeight = totalHours * rowHeight;
      
      // HTML 구조 생성 (스크롤 없이 한 화면에 표시)
      let html = `
        <div style="display: flex; gap: var(--spacing-md); width: 100%; max-width: 1400px; margin: 0 auto;">
          <!-- 메인 간트차트 -->
          <div style="flex: 1; display: flex; border: 1px solid var(--border-color); background: white;">
            <!-- 시간 레이블 열 -->
            <div style="width: 60px; border-right: 1px solid var(--border-color); background: var(--bg-light);">
              <div style="height: 45px; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-color); font-weight: 700; font-size: 12px;">
                시간
              </div>
              <div style="position: relative; height: ${totalHeight}px;">
      `;
      
      // 시간 눈금
      for (let h = startHour; h <= endHour; h++) {
        const displayHour = h > 24 ? h - 24 : h;
        const timeLabel = `${displayHour.toString().padStart(2, '0')}:00`;
        const topPos = (h - startHour) * rowHeight;
        
        html += `
          <div style="position: absolute; top: ${topPos}px; width: 100%; height: ${rowHeight}px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500;">
            ${timeLabel}
          </div>
        `;
      }
      
      html += `
              </div>
            </div>
            
            <!-- 요일별 간트차트 열들 -->
      `;
      
      // 각 요일별 칼럼
      dateInfo.forEach((info, dayIndex) => {
        const day = days[dayIndex];
        const workers = dayWorkers[day];
        
        html += `
          <div style="flex: 1; ${dayIndex < days.length - 1 ? 'border-right: 1px solid var(--border-color);' : ''}">
            <!-- 요일 헤더 -->
            <div style="height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-color); background: var(--bg-light); font-weight: 700; font-size: 12px;">
              <div>${info.day}</div>
              <div style="font-size: 10px; color: var(--text-secondary); font-weight: 400;">${info.date}</div>
            </div>
            
            <!-- 간트차트 영역 -->
            <div style="position: relative; height: ${totalHeight}px; background: white;">
              <!-- 시간 그리드 배경 -->
        `;
        
        // 시간 그리드 라인
        for (let h = startHour; h <= endHour; h++) {
          const topPos = (h - startHour) * rowHeight;
          html += `
            <div style="position: absolute; top: ${topPos}px; width: 100%; height: ${rowHeight}px; border-bottom: 1px solid #f0f0f0;"></div>
          `;
        }
        
        // 각 직원의 막대 (동적 굵기, 직원 수에 따라 자동 조절)
        if (workers.length > 0) {
          const maxBarWidth = 18; // 최대 막대 굵기 (%)
          const minBarWidth = 8;  // 최소 막대 굵기 (%)
          const minSpacing = 3;   // 최소 간격 (%)
          
          // 직원 수에 따라 막대 굵기 동적 계산
          let barWidth = maxBarWidth;
          if (workers.length > 3) {
            const totalWithSpacing = workers.length * maxBarWidth + (workers.length + 1) * minSpacing;
            if (totalWithSpacing > 100) {
              barWidth = (100 - (workers.length + 1) * minSpacing) / workers.length;
              barWidth = Math.max(barWidth, minBarWidth);
            }
          }
          
          const totalBarsWidth = workers.length * barWidth;
          const availableSpace = 100;
          const spacing = workers.length > 1 ? (availableSpace - totalBarsWidth) / (workers.length + 1) : (availableSpace - barWidth) / 2;
          
          workers.forEach((worker, workerIndex) => {
            // 시작/종료 시간을 픽셀 위치로 변환
            const [startH, startM] = worker.startTime.split(':').map(Number);
            const [endH, endM] = worker.endTime.split(':').map(Number);
            
            const startMinutes = (startH - startHour) * 60 + startM;
            const endMinutes = (endH - startHour) * 60 + endM;
            
            const topPos = (startMinutes / 60) * rowHeight;
            const height = ((endMinutes - startMinutes) / 60) * rowHeight;
            const leftPos = spacing * (workerIndex + 1) + barWidth * workerIndex;
            
            html += `
              <div style="
                position: absolute;
                left: ${leftPos}%;
                top: ${topPos}px;
                width: ${barWidth}%;
                height: ${height}px;
                background: ${worker.color};
                opacity: 0.9;
                box-sizing: border-box;
                transition: all 0.2s;
                border-radius: 2px;
              " 
              onmouseover="this.style.opacity='1'; this.style.zIndex='5'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';" 
              onmouseout="this.style.opacity='0.9'; this.style.zIndex='1'; this.style.boxShadow='none';"
              title="${worker.name}: ${worker.startTime}-${worker.endTime} (${worker.hours}h)">
              </div>
            `;
          });
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
          
          <!-- 오른쪽 주간 요약 -->
          <div style="min-width: 220px; max-width: 220px; background: white; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 16px; height: fit-content;">
            <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 700; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px;">📊 주간 요약</h4>
      `;
      
      // 직원별 주간 요약
      if (currentScheduleData.employees) {
        currentScheduleData.employees.forEach(emp => {
          let totalHours = 0;
          let workDays = 0;
          days.forEach(day => {
            const scheduleArray = emp.schedules[day]; // 배열임
            
            // 배열의 모든 스케줄 시간 합산
            if (scheduleArray && Array.isArray(scheduleArray) && scheduleArray.length > 0) {
              scheduleArray.forEach(schedule => {
                if (schedule.isWorkDay) {
                  totalHours += parseFloat(schedule.hours);
                  // 하루에 여러 근무가 있어도 근무일 수는 1일로만 카운트
                }
              });
              // 해당 날짜에 근무가 하나라도 있으면 근무일 수 증가
              if (scheduleArray.some(s => s.isWorkDay)) {
                workDays++;
              }
            }
          });
          
          const color = colorMap[emp.name];
          
          // 급여 정보 (시급/월급/연봉)
          const salaryType = emp.salaryType || 'hourly';
          const salaryAmount = emp.salaryAmount || 0;
          let salaryText = '';
          if (salaryType === 'hourly' || salaryType === '시급') {
            salaryText = `시급: ₩${salaryAmount.toLocaleString()}`;
          } else if (salaryType === 'monthly' || salaryType === '월급') {
            salaryText = `월급: ₩${salaryAmount.toLocaleString()}`;
          } else if (salaryType === 'annual' || salaryType === '연봉') {
            salaryText = `연봉: ₩${salaryAmount.toLocaleString()}`;
          }
          
          // 주급 계산
          let weeklySalary = 0;
          if (salaryType === 'hourly' || salaryType === '시급') {
            weeklySalary = totalHours * salaryAmount;
            // 주휴수당 (주 15시간 이상)
            if (totalHours >= 15 && workDays > 0) {
              const avgDailyHours = totalHours / workDays;
              const weeklyHolidayPay = avgDailyHours * salaryAmount;
              weeklySalary += weeklyHolidayPay;
            }
          } else if (salaryType === 'monthly' || salaryType === '월급') {
            weeklySalary = salaryAmount / 4.345;
          } else if (salaryType === 'annual' || salaryType === '연봉') {
            weeklySalary = salaryAmount / 12 / 4.345;
          }
          
          // 월 예상
          const monthlyEstimate = weeklySalary * 4.345;
          
          html += `
            <div style="margin-bottom: 12px; padding: 8px; border-radius: 6px; background: var(--bg-light);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <div style="width: 14px; height: 14px; background: ${color}; border-radius: 3px;"></div>
                <span style="font-weight: 600; font-size: 12px;">${emp.name}</span>
              </div>
              <div style="font-size: 11px; color: var(--text-secondary); margin-left: 22px;">
                ${salaryText ? `<div>${salaryText}</div>` : ''}
                <div>⏱️ ${totalHours.toFixed(1)}시간</div>
                <div style="color: var(--primary-color); font-weight: 600;">💰 ₩${Math.round(weeklySalary).toLocaleString()} (주급)</div>
                <div style="font-size: 10px; color: var(--text-secondary);">📅 월 예상: ₩${Math.round(monthlyEstimate).toLocaleString()}</div>
              </div>
            </div>
          `;
        });
      }
      
      html += `
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    /**
     * 스케줄 시뮬레이터 모달 열기
     */
    // ============================================
    // 새로운 스케줄 시뮬레이터 (가상 인원 기반)
    // ============================================
    
    // 전역 변수
    let currentSimulator = null; // 현재 로드된 시뮬레이터
    let simulatorPersons = []; // 가상 인원 배열
    let simulatorSchedules = {}; // { personId: { 'YYYY-WW': { 월: {...}, 화: {...}, ... } } }
    let currentSimulatorWeek = null; // 현재 선택된 주차 Date 객체
    let currentEditingPerson = null; // 현재 편집 중인 인원
    
    /**
     * 시뮬레이터 모달 열기
     */
    async function showScheduleSimulator() {
      console.log('🎯 스케줄 시뮬레이터 열기');
      
      // 초기화
      currentSimulator = null;
      simulatorPersons = [];
      simulatorSchedules = {};
      currentSimulatorWeek = getMonday(new Date()); // 이번 주 월요일
      currentEditingPerson = null;
      
      // 시뮬레이터 목록 로드
      await loadSimulatorList();
      
      // UI 업데이트
      updateSimulatorUI();
      
      // 모달 표시
      document.getElementById('scheduleSimulatorModal').style.display = 'block';
    }
    
    /**
     * 시뮬레이터 목록 로드
     */
    async function loadSimulatorList() {
      try {
        const snapshot = await db.collection('simulators').orderBy('createdAt', 'desc').get();
        const select = document.getElementById('simulatorSelect');
        
        // 기본 옵션 유지
        select.innerHTML = '<option value="">새 시뮬레이터</option>';
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = data.name || `시뮬레이터 ${doc.id.substring(0, 8)}`;
          select.appendChild(option);
        });
        
        console.log(`✅ ${snapshot.size}개 시뮬레이터 로드 완료`);
      } catch (error) {
        console.error('❌ 시뮬레이터 목록 로드 실패:', error);
      }
    }
    

    
    /**
     * 전체 UI 업데이트
     */
    function updateSimulatorUI() {
      updateSimulatorPersonList();
      updateSimulatorGanttChart();
      updateSimulatorSummary();
      
      // 저장/삭제 버튼 표시 여부
      const btnDelete = document.getElementById('btnDeleteSimulator');
      if (currentSimulator) {
        btnDelete.style.display = 'inline-block';
      } else {
        btnDelete.style.display = 'none';
      }
    }
    
    /**
     * 가상 인원 목록 업데이트 (주간요약과 동일한 상세 표시)
     */
    function updateSimulatorPersonList() {
      const container = document.getElementById('simulatorPersonList');
      
      if (simulatorPersons.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: var(--spacing-md); color: var(--text-secondary); font-size: 13px;">가상 인원을 추가하세요</div>';
        return;
      }
      
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const monday = new Date(currentSimulatorWeek);
      const year = monday.getFullYear();
      const weekNum = getWeekNumber(monday);
      const weekKey = `${year}-${weekNum}`;
      
      let html = '';
      simulatorPersons.forEach((person, index) => {
        // 급여 정보
        let salaryText = '';
        if (person.salaryType === 'hourly') {
          salaryText = `시급: ₩${person.salaryAmount?.toLocaleString() || 0}`;
        } else if (person.salaryType === 'monthly') {
          salaryText = `월급: ₩${person.salaryAmount?.toLocaleString() || 0}`;
        }
        
        // 주간 근무시간 계산
        let totalHours = 0;
        let workDays = 0;
        const personSchedule = simulatorSchedules[person.id]?.[weekKey];
        if (personSchedule) {
          days.forEach(day => {
            const schedule = personSchedule[day];
            if (schedule && schedule.isWorkDay) {
              totalHours += parseFloat(schedule.hours || 0);
              workDays++;
            }
          });
        }
        
        // 주급 계산
        let weeklySalary = 0;
        if (person.salaryType === 'hourly' && person.salaryAmount) {
          weeklySalary = totalHours * person.salaryAmount;
          // 주휴수당 (주 15시간 이상)
          if (totalHours >= 15 && workDays > 0) {
            const avgDailyHours = totalHours / workDays;
            const weeklyHolidayPay = avgDailyHours * person.salaryAmount;
            weeklySalary += weeklyHolidayPay;
          }
        } else if (person.salaryType === 'monthly' && person.salaryAmount) {
          weeklySalary = person.salaryAmount / 4.345;
        }
        
        html += `
          <div style="background: white; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; cursor: pointer; transition: all 0.2s;" 
               onclick="editSimulatorPerson('${person.id}')"
               onmouseover="this.style.background='#f8f9fa'"
               onmouseout="this.style.background='white'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
              <div style="font-weight: 600; font-size: 14px;">${person.name}</div>
              <button onclick="deleteSimulatorPerson('${person.id}', event)" 
                      style="background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 18px; padding: 0; line-height: 1;"
                      title="삭제">
                ×
              </button>
            </div>
            <div style="font-size: 11px; color: var(--text-secondary);">
              ${salaryText ? `<div style="margin-bottom: 2px;">${salaryText}</div>` : ''}
              <div style="margin-bottom: 2px;">⏱️ ${totalHours.toFixed(1)}시간</div>
              ${weeklySalary > 0 ? `<div style="color: var(--primary-color); font-weight: 600;">💰 ₩${Math.round(weeklySalary).toLocaleString()}</div>` : ''}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    /**
     * 간트 차트 업데이트 (근무스케줄 타임테이블과 동일한 스타일)
     */
    function updateSimulatorGanttChart() {
      const container = document.getElementById('simulatorGanttChart');
      
      if (simulatorPersons.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">가상 인원을 추가하고 스케줄을 설정하세요</div>';
        return;
      }
      
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const monday = new Date(currentSimulatorWeek);
      const year = monday.getFullYear();
      const weekNum = getWeekNumber(monday);
      const weekKey = `${year}-${weekNum}`;
      
      // 직원별 색상 정의
      const employeeColors = [
        '#FF6B6B', '#4ECDC4', '#95E1D3', '#FFE66D', '#C7CEEA',
        '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'
      ];
      
      const colorMap = {};
      simulatorPersons.forEach((person, index) => {
        colorMap[person.id] = employeeColors[index % employeeColors.length];
      });
      
      // 요일 정보 생성 (날짜 제거)
      const dateInfo = [];
      days.forEach((day, index) => {
        dateInfo.push({
          day: day
        });
      });
      
      // 각 요일별 근무자 목록 생성
      const dayWorkers = {};
      days.forEach(day => {
        dayWorkers[day] = [];
      });
      
      simulatorPersons.forEach(person => {
        const personSchedule = simulatorSchedules[person.id]?.[weekKey];
        if (!personSchedule) return;
        
        days.forEach(day => {
          const schedule = personSchedule[day];
          if (schedule && schedule.isWorkDay) {
            dayWorkers[day].push({
              name: person.name,
              startTime: schedule.startTime,
              endTime: schedule.endTime,
              hours: schedule.hours,
              color: colorMap[person.id]
            });
          }
        });
      });
      
      // 시간 범위 (06:00 ~ 01:00, 1시간 단위)
      const startHour = 6;
      const endHour = 25; // 다음날 01:00
      const totalHours = endHour - startHour;
      const rowHeight = 35; // 1시간당 높이 (px)
      const totalHeight = totalHours * rowHeight;
      
      // HTML 구조 생성 (근무스케줄과 동일)
      let html = `
        <div style="display: flex; gap: var(--spacing-md); width: 100%; max-width: 1400px; margin: 0 auto;">
          <!-- 메인 간트차트 -->
          <div style="flex: 1; display: flex; border: 1px solid var(--border-color); background: white;">
            <!-- 시간 레이블 열 -->
            <div style="width: 60px; border-right: 1px solid var(--border-color); background: var(--bg-light);">
              <div style="height: 45px; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-color); font-weight: 700; font-size: 12px;">
                시간
              </div>
              <div style="position: relative; height: ${totalHeight}px;">
      `;
      
      // 시간 눈금
      for (let h = startHour; h <= endHour; h++) {
        const displayHour = h > 24 ? h - 24 : h;
        const timeLabel = `${displayHour.toString().padStart(2, '0')}:00`;
        const topPos = (h - startHour) * rowHeight;
        
        html += `
          <div style="position: absolute; top: ${topPos}px; width: 100%; height: ${rowHeight}px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500;">
            ${timeLabel}
          </div>
        `;
      }
      
      html += `
              </div>
            </div>
            
            <!-- 요일별 간트차트 열들 -->
      `;
      
      // 각 요일별 칼럼
      dateInfo.forEach((info, dayIndex) => {
        const day = days[dayIndex];
        const workers = dayWorkers[day];
        
        html += `
          <div style="flex: 1; ${dayIndex < days.length - 1 ? 'border-right: 1px solid var(--border-color);' : ''}">
            <!-- 요일 헤더 (날짜 제거) -->
            <div style="height: 45px; display: flex; align-items: center; justify-content: center; border-bottom: 2px solid var(--border-color); background: var(--bg-light); font-weight: 700; font-size: 14px;">
              ${info.day}
            </div>
            
            <!-- 간트차트 영역 -->
            <div style="position: relative; height: ${totalHeight}px; background: white;">
              <!-- 시간 그리드 배경 -->
        `;
        
        // 시간 그리드 라인
        for (let h = startHour; h <= endHour; h++) {
          const topPos = (h - startHour) * rowHeight;
          html += `
            <div style="position: absolute; top: ${topPos}px; width: 100%; height: ${rowHeight}px; border-bottom: 1px solid #f0f0f0;"></div>
          `;
        }
        
        // 각 직원의 막대
        if (workers.length > 0) {
          const maxBarWidth = 18; // 최대 막대 굵기 (%)
          const minBarWidth = 8;  // 최소 막대 굵기 (%)
          const minSpacing = 3;   // 최소 간격 (%)
          
          let barWidth = maxBarWidth;
          if (workers.length > 3) {
            const totalWithSpacing = workers.length * maxBarWidth + (workers.length + 1) * minSpacing;
            if (totalWithSpacing > 100) {
              barWidth = (100 - (workers.length + 1) * minSpacing) / workers.length;
              barWidth = Math.max(barWidth, minBarWidth);
            }
          }
          
          const totalBarsWidth = workers.length * barWidth;
          const availableSpace = 100;
          const spacing = workers.length > 1 ? (availableSpace - totalBarsWidth) / (workers.length + 1) : (availableSpace - barWidth) / 2;
          
          workers.forEach((worker, workerIndex) => {
            const [startH, startM] = worker.startTime.split(':').map(Number);
            const [endH, endM] = worker.endTime.split(':').map(Number);
            
            const startMinutes = (startH - startHour) * 60 + startM;
            const endMinutes = (endH - startHour) * 60 + endM;
            
            const topPos = (startMinutes / 60) * rowHeight;
            const height = ((endMinutes - startMinutes) / 60) * rowHeight;
            const leftPos = spacing * (workerIndex + 1) + barWidth * workerIndex;
            
            html += `
              <div style="
                position: absolute;
                left: ${leftPos}%;
                top: ${topPos}px;
                width: ${barWidth}%;
                height: ${height}px;
                background: ${worker.color};
                opacity: 0.9;
                box-sizing: border-box;
                transition: all 0.2s;
                border-radius: 2px;
              " 
              onmouseover="this.style.opacity='1'; this.style.zIndex='5'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';" 
              onmouseout="this.style.opacity='0.9'; this.style.zIndex='1'; this.style.boxShadow='none';"
              title="${worker.name}: ${worker.startTime}-${worker.endTime} (${worker.hours}h)">
              </div>
            `;
          });
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    /**
     * 요약 정보 업데이트
     */
    function updateSimulatorSummary() {
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const monday = new Date(currentSimulatorWeek);
      const year = monday.getFullYear();
      const weekNum = getWeekNumber(monday);
      const weekKey = `${year}-${weekNum}`;
      
      let totalWeeklyHours = 0;
      let workingPersonsCount = 0;
      let totalMonthlySalary = 0;
      
      simulatorPersons.forEach(person => {
        const personSchedule = simulatorSchedules[person.id]?.[weekKey];
        if (!personSchedule) return;
        
        let weeklyHours = 0;
        let weeklyWorkDays = 0;
        
        days.forEach(day => {
          const daySchedule = personSchedule[day];
          if (daySchedule && daySchedule.isWorkDay) {
            weeklyHours += daySchedule.hours || 0;
            weeklyWorkDays++;
          }
        });
        
        if (weeklyHours > 0) {
          workingPersonsCount++;
          totalWeeklyHours += weeklyHours;
          
          // 급여 계산
          if (person.salaryType === 'hourly' && person.salaryAmount) {
            let weeklySalary = weeklyHours * person.salaryAmount;
            
            // 주휴수당 (주 15시간 이상)
            if (weeklyHours >= 15) {
              const avgDailyHours = weeklyHours / weeklyWorkDays;
              const weeklyHolidayPay = avgDailyHours * person.salaryAmount;
              weeklySalary += weeklyHolidayPay;
            }
            
            totalMonthlySalary += weeklySalary * 4.345; // 월 환산
          } else if (person.salaryType === 'monthly' && person.salaryAmount) {
            totalMonthlySalary += person.salaryAmount;
          }
        }
      });
      
      // 주간 요약 업데이트
      document.getElementById('simulatorWeeklySummary').innerHTML = `
        <div>총 근무시간: <strong>${totalWeeklyHours.toFixed(1)}h</strong></div>
        <div>근무 인원: <strong>${workingPersonsCount}명</strong></div>
      `;
      
      // 월간 급여 합계 업데이트
      document.getElementById('simulatorMonthlySalary').innerHTML = `
        <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);">₩${Math.round(totalMonthlySalary).toLocaleString()}</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">주휴수당 포함</div>
      `;
    }
    
    /**
     * 가상 인원 추가
     */
    function addSimulatorPerson() {
      // 다음 알파벳 이름 생성 (A, B, C, ..., Z, AA, AB, ...)
      const getNextName = () => {
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const count = simulatorPersons.length;
        
        if (count < 26) {
          return alphabet[count];
        } else {
          const first = Math.floor(count / 26) - 1;
          const second = count % 26;
          return alphabet[first] + alphabet[second];
        }
      };
      
      const newPerson = {
        id: `person_${Date.now()}_${Math.random().toString(36).substring(7)}`,
        name: getNextName(),
        salaryType: null,
        salaryAmount: null,
        schedules: [] // [{ days: ['월', '화'], startHour, startMinute, endHour, endMinute }]
      };
      
      simulatorPersons.push(newPerson);
      updateSimulatorUI();
      
      // 바로 설정 모달 열기
      editSimulatorPerson(newPerson.id);
    }
    
    /**
     * 가상 인원 편집
     */
    function editSimulatorPerson(personId) {
      const person = simulatorPersons.find(p => p.id === personId);
      if (!person) return;
      
      currentEditingPerson = person;
      
      // 모달 제목 설정
      document.getElementById('personSettingsName').textContent = person.name;
      
      // 급여 설정 복원
      if (person.salaryType === 'hourly') {
        document.querySelector('input[name="personSalaryType"][value="hourly"]').checked = true;
        document.getElementById('salaryAmountContainer').style.display = 'block';
        document.getElementById('personSalaryAmount').value = person.salaryAmount || '';
      } else if (person.salaryType === 'monthly') {
        document.querySelector('input[name="personSalaryType"][value="monthly"]').checked = true;
        document.getElementById('salaryAmountContainer').style.display = 'block';
        document.getElementById('personSalaryAmount').value = person.salaryAmount || '';
      } else {
        document.querySelector('input[name="personSalaryType"][value="none"]').checked = true;
        document.getElementById('salaryAmountContainer').style.display = 'none';
      }
      
      // 근무일 그룹 복원
      const container = document.getElementById('scheduleGroupsContainer');
      if (person.schedules && person.schedules.length > 0) {
        container.innerHTML = '';
        person.schedules.forEach((schedule, index) => {
          addScheduleGroupUI(schedule, index);
        });
      } else {
        // 기본 그룹 하나 추가
        container.innerHTML = '';
        addScheduleGroupUI();
      }
      
      // 모달 표시
      document.getElementById('personSettingsModal').style.display = 'block';
    }
    
    /**
     * 가상 인원 삭제
     */
    function deleteSimulatorPerson(personId, event) {
      if (event) {
        event.stopPropagation(); // 편집 모달 열리지 않도록
      }
      
      if (!confirm('이 가상 인원을 삭제하시겠습니까?')) return;
      
      // 배열에서 제거
      simulatorPersons = simulatorPersons.filter(p => p.id !== personId);
      
      // 스케줄 데이터 제거
      delete simulatorSchedules[personId];
      
      updateSimulatorUI();
    }
    
    /**
     * 급여 입력 토글
     */
    function toggleSalaryInput() {
      const selected = document.querySelector('input[name="personSalaryType"]:checked').value;
      const container = document.getElementById('salaryAmountContainer');
      
      if (selected === 'none') {
        container.style.display = 'none';
      } else {
        container.style.display = 'block';
      }
    }
    
    /**
     * 근무일 그룹 추가 (UI)
     */
    function addScheduleGroup() {
      addScheduleGroupUI();
    }
    
    function addScheduleGroupUI(scheduleData = null, index = null) {
      const container = document.getElementById('scheduleGroupsContainer');
      const groupIndex = index !== null ? index : container.children.length;
      
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      
      const groupDiv = document.createElement('div');
      groupDiv.className = 'schedule-group';
      groupDiv.dataset.groupIndex = groupIndex;
      groupDiv.style.cssText = 'background: white; border: 1px solid var(--border-color); border-radius: 6px; padding: var(--spacing-sm);';
      
      let daysHtml = '';
      days.forEach(day => {
        const checked = scheduleData && scheduleData.days.includes(day) ? 'checked' : '';
        daysHtml += `
          <label style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer; font-size: 13px;">
            <input type="checkbox" value="${day}" ${checked} style="cursor: pointer;">
            <span>${day}</span>
          </label>
        `;
      });
      
      const startHour = scheduleData ? scheduleData.startHour : '09';
      const startMinute = scheduleData ? scheduleData.startMinute : '00';
      const endHour = scheduleData ? scheduleData.endHour : '18';
      const endMinute = scheduleData ? scheduleData.endMinute : '00';
      
      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h5 style="margin: 0; font-size: 13px; font-weight: 600;">근무일 그룹 ${groupIndex + 1}</h5>
          <button onclick="deleteScheduleGroup(${groupIndex})" class="btn btn-sm btn-danger" style="padding: 2px 8px; font-size: 11px;">삭제</button>
        </div>
        <div style="margin-bottom: 8px;">
          <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">근무 요일</label>
          <div style="display: flex; flex-wrap: wrap; gap: 4px;">
            ${daysHtml}
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">시작 시간</label>
            <div style="display: flex; gap: 4px;">
              <input type="number" min="0" max="23" value="${startHour}" placeholder="시" 
                     style="flex: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;">
              <input type="number" min="0" max="59" value="${startMinute}" placeholder="분" 
                     style="flex: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;">
            </div>
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">종료 시간</label>
            <div style="display: flex; gap: 4px;">
              <input type="number" min="0" max="23" value="${endHour}" placeholder="시" 
                     style="flex: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;">
              <input type="number" min="0" max="59" value="${endMinute}" placeholder="분" 
                     style="flex: 1; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px;">
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(groupDiv);
    }
    
    /**
     * 근무일 그룹 삭제
     */
    function deleteScheduleGroup(groupIndex) {
      const container = document.getElementById('scheduleGroupsContainer');
      const groups = container.querySelectorAll('.schedule-group');
      
      if (groups.length <= 1) {
        alert('최소 1개의 근무일 그룹이 필요합니다.');
        return;
      }
      
      if (groups[groupIndex]) {
        groups[groupIndex].remove();
        
        // 인덱스 재조정
        const remainingGroups = container.querySelectorAll('.schedule-group');
        remainingGroups.forEach((group, newIndex) => {
          group.dataset.groupIndex = newIndex;
          const title = group.querySelector('h5');
          if (title) {
            title.textContent = `근무일 그룹 ${newIndex + 1}`;
          }
          const deleteBtn = group.querySelector('button');
          if (deleteBtn) {
            deleteBtn.setAttribute('onclick', `deleteScheduleGroup(${newIndex})`);
          }
        });
      }
    }
    
    /**
     * 인원 설정 저장
     */
    function savePersonSettings() {
      if (!currentEditingPerson) return;
      
      // 급여 설정 수집
      const salaryType = document.querySelector('input[name="personSalaryType"]:checked').value;
      const salaryAmount = document.getElementById('personSalaryAmount').value;
      
      if (salaryType !== 'none') {
        if (!salaryAmount || parseFloat(salaryAmount) <= 0) {
          alert('급여 금액을 입력하세요.');
          return;
        }
        currentEditingPerson.salaryType = salaryType;
        currentEditingPerson.salaryAmount = parseFloat(salaryAmount);
      } else {
        currentEditingPerson.salaryType = null;
        currentEditingPerson.salaryAmount = null;
      }
      
      // 근무일 그룹 수집
      const schedules = [];
      const groups = document.querySelectorAll('.schedule-group');
      
      groups.forEach(group => {
        const checkedDays = Array.from(group.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        if (checkedDays.length === 0) return;
        
        const inputs = group.querySelectorAll('input[type="number"]');
        const startHour = String(parseInt(inputs[0].value) || 0).padStart(2, '0');
        const startMinute = String(parseInt(inputs[1].value) || 0).padStart(2, '0');
        const endHour = String(parseInt(inputs[2].value) || 0).padStart(2, '0');
        const endMinute = String(parseInt(inputs[3].value) || 0).padStart(2, '0');
        
        schedules.push({
          days: checkedDays,
          startHour,
          startMinute,
          endHour,
          endMinute
        });
      });
      
      if (schedules.length === 0) {
        alert('최소 1개의 근무일 그룹을 설정하세요.');
        return;
      }
      
      currentEditingPerson.schedules = schedules;
      
      // 스케줄 데이터 생성 (8주치)
      generatePersonSchedules(currentEditingPerson);
      
      // UI 업데이트
      updateSimulatorUI();
      
      // 모달 닫기
      closePersonSettings();
    }
    
    /**
     * 인원 설정 모달 닫기
     */
    function closePersonSettings() {
      document.getElementById('personSettingsModal').style.display = 'none';
      currentEditingPerson = null;
    }
    
    /**
     * 가상 인원의 스케줄 생성 (8주치)
     */
    function generatePersonSchedules(person) {
      const days = ['월', '화', '수', '목', '금', '토', '일'];
      const today = new Date();
      const baseMonday = getMonday(today);
      
      // 요일별 스케줄 맵 생성
      const dayScheduleMap = {};
      person.schedules.forEach(schedule => {
        schedule.days.forEach(day => {
          const startTime = `${schedule.startHour}:${schedule.startMinute}`;
          const endTime = `${schedule.endHour}:${schedule.endMinute}`;
          const hours = calculateWorkHours(startTime, endTime);
          
          dayScheduleMap[day] = {
            isWorkDay: true,
            startTime,
            endTime,
            hours
          };
        });
      });
      
      // personId로 스케줄 저장소 초기화
      if (!simulatorSchedules[person.id]) {
        simulatorSchedules[person.id] = {};
      }
      
      // 8주치 생성 (이전 4주 + 이후 4주)
      for (let i = -4; i <= 3; i++) {
        const monday = new Date(baseMonday);
        monday.setDate(monday.getDate() + (i * 7));
        
        const year = monday.getFullYear();
        const weekNum = getWeekNumber(monday);
        const weekKey = `${year}-${weekNum}`;
        
        const weekSchedule = {};
        days.forEach(day => {
          if (dayScheduleMap[day]) {
            weekSchedule[day] = { ...dayScheduleMap[day] };
          } else {
            weekSchedule[day] = { isWorkDay: false };
          }
        });
        
        simulatorSchedules[person.id][weekKey] = weekSchedule;
      }
      
      console.log(`✅ ${person.name} 스케줄 생성 완료 (8주치)`);
    }
    
    /**
     * 시뮬레이터 닫기
     */
    function closeScheduleSimulator() {
      document.getElementById('scheduleSimulatorModal').style.display = 'none';
    }
    
    /**
     * 새 시뮬레이터 만들기
     */
    function createNewSimulator() {
      if (currentSimulator || simulatorPersons.length > 0) {
        if (!confirm('현재 작업 중인 시뮬레이터가 있습니다. 새로 만들시겠습니까? (저장되지 않은 내용은 사라집니다)')) {
          return;
        }
      }
      
      // 초기화
      currentSimulator = null;
      simulatorPersons = [];
      simulatorSchedules = {};
      
      // UI 업데이트
      document.getElementById('simulatorSelect').value = '';
      updateSimulatorUI();
    }
    
    /**
     * 시뮬레이터 저장
     */
    async function saveCurrentSimulator() {
      if (simulatorPersons.length === 0) {
        alert('저장할 가상 인원이 없습니다.');
        return;
      }
      
      // 시뮬레이터 이름 입력
      const name = prompt('시뮬레이터 이름을 입력하세요:', currentSimulator?.name || `시뮬레이션 ${new Date().toLocaleDateString()}`);
      if (!name) return;
      
      try {
        const simulatorId = currentSimulator?.id || `sim_${Date.now()}`;
        
        // 1. simulators 컬렉션 저장
        await db.collection('simulators').doc(simulatorId).set({
          name,
          createdAt: currentSimulator?.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // 2. simulatorPersons 컬렉션 저장
        const batch = db.batch();
        
        for (const person of simulatorPersons) {
          const personRef = db.collection('simulatorPersons').doc(`${simulatorId}_${person.id}`);
          batch.set(personRef, {
            simulatorId,
            personId: person.id,
            name: person.name,
            salaryType: person.salaryType,
            salaryAmount: person.salaryAmount,
            schedules: person.schedules
          });
        }
        
        await batch.commit();
        
        // 3. simulatorSchedules 컬렉션 저장
        const scheduleBatch = db.batch();
        let scheduleCount = 0;
        
        for (const personId in simulatorSchedules) {
          for (const weekKey in simulatorSchedules[personId]) {
            const scheduleRef = db.collection('simulatorSchedules').doc(`${simulatorId}_${personId}_${weekKey}`);
            scheduleBatch.set(scheduleRef, {
              simulatorId,
              personId,
              weekKey,
              ...simulatorSchedules[personId][weekKey],
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            scheduleCount++;
          }
        }
        
        await scheduleBatch.commit();
        
        console.log(`✅ 시뮬레이터 저장 완료: ${simulatorPersons.length}명, ${scheduleCount}개 스케줄`);
        
        currentSimulator = { id: simulatorId, name };
        
        // 목록 새로고침
        await loadSimulatorList();
        document.getElementById('simulatorSelect').value = simulatorId;
        
        alert('시뮬레이터가 저장되었습니다!');
        
        updateSimulatorUI();
      } catch (error) {
        console.error('❌ 시뮬레이터 저장 실패:', error);
        alert('저장에 실패했습니다: ' + error.message);
      }
    }
    
    /**
     * 시뮬레이터 불러오기
     */
    async function loadSimulator(simulatorId) {
      if (!simulatorId) {
        createNewSimulator();
        return;
      }
      
      try {
        console.log(`🔄 시뮬레이터 로드: ${simulatorId}`);
        
        // 1. 시뮬레이터 정보 로드
        const simDoc = await db.collection('simulators').doc(simulatorId).get();
        if (!simDoc.exists) {
          alert('시뮬레이터를 찾을 수 없습니다.');
          return;
        }
        
        currentSimulator = { id: simulatorId, ...simDoc.data() };
        
        // 2. 가상 인원 로드
        const personsSnapshot = await db.collection('simulatorPersons')
          .where('simulatorId', '==', simulatorId)
          .get();
        
        simulatorPersons = [];
        personsSnapshot.forEach(doc => {
          const data = doc.data();
          simulatorPersons.push({
            id: data.personId,
            name: data.name,
            salaryType: data.salaryType,
            salaryAmount: data.salaryAmount,
            schedules: data.schedules || []
          });
        });
        
        // 3. 스케줄 데이터 로드
        const schedulesSnapshot = await db.collection('simulatorSchedules')
          .where('simulatorId', '==', simulatorId)
          .get();
        
        simulatorSchedules = {};
        schedulesSnapshot.forEach(doc => {
          const data = doc.data();
          const { personId, weekKey } = data;
          
          if (!simulatorSchedules[personId]) {
            simulatorSchedules[personId] = {};
          }
          
          // weekKey를 제외한 나머지가 실제 스케줄 데이터
          const { simulatorId: _, personId: __, weekKey: ___, updatedAt, ...scheduleData } = data;
          simulatorSchedules[personId][weekKey] = scheduleData;
        });
        
        console.log(`✅ 로드 완료: ${simulatorPersons.length}명, ${schedulesSnapshot.size}개 스케줄`);
        
        // UI 업데이트
        updateSimulatorUI();
      } catch (error) {
        console.error('❌ 시뮬레이터 로드 실패:', error);
        alert('불러오기에 실패했습니다: ' + error.message);
      }
    }
    
    /**
     * 시뮬레이터 삭제
     */
    async function deleteCurrentSimulator() {
      if (!currentSimulator) {
        alert('삭제할 시뮬레이터가 없습니다.');
        return;
      }
      
      if (!confirm(`"${currentSimulator.name}" 시뮬레이터를 삭제하시겠습니까?`)) {
        return;
      }
      
      try {
        const simulatorId = currentSimulator.id;
        
        // 1. simulatorSchedules 삭제
        const schedulesSnapshot = await db.collection('simulatorSchedules')
          .where('simulatorId', '==', simulatorId)
          .get();
        
        const scheduleBatch = db.batch();
        schedulesSnapshot.forEach(doc => {
          scheduleBatch.delete(doc.ref);
        });
        await scheduleBatch.commit();
        
        // 2. simulatorPersons 삭제
        const personsSnapshot = await db.collection('simulatorPersons')
          .where('simulatorId', '==', simulatorId)
          .get();
        
        const personBatch = db.batch();
        personsSnapshot.forEach(doc => {
          personBatch.delete(doc.ref);
        });
        await personBatch.commit();
        
        // 3. simulators 삭제
        await db.collection('simulators').doc(simulatorId).delete();
        
        console.log(`✅ 시뮬레이터 삭제 완료: ${simulatorId}`);
        
        alert('시뮬레이터가 삭제되었습니다.');
        
        // 초기화
        createNewSimulator();
        await loadSimulatorList();
      } catch (error) {
        console.error('❌ 시뮬레이터 삭제 실패:', error);
        alert('삭제에 실패했습니다: ' + error.message);
      }
    }

    /**
     * PDF 저장
     */
    async function exportSchedulePDF() {
      if (!currentScheduleData || !currentScheduleData.employees || currentScheduleData.employees.length === 0) {
        alert('저장할 스케줄 데이터가 없습니다.');
        return;
      }
      
      try {
        // jsPDF 라이브러리가 로드되지 않았다면 동적으로 로드
        if (typeof jspdf === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const monday = getMonday(currentScheduleWeek);
        const year = monday.getFullYear();
        const weekNum = getWeekNumber(monday);
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const daysKor = ['월', '화', '수', '목', '금', '토', '일'];
        
        // 제목
        doc.setFontSize(18);
        doc.text(`Week ${weekNum}, ${year} Schedule`, 20, 20);
        
        // 날짜 범위
        const sunday = new Date(monday);
        sunday.setDate(sunday.getDate() + 6);
        doc.setFontSize(12);
        doc.text(`${monday.getMonth()+1}/${monday.getDate()} - ${sunday.getMonth()+1}/${sunday.getDate()}`, 20, 30);
        
        let yPos = 45;
        
        // 각 직원별 스케줄 표시
        currentScheduleData.employees.forEach((emp, empIndex) => {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(14);
          doc.text(emp.name, 20, yPos);
          yPos += 10;
          
          doc.setFontSize(10);
          
          daysKor.forEach((day, dayIndex) => {
            const schedule = emp.schedules[day];
            const date = new Date(monday);
            date.setDate(date.getDate() + dayIndex);
            
            let scheduleText = `${day}(${date.getMonth()+1}/${date.getDate()}): `;
            
            if (schedule && schedule.isWorkDay) {
              scheduleText += `${schedule.startTime} - ${schedule.endTime} (${schedule.hours}h)`;
            } else {
              scheduleText += 'Off';
            }
            
            doc.text(scheduleText, 25, yPos);
            yPos += 7;
          });
          
          yPos += 5;
        });
        
        // PDF 저장
        doc.save(`schedule_${year}_week${weekNum}.pdf`);
        
        console.log('✅ PDF 저장 완료');
      } catch (error) {
        console.error('❌ PDF 저장 실패:', error);
        alert('PDF 저장에 실패했습니다.');
      }
    }

    // 🔧 계약서 employeeId 마이그레이션
    async function migrateContractEmployeeIds() {
      const logDiv = document.getElementById('migrationLog');
      logDiv.style.display = 'block';
      logDiv.innerHTML = '<p style="color: var(--primary);">🔄 마이그레이션 시작...</p>';
      
      try {
        const db = firebase.firestore();
        
        // 1. 모든 계약서 가져오기
        const contractsSnapshot = await db.collection('contracts').get();
        logDiv.innerHTML += `<p>📋 총 ${contractsSnapshot.size}개의 계약서를 찾았습니다.</p>`;
        
        let fixedCount = 0;
        let errorCount = 0;
        let skipCount = 0;
        
        // 2. employeeId가 없는 계약서 찾기
        for (const contractDoc of contractsSnapshot.docs) {
          const contractData = contractDoc.data();
          const contractId = contractDoc.id;
          
          // employeeId가 이미 있으면 건너뛰기
          if (contractData.employeeId) {
            skipCount++;
            continue;
          }
          
          logDiv.innerHTML += `<p style="color: var(--warning);">⚠️ employeeId 없음: ${contractData.employeeName} (${contractData.employeeBirth})</p>`;
          
          // 3. employeeName + employeeBirth로 users에서 직원 찾기
          try {
            const usersSnapshot = await db.collection('users')
              .where('name', '==', contractData.employeeName)
              .where('birth', '==', contractData.employeeBirth)
              .where('role', '==', 'employee')
              .get();
            
            if (usersSnapshot.empty) {
              logDiv.innerHTML += `<p style="color: var(--error);">  ❌ 일치하는 직원을 찾을 수 없습니다.</p>`;
              errorCount++;
              continue;
            }
            
            if (usersSnapshot.size > 1) {
              logDiv.innerHTML += `<p style="color: var(--warning);">  ⚠️ 여러 명의 직원이 발견됨 (${usersSnapshot.size}명). 첫 번째 직원으로 설정합니다.</p>`;
            }
            
            const employeeDoc = usersSnapshot.docs[0];
            const employeeId = employeeDoc.id;
            
            // 4. 계약서에 employeeId 추가
            await db.collection('contracts').doc(contractId).update({
              employeeId: employeeId,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              migratedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            logDiv.innerHTML += `<p style="color: var(--success);">  ✅ employeeId 설정 완료: ${employeeId}</p>`;
            fixedCount++;
            
          } catch (error) {
            logDiv.innerHTML += `<p style="color: var(--error);">  ❌ 오류: ${error.message}</p>`;
            errorCount++;
          }
        }
        
        // 5. 결과 요약
        logDiv.innerHTML += `<p style="border-top: 2px solid var(--border-color); padding-top: 8px; margin-top: 8px; font-weight: 600;">
          📊 마이그레이션 완료<br>
          ✅ 수정됨: ${fixedCount}개<br>
          ⏭️ 건너뜀 (이미 있음): ${skipCount}개<br>
          ❌ 오류: ${errorCount}개
        </p>`;
        
        if (fixedCount > 0) {
          alert(`✅ ${fixedCount}개의 계약서가 수정되었습니다!\n\n이제 직원 페이지에서 계약서를 확인할 수 있습니다.`);
        } else if (skipCount === contractsSnapshot.size) {
          alert('ℹ️ 모든 계약서에 이미 employeeId가 있습니다.');
        } else {
          alert(`⚠️ ${errorCount}개의 계약서를 수정하지 못했습니다.\n로그를 확인해주세요.`);
        }
        
      } catch (error) {
        console.error('마이그레이션 실패:', error);
        logDiv.innerHTML += `<p style="color: var(--error);">❌ 마이그레이션 실패: ${error.message}</p>`;
        alert('마이그레이션 중 오류가 발생했습니다.');
      }
    }
  </script>

  <!-- 스케줄 시뮬레이터 모달 -->
  <!-- 스케줄 시뮬레이터 모달 (새 버전) -->
  <div id="scheduleSimulatorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: var(--border-radius); max-width: 1400px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
        
        <!-- 모달 헤더 -->
        <div style="padding: var(--spacing-lg); border-bottom: 2px solid var(--border-color);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
            <h3 style="margin: 0; font-size: 18px; font-weight: 700;">📅 스케줄 시뮬레이터</h3>
            <button onclick="closeScheduleSimulator()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
          </div>
          
          <!-- 상단 컨트롤 -->
          <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
            <select id="simulatorSelect" onchange="loadSimulator(this.value)" style="flex: 1; max-width: 300px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
              <option value="">새 시뮬레이터</option>
            </select>
            <button class="btn btn-secondary" onclick="createNewSimulator()">✨ 새로만들기</button>
            <button class="btn btn-primary" onclick="saveCurrentSimulator()" id="btnSaveSimulator">💾 저장</button>
            <button class="btn btn-danger" onclick="deleteCurrentSimulator()" id="btnDeleteSimulator" style="display: none;">🗑️ 삭제</button>
          </div>
        </div>
        
        <!-- 모달 바디 (2단 레이아웃) -->
        <div style="flex: 1; overflow-y: auto; display: flex;">
          <!-- 좌측: 간트 차트 영역 (근무스케줄과 동일한 스타일) -->
          <div style="flex: 1; padding: var(--spacing-lg); overflow-y: auto;">
            <div id="simulatorGanttChart">
              <!-- 간트 차트 렌더링 영역 (근무스케줄 타임테이블 복사) -->
            </div>
          </div>
          
          <!-- 우측: 사이드바 (인원 목록 + 급여 합계) -->
          <div style="width: 320px; padding: var(--spacing-lg); display: flex; flex-direction: column; gap: var(--spacing-lg);">
            <!-- 주간 요약 -->
            <div>
              <h4 style="font-size: 14px; font-weight: 700; margin: 0 0 var(--spacing-sm) 0;">📊 주간 요약</h4>
              <div id="simulatorWeeklySummary" style="background: #f0f7ff; padding: var(--spacing-sm); border-radius: 6px; font-size: 13px;">
                <div>총 근무시간: <strong>0h</strong></div>
                <div>근무 인원: <strong>0명</strong></div>
              </div>
            </div>
            
            <!-- 가상 인원 목록 -->
            <div style="flex: 1; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                <h4 style="font-size: 14px; font-weight: 700; margin: 0;">👥 가상 인원</h4>
                <button class="btn btn-sm btn-primary" onclick="addSimulatorPerson()">+ 추가</button>
              </div>
              <div id="simulatorPersonList" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- 가상 인원 카드 동적 생성 -->
              </div>
            </div>
            
            <!-- 월간 급여 합계 -->
            <div>
              <h4 style="font-size: 14px; font-weight: 700; margin: 0 0 var(--spacing-sm) 0;">💰 월간 급여 합계</h4>
              <div id="simulatorMonthlySalary" style="background: #fff3e0; padding: var(--spacing-md); border-radius: 6px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);">₩0</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">주휴수당 포함</div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
  <!-- 가상 인원 설정 모달 -->
  <div id="personSettingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1100; overflow-y: auto;">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; border-radius: var(--border-radius); width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column;">
        
        <!-- 모달 헤더 -->
        <div style="padding: var(--spacing-lg); border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; font-size: 18px; font-weight: 700;">⚙️ 가상 인원 설정: <span id="personSettingsName">A</span></h3>
          <button onclick="closePersonSettings()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        
        <!-- 모달 바디 -->
        <div style="flex: 1; overflow-y: auto; padding: var(--spacing-lg);">
          
          <!-- 급여 설정 (선택사항) -->
          <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: #f8f9fa; border-radius: 8px;">
            <h4 style="font-size: 15px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">💼 급여 설정 (선택)</h4>
            <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
              <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                <input type="radio" name="personSalaryType" value="hourly" onchange="toggleSalaryInput()" style="cursor: pointer;">
                <span style="font-size: 14px;">시급제</span>
              </label>
              <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                <input type="radio" name="personSalaryType" value="monthly" onchange="toggleSalaryInput()" style="cursor: pointer;">
                <span style="font-size: 14px;">월급제</span>
              </label>
              <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                <input type="radio" name="personSalaryType" value="none" checked onchange="toggleSalaryInput()" style="cursor: pointer;">
                <span style="font-size: 14px;">미설정</span>
              </label>
            </div>
            <div id="salaryAmountContainer" style="display: none;">
              <label style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: block;">금액</label>
              <input type="number" id="personSalaryAmount" placeholder="예: 10000" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
            </div>
          </div>
          
          <!-- 근무 스케줄 (필수) -->
          <div style="margin-bottom: var(--spacing-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
              <h4 style="font-size: 15px; font-weight: 600; margin: 0;">📅 근무 스케줄 (필수)</h4>
              <button class="btn btn-sm btn-secondary" onclick="addScheduleGroup()">+ 근무일 그룹 추가</button>
            </div>
            <div id="scheduleGroupsContainer" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
              <!-- 근무일 그룹 동적 생성 -->
            </div>
          </div>
          
        </div>
        
        <!-- 모달 푸터 -->
        <div style="padding: var(--spacing-lg); border-top: 2px solid var(--border-color); display: flex; justify-content: space-between;">
          <button class="btn btn-secondary" onclick="closePersonSettings()">취소</button>
          <button class="btn btn-primary" onclick="savePersonSettings()">저장</button>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Firebase Init (로드 순서: 맨 마지막, 모든 함수 정의 후) -->
  <script src="js/firebase-init.js"></script>
  <script src="js/field-constants.js"></script>
</body>
</html>
