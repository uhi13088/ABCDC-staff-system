# í•„ë“œëª… í‘œì¤€í™” ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ê¸°ì¡´ ë°ì´í„°ì— `userId` í‘œì¤€ í•„ë“œë¥¼ ì¶”ê°€í•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

**ëª©ì **: 
- ëª¨ë“  ì»¬ë ‰ì…˜ì— í‘œì¤€ í•„ë“œ ì¶”ê°€ (ë“€ì–¼ í•„ë“œ ì „ëµ)
- ê¸°ì¡´ í•„ë“œ ê°’ì„ í‘œì¤€ í•„ë“œë¡œ ë³µì‚¬
- í–¥í›„ í†µê³„/ë¦¬í¬íŠ¸ êµ¬í˜„ ì¤€ë¹„

---

## ğŸ¯ ë§ˆì´ê·¸ë ˆì´ì…˜ ëŒ€ìƒ

### ë‹¨ì¼ í•„ë“œ ì»¬ë ‰ì…˜ (6ê°œ)

| ì»¬ë ‰ì…˜ | ì†ŒìŠ¤ í•„ë“œ | í‘œì¤€ í•„ë“œ | ì„¤ëª… |
|--------|----------|----------|------|
| `attendance` | `uid` | `userId` | ì¶œí‡´ê·¼ ê¸°ë¡ |
| `contracts` | `employeeId` | `userId` | ê³„ì•½ì„œ |
| `signedContracts` | `employeeId` | `userId` | ì„œëª…ëœ ê³„ì•½ì„œ |
| `salaries` | `employeeUid` | `userId` | ê¸‰ì—¬ í™•ì • |
| `approvals` | `applicantUid` | `userId` | ìŠ¹ì¸ ë¬¸ì„œ |
| `time_change_reports` | `employeeUid` | `userId` | ì‹œê°„ ë³€ê²½ ë³´ê³  |

### ë‹¤ì¤‘ í•„ë“œ ì»¬ë ‰ì…˜ (1ê°œ)

| ì»¬ë ‰ì…˜ | ì†ŒìŠ¤ í•„ë“œ | í‘œì¤€ í•„ë“œ | ì„¤ëª… |
|--------|----------|----------|------|
| `shift_requests` | `requesterId` | `requesterUserId` | êµëŒ€ê·¼ë¬´ ì‹ ì²­ì |
| `shift_requests` | `matchedUserId` | `replacementUserId` | êµëŒ€ê·¼ë¬´ ëŒ€íƒ€ì |

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. ì‚¬ì „ ì¤€ë¹„

#### âœ… Firebase Service Account Key í™•ì¸
```bash
# serviceAccountKey.json íŒŒì¼ ì¡´ì¬ í™•ì¸
ls -la /home/user/webapp/serviceAccountKey.json
```

íŒŒì¼ì´ ì—†ë‹¤ë©´:
1. [Firebase Console](https://console.firebase.google.com/) ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì„œë¹„ìŠ¤ ê³„ì •
3. "ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„±" í´ë¦­
4. ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì„ `/home/user/webapp/serviceAccountKey.json`ìœ¼ë¡œ ì €ì¥

#### âœ… Node.js íŒ¨í‚¤ì§€ í™•ì¸
```bash
cd /home/user/webapp
npm install firebase-admin
```

---

### 2. Dry-Run (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)

**âš ï¸ ì¤‘ìš”: ì‹¤ì œ ë³€ê²½í•˜ê¸° ì „ì— ë°˜ë“œì‹œ Dry-Runìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”!**

```bash
cd /home/user/webapp
node scripts/migrate-add-userid.js
```

**Dry-Runì—ì„œ í™•ì¸í•  ì‚¬í•­**:
- âœ… ê° ì»¬ë ‰ì…˜ë³„ ë¬¸ì„œ ìˆ˜
- âœ… ì—…ë°ì´íŠ¸ í•„ìš”í•œ ë¬¸ì„œ ìˆ˜
- âœ… ì´ë¯¸ ìµœì‹  ìƒíƒœì¸ ë¬¸ì„œ ìˆ˜
- âœ… ì†ŒìŠ¤ í•„ë“œê°€ ì—†ëŠ” ë¬¸ì„œ ìˆ˜
- âœ… ì˜ˆìƒ ì†Œìš” ì‹œê°„

**ì¶œë ¥ ì˜ˆì‹œ**:
```
============================================================
ğŸ“Š ì²˜ë¦¬ ê²°ê³¼ í†µê³„
============================================================
ì´ ë¬¸ì„œ ìˆ˜:       1,250ê°œ
ì—…ë°ì´íŠ¸ í•„ìš”:    850ê°œ
ì´ë¯¸ ìµœì‹ :        300ê°œ
ì†ŒìŠ¤ í•„ë“œ ì—†ìŒ:   100ê°œ
ì„±ê³µ:             0ê°œ (DRY-RUN)
ì‹¤íŒ¨:             0ê°œ
============================================================

âš ï¸  DRY-RUN ëª¨ë“œì˜€ìŠµë‹ˆë‹¤. ì‹¤ì œ ë³€ê²½ì€ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
```

---

### 3. í”„ë¡œë•ì…˜ ì‹¤í–‰

#### âš ï¸ ì‹¤í–‰ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Firestore ë°±ì—… ì™„ë£Œ ([ë°±ì—… ë°©ë²•](#firestore-ë°±ì—…-ë°©ë²•))
- [ ] Dry-Run ê²°ê³¼ í™•ì¸ ì™„ë£Œ
- [ ] ì˜ˆìƒ ì†Œìš” ì‹œê°„ í™•ì¸
- [ ] ì‚¬ìš©ìì—ê²Œ ê³µì§€ (ì„œë¹„ìŠ¤ ì¼ì‹œ ì¤‘ë‹¨ í•„ìš” ì‹œ)
- [ ] ì£¼ë§/ì•¼ê°„ ì‹¤í–‰ ê¶Œì¥

#### ğŸ”¥ Production ëª¨ë“œë¡œ ë³€ê²½

`scripts/migrate-add-userid.js` íŒŒì¼ ìˆ˜ì •:

```javascript
// âš ï¸ Dry-run ëª¨ë“œ (true: ì‹¤ì œ ë³€ê²½ ì•ˆ í•¨, false: ì‹¤ì œ ë³€ê²½)
const DRY_RUN = false;  // â† trueë¥¼ falseë¡œ ë³€ê²½
```

#### ì‹¤í–‰

```bash
cd /home/user/webapp
node scripts/migrate-add-userid.js
```

**ì‹¤í–‰ ì¤‘ ë¡œê·¸**:
```
[2025-11-20T10:30:00.000Z] ğŸš€ í•„ë“œëª… í‘œì¤€í™” ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘
[2025-11-20T10:30:00.100Z] â„¹ï¸  ì‹¤í–‰ ëª¨ë“œ: PRODUCTION (ì‹¤ì œ ë³€ê²½)
[2025-11-20T10:30:00.200Z] â„¹ï¸  ë°°ì¹˜ í¬ê¸°: 500ê°œ
[2025-11-20T10:30:00.300Z] â„¹ï¸  ì²˜ë¦¬ ëŒ€ìƒ: 7ê°œ ì»¬ë ‰ì…˜

============================================================
ğŸš€ ì¶œí‡´ê·¼ ê¸°ë¡ (attendance) ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
uid â†’ userId
============================================================
[2025-11-20T10:30:01.000Z] â„¹ï¸  ë¬¸ì„œ ì¡°íšŒ ì¤‘...
[2025-11-20T10:30:02.000Z] â„¹ï¸  ì´ 1,500ê°œ ë¬¸ì„œ ë°œê²¬
[2025-11-20T10:30:03.000Z] ğŸ“ ë¬¸ì„œ abc123: uid="user456" â†’ userId="user456"
...
[2025-11-20T10:30:10.000Z] âœ… ë°°ì¹˜ ì»¤ë°‹ ì™„ë£Œ: 500/1200ê°œ
[2025-11-20T10:30:15.000Z] âœ… ë°°ì¹˜ ì»¤ë°‹ ì™„ë£Œ: 1000/1200ê°œ
[2025-11-20T10:30:20.000Z] âœ… ë°°ì¹˜ ì»¤ë°‹ ì™„ë£Œ: 1200/1200ê°œ
[2025-11-20T10:30:21.000Z] ğŸ‰ ì¶œí‡´ê·¼ ê¸°ë¡ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ

============================================================
ğŸ“Š ì²˜ë¦¬ ê²°ê³¼ í†µê³„
============================================================
ì´ ë¬¸ì„œ ìˆ˜:       1,500ê°œ
ì—…ë°ì´íŠ¸ í•„ìš”:    1,200ê°œ
ì´ë¯¸ ìµœì‹ :        250ê°œ
ì†ŒìŠ¤ í•„ë“œ ì—†ìŒ:   50ê°œ
ì„±ê³µ:             1,200ê°œ
ì‹¤íŒ¨:             0ê°œ
============================================================
```

---

### 4. ê²°ê³¼ í™•ì¸

#### Firebase Consoleì—ì„œ í™•ì¸

1. [Firestore Database](https://console.firebase.google.com/project/abcdc-staff-system/firestore/data) ì ‘ì†
2. ê° ì»¬ë ‰ì…˜ ìƒ˜í”Œ ë¬¸ì„œ í™•ì¸
3. ë‹¤ìŒ í•„ë“œë“¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸:
   - `userId` (í‘œì¤€ í•„ë“œ)
   - `migratedAt` (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œê°)
   - `migrationVersion: 'v1.1-userId'`

#### ì¿¼ë¦¬ë¡œ í™•ì¸

```javascript
// attendance ì˜ˆì‹œ
db.collection('attendance')
  .where('migratedAt', '!=', null)
  .limit(5)
  .get()
  .then(snapshot => {
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      console.log({
        id: doc.id,
        uid: data.uid,
        userId: data.userId,
        migratedAt: data.migratedAt
      });
    });
  });
```

---

## ğŸ›¡ï¸ Firestore ë°±ì—… ë°©ë²•

### ë°©ë²• 1: Firebase Console (ìˆ˜ë™)

1. [Firebase Console](https://console.firebase.google.com/) ì ‘ì†
2. Firestore Database â†’ ë°ì´í„° â†’ ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°
3. "ë‚´ë³´ë‚´ê¸°" í´ë¦­
4. ëª¨ë“  ì»¬ë ‰ì…˜ ì„ íƒ
5. Cloud Storage ë²„í‚· ì„ íƒ
6. "ë‚´ë³´ë‚´ê¸°" ì‹¤í–‰

### ë°©ë²• 2: gcloud CLI (ìë™)

```bash
# gcloud ì„¤ì¹˜ ë° ì¸ì¦
gcloud auth login

# Firestore ë°±ì—…
gcloud firestore export gs://abcdc-staff-system.appspot.com/backups/$(date +%Y%m%d_%H%M%S)
```

---

## ğŸ“Š ì„±ëŠ¥ ì˜ˆìƒ

### ì²˜ë¦¬ ì†ë„

- **Dry-Run**: ~10,000 ë¬¸ì„œ/ë¶„
- **Production**: ~3,000-5,000 ë¬¸ì„œ/ë¶„ (Firestore ì“°ê¸° ì†ë„ ì œí•œ)

### ì˜ˆìƒ ì†Œìš” ì‹œê°„

| ì´ ë¬¸ì„œ ìˆ˜ | Dry-Run | Production |
|-----------|---------|-----------|
| 1,000ê°œ | ~10ì´ˆ | ~20ì´ˆ |
| 10,000ê°œ | ~1ë¶„ | ~3ë¶„ |
| 100,000ê°œ | ~10ë¶„ | ~30ë¶„ |
| 1,000,000ê°œ | ~100ë¶„ | ~5ì‹œê°„ |

**ë°°ì¹˜ í¬ê¸° ì¡°ì •**:
- ê¸°ë³¸ê°’: 500ê°œ (Firestore ì œí•œ)
- ì„±ëŠ¥ ìš°ì„ : ê·¸ëŒ€ë¡œ ìœ ì§€
- ì•ˆì •ì„± ìš°ì„ : 100-200ê°œë¡œ ì¤„ì´ê¸°

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ë°ì´í„° ì •í•©ì„±

**ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì‹ ê·œ ë°ì´í„° ë°œìƒ ì‹œ**:
- ì‹ ê·œ ë°ì´í„°ëŠ” ì´ë¯¸ ë“€ì–¼ í•„ë“œ í¬í•¨ (Phase 1 ì ìš© ì™„ë£Œ)
- ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ë¯¸ ìµœì‹  ìƒíƒœë©´ ìŠ¤í‚µ
- **ì¶©ëŒ ì—†ìŒ**

### 2. Firestore ë¹„ìš©

**ì½ê¸° ë¹„ìš©**:
- ë¬¸ì„œ ìˆ˜ë§Œí¼ ì½ê¸° ì‘ì—… ë°œìƒ
- ì˜ˆ: 100,000ê°œ ë¬¸ì„œ = 100,000 reads

**ì“°ê¸° ë¹„ìš©**:
- ì—…ë°ì´íŠ¸ í•„ìš”í•œ ë¬¸ì„œë§Œ ì“°ê¸° ì‘ì—…
- ì˜ˆ: 80,000ê°œ ì—…ë°ì´íŠ¸ = 80,000 writes

**ì˜ˆìƒ ë¹„ìš© (ë¬´ë£Œ í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ)**:
- ì½ê¸°: $0.036 / 100,000 reads
- ì“°ê¸°: $0.108 / 100,000 writes
- 100,000ê°œ ë¬¸ì„œ: ì•½ $0.15

### 3. ë¡¤ë°± ë°©ë²•

**ë¬¸ì œ ë°œìƒ ì‹œ ë¡¤ë°±**:

1. **ë°±ì—…ì—ì„œ ë³µì›**:
   ```bash
   gcloud firestore import gs://abcdc-staff-system.appspot.com/backups/BACKUP_DATE
   ```

2. **ê°œë³„ í•„ë“œ ì œê±°** (ê¸´ê¸‰):
   ```javascript
   // íŠ¹ì • ì»¬ë ‰ì…˜ì˜ userId í•„ë“œ ì œê±°
   const batch = db.batch();
   const snapshot = await db.collection('attendance').limit(500).get();
   
   snapshot.docs.forEach(doc => {
     batch.update(doc.ref, {
       userId: admin.firestore.FieldValue.delete(),
       migratedAt: admin.firestore.FieldValue.delete(),
       migrationVersion: admin.firestore.FieldValue.delete()
     });
   });
   
   await batch.commit();
   ```

---

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: "serviceAccountKey.json not found"

**ì›ì¸**: Firebase Service Account Key íŒŒì¼ ì—†ìŒ

**í•´ê²°**:
```bash
# 1. Firebase Consoleì—ì„œ ë‹¤ìš´ë¡œë“œ
# 2. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì €ì¥
cp ~/Downloads/abcdc-staff-system-*.json /home/user/webapp/serviceAccountKey.json
```

---

### ë¬¸ì œ 2: "Permission denied"

**ì›ì¸**: Firebase Admin ê¶Œí•œ ë¶€ì¡±

**í•´ê²°**:
1. Firebase Console â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì„œë¹„ìŠ¤ ê³„ì •
2. ê¶Œí•œ í™•ì¸: "Firebase Admin SDK ê´€ë¦¬ì ì„œë¹„ìŠ¤ ì—ì´ì „íŠ¸"
3. ìƒˆ í‚¤ ìƒì„± í›„ ì¬ì‹œë„

---

### ë¬¸ì œ 3: íƒ€ì„ì•„ì›ƒ ë°œìƒ

**ì›ì¸**: ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì‹œê°„ ì´ˆê³¼

**í•´ê²°**:
```javascript
// ë°°ì¹˜ í¬ê¸° ì¤„ì´ê¸°
const BATCH_SIZE = 200;  // 500 â†’ 200

// ë˜ëŠ” ì»¬ë ‰ì…˜ ë³„ë„ ì‹¤í–‰
const COLLECTIONS = [
  { name: 'attendance', sourceField: 'uid', targetField: 'userId' }
  // ë‚˜ë¨¸ì§€ ì£¼ì„ ì²˜ë¦¬
];
```

---

### ë¬¸ì œ 4: "already exists" ì˜¤ë¥˜

**ì›ì¸**: ë™ì‹œ ì‹¤í–‰ ë˜ëŠ” ì¤‘ë³µ ì‹¤í–‰

**í•´ê²°**:
- ìŠ¤í¬ë¦½íŠ¸ë¥¼ í•œ ë²ˆë§Œ ì‹¤í–‰
- ì´ë¯¸ ìµœì‹  ìƒíƒœë©´ ìŠ¤í‚µë¨ (ë¬¸ì œ ì—†ìŒ)
- Dry-Runìœ¼ë¡œ ì¬í™•ì¸

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [FIELD_NAMING_STANDARD.md](../FIELD_NAMING_STANDARD.md) - í•„ë“œëª… í‘œì¤€í™” ê°€ì´ë“œ
- [Firestore ë°°ì¹˜ ì‘ì—…](https://firebase.google.com/docs/firestore/manage-data/transactions)
- [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup)

---

## ğŸ“ ë¬¸ì˜

ë¬¸ì œ ë°œìƒ ì‹œ:
1. Dry-Run ê²°ê³¼ í™•ì¸
2. ë¡œê·¸ ì „ì²´ ì €ì¥
3. GitHub Issuesì— ë“±ë¡

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-20
**ë²„ì „**: v1.0
