<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§›ë‚¨ì‚´ë¡± ì§ì› ê°€ì…</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #2563EB; 
      --primary-dark: #1E40AF;
      --primary-light: #3B82F6;
      --bg-light: #F5F7FB; 
      --bg-white: #FFFFFF;
      --text-primary: #0F172A; 
      --text-secondary: #64748B; 
      --border-color: #E2E8F0; 
      --border-radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px 0 rgba(15, 23, 42, 0.08);
      --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.1);
      --spacing-xs: 6px; 
      --spacing-sm: 12px; 
      --spacing-md: 16px; 
      --spacing-lg: 24px; 
      --spacing-xl: 32px;
      --success-color: #10B981; 
      --warning-color: #F59E0B; 
      --danger-color: #EF4444;
      --font-sans: 'Noto Sans KR', Inter, system-ui, -apple-system, sans-serif;
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-light);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-primary);
    }

    .register-box {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      padding: 48px 40px;
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    @media (max-width: 640px) {
      .register-box {
        padding: 32px 24px;
      }
    }

    .logo {
      text-align: center;
      font-size: 64px;
      margin-bottom: 16px;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    label .required {
      color: var(--danger-color);
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 15px;
      transition: all 0.2s;
      background: var(--bg-white);
      color: var(--text-primary);
    }

    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    input:disabled, select:disabled {
      background: #F1F5F9;
      cursor: not-allowed;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: var(--primary-color);
      color: var(--bg-white);
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }

    .btn:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-sm);
    }

    .btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-secondary {
      background: var(--text-secondary);
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .error {
      background: #FEE2E2;
      color: #991B1B;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #FECACA;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success {
      background: #D1FAE5;
      color: #065F46;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #A7F3D0;
      display: none;
    }

    .success.show {
      display: block;
    }

    .info {
      background: #DBEAFE;
      color: #1E40AF;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #BFDBFE;
      display: none;
    }

    .info.show {
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      color: var(--primary-color);
      font-weight: 600;
      margin-top: 10px;
    }

    .loading.show {
      display: block;
    }

    .help-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .login-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .login-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }

    .login-link a:hover {
      text-decoration: underline;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary-color);
      margin: var(--spacing-lg) 0 var(--spacing-md) 0;
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--border-color);
    }

    .invite-section {
      background: #F8FAFC;
      padding: 20px;
      border-radius: var(--border-radius);
      border: 2px dashed var(--border-color);
      margin-bottom: 24px;
    }

    .invite-section.verified {
      border-color: var(--success-color);
      background: #F0FDF4;
    }

    .input-with-button {
      display: flex;
      gap: 10px;
    }

    .input-with-button input {
      flex: 1;
    }

    .input-with-button .btn {
      width: auto;
      padding: 14px 24px;
      margin-top: 0;
      white-space: nowrap;
    }

    .company-info {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-white);
      border-radius: 8px;
      border: 1px solid #A7F3D0;
    }

    .company-info.show {
      display: block;
    }

    .company-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .company-info-row:last-child {
      margin-bottom: 0;
    }

    .company-info-label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .company-info-value {
      color: var(--text-primary);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="register-box">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
        <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
        <line x1="6" y1="1" x2="6" y2="4"/>
        <line x1="10" y1="1" x2="10" y2="4"/>
        <line x1="14" y1="1" x2="14" y2="4"/>
      </svg>
    </div>
    <h1>ë§›ë‚¨ì‚´ë¡±</h1>
    <p class="subtitle">ì§ì› ê°€ì… (v3.1 Multi-tenant)</p>

    <div id="error" class="error"></div>
    <div id="success" class="success"></div>
    <div id="info" class="info"></div>

    <!-- v3.1: ì´ˆëŒ€ ì½”ë“œ ì…ë ¥ ì„¹ì…˜ (ìµœìƒë‹¨) -->
    <div class="invite-section" id="inviteSection">
      <label for="inviteCode">ì´ˆëŒ€ ì½”ë“œ <span class="required">*</span></label>
      <div class="help-text" style="margin-bottom: 12px;">íšŒì‚¬ì—ì„œ ë°œê¸‰ë°›ì€ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
      
      <div class="input-with-button">
        <input type="text" id="inviteCode" placeholder="ABC2025-STAFF-XXX" required>
        <button type="button" id="verifyCodeBtn" class="btn">ì½”ë“œ í™•ì¸</button>
      </div>

      <!-- ì½”ë“œ í™•ì¸ í›„ íšŒì‚¬/ë§¤ì¥ ì •ë³´ í‘œì‹œ -->
      <div class="company-info" id="companyInfo">
        <div class="company-info-row">
          <span class="company-info-label">íšŒì‚¬:</span>
          <span class="company-info-value" id="companyName">-</span>
        </div>
        <div class="company-info-row">
          <span class="company-info-label">ë°°ì • ë§¤ì¥:</span>
          <span class="company-info-value" id="storeName">-</span>
        </div>
        <div class="company-info-row">
          <span class="company-info-label">ì§ì±…:</span>
          <span class="company-info-value" id="roleDisplay">-</span>
        </div>
      </div>
    </div>

    <form id="registerForm" autocomplete="off" style="display:none;">
      <input type="text" style="display:none" aria-hidden="true">
      <input type="password" style="display:none" aria-hidden="true">
      
      <!-- ê¸°ë³¸ ì •ë³´ -->
      <div class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        ê¸°ë³¸ ì •ë³´
      </div>
      
      <div class="form-group">
        <label for="name">ì´ë¦„ <span class="required">*</span></label>
        <input type="text" id="name" placeholder="ê¹€ë¯¼ìˆ˜" required>
      </div>

      <div class="form-group">
        <label for="birth">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="text" id="birth" placeholder="000000-0000000" maxlength="14" required>
        <div class="help-text">- í¬í•¨í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš” (ì¸ê±´ë¹„ ì‹ ê³ ìš©)</div>
      </div>

      <div class="form-group">
        <label for="phone">ì—°ë½ì²˜ <span class="required">*</span></label>
        <input type="tel" id="phone" placeholder="010-1234-5678" required>
        <div class="help-text">- í¬í•¨í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
      </div>

      <div class="form-group">
        <label for="address">ì£¼ì†Œ <span class="required">*</span></label>
        <input type="text" id="address" placeholder="ê²½ê¸°ë„ ë¶€ì²œì‹œ ì›ë¯¸êµ¬" required>
      </div>

      <!-- ê·¼ë¬´ ì •ë³´ (v3.1: ì´ˆëŒ€ ì½”ë“œì—ì„œ ìë™ í• ë‹¹ë¨) -->
      <div class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </svg>
        ê·¼ë¬´ ì •ë³´
      </div>
      
      <!-- v3.1: ë§¤ì¥ ì •ë³´ ì½ê¸° ì „ìš© í‘œì‹œ -->
      <div class="form-group">
        <label for="storeDisplay">ê·¼ë¬´ ë§¤ì¥</label>
        <input type="text" id="storeDisplay" disabled>
        <div class="help-text">ì´ˆëŒ€ ì½”ë“œë¡œ ìë™ ë°°ì •ëœ ë§¤ì¥ì…ë‹ˆë‹¤</div>
      </div>

      <div class="form-group">
        <label for="position">ì§ì±…/ì§ë¬´ <span class="required">*</span></label>
        <select id="position" required>
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ë°”ë¦¬ìŠ¤íƒ€">ë°”ë¦¬ìŠ¤íƒ€</option>
          <option value="ë² ì´ì»¤">ë² ì´ì»¤</option>
        </select>
      </div>

      <!-- ê³„ì • ì •ë³´ -->
      <div class="section-title">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        ê³„ì • ì •ë³´
      </div>
      
      <div class="form-group">
        <label for="email">ì´ë©”ì¼ (ë¡œê·¸ì¸ ID) <span class="required">*</span></label>
        <input type="text" id="email" name="reg_email" placeholder="example@email.com" autocomplete="new-password" required>
        <div class="help-text">ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  ì´ë©”ì¼ ì£¼ì†Œ</div>
      </div>

      <div class="form-group">
        <label for="password">ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
        <input type="password" id="password" name="reg_password" placeholder="6ì ì´ìƒ" autocomplete="new-password" required minlength="6">
      </div>

      <div class="form-group">
        <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
        <input type="password" id="passwordConfirm" name="reg_password_confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" autocomplete="new-password" required minlength="6">
      </div>

      <button type="submit" id="registerBtn" class="btn">ê°€ì…í•˜ê¸°</button>
    </form>

    <div class="loading" id="loading">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 6px; animation: spin 1s linear infinite;">
        <line x1="12" y1="2" x2="12" y2="6"/>
        <line x1="12" y1="18" x2="12" y2="22"/>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
        <line x1="2" y1="12" x2="6" y2="12"/>
        <line x1="18" y1="12" x2="22" y2="12"/>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
      </svg>
      ì²˜ë¦¬ ì¤‘...
    </div>
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>

    <div class="login-link">
      ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="employee-login.html">ë¡œê·¸ì¸</a> | <a href="index.html">ë©”ì¸ìœ¼ë¡œ</a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCr3Tq2T7oy5rVlK1c33m_G0TlUWv0-g3k",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "442207878284",
      appId: "1:442207878284:web:49b157573851b124d28fa9",
      measurementId: "G-WYPQ3YEJRT"
    };

    // Firebase ì´ˆê¸°í™”
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');

    // v3.1: ì „ì—­ ë³€ìˆ˜ (ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ ê²°ê³¼ ì €ì¥)
    let verifiedInviteData = null;

    // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const inviteSection = document.getElementById('inviteSection');
    const inviteCodeInput = document.getElementById('inviteCode');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const companyInfo = document.getElementById('companyInfo');
    const companyNameEl = document.getElementById('companyName');
    const storeNameEl = document.getElementById('storeName');
    const roleDisplayEl = document.getElementById('roleDisplay');
    
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const successDiv = document.getElementById('success');
    const infoDiv = document.getElementById('info');

    const storeDisplay = document.getElementById('storeDisplay');

    // v3.1: URL íŒŒë¼ë¯¸í„°ì—ì„œ ì´ˆëŒ€ ì½”ë“œ ìë™ ì±„ìš°ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const codeFromUrl = urlParams.get('code');
    if (codeFromUrl) {
      inviteCodeInput.value = codeFromUrl.trim();
      showInfo('URLì—ì„œ ì´ˆëŒ€ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ì…ë ¥í–ˆìŠµë‹ˆë‹¤. "ì½”ë“œ í™•ì¸" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      console.log('âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ì´ˆëŒ€ ì½”ë“œ ìë™ ì…ë ¥:', codeFromUrl);
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.add('show');
      successDiv.classList.remove('show');
      infoDiv.classList.remove('show');
    }

    // ì„±ê³µ í‘œì‹œ
    function showSuccess(msg) {
      successDiv.textContent = msg;
      successDiv.classList.add('show');
      errorDiv.classList.remove('show');
      infoDiv.classList.remove('show');
    }

    // ì •ë³´ í‘œì‹œ
    function showInfo(msg) {
      infoDiv.textContent = msg;
      infoDiv.classList.add('show');
      errorDiv.classList.remove('show');
      successDiv.classList.remove('show');
    }

    // ë©”ì‹œì§€ ìˆ¨ê¹€
    function hideMessages() {
      errorDiv.classList.remove('show');
      successDiv.classList.remove('show');
      infoDiv.classList.remove('show');
    }

    // v3.1: ì—­í•  í•œê¸€ ë³€í™˜
    function getRoleDisplayName(role) {
      const roleMap = {
        'staff': 'ì¼ë°˜ ì§ì›',
        'step': 'ìŠ¤íƒ­',
        'store_manager': 'ë§¤ì¥ ë§¤ë‹ˆì €',
        'manager': 'ê´€ë¦¬ì',
        'admin': 'ìµœê³  ê´€ë¦¬ì'
      };
      return roleMap[role] || role;
    }

    // v3.1: ì´ˆëŒ€ ì½”ë“œ í™•ì¸ (Cloud Functions í˜¸ì¶œ)
    verifyCodeBtn.addEventListener('click', async () => {
      const code = inviteCodeInput.value.trim();
      
      if (!code) {
        showError('âš ï¸ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      hideMessages();
      verifyCodeBtn.disabled = true;
      loading.classList.add('show');

      try {
        console.log('ğŸ“ Cloud Functions í˜¸ì¶œ: verifyInviteCode');
        
        const verifyInviteCode = functions.httpsCallable('verifyInviteCode');
        const result = await verifyInviteCode({ inviteCode: code });

        console.log('âœ… ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ ì„±ê³µ:', result.data);

        if (result.data.ok) {
          verifiedInviteData = result.data;
          
          // UI ì—…ë°ì´íŠ¸
          inviteSection.classList.add('verified');
          companyInfo.classList.add('show');
          companyNameEl.textContent = result.data.companyName;
          storeNameEl.textContent = result.data.storeName;
          roleDisplayEl.textContent = getRoleDisplayName(result.data.role);
          
          // íšŒì›ê°€ì… í¼ í‘œì‹œ
          registerForm.style.display = 'block';
          storeDisplay.value = result.data.storeName;
          
          // ì´ˆëŒ€ ì½”ë“œ ì…ë ¥ ë¹„í™œì„±í™”
          inviteCodeInput.disabled = true;
          verifyCodeBtn.disabled = true;
          
          showSuccess('âœ… ì´ˆëŒ€ ì½”ë“œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        } else {
          showError('âŒ ' + (result.data.error || 'ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ ì‹¤íŒ¨'));
          verifyCodeBtn.disabled = false;
        }
        
      } catch (error) {
        console.error('âŒ ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ ì˜¤ë¥˜:', error);
        
        let errorMsg = 'ì´ˆëŒ€ ì½”ë“œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        
        // âœ… v3.2: ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
        if (error.code === 'functions/not-found') {
          errorMsg = 'âš ï¸ Cloud Functionsê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. functions/index.jsë¥¼ ë°°í¬í•´ì£¼ì„¸ìš”.';
        } else if (error.code === 'functions/unauthenticated') {
          errorMsg = 'âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
        } else if (error.code === 'functions/invalid-argument') {
          errorMsg = 'âš ï¸ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        } else if (error.code === 'not-found') {
          errorMsg = 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤.';
        } else if (error.code === 'failed-precondition') {
          errorMsg = 'âŒ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ìš”ì²­í•˜ì„¸ìš”.';
        } else if (error.code === 'resource-exhausted') {
          errorMsg = 'âŒ ì´ˆëŒ€ ì½”ë“œ ì‚¬ìš© íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ìš”ì²­í•˜ì„¸ìš”.';
        } else if (error.code === 'deadline-exceeded') {
          errorMsg = 'âŒ ë§Œë£Œëœ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ìƒˆë¡œìš´ ì½”ë“œë¥¼ ìš”ì²­í•˜ì„¸ìš”.';
        } else if (error.message) {
          errorMsg = 'âŒ ' + error.message;
        }
        
        showError(errorMsg);
        verifyCodeBtn.disabled = false;
      } finally {
        loading.classList.remove('show');
      }
    });

    // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
    document.getElementById('birth').addEventListener('input', function(e) {
      let value = e.target.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ
      
      if (value.length > 6) {
        value = value.substring(0, 6) + '-' + value.substring(6, 13);
      }
      
      e.target.value = value;
    });

    // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
    function validateSSN(ssn) {
      const cleaned = ssn.replace(/-/g, '');
      if (cleaned.length !== 13) {
        return false;
      }
      
      // ìˆ«ìë§Œ ìˆëŠ”ì§€ í™•ì¸
      if (!/^\d+$/.test(cleaned)) {
        return false;
      }
      
      return true;
    }

    // v3.1: ê°€ì… í¼ ì œì¶œ
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // v3.1: ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ í™•ì¸
      if (!verifiedInviteData) {
        showError('âš ï¸ ì´ˆëŒ€ ì½”ë“œë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const birth = document.getElementById('birth').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const position = document.getElementById('position').value;
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('passwordConfirm').value;
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!name || !birth || !phone || !address || !position || !email || !password) {
        showError('âš ï¸ ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!validateSSN(birth)) {
        showError('âš ï¸ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (13ìë¦¬)');
        return;
      }

      if (password !== passwordConfirm) {
        showError('âš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      if (password.length < 6) {
        showError('âš ï¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      hideMessages();
      registerBtn.disabled = true;
      loading.classList.add('show');
      
      try {
        console.log('ğŸ“ ì§ì› ê°€ì… ì‹œì‘ (v3.1 Multi-tenant):', email);
        
        // 1. Firebase Authenticationì— ì‚¬ìš©ì ìƒì„±
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log('âœ… Auth ì‚¬ìš©ì ìƒì„± ì™„ë£Œ:', user.uid);
        
        // 2. v3.1: Firestoreì— ì§ì› ì •ë³´ ì €ì¥ (companyId, storeId í¬í•¨)
        const employeeData = {
          uid: user.uid,
          email: email,
          name: name,
          birth: birth,
          phone: phone,
          address: address,
          
          // v3.1: Multi-tenant í•„ë“œ
          companyId: verifiedInviteData.companyId,
          storeId: verifiedInviteData.storeId,
          store: verifiedInviteData.storeName,  // í•˜ìœ„í˜¸í™˜ì„± ìœ ì§€
          
          position: position,
          role: verifiedInviteData.role,  // ì´ˆëŒ€ ì½”ë“œì—ì„œ ê°€ì ¸ì˜¨ ì—­í• 
          inviteCode: inviteCodeInput.value.trim(),  // ì‚¬ìš©í•œ ì´ˆëŒ€ ì½”ë“œ ì €ì¥
          
          status: 'pending',  // ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // users ì»¬ë ‰ì…˜ì— ì €ì¥
        await db.collection('users').doc(user.uid).set(employeeData);
        
        // employees ì»¬ë ‰ì…˜ì—ë„ ì €ì¥ (ê´€ë¦¬ìê°€ ì‰½ê²Œ ì¡°íšŒí•˜ê¸° ìœ„í•´)
        await db.collection('employees').doc(user.uid).set(employeeData);
        
        console.log('âœ… Firestoreì— ì§ì› ì •ë³´ ì €ì¥ ì™„ë£Œ (ìŠ¹ì¸ ëŒ€ê¸°)');
        
        // 3. v3.1: ì´ˆëŒ€ ì½”ë“œ ì‚¬ìš© ê¸°ë¡ (recordInviteUse Cloud Function í˜¸ì¶œ)
        try {
          const recordInviteUse = functions.httpsCallable('recordInviteUse');
          await recordInviteUse({
            inviteCode: inviteCodeInput.value.trim(),
            userId: user.uid
          });
          console.log('âœ… ì´ˆëŒ€ ì½”ë“œ ì‚¬ìš© ê¸°ë¡ ì™„ë£Œ');
        } catch (recordError) {
          console.warn('âš ï¸ ì´ˆëŒ€ ì½”ë“œ ì‚¬ìš© ê¸°ë¡ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰):', recordError);
        }
        
        showSuccess('âœ… ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nì ì‹œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        
        // 3ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.location.href = 'employee-login.html';
        }, 3000);
        
      } catch (error) {
        console.error('âŒ ê°€ì… ì‹¤íŒ¨:', error);
        
        let errorMsg = 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = 'âš ï¸ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
          // íŒì—… ì•Œë¦¼ ì¶”ê°€
          alert('âš ï¸ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.\n\në‹¤ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = 'âš ï¸ ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
        } else if (error.code === 'auth/weak-password') {
          errorMsg = 'âš ï¸ ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.';
        } else {
          errorMsg = 'âŒ ' + (error.message || 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        showError(errorMsg);
        registerBtn.disabled = false;
        loading.classList.remove('show');
      }
    });
  </script>
</body>
</html>
