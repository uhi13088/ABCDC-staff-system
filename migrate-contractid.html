<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ì¼€ì¤„ ContractId ë§ˆì´ê·¸ë ˆì´ì…˜</title>
  <style>
    body {
      font-family: 'Malgun Gothic', sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      border-left: 4px solid #2196F3;
    }
    .warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      border-left: 4px solid #ffc107;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    #log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
    }
    .progress {
      background: #e0e0e0;
      border-radius: 10px;
      height: 30px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress-bar {
      background: #4CAF50;
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“‹ ìŠ¤ì¼€ì¤„ ContractId ë§ˆì´ê·¸ë ˆì´ì…˜</h1>

    <div class="info">
      <strong>â„¹ï¸ ì‚¬ìš© ì „ í™•ì¸:</strong> ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!
    </div>
    
    <div class="warning">
      <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
      <ul>
        <li>í˜„ì¬ contracts ì»¬ë ‰ì…˜ì— ìˆëŠ” ê³„ì•½ì„œ ê¸°ë°˜ìœ¼ë¡œë§Œ ë³µêµ¬í•©ë‹ˆë‹¤</li>
        <li>ê° ê³„ì•½ì„œì˜ ê¸°ê°„ ë‚´ ìŠ¤ì¼€ì¤„ë§Œ ë³µêµ¬ë©ë‹ˆë‹¤</li>
        <li>schedules_backupì—ì„œ schedulesë¡œ ë³µì‚¬í•˜ë©´ì„œ contractIdë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤</li>
        <li>ê¸°ì¡´ schedulesì˜ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì¶”ê°€ë§Œ ë©ë‹ˆë‹¤)</li>
      </ul>
    </div>

    <div class="info" id="stats">
      <strong>ğŸ“Š í†µê³„:</strong><br>
      - í˜„ì¬ ê³„ì•½ì„œ ìˆ˜: <span id="contractCount">-</span>ê°œ<br>
      - ë°±ì—… ìŠ¤ì¼€ì¤„ ìˆ˜: <span id="backupCount">-</span>ê°œ<br>
      - ë³µêµ¬ ëŒ€ìƒ ìŠ¤ì¼€ì¤„: <span id="targetCount">-</span>ê°œ<br>
      - ë³µêµ¬ ì™„ë£Œ: <span id="restoredCount">0</span>ê°œ
    </div>

    <div class="progress" id="progressContainer" style="display: none;">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div>
      <button onclick="analyzeData()">1ï¸âƒ£ ë°ì´í„° ë¶„ì„</button>
      <button onclick="startMigration()" id="migrateBtn" disabled>2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
      <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyD_t4MI33hyat9cqLAYR1bp3WJiSOE3pWg",
      authDomain: "abcdc-4b6c3.firebaseapp.com",
      projectId: "abcdc-4b6c3",
      storageBucket: "abcdc-4b6c3.firebasestorage.app",
      messagingSenderId: "980986007933",
      appId: "1:980986007933:web:67b8b41cf4f98b1d4f36af"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    let contractsData = [];
    let backupSchedules = [];
    let targetSchedules = [];



    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
      logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressBar').textContent = percent + '%';
    }

    async function analyzeData() {
      try {
        log('ğŸ“Š ë°ì´í„° ë¶„ì„ ì‹œì‘...');
        
        // 1. í˜„ì¬ ê·¼ë¬´ ì¤‘ì¸ ì§ì› ì¡°íšŒ
        log('1ï¸âƒ£ ê·¼ë¬´ ì¤‘ì¸ ì§ì› ì¡°íšŒ ì¤‘...');
        const usersSnapshot = await db.collection('users')
          .where('role', '==', 'employee')
          .get();
        
        const activeEmployees = usersSnapshot.docs
          .map(doc => ({ uid: doc.id, ...doc.data() }))
          .filter(user => user.status !== 'resigned');
        
        log(`   âœ… ê·¼ë¬´ ì¤‘ì¸ ì§ì› ${activeEmployees.length}ëª… ë°œê²¬`);
        activeEmployees.forEach(emp => {
          log(`   - ${emp.name} (UID: ${emp.uid})`);
        });

        // 2. ê° ì§ì›ì˜ ê°€ì¥ ìµœê·¼ ê³„ì•½ì„œë§Œ ì¡°íšŒ
        log('2ï¸âƒ£ ê° ì§ì›ì˜ ìµœì‹  ê³„ì•½ì„œ ì¡°íšŒ ì¤‘...');
        contractsData = [];
        
        for (const employee of activeEmployees) {
          const empContracts = await db.collection('contracts')
            .where('employeeId', '==', employee.uid)
            .get();
          
          if (empContracts.empty) {
            log(`   âš ï¸ ${employee.name}: ê³„ì•½ì„œ ì—†ìŒ`, 'warning');
            continue;
          }

          // createdAt ê¸°ì¤€ìœ¼ë¡œ ìµœì‹  ê³„ì•½ì„œ ì„ íƒ
          const contracts = empContracts.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          })).sort((a, b) => {
            const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
            const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
            return dateB - dateA;
          });

          const latestContract = contracts[0];
          contractsData.push(latestContract);
          
          log(`   - ${employee.name}: ìµœì‹  ê³„ì•½ì„œ ${latestContract.id} (${latestContract.contractStartDate || latestContract.startDate} ~ ${latestContract.contractEndDate || latestContract.endDate || 'ë¬´ê¸°í•œ'})`);
        }
        
        log(`   âœ… ìµœì‹  ê³„ì•½ì„œ ${contractsData.length}ê°œ ì„ íƒë¨`);
        document.getElementById('contractCount').textContent = contractsData.length;

        // 2. ë°±ì—… ìŠ¤ì¼€ì¤„ ì¡°íšŒ
        log('2ï¸âƒ£ ë°±ì—… ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì¤‘...');
        const backupSnapshot = await db.collection('schedules_backup').get();
        backupSchedules = backupSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        log(`   âœ… ë°±ì—… ìŠ¤ì¼€ì¤„ ${backupSchedules.length}ê°œ ë°œê²¬`);
        document.getElementById('backupCount').textContent = backupSchedules.length;

        // 3. ë³µêµ¬ ëŒ€ìƒ ìŠ¤ì¼€ì¤„ í•„í„°ë§
        log('3ï¸âƒ£ ë³µêµ¬ ëŒ€ìƒ í•„í„°ë§ ì¤‘...');
        targetSchedules = [];
        
        for (const contract of contractsData) {
          const employeeId = contract.employeeId;
          const contractId = contract.id;
          const startDate = contract.contractStartDate || contract.startDate;
          const endDate = contract.contractEndDate || contract.endDate;
          
          if (!employeeId || !startDate) {
            log(`   âš ï¸ ê³„ì•½ì„œ ${contractId}: employeeId ë˜ëŠ” startDate ì—†ìŒ, ê±´ë„ˆëœ€`, 'warning');
            continue;
          }

          // í•´ë‹¹ ì§ì›ì˜ ê³„ì•½ ê¸°ê°„ ë‚´ ìŠ¤ì¼€ì¤„ ì°¾ê¸°
          const employeeSchedules = backupSchedules.filter(schedule => {
            if (schedule.userId !== employeeId) return false;
            if (schedule.date < startDate) return false;
            if (endDate && schedule.date > endDate) return false;
            return true;
          });

          targetSchedules.push(...employeeSchedules.map(s => ({
            ...s,
            contractId: contractId,
            contractInfo: `${contract.employeeName} (${startDate}~${endDate || 'ë¬´ê¸°í•œ'})`
          })));

          log(`   - ${contract.employeeName}: ${employeeSchedules.length}ê°œ ìŠ¤ì¼€ì¤„ ë°œê²¬`);
        }

        log(`âœ… ë³µêµ¬ ëŒ€ìƒ ìŠ¤ì¼€ì¤„ ì´ ${targetSchedules.length}ê°œ`, 'success');
        document.getElementById('targetCount').textContent = targetSchedules.length;

        if (targetSchedules.length > 0) {
          document.getElementById('migrateBtn').disabled = false;
          log('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„ ì™„ë£Œ! "2ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'success');
        } else {
          log('âš ï¸ ë³µêµ¬í•  ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        }

      } catch (error) {
        log(`âŒ ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function startMigration() {
      if (!confirm(`ì •ë§ë¡œ ${targetSchedules.length}ê°œì˜ ìŠ¤ì¼€ì¤„ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        log('ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('migrateBtn').disabled = true;

        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < targetSchedules.length; i++) {
          const schedule = targetSchedules[i];
          
          try {
            // contractId ì¶”ê°€í•˜ì—¬ schedulesì— ì €ì¥
            const newSchedule = {
              ...schedule,
              contractId: schedule.contractId
            };
            delete newSchedule.id; // ê¸°ì¡´ ID ì œê±°
            delete newSchedule.contractInfo; // ì¶”ê°€ ì •ë³´ ì œê±°

            await db.collection('schedules').add(newSchedule);
            
            successCount++;
            document.getElementById('restoredCount').textContent = successCount;
            updateProgress(i + 1, targetSchedules.length);

            if (i % 10 === 0) {
              log(`   ì§„í–‰ ì¤‘: ${i + 1}/${targetSchedules.length} (${schedule.contractInfo})`);
            }

          } catch (error) {
            log(`   âŒ ìŠ¤ì¼€ì¤„ ë³µêµ¬ ì‹¤íŒ¨ (${schedule.date}): ${error.message}`, 'error');
            errorCount++;
          }
        }

        log(`âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!`, 'success');
        log(`   - ì„±ê³µ: ${successCount}ê°œ`, 'success');
        if (errorCount > 0) {
          log(`   - ì‹¤íŒ¨: ${errorCount}ê°œ`, 'error');
        }

        alert(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!\nì„±ê³µ: ${successCount}ê°œ\nì‹¤íŒ¨: ${errorCount}ê°œ`);

      } catch (error) {
        log(`âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
        alert('ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
      } finally {
        document.getElementById('migrateBtn').disabled = false;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
    window.addEventListener('load', () => {
      log('ğŸ“‹ ìŠ¤ì¼€ì¤„ ContractId ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬');
      log('â„¹ï¸ "1ï¸âƒ£ ë°ì´í„° ë¶„ì„" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.');
    });
  </script>
</body>
</html>
