name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ [ìˆ˜ì •] ì´ ë¶€ë¶„ì´ í•µì‹¬ì…ë‹ˆë‹¤! ì‹¤í—˜ ê¸°ëŠ¥ì„ ì¼œì£¼ëŠ” í™˜ê²½ë³€ìˆ˜ ì¶”ê°€
    env:
      FIREBASE_CLI_EXPERIMENTS: webframeworks

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ”§ Create .env.local
        run: |
          cat << EOF > .env.local
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_HOLIDAY_API_KEY=${{ secrets.NEXT_PUBLIC_HOLIDAY_API_KEY }}
          FIREBASE_ADMIN_PROJECT_ID=${{ secrets.FIREBASE_ADMIN_PROJECT_ID }}
          FIREBASE_ADMIN_CLIENT_EMAIL=${{ secrets.FIREBASE_ADMIN_CLIENT_EMAIL }}
          FIREBASE_ADMIN_PRIVATE_KEY=${{ secrets.FIREBASE_ADMIN_PRIVATE_KEY }}
          EOF
      
      # Next.js ë¹Œë“œ (ì´ì œ ì •ì  íŒŒì¼ ìƒì„±ì´ ì•„ë‹Œ, ì„œë²„ìš© ë¹Œë“œê°€ ë¨)
      - name: ğŸ”‘ Setup Firebase Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > $HOME/gcloud-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-key.json" >> $GITHUB_ENV
      
      - name: ğŸš€ Deploy to Firebase Hosting & Functions
        run: |
          npx firebase-tools deploy --only hosting,functions --force --project abcdc-staff-system --non-interactive

