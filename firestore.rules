rules_version = '2';

/**
 * Firestore Security Rules
 * 표준 필드명 기반 (FIELD_NAMING_STANDARD.md 준수)
 * 
 * 핵심 원칙:
 * 1. 모든 데이터는 companyId로 격리
 * 2. 표준 필드명 (userId, storeId, clockIn 등) 검증
 * 3. 역할 기반 권한 (admin, manager, store_manager, employee)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // 헬퍼 함수
    // ====================================
    
    /**
     * 인증된 사용자인지 확인
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * 사용자의 역할 가져오기
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    /**
     * 사용자의 회사 ID 가져오기
     */
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    /**
     * Admin 권한 확인
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    /**
     * Manager 이상 권한 확인
     */
    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager'];
    }
    
    /**
     * Store Manager 이상 권한 확인
     */
    function isStoreManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'store_manager'];
    }
    
    /**
     * 같은 회사 소속 확인
     */
    function isSameCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }
    
    /**
     * 본인 데이터 확인
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ====================================
    // 1. Companies (회사)
    // ====================================
    match /companies/{companyId} {
      // 읽기: 본인 회사만
      allow read: if isSameCompany(companyId);
      
      // 생성: 회원가입 시
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['companyId', 'companyName', 'email'])
        && request.resource.data.companyId is string
        && request.resource.data.companyName is string
        && request.resource.data.email is string;
      
      // 수정: Admin만
      allow update: if isAdmin() && isSameCompany(companyId);
      
      // 삭제: 금지
      allow delete: if false;
    }
    
    // ====================================
    // 2. Users (사용자/직원)
    // ====================================
    match /users/{userId} {
      // 읽기: 같은 회사 + Manager 이상
      allow read: if isAuthenticated() 
        && (isOwner(userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // 생성: 회원가입 또는 Manager가 직원 추가
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userId', 'companyId', 'name', 'role'])
        && request.resource.data.userId is string
        && request.resource.data.companyId is string
        && request.resource.data.name is string
        && request.resource.data.role in ['admin', 'manager', 'store_manager', 'employee', 'staff']
        && (
          // 본인 가입
          request.auth.uid == request.resource.data.userId
          // 또는 Manager가 추가
          || (isManager() && isSameCompany(request.resource.data.companyId))
        );
      
      // 수정: 본인 또는 Manager 이상
      allow update: if isAuthenticated()
        && (isOwner(userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // 삭제: Manager 이상만
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 3. Contracts (계약서)
    // ====================================
    match /contracts/{contractId} {
      // 읽기: 같은 회사 + Store Manager 이상
      allow read: if isStoreManager() && isSameCompany(resource.data.companyId);
      
      // 생성: Store Manager 이상
      allow create: if isStoreManager()
        && request.resource.data.keys().hasAll(['userId', 'companyId', 'storeId', 'employeeName'])
        && request.resource.data.userId is string
        && request.resource.data.companyId is string
        && request.resource.data.storeId is string
        && request.resource.data.employeeName is string
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Store Manager 이상
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Manager 이상
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 4. Attendance (출퇴근)
    // ====================================
    match /attendance/{attendanceId} {
      // 읽기: 본인 또는 Store Manager 이상
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isStoreManager() && isSameCompany(resource.data.companyId)));
      
      // 생성: 본인 또는 Store Manager 이상
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userId', 'companyId', 'storeId', 'date'])
        && request.resource.data.userId is string
        && request.resource.data.companyId is string
        && request.resource.data.storeId is string
        && request.resource.data.date is string
        // clockIn/clockOut 표준 필드 (옵션)
        && (!request.resource.data.keys().hasAny(['clockIn']) || request.resource.data.clockIn is string)
        && (!request.resource.data.keys().hasAny(['clockOut']) || request.resource.data.clockOut is string)
        && (
          isOwner(request.resource.data.userId)
          || (isStoreManager() && isSameCompany(request.resource.data.companyId))
        );
      
      // 수정: Store Manager 이상
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Manager 이상
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 5. Schedules (근무스케줄)
    // ====================================
    match /schedules/{scheduleId} {
      // 읽기: 본인 또는 Store Manager 이상
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isStoreManager() && isSameCompany(resource.data.companyId)));
      
      // 생성: Store Manager 이상
      allow create: if isStoreManager()
        && request.resource.data.keys().hasAll(['userId', 'companyId', 'storeId', 'date'])
        && request.resource.data.userId is string
        && request.resource.data.companyId is string
        && request.resource.data.storeId is string
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Store Manager 이상
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Store Manager 이상
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 6. Salary (급여)
    // ====================================
    match /salary/{salaryId} {
      // 읽기: 본인 또는 Manager 이상
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // 생성: Manager 이상만
      allow create: if isManager()
        && request.resource.data.keys().hasAll(['userId', 'companyId'])
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Manager 이상만
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Admin만
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 7. Approvals (승인 요청)
    // ====================================
    match /approvals/{approvalId} {
      // 읽기: 본인 또는 Manager 이상
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // 생성: 본인만 (직원이 요청)
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userId', 'companyId'])
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Manager 이상 (승인/거부)
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: 본인 또는 Manager
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    // ====================================
    // 8. Notices (공지사항)
    // ====================================
    match /notices/{noticeId} {
      // 읽기: 같은 회사 모든 직원
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      // 생성: Manager 이상
      allow create: if isManager()
        && request.resource.data.keys().hasAll(['companyId', 'title', 'content'])
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Manager 이상
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Manager 이상
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 9. Brands (브랜드)
    // ====================================
    match /brands/{brandId} {
      // 읽기: 같은 회사
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      // 생성: Admin만
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['companyId', 'brandName'])
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Admin만
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      
      // 삭제: Admin만
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 10. Stores (매장)
    // ====================================
    match /stores/{storeId} {
      // 읽기: 같은 회사
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      // 생성: Admin만
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['companyId', 'storeName'])
        && request.resource.data.companyId is string
        && request.resource.data.storeName is string
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Admin만
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      
      // 삭제: Admin만
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11. Invites (초대 코드)
    // ====================================
    match /invites/{inviteId} {
      // 읽기: 같은 회사
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      // 생성: Admin만
      allow create: if isAdmin()
        && request.resource.data.keys().hasAll(['companyId', 'code'])
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Admin만
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      
      // 삭제: Admin만
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 12. Shift Requests (교대근무 요청)
    // ====================================
    match /shift_requests/{shiftId} {
      // 읽기: 같은 회사
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      // 생성: 인증된 사용자
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['companyId'])
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: Manager 이상
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      
      // 삭제: Manager 이상
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 13. Simulators (스케줄 시뮬레이터)
    // ====================================
    match /simulators/{simulatorId} {
      // 읽기: 인증된 사용자 (모든 시뮬레이터 조회 가능)
      allow read: if isAuthenticated();
      
      // 생성: Store Manager 이상
      allow create: if isStoreManager()
        && request.resource.data.keys().hasAll(['name', 'createdAt']);
      
      // 수정: Store Manager 이상
      allow update: if isStoreManager();
      
      // 삭제: Store Manager 이상
      allow delete: if isStoreManager();
    }
    
    // ====================================
    // 14. Signed Contracts (서명된 계약서)
    // ====================================
    match /signedContracts/{contractId} {
      // 읽기: 같은 회사 + Store Manager 이상 또는 본인
      allow read: if isAuthenticated()
        && ((isStoreManager() && isSameCompany(resource.data.companyId))
        || isOwner(resource.data.userId));
      
      // 생성: 본인만 (직원이 서명)
      allow create: if isAuthenticated()
        && request.resource.data.keys().hasAll(['userId', 'companyId'])
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      
      // 수정: 금지 (서명 후 수정 불가)
      allow update: if false;
      
      // 삭제: Admin만
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 기본 규칙: 모든 다른 경로는 차단
    // ====================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
