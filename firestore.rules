rules_version = '2';

/**
 * Firestore Security Rules
 * í‘œì¤€ í•„ë“œëª… ê¸°ë°˜ (FIELD_NAMING_STANDARD.md ì¤€ìˆ˜)
 * í•µì‹¬ ì›ì¹™:
 * 1. ëª¨ë“  ë°ì´í„°ëŠ” companyIdë¡œ ê²©ë¦¬
 * 2. í‘œì¤€ í•„ë“œëª… (userId, storeId, clockIn ë“±) ê²€ì¦
 * 3. ì—­í•  ê¸°ë°˜ ê¶Œí•œ (super_admin, admin, manager, store_manager, employee)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // í—¬í¼ í•¨ìˆ˜
    // ====================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }
    
    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'super_admin'];
    }
    
    function isStoreManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'store_manager', 'super_admin'];
    }
    
    function isSameCompany(companyId) {
      return isAuthenticated() && (getUserCompanyId() == companyId || isSuperAdmin());
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ====================================
    // 1. Companies (íšŒì‚¬)
    // ====================================
    match /companies/{companyId} {
      allow read: if isSameCompany(companyId) || isSuperAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin() && isSameCompany(companyId);
      allow delete: if isSuperAdmin();
      
      // íšŒì‚¬ ì„¤ì • (ì„œë¸Œì»¬ë ‰ì…˜)
      match /settings/{settingId} {
        allow read: if isSameCompany(companyId);
        allow write: if isAdmin() && isSameCompany(companyId);
      }
    }
    
    // ====================================
    // 2. Users (ì‚¬ìš©ì/ì§ì›)
    // ==================================== 
    match /users/{userId} {
      // ì¡°íšŒ: ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ ë§¤ë‹ˆì €
      allow get: if isAuthenticated() 
        && (
          isOwner(userId) 
          || (resource != null && isManager() && isSameCompany(resource.data.companyId))
        );
      
      // [ìˆ˜ì • ì™„ë£Œ] ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ: ì¸ì¦ëœ ì‚¬ìš©ì í—ˆìš© (í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ í•„ìˆ˜)
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (isOwner(userId) || (isManager() && resource != null && isSameCompany(resource.data.companyId)))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId']) 
            || isSuperAdmin());
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 3. Contracts (ê³„ì•½ì„œ)
    // ====================================
    match /contracts/{contractId} {
      // ë‹¨ê±´ ì¡°íšŒ: ë³¸ì¸ ê³„ì•½ì„œ ë˜ëŠ” ê°™ì€ íšŒì‚¬ ë§¤ë‹ˆì €
      allow get: if isAuthenticated()
        && (
          (resource != null && isOwner(resource.data.userId))
          || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId))
        );
      
      // [ìˆ˜ì • ì™„ë£Œ] ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ: ë§¤ë‹ˆì € ë˜ëŠ” ë³¸ì¸ ë°ì´í„°
      allow list: if isAuthenticated() && (isStoreManager() || (resource.data.userId == request.auth.uid));
      
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      
      allow update: if isAuthenticated()
        && resource != null
        && (
          (isStoreManager() && isSameCompany(resource.data.companyId))
          || (
            isOwner(resource.data.userId)
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['employeeSignedAt', 'employeeSignedBy', 'employeeSignature', 'updatedAt', 'status'])
          )
        );
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 4. Attendance (ì¶œí‡´ê·¼)
    // ====================================
    match /attendance/{attendanceId} {
      // ë‹¨ê±´ ì¡°íšŒ: ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ ë§¤ë‹ˆì €
      allow get: if isAuthenticated()
        && (
          (resource != null && isOwner(resource.data.userId))
          || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId))
        );
      
      // [ìˆ˜ì • ì™„ë£Œ] ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ: ë§¤ë‹ˆì € ë˜ëŠ” ë³¸ì¸ ë°ì´í„°
      allow list: if isAuthenticated() && (isStoreManager() || (resource.data.userId == request.auth.uid));
      
      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.userId) || (isStoreManager() && isSameCompany(request.resource.data.companyId)));
      
      allow update: if isAuthenticated()
        && resource != null
        && (
          (isStoreManager() && isSameCompany(resource.data.companyId))
          || isOwner(resource.data.userId)
        );
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 5. Schedules (ê·¼ë¬´ìŠ¤ì¼€ì¤„)
    // ====================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated()
        && (
          (resource != null && isOwner(resource.data.userId))
          || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId))
          || (resource != null && isSameCompany(resource.data.companyId))
        );
        
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 6. Salary (ê¸‰ì—¬)
    // ====================================
    match /salary/{salaryId} {
      // ë‹¨ê±´ ì¡°íšŒ: ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ ë§¤ë‹ˆì €
      allow get: if isAuthenticated()
        && resource != null
        && (
          isOwner(resource.data.userId) 
          || (isManager() && isSameCompany(resource.data.companyId))
        );
      
      // [ìˆ˜ì • ì™„ë£Œ] ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ: ë§¤ë‹ˆì € ë˜ëŠ” ë³¸ì¸ ë°ì´í„°
      allow list: if isAuthenticated() && (isManager() || (resource.data.userId == request.auth.uid));
      
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && resource != null && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 7. Approvals (ìŠ¹ì¸ ìš”ì²­)
    // ====================================
    match /approvals/{approvalId} {
      // ë‹¨ê±´ ì¡°íšŒ: ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ ë§¤ë‹ˆì €
      allow get: if isAuthenticated()
        && resource != null
        && (
          isOwner(resource.data.userId) 
          || (isManager() && isSameCompany(resource.data.companyId))
        );
      
      // [ìˆ˜ì • ì™„ë£Œ] ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ: ë§¤ë‹ˆì € ë˜ëŠ” ë³¸ì¸ ë°ì´í„°
      allow list: if isAuthenticated() && (isManager() || (resource.data.userId == request.auth.uid));
      
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      
      allow update: if isManager() && resource != null && isSameCompany(resource.data.companyId);
      allow delete: if isAuthenticated()
        && resource != null
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    // ====================================
    // 8. Notices (ê³µì§€ì‚¬í•­)
    // ====================================
    match /notices/{noticeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 9. Brands (ë¸Œëœë“œ)
    // ====================================
    match /brands/{brandId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 10. Stores (ë§¤ì¥)
    // ====================================
    match /stores/{storeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11. Invites (ì´ˆëŒ€ ì½”ë“œ - ë§¤ì¥ìš©)
    // ====================================
    match /invites/{inviteId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11-2. Company Invites (ì§ì› ì´ˆëŒ€ ì½”ë“œ)
    // ====================================
    match /company_invites/{inviteId} {
      // [ìˆ˜ì • ì™„ë£Œ] ë³´ì•ˆ ì·¨ì•½ì  ì œê±°: || request.auth != null ì‚­ì œí•¨
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 12. Shift Requests (êµëŒ€ê·¼ë¬´ ìš”ì²­)
    // ====================================
    match /shift_requests/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 13. Simulators (ìŠ¤ì¼€ì¤„ ì‹œë®¬ë ˆì´í„°)
    // ====================================
    match /simulators/{simulatorId} {
      // ğŸ”’ list/get ë¶„ë¦¬ (resource null ì²´í¬)
      allow get: if isAuthenticated() 
        && resource != null 
        && isSameCompany(resource.data.companyId);
      
      allow list: if isAuthenticated() && isStoreManager();
      
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() 
        && resource != null 
        && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() 
        && resource != null 
        && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 14. Signed Contracts (ì„œëª…ëœ ê³„ì•½ì„œ)
    // ====================================
    match /signedContracts/{contractId} {
      allow read: if isAuthenticated()
        && ((isStoreManager() && isSameCompany(resource.data.companyId))
        || isOwner(resource.data.userId));
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      allow update: if false;
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 15. Holidays (ê³µíœ´ì¼)
    // ====================================
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ====================================
    // 16. Subscription Plans (êµ¬ë… í”Œëœ)
    // ====================================
    match /subscription_plans/{planId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 17. Invitation Codes (í”Œë«í¼ ì´ˆëŒ€ ì½”ë“œ)
    // ====================================
    match /invitation_codes/{codeId} {
      allow read: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 18. Open Shifts (ê¸´ê¸‰ êµ¬ì¸)
    // ====================================
    match /open_shifts/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 19. Notifications (ì•Œë¦¼)
    // ====================================
    match /notifications/{notifId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      // ì§ì›ë„ ì•Œë¦¼ ìƒì„± ê°€ëŠ¥ (ì¶œí‡´ê·¼ ìˆ˜ì • ìš”ì²­ ì•Œë¦¼ ë“±)
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}