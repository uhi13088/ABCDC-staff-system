rules_version = '2';

/**
 * Firestore Security Rules
 * í‘œì¤€ í•„ë“œëª… ê¸°ë°˜ (FIELD_NAMING_STANDARD.md ì¤€ìˆ˜)
 * * í•µì‹¬ ì›ì¹™:
 * 1. ëª¨ë“  ë°ì´í„°ëŠ” companyIdë¡œ ê²©ë¦¬
 * 2. í‘œì¤€ í•„ë“œëª… (userId, storeId, clockIn ë“±) ê²€ì¦
 * 3. ì—­í•  ê¸°ë°˜ ê¶Œí•œ (super_admin, admin, manager, store_manager, employee)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // í—¬í¼ í•¨ìˆ˜
    // ====================================
    
    /**
     * ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * ì‚¬ìš©ìì˜ ì—­í•  ê°€ì ¸ì˜¤ê¸°
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    /**
     * ì‚¬ìš©ìì˜ íšŒì‚¬ ID ê°€ì ¸ì˜¤ê¸°
     */
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    /**
     * Super Admin í™•ì¸ (í”Œë«í¼ ê´€ë¦¬ì)
     */
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    /**
     * Admin ê¶Œí•œ í™•ì¸ (Super Admin í¬í•¨)
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }
    
    /**
     * Manager ì´ìƒ ê¶Œí•œ í™•ì¸ (Super Admin í¬í•¨)
     */
    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'super_admin'];
    }
    
    /**
     * Store Manager ì´ìƒ ê¶Œí•œ í™•ì¸ (Super Admin í¬í•¨)
     */
    function isStoreManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'store_manager', 'super_admin'];
    }
    
    /**
     * ê°™ì€ íšŒì‚¬ ì†Œì† í™•ì¸
     * ğŸš€ Super Adminì€ íšŒì‚¬ ID ê²€ì¦ì„ ìš°íšŒí•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ìˆ˜ë„ ìˆì§€ë§Œ, 
     * í˜„ì¬ êµ¬ì¡°ìƒ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” ë³¸ì¸ ê³„ì •ì— í• ë‹¹ëœ companyIdê°€ ìˆì–´ì•¼ í•¨.
     */
    function isSameCompany(companyId) {
      return isAuthenticated() && (getUserCompanyId() == companyId || isSuperAdmin());
    }
    
    /**
     * ë³¸ì¸ ë°ì´í„° í™•ì¸
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ====================================
    // 1. Companies (íšŒì‚¬)
    // ====================================
    match /companies/{companyId} {
      allow read: if isSameCompany(companyId) || isSuperAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin() && isSameCompany(companyId);
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 2. Users (ì‚¬ìš©ì/ì§ì›)
    // ====================================
    match /users/{userId} {
      allow read: if isAuthenticated() 
        && (
          isOwner(userId) 
          || isManager()
        );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (isOwner(userId) || (isManager() && isSameCompany(resource.data.companyId)))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId']) 
            || isSuperAdmin());
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 3. Contracts (ê³„ì•½ì„œ)
    // ====================================
    match /contracts/{contractId} {
      allow read: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 4. Attendance (ì¶œí‡´ê·¼)
    // ====================================
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isStoreManager() && isSameCompany(resource.data.companyId)));
      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.userId) || (isStoreManager() && isSameCompany(request.resource.data.companyId)));
      allow update: if isAuthenticated()
        && (
          (isStoreManager() && isSameCompany(resource.data.companyId))
          || isOwner(resource.data.userId)
        );
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 5. Schedules (ê·¼ë¬´ìŠ¤ì¼€ì¤„)
    // ====================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isStoreManager() && isSameCompany(resource.data.companyId)));
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 6. Salary (ê¸‰ì—¬)
    // ====================================
    match /salary/{salaryId} {
      allow read: if isAuthenticated()
        && (
          isOwner(resource.data.userId) 
          || isManager()
        );
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 7. Approvals (ìŠ¹ì¸ ìš”ì²­)
    // ====================================
    match /approvals/{approvalId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    // ====================================
    // 8. Notices (ê³µì§€ì‚¬í•­)
    // ====================================
    match /notices/{noticeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 9. Brands (ë¸Œëœë“œ)
    // ====================================
    match /brands/{brandId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 10. Stores (ë§¤ì¥)
    // ====================================
    match /stores/{storeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11. Invites (ì´ˆëŒ€ ì½”ë“œ - ë§¤ì¥ìš©, êµ¬ ë²„ì „)
    // ====================================
    match /invites/{inviteId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11-2. Company Invites (ì§ì› ì´ˆëŒ€ ì½”ë“œ)
    // ====================================
    match /company_invites/{inviteId} {
      // ì½ê¸°: ë³¸ì¸ íšŒì‚¬ ë˜ëŠ” ì½”ë“œë¡œ ê²€ì¦ ì‹œ
      allow read: if isAuthenticated() && (
        isSameCompany(resource.data.companyId) ||
        request.auth != null  // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ì´ˆëŒ€ ì½”ë“œ ê²€ì¦ ê°€ëŠ¥
      );
      // ìƒì„±: ê´€ë¦¬ìë§Œ (ë³¸ì¸ íšŒì‚¬)
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      // ìˆ˜ì •: ê´€ë¦¬ìë§Œ (ë³¸ì¸ íšŒì‚¬)
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ (ë³¸ì¸ íšŒì‚¬)
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 12. Shift Requests (êµëŒ€ê·¼ë¬´ ìš”ì²­)
    // ====================================
    match /shift_requests/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 13. Simulators (ìŠ¤ì¼€ì¤„ ì‹œë®¬ë ˆì´í„°)
    // ====================================
    match /simulators/{simulatorId} {
      allow read: if isAuthenticated();
      allow create: if isStoreManager();
      allow update: if isStoreManager();
      allow delete: if isStoreManager();
    }
    
    // ====================================
    // 14. Signed Contracts (ì„œëª…ëœ ê³„ì•½ì„œ)
    // ====================================
    match /signedContracts/{contractId} {
      allow read: if isAuthenticated()
        && ((isStoreManager() && isSameCompany(resource.data.companyId))
        || isOwner(resource.data.userId));
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      allow update: if false;
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 15. Holidays (ê³µíœ´ì¼)
    // ====================================
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ====================================
    // 16. Subscription Plans (êµ¬ë… í”Œëœ) [í”Œë«í¼]
    // ====================================
    match /subscription_plans/{planId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 17. Invitation Codes (í”Œë«í¼ ì´ˆëŒ€ ì½”ë“œ) [í”Œë«í¼]
    // ====================================
    match /invitation_codes/{codeId} {
      allow read: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 18. Open Shifts (ê¸´ê¸‰ êµ¬ì¸)
    // ====================================
    match /open_shifts/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 19. Notifications (ì•Œë¦¼)
    // ====================================
    match /notifications/{notifId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
