rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================================================
    // ë©€í‹°í…Œë„ŒíŠ¸ Firestore Security Rules v3.6 (Final Optimized)
    // ABCDC Staff System - Multi-tenant SaaS
    // 
    // ì£¼ìš” ê°œì„ ì‚¬í•­:
    // - ë¶ˆí•„ìš”í•œ í—¬í¼ í•¨ìˆ˜ ì œê±° (ì½”ë“œ ê°„ì†Œí™”)
    // - í´ë¼ì´ì–¸íŠ¸ ì¿¼ë¦¬(whereì ˆ)ì™€ ê·œì¹™ì˜ 1:1 ë§¤ì¹­ìœ¼ë¡œ ë³´ì•ˆ ê°•í™”
    // - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(ëŒ€íƒ€ êµ¬í•˜ê¸°) ì™„ë²½ êµ¬í˜„
    // - ëˆ„ë½ëœ ì»¬ë ‰ì…˜(brands, salaries) ì¶”ê°€
    // ===================================================================
    
    // ============ Helper Functions ============
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ì‚¬ìš©ì ì •ë³´ ë°”ë¡œ ê°€ì ¸ì˜¤ê¸° (DB ì½ê¸° 1íšŒ, ìë™ ìºì‹±)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && getUserData().role == "super_admin";
    }
    
    // í˜„ì¬ ì‚¬ìš©ìì˜ ë©”íƒ€ë°ì´í„°
    function currentCompanyId() {
      return getUserData().companyId;
    }
    
    function currentStoreId() {
      return getUserData().storeId;
    }
    
    function currentStoreName() {
      return getUserData().store;
    }
    
    function currentRole() {
      return getUserData().role;
    }
    
    // ì—­í•  ê·¸ë£¹ ì²´í¬
    function isAdmin() {
      return isSignedIn() && currentRole() == "admin";
    }
    
    function isManagerOrAbove() {
      return isSignedIn() && currentRole() in ["admin", "store_manager"];
    }

    // ============ Collection Rules ============
    
    // 1. Users (ì§ì› ì •ë³´)
    match /users/{userId} {
      // list: ê´€ë¦¬ìëŠ” íšŒì‚¬ ì „ì²´ ì¡°íšŒ ê°€ëŠ¥
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (isManagerOrAbove() && resource.data.companyId == currentCompanyId())
      );
      
      // get: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì
      allow get: if isSignedIn() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (isManagerOrAbove() && resource.data.companyId == currentCompanyId())
      );
      
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // update: ë³¸ì¸ì€ ë¯¼ê°ì •ë³´ ì œì™¸í•˜ê³  ìˆ˜ì • ê°€ëŠ¥, ê´€ë¦¬ìëŠ” ì „ì²´ ê°€ëŠ¥
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && request.resource.data.companyId == resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == currentCompanyId()) ||
        isSuperAdmin()
      );
      
      allow delete: if isSuperAdmin() || (isAdmin() && resource.data.companyId == currentCompanyId());
    }
    
    // 2. Companies
    match /companies/{companyId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() || currentCompanyId() == companyId
      );
      allow create: if isSignedIn();
      allow update, delete: if isSuperAdmin() || (isAdmin() && currentCompanyId() == companyId);
    }
    
    // 3. Brands (ë¸Œëœë“œ ê´€ë¦¬) - NEW!
    match /brands/{brandId} {
      // ê°™ì€ íšŒì‚¬ ì‚¬ëŒì´ë©´ ë¸Œëœë“œ ì¡°íšŒ ê°€ëŠ¥ (ê³„ì•½ì„œ ì‘ì„±, ë§¤ì¥ ê´€ë¦¬ ë“±)
      allow read: if isSignedIn() && (
        isSuperAdmin() || 
        resource.data.companyId == currentCompanyId()
      );
      
      allow write: if isSuperAdmin() || (isAdmin() && resource.data.companyId == currentCompanyId());
    }
    
    // 4. Stores
    match /stores/{storeId} {
      // ê°™ì€ íšŒì‚¬ ì‚¬ëŒì´ë©´ ë§¤ì¥ ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥ (íšŒì›ê°€ì…, ê³„ì•½ì„œ ì‘ì„± ë“±)
      allow read: if isSignedIn() && (
        isSuperAdmin() || resource.data.companyId == currentCompanyId()
      );
      allow write: if isSuperAdmin() || (isAdmin() && resource.data.companyId == currentCompanyId());
    }
    
    // 5. Attendance (ì¶œí‡´ê·¼)
    match /attendance/{docId} {
      // ğŸ”¥ list: [ë³¸ì¸] ë‚´ ë°ì´í„°ë§Œ OR [ê´€ë¦¬ì] íšŒì‚¬ ì „ì²´
      // í´ë¼ì´ì–¸íŠ¸ê°€ .where('userId', '==', myUid)ë¥¼ ë³´ë‚´ë©´ í—ˆìš©ë¨
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.userId == request.auth.uid)
      );
  
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.userId == request.auth.uid)
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.companyId == currentCompanyId() &&
                       (request.resource.data.userId == request.auth.uid || isManagerOrAbove());
                       
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.userId == request.auth.uid && resource.data.companyId == currentCompanyId())
      );
      
      allow delete: if isSuperAdmin() || isAdmin();
    }
    
    // 6. Schedules (ìŠ¤ì¼€ì¤„)
    match /schedules/{docId} {
      // list: ê°™ì€ íšŒì‚¬ ë°ì´í„°ë©´ ì¡°íšŒ ê°€ëŠ¥ (ë§¤ì¥ë³„ í•„í„°ë§ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (resource.data.companyId == currentCompanyId())
      );
      
      allow get: if isSignedIn() && (
        isSuperAdmin() || 
        resource.data.companyId == currentCompanyId()
      );
      
      allow write: if isSuperAdmin() || (isManagerOrAbove() && request.resource.data.companyId == currentCompanyId());
    }
    
    // 7. Contracts (ê³„ì•½ì„œ)
    match /contracts/{docId} {
      // list: [ë³¸ì¸] ë‚´ ê³„ì•½ì„œ OR [ê´€ë¦¬ì]
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.employeeId == request.auth.uid)
      );
      
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.employeeId == request.auth.uid)
      );
      
      allow write: if isSuperAdmin() || (isManagerOrAbove() && request.resource.data.companyId == currentCompanyId());
    }
    
    // 8. Saved Contracts (ì„ì‹œ ì €ì¥)
    match /savedContracts/{docId} {
      allow read, write: if isSignedIn() && (isSuperAdmin() || isManagerOrAbove());
    }
    
    // 9. Signed Contracts (ì„œëª…ëœ ê³„ì•½ì„œ)
    match /signedContracts/{docId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.employeeId == request.auth.uid)
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.companyId == currentCompanyId() &&
                       (request.resource.data.employeeId == request.auth.uid || isManagerOrAbove());
                       
      allow update, delete: if isSuperAdmin() || isManagerOrAbove();
    }
    
    // 10. Salaries (ê¸‰ì—¬ ë‚´ì—­) - NEW!
    match /salaries/{docId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.employeeUid == request.auth.uid)
      );
      
      allow write: if isSuperAdmin() || (isAdmin() && request.resource.data.companyId == currentCompanyId());
    }
    
    // 11. Approvals (ìŠ¹ì¸ ìš”ì²­)
    match /approvals/{docId} {
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.applicantUid == request.auth.uid)
      );
      
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.applicantUid == request.auth.uid)
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.applicantUid == request.auth.uid &&
                       request.resource.data.companyId == currentCompanyId();
                       
      allow update, delete: if isSuperAdmin() || isManagerOrAbove();
    }
    
    // 12. Shift Requests (êµëŒ€ ê·¼ë¬´) ğŸ”¥
    match /shift_requests/{docId} {
      // list: 
      // 1. ê´€ë¦¬ìëŠ” ë‹¤ ë´„
      // 2. ì§ì›ì€ 'ë‚´ ë§¤ì¥'ì˜ 'pending(ëŒ€ê¸°ì¤‘)' ìš”ì²­ì„ ë´„ (ëŒ€íƒ€ êµ¬í•˜ê¸°)
      // 3. ì§ì›ì€ 'ë‚´ê°€ ì“´' ìš”ì²­ì„ ë´„
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (
          resource.data.companyId == currentCompanyId() && 
          (
             (resource.data.store == currentStoreName() && resource.data.status == 'pending') || 
             resource.data.requesterId == request.auth.uid
          )
        )
      );
      
      allow get: if isSignedIn() && resource.data.companyId == currentCompanyId();
      
      allow create: if isSignedIn() && 
                       request.resource.data.requesterId == request.auth.uid &&
                       request.resource.data.companyId == currentCompanyId();
      
      // ğŸ”’ update: ìš”ì²­ì ë³¸ì¸ OR ëŒ€íƒ€ê°€ ìˆ˜ë½ OR ê´€ë¦¬ìê°€ ìŠ¹ì¸
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (
          resource.data.companyId == currentCompanyId() && 
          (
            // ìš”ì²­ì ë³¸ì¸ì´ ìˆ˜ì • (ì·¨ì†Œ, ì‚­ì œ)
            resource.data.requesterId == request.auth.uid ||
            // ëŒ€íƒ€ê°€ ìˆ˜ë½ (statusë¥¼ 'matched'ë¡œ ë³€ê²½)
            (resource.data.status == 'pending' && 
             request.resource.data.replacementId == request.auth.uid &&
             request.resource.data.status == 'matched')
          )
        )
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.requesterId == request.auth.uid)
      );
    }
    
    // 13. Time Change Reports (ìˆ˜ì • ì´ë ¥)
    match /time_change_reports/{docId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove() ||
        (resource.data.companyId == currentCompanyId() && resource.data.employeeUid == request.auth.uid)
      );
      
      allow create: if isSignedIn() && request.resource.data.companyId == currentCompanyId();
      allow update, delete: if isSuperAdmin() || isManagerOrAbove();
    }

    // 14. Notices (ê³µì§€ì‚¬í•­)
    match /notices/{docId} {
      allow read: if isSignedIn() && (isSuperAdmin() || resource.data.companyId == currentCompanyId());
      allow write: if isSuperAdmin() || (isAdmin() && request.resource.data.companyId == currentCompanyId());
    }
    
    // 15. Employee Docs (ì„œë¥˜)
    match /employee_docs/{userId} {
      allow read, write: if isSignedIn() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (isManagerOrAbove() && 
         get(/databases/$(database)/documents/users/$(userId)).data.companyId == currentCompanyId())
      );
    }
    
    // 16. Company Invites (ì´ˆëŒ€ ì½”ë“œ)
    match /company_invites/{docId} {
      allow read: if isSuperAdmin() || isManagerOrAbove();
      allow write: if isSuperAdmin() || isAdmin();
    }

    // 17. Simulators (ê¸‰ì—¬ ì‹œë®¬ë ˆì´í„° - ê´€ë¦¬ì ì „ìš©)
    match /simulators/{docId} { 
      allow read, write: if isSuperAdmin() || isManagerOrAbove(); 
    }
    
    match /simulatorPersons/{docId} { 
      allow read, write: if isSuperAdmin() || isManagerOrAbove(); 
    }
    
    match /simulatorSchedules/{docId} { 
      allow read, write: if isSuperAdmin() || isManagerOrAbove(); 
    }

    // ê¸°íƒ€ ëª¨ë“  ì»¬ë ‰ì…˜: super_adminë§Œ ì ‘ê·¼
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
