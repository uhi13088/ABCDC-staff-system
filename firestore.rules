rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================================================
    // ë©€í‹°í…Œë„ŒíŠ¸ Firestore Security Rules v3.1.7
    // ABCDC Staff System - Multi-tenant SaaS
    // ìˆœí™˜ì°¸ì¡° ì œê±° + ë³´ì•ˆ ê°•í™” + ê´€ë¦¬ì íšŒì›ê°€ì… ì§€ì› + ì¿¼ë¦¬ ë ˆë²¨ ê¶Œí•œ ìˆ˜ì •
    // v3.1.7: stores ìƒì„± ì‹œ companyId ìë™ ì¶”ê°€ ì™„ë£Œ
    // ===================================================================
    
    // ============ Helper Functions ============
    
    // ì¸ì¦ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }
    
    // â­ v3.2: Super Admin í™•ì¸ (Firestore role í•„ë“œ ì²´í¬)
    function isSuperAdmin() {
      return request.auth != null
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "super_admin";
    }
    
    // â­ v3.1.3: Helper í•¨ìˆ˜ (ìˆœí™˜ì°¸ì¡° ë°©ì§€)
    // ì£¼ì˜: ì´ í—¬í¼ë“¤ì€ /users, /employees ì»¬ë ‰ì…˜ "ë‚´ë¶€"ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    // ë‹¤ë¥¸ ì»¬ë ‰ì…˜ì—ì„œë§Œ ì‚¬ìš© (attendance, schedules ë“±)
    function currentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function currentUserExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function currentCompanyId() {
      return currentUser().data.companyId;
    }
    
    function currentStoreId() {
      return currentUser().data.storeId;
    }
    
    function currentRole() {
      return currentUser().data.role;
    }
    
    // â­ v3.1.5: ì¿¼ë¦¬ ë ˆë²¨ ê¶Œí•œ ì²´í¬ìš© í•¨ìˆ˜ (resource ì—†ì´ë„ ë™ì‘)
    function isAdmin() {
      return currentUserExists()
          && currentUser().data.role == "admin";
    }
    
    function isManagerOrAbove() {
      return currentUserExists()
          && currentUser().data.role in ["admin", "manager", "store_manager"];
    }
    
    // â­ ë¬¸ì„œ ë ˆë²¨ ê¶Œí•œ ì²´í¬ìš© í•¨ìˆ˜ (resource í•„ìš”)
    function isCompanyAdmin() {
      return currentUserExists()
          && currentUser().data.companyId == resource.data.companyId
          && currentUser().data.role == "admin";
    }
    
    function isCompanyAdminOrManager() {
      return currentUserExists()
          && currentUser().data.companyId == resource.data.companyId
          && currentUser().data.role in ["admin", "manager", "store_manager"];
    }
    
    function isSameCompany(resource) {
      return resource.data.companyId == currentCompanyId();
    }
    
    function isSameStore(resource) {
      return resource.data.storeId == currentStoreId();
    }
    
    // ============ Collection Rules ============
    
    // â­ v3.1.5: users ì»¬ë ‰ì…˜ (ìˆœí™˜ì°¸ì¡° ì œê±° + ë¯¼ê° í•„ë“œ ë³´í˜¸ + ì¿¼ë¦¬ ë ˆë²¨ í—ˆìš©)
    match /users/{userId} {
      // ğŸ”¥ ì¿¼ë¦¬ ì¡°íšŒ (list): admin/managerëŠ” ìê¸° íšŒì‚¬ ì „ì²´ ì¡°íšŒ ê°€ëŠ¥
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentUser().data.role in ["admin", "manager", "store_manager"])
      );
      
      // ê°œë³„ ë¬¸ì„œ ì½ê¸° (get): ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ì˜ admin/manager
      allow get: if isSignedIn() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (
          request.auth.uid != userId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role in ["admin", "manager", "store_manager"]
        )
      );
      
      // ìƒì„±: íšŒì›ê°€ì… ì‹œ
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // â­ ìˆ˜ì • 1: ë³¸ì¸ì´ ìê¸° ë¬¸ì„œ ìˆ˜ì • ì‹œ - ë¯¼ê° í•„ë“œ ë³€ê²½ ê¸ˆì§€
      // companyId, role, storeId, statusëŠ” ë³€ê²½ ë¶ˆê°€
      allow update: if isSignedIn()
                    && request.auth.uid == userId
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.role == resource.data.role
                    && request.resource.data.storeId == resource.data.storeId
                    && request.resource.data.status == resource.data.status;
      
      // â­ ìˆ˜ì • 2: admin/super_admin - ëª¨ë“  í•„ë“œ ìˆ˜ì • ê°€ëŠ¥
      // ìê¸° ìì‹ ì´ ì•„ë‹ ë•Œë§Œ ì ìš©
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.uid != userId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role == "admin"
        )
      );
    }
    
    // companies: íšŒì‚¬ ì •ë³´
    match /companies/{companyId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentCompanyId() == companyId)
      );
      
      // â­ v3.1.4: íšŒì‚¬ ìƒì„± - ê´€ë¦¬ì íšŒì›ê°€ì… ì‹œ users ë¬¸ì„œ ì—†ì´ ìƒì„± ê°€ëŠ¥
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        request.resource.data.createdBy == request.auth.uid  // ë³¸ì¸ì´ ìƒì„±í•˜ëŠ” íšŒì‚¬
      );
      
      // íšŒì‚¬ ìˆ˜ì •/ì‚­ì œ - í•´ë‹¹ íšŒì‚¬ì˜ adminë§Œ ê°€ëŠ¥
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentCompanyId() == companyId && currentRole() == "admin")
      );
    }
    
    // â­ v3.1.6: stores ì»¬ë ‰ì…˜ (ì¿¼ë¦¬/ë¬¸ì„œ ê¶Œí•œ ë¶„ë¦¬)
    match /stores/{storeId} {
      // ğŸ”¥ ì¿¼ë¦¬ ì¡°íšŒ (list): admin/managerëŠ” ë¹ˆ ì»¬ë ‰ì…˜ë„ ì¡°íšŒ ê°€ëŠ¥
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentUser().data.role in ["admin", "manager", "store_manager"])
      );
      
      // ê°œë³„ ë¬¸ì„œ ì½ê¸° (get): ê°™ì€ íšŒì‚¬ë§Œ
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource))  // ğŸ”’ ìê¸° íšŒì‚¬ë§Œ
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // â­ v3.1.3: employees ì»¬ë ‰ì…˜ (ìˆœí™˜ì°¸ì¡° ì œê±° + ë¯¼ê° í•„ë“œ ë³´í˜¸)
    match /employees/{employeeId} {
      // ì½ê¸°: ë³¸ì¸ì€ ì§ì ‘ ë¹„êµ, íƒ€ì¸ì€ ëª…ì‹œì  get()ìœ¼ë¡œ ì²´í¬
      allow read: if isSignedIn() && (
        request.auth.uid == employeeId ||
        isSuperAdmin() ||
        (
          // â­ ìê¸° ìì‹ ì´ ì•„ë‹ ë•Œë§Œ currentUser() ì‚¬ìš©
          request.auth.uid != employeeId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role in ["admin", "manager", "store_manager"]
        )
      );
      
      allow create: if isSignedIn() && request.auth.uid == employeeId;
      
      // â­ ë³¸ì¸ ìˆ˜ì •: ë¯¼ê° í•„ë“œ ë³€ê²½ ê¸ˆì§€
      allow update: if isSignedIn()
                    && request.auth.uid == employeeId
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.storeId == resource.data.storeId
                    && request.resource.data.role == resource.data.role
                    && request.resource.data.status == resource.data.status;
      
      // â­ admin/super_admin: í’€ ê¶Œí•œ (ìê¸° ìì‹  ì•„ë‹ ë•Œë§Œ)
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.uid != employeeId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role == "admin"
        )
      );
    }
    
    // attendance: ì¶œí‡´ê·¼ ê¸°ë¡
    match /attendance/{attendanceId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager() ||  // ğŸ”’ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë§Œ
        (currentUserExists() && (resource.data.employeeId == request.auth.uid || resource.data.userId == request.auth.uid))  // â­ staffëŠ” ìê¸° ì¶œí‡´ê·¼ë§Œ (employeeId ë˜ëŠ” userId)
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() &&
         request.resource.data.storeId == currentStoreId())
      );
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.employeeId == request.auth.uid || currentRole() == "admin"))
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // schedules: ê·¼ë¬´ ìŠ¤ì¼€ì¤„
    match /schedules/{scheduleId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager() ||  // ğŸ”’ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë§Œ
        (currentUserExists() && (resource.data.employeeId == request.auth.uid || resource.data.userId == request.auth.uid))  // â­ staffëŠ” ìê¸° ìŠ¤ì¼€ì¤„ë§Œ (employeeId ë˜ëŠ” userId)
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // contracts: ê³„ì•½ì„œ
    match /contracts/{contractId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager() ||  // ğŸ”’ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë§Œ
        (currentUserExists() && resource.data.employeeId == request.auth.uid)  // â­ staffëŠ” ìê¸° ê³„ì•½ì„œë§Œ
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // savedContracts: ì„ì‹œ ì €ì¥ ê³„ì•½ì„œ
    match /savedContracts/{contractId} {
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isSuperAdmin() ||
        isCompanyAdmin()
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update, delete: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // â­ v3.1.5: signedContracts (ìƒì„± ê¶Œí•œ ê°•í™” - ë³¸ì¸ë§Œ ë˜ëŠ” adminë§Œ)
    match /signedContracts/{contractId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager() ||  // ğŸ”’ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë§Œ
        (currentUserExists() && resource.data.employeeId == request.auth.uid)  // â­ staffëŠ” ìê¸° ì„œëª… ê³„ì•½ì„œë§Œ
      );
      
      // â­ ìƒì„±: ë³¸ì¸ ê³„ì•½ì„œë§Œ ì„œëª… ê°€ëŠ¥ OR adminì´ ìƒì„±
      allow create: if isSignedIn() &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId() &&
                       (request.resource.data.employeeId == request.auth.uid || 
                        currentRole() == "admin");
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // salaries: ê¸‰ì—¬ ì •ë³´
    match /salaries/{salaryId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.employeeId == request.auth.uid || currentRole() == "admin"))
      );
      
      allow create, update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
    }
    
    // notices: ê³µì§€ì‚¬í•­
    match /notices/{noticeId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource))  // â­ ê°™ì€ íšŒì‚¬ ì§ì› ëª¨ë‘ ì¡°íšŒ ê°€ëŠ¥ (staff í¬í•¨)
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // â­ v3.1.6: approvals ì»¬ë ‰ì…˜ (ì¿¼ë¦¬/ë¬¸ì„œ ê¶Œí•œ ë¶„ë¦¬)
    match /approvals/{approvalId} {
      // ğŸ”¥ ì¿¼ë¦¬ ì¡°íšŒ (list): ê´€ë¦¬ìëŠ” ë¹ˆ ì»¬ë ‰ì…˜ë„ ì¡°íšŒ ê°€ëŠ¥, staffëŠ” ì¿¼ë¦¬ í•„í„° í•„ìˆ˜
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        currentUserExists()  // â­ ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì¿¼ë¦¬ ê°€ëŠ¥ (í•„í„° ì¡°ê±´ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ)
      );
      
      // ê°œë³„ ë¬¸ì„œ ì½ê¸° (get): ë³¸ì¸ ë˜ëŠ” ê°™ì€ íšŒì‚¬ì˜ admin
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.applicantUid == request.auth.uid || currentRole() == "admin"))
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.applicantUid == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // â­ v3.1.6: shift_requests ì»¬ë ‰ì…˜ (ì¿¼ë¦¬/ë¬¸ì„œ ê¶Œí•œ ë¶„ë¦¬)
    match /shift_requests/{requestId} {
      // ğŸ”¥ ì¿¼ë¦¬ ì¡°íšŒ (list): admin/managerëŠ” ë¹ˆ ì»¬ë ‰ì…˜ë„ ì¡°íšŒ ê°€ëŠ¥
      allow list: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentUser().data.role in ["admin", "manager", "store_manager"])
      );
      
      // ê°œë³„ ë¬¸ì„œ ì½ê¸° (get): ê°™ì€ íšŒì‚¬ì˜ admin/managerë§Œ
      allow get: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager()  // ğŸ”’ ìê¸° íšŒì‚¬ë§Œ
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.requesterId == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (isSameStore(resource) || currentRole() == "admin"))
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.requesterId == request.auth.uid || currentRole() == "admin"))
      );
    }
    
    // time_change_reports: ê·¼ë¬´ì‹œê°„ ìˆ˜ì • ì´ë ¥
    match /time_change_reports/{reportId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager() ||  // ğŸ”’ ê´€ë¦¬ìëŠ” ìê¸° íšŒì‚¬ë§Œ
        (currentUserExists() && (resource.data.employeeId == request.auth.uid || resource.data.employeeUid == request.auth.uid))  // â­ staffëŠ” ìê¸° ìˆ˜ì • ì´ë ¥ë§Œ (employeeId ë˜ëŠ” employeeUid)
      );
      
      allow create: if isSignedIn() &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager()
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // employee_docs: ì§ì› ì„œë¥˜
    match /employee_docs/{docId} {
      allow read: if isSignedIn() && (
        docId == request.auth.uid ||
        isSuperAdmin() ||
        (currentUserExists() &&
         exists(/databases/$(database)/documents/users/$(docId)) &&
         currentCompanyId() == get(/databases/$(database)/documents/users/$(docId)).data.companyId &&
         currentRole() == "admin")
      );
      
      allow write: if isSignedIn() && (
        docId == request.auth.uid ||
        isSuperAdmin() ||
        (currentUserExists() &&
         exists(/databases/$(database)/documents/users/$(docId)) &&
         currentCompanyId() == get(/databases/$(database)/documents/users/$(docId)).data.companyId &&
         currentRole() == "admin")
      );
    }
    
    // company_invites (ì´ˆëŒ€ ì½”ë“œ)
    match /company_invites/{inviteId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // ë§ˆì´ê·¸ë ˆì´ì…˜ ë°±ì—… ì»¬ë ‰ì…˜ (ì„ì‹œ)
    match /schedules_backup/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    match /schedules_new/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    match /schedules_old/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    // ê¸°íƒ€ ëª¨ë“  ì»¬ë ‰ì…˜: super_adminë§Œ ì ‘ê·¼
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
