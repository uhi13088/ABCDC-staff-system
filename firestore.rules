rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================================================
    // 멀티테넌트 Firestore Security Rules v3.1.5
    // ABCDC Staff System - Multi-tenant SaaS
    // 순환참조 제거 + 보안 강화 + 관리자 회원가입 지원 + 쿼리 레벨 권한 수정
    // v3.1.5: 빈 컬렉션 조회 허용 (admin/manager는 resource 없이 권한 체크)
    // ===================================================================
    
    // ============ Helper Functions ============
    
    // 인증 확인
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ⭐ Super Admin 확인 (Firebase Custom Claims)
    function isSuperAdmin() {
      return request.auth != null
          && request.auth.token.super_admin == true;
    }
    
    // ⭐ v3.1.3: Helper 함수 (순환참조 방지)
    // 주의: 이 헬퍼들은 /users, /employees 컬렉션 "내부"에서는 사용하지 않음
    // 다른 컬렉션에서만 사용 (attendance, schedules 등)
    function currentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function currentUserExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function currentCompanyId() {
      return currentUser().data.companyId;
    }
    
    function currentStoreId() {
      return currentUser().data.storeId;
    }
    
    function currentRole() {
      return currentUser().data.role;
    }
    
    // ⭐ v3.1.5: 쿼리 레벨 권한 체크용 함수 (resource 없이도 동작)
    function isAdmin() {
      return currentUserExists()
          && currentUser().data.role == "admin";
    }
    
    function isManagerOrAbove() {
      return currentUserExists()
          && currentUser().data.role in ["admin", "manager", "store_manager"];
    }
    
    // ⭐ 문서 레벨 권한 체크용 함수 (resource 필요)
    function isCompanyAdmin() {
      return currentUserExists()
          && currentUser().data.companyId == resource.data.companyId
          && currentUser().data.role == "admin";
    }
    
    function isCompanyAdminOrManager() {
      return currentUserExists()
          && currentUser().data.companyId == resource.data.companyId
          && currentUser().data.role in ["admin", "manager", "store_manager"];
    }
    
    function isSameCompany(resource) {
      return resource.data.companyId == currentCompanyId();
    }
    
    function isSameStore(resource) {
      return resource.data.storeId == currentStoreId();
    }
    
    // ============ Collection Rules ============
    
    // ⭐ v3.1.3: users 컬렉션 (순환참조 제거 + 민감 필드 보호)
    match /users/{userId} {
      // 읽기: 본인은 직접 비교, 타인은 명시적 get()으로 체크
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isSuperAdmin() ||
        (
          // ⭐ 자기 자신이 아닐 때만 currentUser() 사용
          request.auth.uid != userId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role in ["admin", "manager", "store_manager"]
        )
      );
      
      // 생성: 회원가입 시
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // ⭐ 수정 1: 본인이 자기 문서 수정 시 - 민감 필드 변경 금지
      // companyId, role, storeId, status는 변경 불가
      allow update: if isSignedIn()
                    && request.auth.uid == userId
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.role == resource.data.role
                    && request.resource.data.storeId == resource.data.storeId
                    && request.resource.data.status == resource.data.status;
      
      // ⭐ 수정 2: admin/super_admin - 모든 필드 수정 가능
      // 자기 자신이 아닐 때만 적용
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.uid != userId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role == "admin"
        )
      );
    }
    
    // companies: 회사 정보
    match /companies/{companyId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentCompanyId() == companyId)
      );
      
      // ⭐ v3.1.4: 회사 생성 - 관리자 회원가입 시 users 문서 없이 생성 가능
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        request.resource.data.createdBy == request.auth.uid  // 본인이 생성하는 회사
      );
      
      // 회사 수정/삭제 - 해당 회사의 admin만 가능
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentCompanyId() == companyId && currentRole() == "admin")
      );
    }
    
    // stores: 매장 정보
    match /stores/{storeId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // ⭐ v3.1.3: employees 컬렉션 (순환참조 제거 + 민감 필드 보호)
    match /employees/{employeeId} {
      // 읽기: 본인은 직접 비교, 타인은 명시적 get()으로 체크
      allow read: if isSignedIn() && (
        request.auth.uid == employeeId ||
        isSuperAdmin() ||
        (
          // ⭐ 자기 자신이 아닐 때만 currentUser() 사용
          request.auth.uid != employeeId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role in ["admin", "manager", "store_manager"]
        )
      );
      
      allow create: if isSignedIn() && request.auth.uid == employeeId;
      
      // ⭐ 본인 수정: 민감 필드 변경 금지
      allow update: if isSignedIn()
                    && request.auth.uid == employeeId
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.storeId == resource.data.storeId
                    && request.resource.data.role == resource.data.role
                    && request.resource.data.status == resource.data.status;
      
      // ⭐ admin/super_admin: 풀 권한 (자기 자신 아닐 때만)
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (
          request.auth.uid != employeeId &&
          currentUserExists() &&
          currentUser().data.companyId == resource.data.companyId &&
          currentUser().data.role == "admin"
        )
      );
    }
    
    // attendance: 출퇴근 기록
    match /attendance/{attendanceId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() &&
         request.resource.data.storeId == currentStoreId())
      );
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.employeeId == request.auth.uid || currentRole() == "admin"))
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // schedules: 근무 스케줄
    match /schedules/{scheduleId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // contracts: 계약서
    match /contracts/{contractId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // savedContracts: 임시 저장 계약서
    match /savedContracts/{contractId} {
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isSuperAdmin() ||
        isCompanyAdmin()
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update, delete: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // ⭐ v3.1.5: signedContracts (생성 권한 강화 - 본인만 또는 admin만)
    match /signedContracts/{contractId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      // ⭐ 생성: 본인 계약서만 서명 가능 OR admin이 생성
      allow create: if isSignedIn() &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId() &&
                       (request.resource.data.employeeId == request.auth.uid || 
                        currentRole() == "admin");
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // salaries: 급여 정보
    match /salaries/{salaryId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create, update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
    }
    
    // notices: 공지사항
    match /notices/{noticeId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // approvals: 문서 승인
    match /approvals/{approvalId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.applicantUid == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // shift_requests: 교대근무 신청
    match /shift_requests/{requestId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.requesterId == request.auth.uid &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (isSameStore(resource) || currentRole() == "admin"))
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && isSameCompany(resource) &&
         (resource.data.requesterId == request.auth.uid || currentRole() == "admin"))
      );
    }
    
    // time_change_reports: 근무시간 수정 이력
    match /time_change_reports/{reportId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isManagerOrAbove()  // ⭐ v3.1.5: 쿼리 레벨 허용
      );
      
      allow create: if isSignedIn() &&
                       currentUserExists() &&
                       request.resource.data.companyId == currentCompanyId();
      
      allow update: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdminOrManager()
      );
      
      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // employee_docs: 직원 서류
    match /employee_docs/{docId} {
      allow read: if isSignedIn() && (
        docId == request.auth.uid ||
        isSuperAdmin() ||
        (currentUserExists() &&
         exists(/databases/$(database)/documents/users/$(docId)) &&
         currentCompanyId() == get(/databases/$(database)/documents/users/$(docId)).data.companyId &&
         currentRole() == "admin")
      );
      
      allow write: if isSignedIn() && (
        docId == request.auth.uid ||
        isSuperAdmin() ||
        (currentUserExists() &&
         exists(/databases/$(database)/documents/users/$(docId)) &&
         currentCompanyId() == get(/databases/$(database)/documents/users/$(docId)).data.companyId &&
         currentRole() == "admin")
      );
    }
    
    // company_invites (초대 코드)
    match /company_invites/{inviteId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
      
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && 
         request.resource.data.companyId == currentCompanyId() && 
         currentRole() == "admin")
      );
      
      allow update, delete: if isSignedIn() && (
        isSuperAdmin() ||
        isCompanyAdmin()
      );
    }
    
    // 마이그레이션 백업 컬렉션 (임시)
    match /schedules_backup/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    match /schedules_new/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    match /schedules_old/{scheduleId} {
      allow read, write: if isSignedIn() && (
        isSuperAdmin() ||
        (currentUserExists() && currentRole() == "admin")
      );
    }
    
    // 기타 모든 컬렉션: super_admin만 접근
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
