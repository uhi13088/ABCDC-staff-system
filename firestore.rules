rules_version = '2';

/**
 * Firestore Security Rules
 * 표준 필드명 기반 (FIELD_NAMING_STANDARD.md 준수)
 * * 핵심 원칙:
 * 1. 모든 데이터는 companyId로 격리
 * 2. 표준 필드명 (userId, storeId, clockIn 등) 검증
 * 3. 역할 기반 권한 (super_admin, admin, manager, store_manager, employee)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // 헬퍼 함수
    // ====================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }
    
    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'super_admin'];
    }
    
    function isStoreManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'store_manager', 'super_admin'];
    }
    
    function isSameCompany(companyId) {
      return isAuthenticated() && (getUserCompanyId() == companyId || isSuperAdmin());
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ====================================
    // 1. Companies (회사)
    // ====================================
    match /companies/{companyId} {
      allow read: if isSameCompany(companyId) || isSuperAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin() && isSameCompany(companyId);
      allow delete: if isSuperAdmin();
      
      // 회사 설정 (서브컬렉션)
      match /settings/{settingId} {
        allow read: if isSameCompany(companyId);
        allow write: if isAdmin() && isSameCompany(companyId);
      }
    }
    
    // ====================================
    // 2. Users (사용자/직원)
    // ====================================
    match /users/{userId} {
      allow read: if isAuthenticated() 
        && (
          isOwner(userId) 
          || isManager()
        );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (isOwner(userId) || (isManager() && isSameCompany(resource.data.companyId)))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId']) 
            || isSuperAdmin());
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 3. Contracts (계약서)
    // ====================================
    match /contracts/{contractId} {
      allow read: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 4. Attendance (출퇴근)
    // ====================================
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isStoreManager() && isSameCompany(resource.data.companyId)));
      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.userId) || (isStoreManager() && isSameCompany(request.resource.data.companyId)));
      allow update: if isAuthenticated()
        && (
          (isStoreManager() && isSameCompany(resource.data.companyId))
          || isOwner(resource.data.userId)
        );
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 5. Schedules (근무스케줄)
    // ====================================
    match /schedules/{scheduleId} {
      // [수정] 일반 직원도 같은 회사 스케줄 조회 가능 (isStoreManager 제거)
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || isSameCompany(resource.data.companyId));
        
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 6. Salary (급여)
    // ====================================
    match /salary/{salaryId} {
      allow read: if isAuthenticated()
        && (
          isOwner(resource.data.userId) 
          || (isManager() && isSameCompany(resource.data.companyId))
        );
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 7. Approvals (승인 요청)
    // ====================================
    match /approvals/{approvalId} {
      // 표준 필드명 userId 기준 검사
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    // ====================================
    // 8. Notices (공지사항)
    // ====================================
    match /notices/{noticeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 9. Brands (브랜드)
    // ====================================
    match /brands/{brandId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 10. Stores (매장)
    // ====================================
    match /stores/{storeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11. Invites (초대 코드 - 매장용)
    // ====================================
    match /invites/{inviteId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 11-2. Company Invites (직원 초대 코드)
    // ====================================
    match /company_invites/{inviteId} {
      allow read: if isAuthenticated() && (
        isSameCompany(resource.data.companyId) ||
        request.auth != null
      );
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 12. Shift Requests (교대근무 요청)
    // ====================================
    match /shift_requests/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 13. Simulators (스케줄 시뮬레이터)
    // ====================================
    match /simulators/{simulatorId} {
      allow read: if isAuthenticated();
      allow create: if isStoreManager();
      allow update: if isStoreManager();
      allow delete: if isStoreManager();
    }
    
    // ====================================
    // 14. Signed Contracts (서명된 계약서)
    // ====================================
    match /signedContracts/{contractId} {
      allow read: if isAuthenticated()
        && ((isStoreManager() && isSameCompany(resource.data.companyId))
        || isOwner(resource.data.userId));
      allow create: if isAuthenticated()
        && isOwner(request.resource.data.userId)
        && isSameCompany(request.resource.data.companyId);
      allow update: if false;
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 15. Holidays (공휴일)
    // ====================================
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ====================================
    // 16. Subscription Plans (구독 플랜)
    // ====================================
    match /subscription_plans/{planId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 17. Invitation Codes (플랫폼 초대 코드)
    // ====================================
    match /invitation_codes/{codeId} {
      allow read: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ====================================
    // 18. Open Shifts (긴급 구인)
    // ====================================
    match /open_shifts/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 19. Notifications (알림)
    // ====================================
    match /notifications/{notifId} {
      allow read: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow delete: if isAuthenticated()
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}