rules_version = '2';

/**
 * Firestore Security Rules (보안 강화 수정본)
 * 1. list 규칙에 isSameCompany() 강제 적용 -> 타 회사 데이터 접근 차단
 * 2. 관리자라도 본인 회사의 데이터만 조회 가능하도록 수정
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ====================================
    // 헬퍼 함수
    // ====================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function getUserCompanyId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }
    
    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'super_admin'];
    }
    
    function isStoreManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'store_manager', 'super_admin'];
    }
    
    function isSameCompany(companyId) {
      return isAuthenticated() && (getUserCompanyId() == companyId || isSuperAdmin());
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ====================================
    // 1. Companies (회사)
    // ====================================
    match /companies/{companyId} {
      allow read: if isSameCompany(companyId) || isSuperAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin() && isSameCompany(companyId);
      allow delete: if isSuperAdmin();
      
      match /settings/{settingId} {
        allow read: if isSameCompany(companyId);
        allow write: if isAdmin() && isSameCompany(companyId);
      }
    }
    
    // ====================================
    // 2. Users (사용자/직원)
    // ==================================== 
    match /users/{userId} {
      allow get: if isAuthenticated() 
        && (isOwner(userId) || (resource != null && isManager() && isSameCompany(resource.data.companyId)));
      
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated() && isManager();
      
      allow create: if isAuthenticated();
      allow update: if isAuthenticated()
        && (isOwner(userId) || (isManager() && resource != null && isSameCompany(resource.data.companyId)))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId']) || isSuperAdmin());
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 3. Contracts (계약서)
    // ====================================
    match /contracts/{contractId} {
      allow get: if isAuthenticated()
        && ((resource != null && isOwner(resource.data.userId)) || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId)));
      
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated() && isStoreManager();
      
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      
      allow update: if isAuthenticated() && resource != null
        && ((isStoreManager() && isSameCompany(resource.data.companyId)) || (isOwner(resource.data.userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['employeeSignedAt', 'employeeSignedBy', 'employeeSignature', 'updatedAt', 'status'])));
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 4. Attendance (출퇴근)
    // ====================================
    match /attendance/{attendanceId} {
      allow get: if isAuthenticated()
        && ((resource != null && isOwner(resource.data.userId)) || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId)));
      
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && (isOwner(request.resource.data.userId) || (isStoreManager() && isSameCompany(request.resource.data.companyId)));
      
      allow update: if isAuthenticated() && resource != null
        && ((isStoreManager() && isSameCompany(resource.data.companyId)) || isOwner(resource.data.userId));
      allow delete: if isManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 5. Schedules (근무스케줄)
    // ====================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated()
        && (
          (resource != null && isOwner(resource.data.userId))
          || (resource != null && isStoreManager() && isSameCompany(resource.data.companyId))
          || (resource != null && isSameCompany(resource.data.companyId))
        );
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 6. Salary (급여)
    // ====================================
    match /salary/{salaryId} {
      allow get: if isAuthenticated() && resource != null
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated() && isManager();
      
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && resource != null && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 7. Approvals (승인 요청)
    // ====================================
    match /approvals/{approvalId} {
      allow get: if isAuthenticated() && resource != null
        && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId) && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && resource != null && isSameCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && resource != null && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    // ====================================
    // 8. Notices, Brands, Stores, Invites, Company Invites (공통: 같은 회사만 조회)
    // ====================================
    match /notices/{noticeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    match /brands/{brandId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    match /stores/{storeId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    match /invites/{inviteId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    match /company_invites/{inviteId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAdmin() && isSameCompany(request.resource.data.companyId);
      allow update: if isAdmin() && isSameCompany(resource.data.companyId);
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 12. Shift Requests
    // ====================================
    match /shift_requests/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isManager() && isSameCompany(resource.data.companyId);
      allow delete: if isManager() && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 13. Simulators
    // ====================================
    match /simulators/{simulatorId} {
      allow get: if isAuthenticated() && resource != null && isSameCompany(resource.data.companyId);
      // [수정] list 규칙: 쿼리에 companyId 필터 필수
      allow list: if isAuthenticated() && isStoreManager();
      
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && resource != null && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && resource != null && isSameCompany(resource.data.companyId);
    }
    
    // ====================================
    // 14~19. 기타 규칙 (Signed Contracts, Open Shifts, Notifications 등)
    // ====================================
    match /signedContracts/{contractId} {
      allow read: if isAuthenticated() && ((isStoreManager() && isSameCompany(resource.data.companyId)) || isOwner(resource.data.userId));
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId) && isSameCompany(request.resource.data.companyId);
      allow update: if false;
      allow delete: if isAdmin() && isSameCompany(resource.data.companyId);
    }
    
    match /holidays/{holidayId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    match /subscription_plans/{planId} {
      allow read: if true;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    match /invitation_codes/{codeId} {
      allow read: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    match /open_shifts/{shiftId} {
      allow read: if isAuthenticated() && isSameCompany(resource.data.companyId);
      allow create: if isStoreManager() && isSameCompany(request.resource.data.companyId);
      allow update: if isStoreManager() && isSameCompany(resource.data.companyId);
      allow delete: if isStoreManager() && isSameCompany(resource.data.companyId);
    }
    
    match /notifications/{notifId} {
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow create: if isAuthenticated() && isSameCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
      allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || (isManager() && isSameCompany(resource.data.companyId)));
    }
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}