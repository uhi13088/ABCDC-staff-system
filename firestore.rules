rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================================================
    // 멀티테넌트 Firestore Security Rules v3.1
    // ABCDC Staff System - Multi-tenant SaaS
    // ===================================================================
    
    // ============ Helper Functions ============
    
    // 인증 확인
    function isSignedIn() {
      return request.auth != null;
    }
    
    // ⭐ v3.1: Super Admin 확인 (Firebase Custom Claims)
    function isSuperAdmin() {
      return request.auth != null
          && request.auth.token.super_admin == true;
    }
    
    // 사용자 문서 가져오기
    function getUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // 사용자의 companyId
    function userCompanyId() {
      return getUser().data.companyId;
    }
    
    // 사용자의 storeId
    function userStoreId() {
      return getUser().data.storeId;
    }
    
    // 역할 확인
    function hasRole(roleName) {
      return getUser().data.role == roleName;
    }
    
    // Admin 여부 (회사 관리자)
    function isAdmin() {
      return hasRole("admin");
    }
    
    // Store Manager 여부
    function isStoreManager() {
      return getUser().data.role in ["store_manager", "manager"];
    }
    
    // Admin 또는 Manager
    function isAdminOrManager() {
      return isAdmin() || isStoreManager();
    }
    
    // ⭐ 같은 회사인지 확인 (리소스)
    function isSameCompany(resource) {
      return resource.data.companyId == userCompanyId();
    }
    
    // ⭐ 같은 매장인지 확인 (리소스)
    function isSameStore(resource) {
      return resource.data.storeId == userStoreId();
    }
    
    // ⭐ 같은 회사인지 확인 (요청 데이터)
    function isSameCompanyInRequest() {
      return request.resource.data.companyId == userCompanyId();
    }
    
    // ⭐ 같은 매장인지 확인 (요청 데이터)
    function isSameStoreInRequest() {
      return request.resource.data.storeId == userStoreId();
    }
    
    // ============ Collection Rules ============
    
    // companies: 회사 정보
    match /companies/{companyId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        userCompanyId() == companyId || isSuperAdmin()
      );
      
      // 쓰기: 해당 회사 admin 또는 super_admin
      allow write: if isSignedIn() && (
        (userCompanyId() == companyId && isAdmin()) || isSuperAdmin()
      );
    }
    
    // stores: 매장 정보
    match /stores/{storeId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 쓰기: 해당 회사 admin 또는 super_admin
      allow create: if isSignedIn() && (
        (isSameCompanyInRequest() && isAdmin()) || isSuperAdmin()
      );
      allow update, delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // users: 사용자 정보
    match /users/{userId} {
      // 읽기: 본인 또는 같은 회사 admin/manager 또는 super_admin
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        (isSameCompany(resource) && isAdminOrManager()) ||
        isSuperAdmin()
      );
      
      // 생성: 회원가입 시 (companyId 검증은 Cloud Function에서)
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // 수정: 본인 또는 같은 회사 admin 또는 super_admin
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
      
      // 삭제: 같은 회사 admin 또는 super_admin
      allow delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // employees: 직원 목록 (users와 동일한 규칙)
    match /employees/{employeeId} {
      allow read: if isSignedIn() && (
        request.auth.uid == employeeId ||
        (isSameCompany(resource) && isAdminOrManager()) ||
        isSuperAdmin()
      );
      
      allow create: if isSignedIn() && request.auth.uid == employeeId;
      
      allow update: if isSignedIn() && (
        request.auth.uid == employeeId ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
      
      allow delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // attendance: 출퇴근 기록
    match /attendance/{attendanceId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 생성: 같은 회사, 같은 매장
      allow create: if isSignedIn() && (
        isSameCompanyInRequest() && isSameStoreInRequest() || isSuperAdmin()
      );
      
      // 수정: 본인 또는 같은 회사 admin 또는 super_admin
      allow update: if isSignedIn() && (
        (isSameCompany(resource) && (resource.data.employeeId == request.auth.uid || isAdmin())) ||
        isSuperAdmin()
      );
      
      // 삭제: 같은 회사 admin 또는 super_admin
      allow delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // schedules: 근무 스케줄
    match /schedules/{scheduleId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 쓰기: 같은 회사 admin 또는 super_admin
      allow write: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // contracts: 계약서
    match /contracts/{contractId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 쓰기: 같은 회사 admin 또는 super_admin
      allow write: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // savedContracts: 임시 저장 계약서
    match /savedContracts/{contractId} {
      // 읽기: 본인이 작성한 것 또는 같은 회사 admin 또는 super_admin
      allow read: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
      
      // 생성: 본인이 작성
      allow create: if isSignedIn() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       isSameCompanyInRequest();
      
      // 수정/삭제: 본인 또는 같은 회사 admin 또는 super_admin
      allow update, delete: if isSignedIn() && (
        resource.data.createdBy == request.auth.uid ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
    }
    
    // signedContracts: 서명된 계약서
    match /signedContracts/{contractId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 생성: 같은 회사 직원
      allow create: if isSignedIn() && isSameCompanyInRequest();
      
      // 수정/삭제: 같은 회사 admin 또는 super_admin
      allow update, delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // salaries: 급여 정보
    match /salaries/{salaryId} {
      // 읽기: 본인 급여 또는 같은 회사 admin 또는 super_admin
      allow read: if isSignedIn() && (
        (isSameCompany(resource) && (resource.data.employeeId == request.auth.uid || isAdmin())) ||
        isSuperAdmin()
      );
      
      // 쓰기: 같은 회사 admin 또는 super_admin
      allow create, update, delete: if isSignedIn() && (
        (isSameCompanyInRequest() && isAdmin()) || isSuperAdmin()
      );
    }
    
    // notices: 공지사항
    match /notices/{noticeId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 쓰기: 같은 회사 admin 또는 super_admin
      allow write: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // approvals: 문서 승인
    match /approvals/{approvalId} {
      // 읽기: 본인 신청 또는 같은 회사 admin 또는 super_admin
      allow read: if isSignedIn() && (
        (isSameCompany(resource) && (resource.data.applicantUid == request.auth.uid || isAdmin())) ||
        isSuperAdmin()
      );
      
      // 생성: 같은 회사 직원
      allow create: if isSignedIn() && 
                       request.resource.data.applicantUid == request.auth.uid &&
                       isSameCompanyInRequest();
      
      // 수정/삭제: 같은 회사 admin 또는 super_admin
      allow update, delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // shift_requests: 교대근무 신청
    match /shift_requests/{requestId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 생성: 같은 회사 직원
      allow create: if isSignedIn() && 
                       request.resource.data.requesterId == request.auth.uid &&
                       isSameCompanyInRequest();
      
      // 수정: 같은 매장 직원 또는 같은 회사 admin 또는 super_admin
      allow update: if isSignedIn() && (
        (isSameCompany(resource) && (isSameStore(resource) || isAdmin())) ||
        isSuperAdmin()
      );
      
      // 삭제: 본인 또는 같은 회사 admin 또는 super_admin
      allow delete: if isSignedIn() && (
        (isSameCompany(resource) && (resource.data.requesterId == request.auth.uid || isAdmin())) ||
        isSuperAdmin()
      );
    }
    
    // time_change_reports: 근무시간 수정 이력
    match /time_change_reports/{reportId} {
      // 읽기: 같은 회사 사용자 또는 super_admin
      allow read: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 생성: 같은 회사 직원
      allow create: if isSignedIn() && isSameCompanyInRequest();
      
      // 수정: 같은 회사 사용자
      allow update: if isSignedIn() && (
        isSameCompany(resource) || isSuperAdmin()
      );
      
      // 삭제: 같은 회사 admin 또는 super_admin
      allow delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // employee_docs: 직원 서류
    match /employee_docs/{docId} {
      // 읽기: 본인 또는 같은 회사 admin 또는 super_admin
      allow read: if isSignedIn() && (
        docId == request.auth.uid ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
      
      // 쓰기: 본인 또는 같은 회사 admin 또는 super_admin
      allow write: if isSignedIn() && (
        docId == request.auth.uid ||
        (isSameCompany(resource) && isAdmin()) ||
        isSuperAdmin()
      );
    }
    
    // ⭐ v3.1: company_invites (초대 코드)
    match /company_invites/{inviteId} {
      // 읽기: 같은 회사 admin 또는 super_admin
      // (Cloud Function에서 검증하므로 클라이언트 직접 접근 최소화)
      allow read: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
      
      // 쓰기: 같은 회사 admin 또는 super_admin
      allow create: if isSignedIn() && (
        (isSameCompanyInRequest() && isAdmin()) || isSuperAdmin()
      );
      allow update, delete: if isSignedIn() && (
        (isSameCompany(resource) && isAdmin()) || isSuperAdmin()
      );
    }
    
    // 마이그레이션 백업 컬렉션 (임시)
    match /schedules_backup/{scheduleId} {
      allow read, write: if isSignedIn() && (isAdmin() || isSuperAdmin());
    }
    
    match /schedules_new/{scheduleId} {
      allow read, write: if isSignedIn() && (isAdmin() || isSuperAdmin());
    }
    
    match /schedules_old/{scheduleId} {
      allow read, write: if isSignedIn() && (isAdmin() || isSuperAdmin());
    }
    
    // 기타 모든 컬렉션: super_admin만 접근
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
